<!DOCTYPE html>
<html xmlns='http://www.w3.org/1999/xhtml'>
  <head>
    <title>Code coverage for Webapp</title>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <script src='./assets/0.10.2/application.js' type='text/javascript'></script>    
    <link href='./assets/0.10.2/application.css' media='screen, projection, print' rel='stylesheet' type='text/css'>
    <link rel="shortcut icon" type="image/png" href="./assets/0.10.2/favicon_red.png" />
    <link rel="icon" type="image/png" href="./assets/0.10.2/favicon.png" />
  </head>
  
  <body>
    <div id="loading">
      <img src="./assets/0.10.2/loading.gif" alt="loading"/>
    </div>
    <div id="wrapper" style="display:none;">
      <div class="timestamp">Generated <abbr class="timeago" title="2022-05-05T19:48:41+00:00">2022-05-05T19:48:41+00:00</abbr></div>
      <ul class="group_tabs"></ul>

      <div id="content">
        <div class="file_list_container" id="AllFiles">
  <h2>
    <span class="group_name">All Files</span>
    (<span class="covered_percent"><span class="red">13.11%</span></span>
     covered at
     <span class="covered_strength">
       <span class="red">
         0.21
       </span>
    </span> hits/line)
  </h2>
  <a name="AllFiles"></a>
  <div>
    <b>106</b> files in total.
    <b>4316</b> relevant lines. 
    <span class="green"><b>566</b> lines covered</span> and
    <span class="red"><b>3750</b> lines missed </span>
  </div>
  <table class="file_list">
    <thead>
      <tr>
        <th>File</th>
        <th>% covered</th>
        <th>Lines</th>
        <th>Relevant Lines</th>
        <th>Lines covered</th>
        <th>Lines missed</th>
        <th>Avg. Hits / Line</th>
      </tr>
    </thead>
    <tbody>
      
      <tr>
        <td class="strong"><a href="#d90f43a456e9317fb3609a66a12474a3478ffc70" class="src_link" title="app/channels/application_cable/channel.rb">app/channels/application_cable/channel.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>6</td>
        <td>4</td>
        <td>0</td>
        <td>4</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#45cb0c041c58164965a935e2deda0967365ef722" class="src_link" title="app/channels/application_cable/connection.rb">app/channels/application_cable/connection.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>6</td>
        <td>4</td>
        <td>0</td>
        <td>4</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#dc5a61aa28018c8fefcdbdfe79b5842b90711183" class="src_link" title="app/controllers/admin_sets_controller.rb">app/controllers/admin_sets_controller.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>85</td>
        <td>58</td>
        <td>0</td>
        <td>58</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#8ed88db25718897073c08ec6242208933f54c0ae" class="src_link" title="app/controllers/application_controller.rb">app/controllers/application_controller.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>23</td>
        <td>18</td>
        <td>0</td>
        <td>18</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#a5b7656fa412c2da0c53d4969e6b972822d5e102" class="src_link" title="app/controllers/batch_processes_controller.rb">app/controllers/batch_processes_controller.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>139</td>
        <td>105</td>
        <td>0</td>
        <td>105</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#32dad210ba7097a9ef94e05d6c4d43976b741c10" class="src_link" title="app/controllers/child_objects_controller.rb">app/controllers/child_objects_controller.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>86</td>
        <td>60</td>
        <td>0</td>
        <td>60</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#be81abd7aafcec892e3433c0723be8e20ce93558" class="src_link" title="app/controllers/delayed_job_dashboard_controller.rb">app/controllers/delayed_job_dashboard_controller.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>51</td>
        <td>42</td>
        <td>0</td>
        <td>42</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#86669f013b49e9857ef8f780a58b0589ba6c1c17" class="src_link" title="app/controllers/management_controller.rb">app/controllers/management_controller.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>9</td>
        <td>6</td>
        <td>0</td>
        <td>6</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#602e7fc8db38513662cea28fc63a5353c90482e2" class="src_link" title="app/controllers/oid_minter_controller.rb">app/controllers/oid_minter_controller.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>26</td>
        <td>21</td>
        <td>0</td>
        <td>21</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#12bceef399a62054591d656c65bdec9aa5893f4b" class="src_link" title="app/controllers/omniauth_callbacks_controller.rb">app/controllers/omniauth_callbacks_controller.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>27</td>
        <td>22</td>
        <td>0</td>
        <td>22</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#13b1ee54980f70c8c502b35457131db12a0aa0d5" class="src_link" title="app/controllers/parent_objects_controller.rb">app/controllers/parent_objects_controller.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>227</td>
        <td>182</td>
        <td>0</td>
        <td>182</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#2470e440229660ee7a02fcd32fd4b764a937ec8c" class="src_link" title="app/controllers/preservica_ingests_controller.rb">app/controllers/preservica_ingests_controller.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>12</td>
        <td>8</td>
        <td>0</td>
        <td>8</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#b3d54654a3b0f970a1e457c5177fa414de360f76" class="src_link" title="app/controllers/redirected_parent_objects_controller.rb">app/controllers/redirected_parent_objects_controller.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>12</td>
        <td>8</td>
        <td>0</td>
        <td>8</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#b98eb997174d95750d66cce867c71ff35e2168ef" class="src_link" title="app/controllers/reoccurring_jobs_controller.rb">app/controllers/reoccurring_jobs_controller.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>43</td>
        <td>37</td>
        <td>0</td>
        <td>37</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#2110ca64f9e4dd2d8da54557150e92f5ee025757" class="src_link" title="app/controllers/roles_controller.rb">app/controllers/roles_controller.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>54</td>
        <td>41</td>
        <td>0</td>
        <td>41</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#b2da084446acfc25d80c1c77c21e843a2b54d9fe" class="src_link" title="app/controllers/users_controller.rb">app/controllers/users_controller.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>57</td>
        <td>45</td>
        <td>0</td>
        <td>45</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#36a66f34bdaece141e7dbc8e8cc2df572e4880ca" class="src_link" title="app/datatables/admin_set_datatable.rb">app/datatables/admin_set_datatable.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>43</td>
        <td>33</td>
        <td>0</td>
        <td>33</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#0e7f298e66f63a5ef7cb9b567e186f660ce5fb85" class="src_link" title="app/datatables/batch_process_datatable.rb">app/datatables/batch_process_datatable.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>48</td>
        <td>37</td>
        <td>0</td>
        <td>37</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#e7ee03a5db248076edc0bb015fea2ee1e2595a06" class="src_link" title="app/datatables/batch_process_detail_datatable.rb">app/datatables/batch_process_detail_datatable.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>42</td>
        <td>31</td>
        <td>0</td>
        <td>31</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#e99446c7b559f6d0219e36fbc04504ef821ded02" class="src_link" title="app/datatables/batch_process_parent_datatable.rb">app/datatables/batch_process_parent_datatable.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>39</td>
        <td>29</td>
        <td>0</td>
        <td>29</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#77653a807a5304165be2cf68ad6c248b6cc99c7f" class="src_link" title="app/datatables/child_object_datatable.rb">app/datatables/child_object_datatable.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>71</td>
        <td>57</td>
        <td>0</td>
        <td>57</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#484feee8fde92adcbffcb2e3455853e53b104eb3" class="src_link" title="app/datatables/parent_object_datatable.rb">app/datatables/parent_object_datatable.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>93</td>
        <td>78</td>
        <td>0</td>
        <td>78</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#8bb3c008a511724983479744eec825f3ea67ee7e" class="src_link" title="app/datatables/preservica_ingest_datatable.rb">app/datatables/preservica_ingest_datatable.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>43</td>
        <td>34</td>
        <td>0</td>
        <td>34</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#22bebc02d913dd3afcb6c9101215cb4300073835" class="src_link" title="app/datatables/redirected_parent_object_datatable.rb">app/datatables/redirected_parent_object_datatable.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>61</td>
        <td>46</td>
        <td>0</td>
        <td>46</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#f5dba6404cb6d24f2e5e0c2c2e91c05edecd093f" class="src_link" title="app/datatables/reoccurring_job_datatable.rb">app/datatables/reoccurring_job_datatable.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>46</td>
        <td>35</td>
        <td>0</td>
        <td>35</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#b28c03fae835fbba1b3590ad329265f41d545298" class="src_link" title="app/datatables/user_datatable.rb">app/datatables/user_datatable.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>48</td>
        <td>38</td>
        <td>0</td>
        <td>38</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#2e1d9f7c0527ed02e6e63adb4a10eb13a082dc0b" class="src_link" title="app/helpers/admin_sets_helper.rb">app/helpers/admin_sets_helper.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>4</td>
        <td>1</td>
        <td>1</td>
        <td>0</td>
        <td>1.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#b8c6313cec3a31a656a56e8903d8f0039855c70e" class="src_link" title="app/helpers/application_helper.rb">app/helpers/application_helper.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>4</td>
        <td>1</td>
        <td>1</td>
        <td>0</td>
        <td>1.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#9fae1db60ceb079d12800e9ccb4b4b7f647d72a2" class="src_link" title="app/helpers/batch_processes_helper.rb">app/helpers/batch_processes_helper.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>4</td>
        <td>1</td>
        <td>1</td>
        <td>0</td>
        <td>1.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#c36acb1105b1855a660f08ca6bd73400bbb27f0c" class="src_link" title="app/helpers/json_helper.rb">app/helpers/json_helper.rb</a></td>
        <td class="red strong">40.0 %</td>
        <td>10</td>
        <td>5</td>
        <td>2</td>
        <td>3</td>
        <td>0.4</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#1f31b9ed0a13fcea49b6205180709c64cd8f1ed6" class="src_link" title="app/helpers/users_helper.rb">app/helpers/users_helper.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>4</td>
        <td>1</td>
        <td>1</td>
        <td>0</td>
        <td>1.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#9ccd2405b73add10fffff1231088f0218c1527d7" class="src_link" title="app/jobs/activity_stream_job.rb">app/jobs/activity_stream_job.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>9</td>
        <td>6</td>
        <td>0</td>
        <td>6</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#18561932383e1f412256f80a3e17be42ccacb2f2" class="src_link" title="app/jobs/activity_stream_manual_job.rb">app/jobs/activity_stream_manual_job.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>8</td>
        <td>5</td>
        <td>0</td>
        <td>5</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#1967e7cc678c57df31119f8de6b17d4923c2e716" class="src_link" title="app/jobs/add_extent_of_digitization_to_parent_objects_job.rb">app/jobs/add_extent_of_digitization_to_parent_objects_job.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>18</td>
        <td>12</td>
        <td>0</td>
        <td>12</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#09de5d45923ed6ab78a5c59ec4408d8989b99832" class="src_link" title="app/jobs/add_rights_to_parent_objects_job.rb">app/jobs/add_rights_to_parent_objects_job.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>18</td>
        <td>12</td>
        <td>0</td>
        <td>12</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#b8e823a678581b4974f1fbf215219e4072f84827" class="src_link" title="app/jobs/application_job.rb">app/jobs/application_job.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>19</td>
        <td>5</td>
        <td>5</td>
        <td>0</td>
        <td>5.8</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#3f7db38c3aa6c92ed23cfd45505377d634c185ab" class="src_link" title="app/jobs/create_child_oid_csv_job.rb">app/jobs/create_child_oid_csv_job.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>13</td>
        <td>9</td>
        <td>0</td>
        <td>9</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#d4369abb634be67a41b8d1d9f4db662d1ebc9688" class="src_link" title="app/jobs/create_new_parent_job.rb">app/jobs/create_new_parent_job.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>13</td>
        <td>9</td>
        <td>0</td>
        <td>9</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#ef79036001b6348d7f8a4a46e0c625a7b06638e0" class="src_link" title="app/jobs/create_parent_oid_csv_job.rb">app/jobs/create_parent_oid_csv_job.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>13</td>
        <td>9</td>
        <td>0</td>
        <td>9</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#00f43bcf15d0a7b8121f83196a2e08196673b3f4" class="src_link" title="app/jobs/delete_child_objects_job.rb">app/jobs/delete_child_objects_job.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>13</td>
        <td>9</td>
        <td>0</td>
        <td>9</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#7f44b38764737b76334454d73dab7400d185f019" class="src_link" title="app/jobs/delete_parent_objects_job.rb">app/jobs/delete_parent_objects_job.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>13</td>
        <td>9</td>
        <td>0</td>
        <td>9</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#c4a6cf0a70b3f70b69e5cb66ba44aa4dba5ad825" class="src_link" title="app/jobs/generate_manifest_job.rb">app/jobs/generate_manifest_job.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>39</td>
        <td>30</td>
        <td>0</td>
        <td>30</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#554c6a3cc942c45b3e1b21b8fb02696154f8760f" class="src_link" title="app/jobs/generate_output_csv_job.rb">app/jobs/generate_output_csv_job.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>16</td>
        <td>12</td>
        <td>0</td>
        <td>12</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#4a4152c875b27d060019fe9d0471187e1e3798c8" class="src_link" title="app/jobs/generate_pdf_job.rb">app/jobs/generate_pdf_job.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>20</td>
        <td>16</td>
        <td>0</td>
        <td>16</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#d0c9bb9e11fcc8d3fced176b27863c8b4160e903" class="src_link" title="app/jobs/generate_ptiff_job.rb">app/jobs/generate_ptiff_job.rb</a></td>
        <td class="green strong">94.44 %</td>
        <td>32</td>
        <td>18</td>
        <td>17</td>
        <td>1</td>
        <td>1.7</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#2c2beef6211dc4dcdd5daf24012f7eba325edeee" class="src_link" title="app/jobs/mets_directory_scan_job.rb">app/jobs/mets_directory_scan_job.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>15</td>
        <td>9</td>
        <td>0</td>
        <td>9</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#181fa2ed0eff77202ce9e6631074e6c7019f4972" class="src_link" title="app/jobs/reassociate_child_oids_job.rb">app/jobs/reassociate_child_oids_job.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>15</td>
        <td>11</td>
        <td>0</td>
        <td>11</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#a90d3e8237ae1f8a44fbec25625145591481dd69" class="src_link" title="app/jobs/recreate_child_oid_ptiffs_job.rb">app/jobs/recreate_child_oid_ptiffs_job.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>13</td>
        <td>6</td>
        <td>6</td>
        <td>0</td>
        <td>1.2</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#1a0b6fa617d46db6f36ca67868484a7310696d21" class="src_link" title="app/jobs/setup_metadata_job.rb">app/jobs/setup_metadata_job.rb</a></td>
        <td class="red strong">15.56 %</td>
        <td>78</td>
        <td>45</td>
        <td>7</td>
        <td>38</td>
        <td>0.2</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#bff33abfa2cd3d4ff9579bed67fd7658a433f230" class="src_link" title="app/jobs/solr_index_job.rb">app/jobs/solr_index_job.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>15</td>
        <td>11</td>
        <td>0</td>
        <td>11</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#f39b578c0e65f8a5635746d9c9b2cf46877775a7" class="src_link" title="app/jobs/solr_reindex_all_job.rb">app/jobs/solr_reindex_all_job.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>41</td>
        <td>34</td>
        <td>0</td>
        <td>34</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#bff22620fcd7d78d3ebe45eec5a5033ea81ee10f" class="src_link" title="app/jobs/sync_from_preservica_job.rb">app/jobs/sync_from_preservica_job.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>13</td>
        <td>9</td>
        <td>0</td>
        <td>9</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#398c813b0f9852f93a4ef2b46114d2e6f554f1e8" class="src_link" title="app/jobs/update_all_metadata_job.rb">app/jobs/update_all_metadata_job.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>20</td>
        <td>16</td>
        <td>0</td>
        <td>16</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#cafff5f7a86b313a057477058a0d8e6a097e2c01" class="src_link" title="app/jobs/update_fulltext_status_job.rb">app/jobs/update_fulltext_status_job.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>35</td>
        <td>29</td>
        <td>0</td>
        <td>29</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#9131f0b58ef225c8ce63dd0bab27666e4f679b9f" class="src_link" title="app/jobs/update_fulltext_status_sub_job.rb">app/jobs/update_fulltext_status_sub_job.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>13</td>
        <td>9</td>
        <td>0</td>
        <td>9</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#6a4ea372c493b55615de29240cb674138279e524" class="src_link" title="app/jobs/update_parent_objects_job.rb">app/jobs/update_parent_objects_job.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>15</td>
        <td>10</td>
        <td>0</td>
        <td>10</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#837b27b23ebfac0de52918661fbd4a2bb7e3d0f6" class="src_link" title="app/lib/activity_stream_reader.rb">app/lib/activity_stream_reader.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>173</td>
        <td>117</td>
        <td>0</td>
        <td>117</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#91f31c564792f4b129d09f27064785deceaa3cb3" class="src_link" title="app/lib/json_validator.rb">app/lib/json_validator.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>12</td>
        <td>8</td>
        <td>0</td>
        <td>8</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#c369233904be2951c2d6753cb38a395bebf8e28f" class="src_link" title="app/lib/mets_directory_scanner.rb">app/lib/mets_directory_scanner.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>69</td>
        <td>50</td>
        <td>0</td>
        <td>50</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#61fe50cb81a005eca8666b96e4d768aceea104ec" class="src_link" title="app/lib/preservica_client.rb">app/lib/preservica_client.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>136</td>
        <td>107</td>
        <td>0</td>
        <td>107</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#e13bed53c789df603fd18623c79d8a3e8b0b35e1" class="src_link" title="app/mailers/application_mailer.rb">app/mailers/application_mailer.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>6</td>
        <td>4</td>
        <td>0</td>
        <td>4</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#2bc6a29882573554f8cd99b81786a049ff6ab00f" class="src_link" title="app/models/ability.rb">app/models/ability.rb</a></td>
        <td class="red strong">62.07 %</td>
        <td>42</td>
        <td>29</td>
        <td>18</td>
        <td>11</td>
        <td>1.3</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#c6467705302b68c4ce333e6cd043ad3ae414ff1f" class="src_link" title="app/models/activity_stream_log.rb">app/models/activity_stream_log.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>4</td>
        <td>2</td>
        <td>0</td>
        <td>2</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#556aedd0f16de3642c6b8b641e775e0de01bcd0e" class="src_link" title="app/models/admin_set.rb">app/models/admin_set.rb</a></td>
        <td class="red strong">50.0 %</td>
        <td>49</td>
        <td>24</td>
        <td>12</td>
        <td>12</td>
        <td>0.5</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#dfd13e26507655b8df42f582f81d00f182338150" class="src_link" title="app/models/application_record.rb">app/models/application_record.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>5</td>
        <td>2</td>
        <td>2</td>
        <td>0</td>
        <td>1.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#6969bbe0a288d2999c0c9a14454002c3e70facca" class="src_link" title="app/models/batch_connection.rb">app/models/batch_connection.rb</a></td>
        <td class="green strong">90.91 %</td>
        <td>20</td>
        <td>11</td>
        <td>10</td>
        <td>1</td>
        <td>1.8</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#0ea6fbfd2150a7a9b66ada2ebffed2223b304922" class="src_link" title="app/models/batch_process.rb">app/models/batch_process.rb</a></td>
        <td class="red strong">32.61 %</td>
        <td>519</td>
        <td>276</td>
        <td>90</td>
        <td>186</td>
        <td>0.5</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#debc041c42081c545d1bd39008ac41e2079b88c0" class="src_link" title="app/models/child_object.rb">app/models/child_object.rb</a></td>
        <td class="red strong">51.46 %</td>
        <td>184</td>
        <td>103</td>
        <td>53</td>
        <td>50</td>
        <td>0.8</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#16c1f454139d1a65576bfb1dc4802cbe2cd697f6" class="src_link" title="app/models/concerns/csv_exportable.rb">app/models/concerns/csv_exportable.rb</a></td>
        <td class="red strong">17.33 %</td>
        <td>165</td>
        <td>75</td>
        <td>13</td>
        <td>62</td>
        <td>0.2</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#fe96f9aa7420c3ea3683a838f7e1f63fb71d691a" class="src_link" title="app/models/concerns/delayable.rb">app/models/concerns/delayable.rb</a></td>
        <td class="red strong">60.0 %</td>
        <td>31</td>
        <td>15</td>
        <td>9</td>
        <td>6</td>
        <td>0.6</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#c55180af3fbbab36c3e6e8a59acf943274554159" class="src_link" title="app/models/concerns/deletable.rb">app/models/concerns/deletable.rb</a></td>
        <td class="red strong">12.77 %</td>
        <td>72</td>
        <td>47</td>
        <td>6</td>
        <td>41</td>
        <td>0.1</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#76386b2d974d971e3b5944d17ce162a96780b006" class="src_link" title="app/models/concerns/digital_object_management.rb">app/models/concerns/digital_object_management.rb</a></td>
        <td class="red strong">23.81 %</td>
        <td>88</td>
        <td>42</td>
        <td>10</td>
        <td>32</td>
        <td>0.2</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#d77006734a3555089d3607e26d16fa3f9528f6a2" class="src_link" title="app/models/concerns/json_file.rb">app/models/concerns/json_file.rb</a></td>
        <td class="red strong">33.33 %</td>
        <td>14</td>
        <td>9</td>
        <td>3</td>
        <td>6</td>
        <td>0.3</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#7f33d24ee327110d70de1b9f242b18ddc6a48bc4" class="src_link" title="app/models/concerns/metadata_cloud_url_parsable.rb">app/models/concerns/metadata_cloud_url_parsable.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>72</td>
        <td>53</td>
        <td>0</td>
        <td>53</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#e642132fd520434fca52ab01599d232183b03325" class="src_link" title="app/models/concerns/pdf_representable.rb">app/models/concerns/pdf_representable.rb</a></td>
        <td class="red strong">23.53 %</td>
        <td>159</td>
        <td>85</td>
        <td>20</td>
        <td>65</td>
        <td>0.2</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#9a7ac4df9003ed8a0d3854f110e28104bbcc7433" class="src_link" title="app/models/concerns/reassociatable.rb">app/models/concerns/reassociatable.rb</a></td>
        <td class="red strong">17.17 %</td>
        <td>184</td>
        <td>99</td>
        <td>17</td>
        <td>82</td>
        <td>0.2</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#58fcc178fd8bc086d0ec70a6798877a60967897a" class="src_link" title="app/models/concerns/solr_indexable.rb">app/models/concerns/solr_indexable.rb</a></td>
        <td class="red strong">20.69 %</td>
        <td>315</td>
        <td>116</td>
        <td>24</td>
        <td>92</td>
        <td>0.2</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#d72c0d287c21dbbfdd9d2ae0ae4fba0ac23ff1c6" class="src_link" title="app/models/concerns/statable.rb">app/models/concerns/statable.rb</a></td>
        <td class="red strong">67.35 %</td>
        <td>89</td>
        <td>49</td>
        <td>33</td>
        <td>16</td>
        <td>3.2</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#17dd4de8907d0e7d2ea829106c22786317d9a4ac" class="src_link" title="app/models/concerns/updatable.rb">app/models/concerns/updatable.rb</a></td>
        <td class="red strong">17.02 %</td>
        <td>158</td>
        <td>94</td>
        <td>16</td>
        <td>78</td>
        <td>0.2</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#b29f6b11743643f08e90223b6137d0586cdcad06" class="src_link" title="app/models/csv_export.rb">app/models/csv_export.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>18</td>
        <td>12</td>
        <td>0</td>
        <td>12</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#bd4c3de8b94cf620d67bbbafe5778291d05f6708" class="src_link" title="app/models/dependent_object.rb">app/models/dependent_object.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>5</td>
        <td>3</td>
        <td>0</td>
        <td>3</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#fed2bf7deaf5ad819cffedd84d84c4d854d625e3" class="src_link" title="app/models/digital_object_json.rb">app/models/digital_object_json.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>5</td>
        <td>3</td>
        <td>0</td>
        <td>3</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#75c5cff65a276c77b06b336a2a6e27b0bf426700" class="src_link" title="app/models/iiif_presentation_v3.rb">app/models/iiif_presentation_v3.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>287</td>
        <td>244</td>
        <td>0</td>
        <td>244</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#32ad6ffafa6b2170e7cf39435bfbdda9738302e4" class="src_link" title="app/models/ingest_event.rb">app/models/ingest_event.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>5</td>
        <td>2</td>
        <td>2</td>
        <td>0</td>
        <td>1.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#9bac5f8e6b54f78003f46c1bee2737dd3822c9e7" class="src_link" title="app/models/metadata_source.rb">app/models/metadata_source.rb</a></td>
        <td class="red strong">28.26 %</td>
        <td>81</td>
        <td>46</td>
        <td>13</td>
        <td>33</td>
        <td>0.3</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#74605905f1f4acf88e5dba3bfbe0f6aa7d8a3ce6" class="src_link" title="app/models/mets_document.rb">app/models/mets_document.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>210</td>
        <td>167</td>
        <td>0</td>
        <td>167</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#d21dccce01f4efa2b8b0c4abad7be653aff59c1c" class="src_link" title="app/models/parent_object.rb">app/models/parent_object.rb</a></td>
        <td class="red strong">32.92 %</td>
        <td>580</td>
        <td>322</td>
        <td>106</td>
        <td>216</td>
        <td>0.5</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#3b71ddcd5b42257d88fd6ceee42a4b871c03c626" class="src_link" title="app/models/preservica/bitstream.rb">app/models/preservica/bitstream.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>55</td>
        <td>44</td>
        <td>0</td>
        <td>44</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#ae7510421e94bec401ed50776372f4ceb864d06c" class="src_link" title="app/models/preservica/content_object.rb">app/models/preservica/content_object.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>33</td>
        <td>25</td>
        <td>0</td>
        <td>25</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#44e92fa54168865d8cec4eaf51acbcbcdb7fb4e4" class="src_link" title="app/models/preservica/generation.rb">app/models/preservica/generation.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>52</td>
        <td>39</td>
        <td>0</td>
        <td>39</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#1e0b824c05175b548f70c6627d2947ed110a4d1e" class="src_link" title="app/models/preservica/information_object.rb">app/models/preservica/information_object.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>50</td>
        <td>37</td>
        <td>0</td>
        <td>37</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#8d8256e1054ecb4072be7cfe9a1188d15c086455" class="src_link" title="app/models/preservica/preservica_object.rb">app/models/preservica/preservica_object.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>6</td>
        <td>4</td>
        <td>0</td>
        <td>4</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#507d99957289d16a6198be29c92ae8fe39ec68bd" class="src_link" title="app/models/preservica/representation.rb">app/models/preservica/representation.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>45</td>
        <td>34</td>
        <td>0</td>
        <td>34</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#cb099bc2e3144de55713ebb89761069dc390b856" class="src_link" title="app/models/preservica/structural_object.rb">app/models/preservica/structural_object.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>33</td>
        <td>25</td>
        <td>0</td>
        <td>25</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#219b1961ac32c8c70d7f80b9ed3e0522956fd30b" class="src_link" title="app/models/preservica_ingest.rb">app/models/preservica_ingest.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>4</td>
        <td>2</td>
        <td>0</td>
        <td>2</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#ec443c59eff4740389c7707223bc723458e6bbf3" class="src_link" title="app/models/pyramidal_tiff.rb">app/models/pyramidal_tiff.rb</a></td>
        <td class="red strong">41.67 %</td>
        <td>101</td>
        <td>60</td>
        <td>25</td>
        <td>35</td>
        <td>0.6</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#a2c95fa46c8da8e41ec1de35bf6d3d7d68c86e98" class="src_link" title="app/models/role.rb">app/models/role.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>16</td>
        <td>5</td>
        <td>5</td>
        <td>0</td>
        <td>1.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#560e1180e2f82ccecb0681b6560771c3f3e269a6" class="src_link" title="app/models/user.rb">app/models/user.rb</a></td>
        <td class="red strong">51.52 %</td>
        <td>59</td>
        <td>33</td>
        <td>17</td>
        <td>16</td>
        <td>0.5</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#9b6af46cad0b11874edc42f3e1fee1491d927bac" class="src_link" title="app/models/users_role.rb">app/models/users_role.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>6</td>
        <td>3</td>
        <td>3</td>
        <td>0</td>
        <td>1.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#beca431a1b978a79e1a5fb983977bc90b0fd081f" class="src_link" title="app/services/csv_row_parent_service.rb">app/services/csv_row_parent_service.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>120</td>
        <td>89</td>
        <td>0</td>
        <td>89</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#2e9c1bc41a59b291ee8cd660641cf8af86f2848e" class="src_link" title="app/services/fixture_parsing_service.rb">app/services/fixture_parsing_service.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>53</td>
        <td>43</td>
        <td>0</td>
        <td>43</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#95354c7249fb5fbc0510dae7d66278abfb8efd85" class="src_link" title="app/services/oid_minter_service.rb">app/services/oid_minter_service.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>20</td>
        <td>16</td>
        <td>0</td>
        <td>16</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#d6e6a1f0efeb8a61c5e20db59381325488d9819c" class="src_link" title="app/services/preservica_image_service.rb">app/services/preservica_image_service.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>82</td>
        <td>67</td>
        <td>0</td>
        <td>67</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#aaf21e66f2911224e6b5a537ad0b46830b8dc070" class="src_link" title="app/services/s3_service.rb">app/services/s3_service.rb</a></td>
        <td class="red strong">35.29 %</td>
        <td>115</td>
        <td>51</td>
        <td>18</td>
        <td>33</td>
        <td>0.4</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#cb328b0fce87a4f5bd88a3193411b09607011502" class="src_link" title="app/services/solr_service.rb">app/services/solr_service.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>111</td>
        <td>76</td>
        <td>0</td>
        <td>76</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#9ef4732ba0c2a9abbcd2e3571699773c650235a7" class="src_link" title="lib/download_images.rb">lib/download_images.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>13</td>
        <td>9</td>
        <td>0</td>
        <td>9</td>
        <td>0.0</td>
      </tr>
      
    </tbody>
  </table>
</div>


        
          <div class="file_list_container" id="Controllers">
  <h2>
    <span class="group_name">Controllers</span>
    (<span class="covered_percent"><span class="red">0.0%</span></span>
     covered at
     <span class="covered_strength">
       <span class="red">
         0.0
       </span>
    </span> hits/line)
  </h2>
  <a name="Controllers"></a>
  <div>
    <b>14</b> files in total.
    <b>653</b> relevant lines. 
    <span class="green"><b>0</b> lines covered</span> and
    <span class="red"><b>653</b> lines missed </span>
  </div>
  <table class="file_list">
    <thead>
      <tr>
        <th>File</th>
        <th>% covered</th>
        <th>Lines</th>
        <th>Relevant Lines</th>
        <th>Lines covered</th>
        <th>Lines missed</th>
        <th>Avg. Hits / Line</th>
      </tr>
    </thead>
    <tbody>
      
      <tr>
        <td class="strong"><a href="#dc5a61aa28018c8fefcdbdfe79b5842b90711183" class="src_link" title="app/controllers/admin_sets_controller.rb">app/controllers/admin_sets_controller.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>85</td>
        <td>58</td>
        <td>0</td>
        <td>58</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#8ed88db25718897073c08ec6242208933f54c0ae" class="src_link" title="app/controllers/application_controller.rb">app/controllers/application_controller.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>23</td>
        <td>18</td>
        <td>0</td>
        <td>18</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#a5b7656fa412c2da0c53d4969e6b972822d5e102" class="src_link" title="app/controllers/batch_processes_controller.rb">app/controllers/batch_processes_controller.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>139</td>
        <td>105</td>
        <td>0</td>
        <td>105</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#32dad210ba7097a9ef94e05d6c4d43976b741c10" class="src_link" title="app/controllers/child_objects_controller.rb">app/controllers/child_objects_controller.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>86</td>
        <td>60</td>
        <td>0</td>
        <td>60</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#be81abd7aafcec892e3433c0723be8e20ce93558" class="src_link" title="app/controllers/delayed_job_dashboard_controller.rb">app/controllers/delayed_job_dashboard_controller.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>51</td>
        <td>42</td>
        <td>0</td>
        <td>42</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#86669f013b49e9857ef8f780a58b0589ba6c1c17" class="src_link" title="app/controllers/management_controller.rb">app/controllers/management_controller.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>9</td>
        <td>6</td>
        <td>0</td>
        <td>6</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#602e7fc8db38513662cea28fc63a5353c90482e2" class="src_link" title="app/controllers/oid_minter_controller.rb">app/controllers/oid_minter_controller.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>26</td>
        <td>21</td>
        <td>0</td>
        <td>21</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#12bceef399a62054591d656c65bdec9aa5893f4b" class="src_link" title="app/controllers/omniauth_callbacks_controller.rb">app/controllers/omniauth_callbacks_controller.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>27</td>
        <td>22</td>
        <td>0</td>
        <td>22</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#13b1ee54980f70c8c502b35457131db12a0aa0d5" class="src_link" title="app/controllers/parent_objects_controller.rb">app/controllers/parent_objects_controller.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>227</td>
        <td>182</td>
        <td>0</td>
        <td>182</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#2470e440229660ee7a02fcd32fd4b764a937ec8c" class="src_link" title="app/controllers/preservica_ingests_controller.rb">app/controllers/preservica_ingests_controller.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>12</td>
        <td>8</td>
        <td>0</td>
        <td>8</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#b3d54654a3b0f970a1e457c5177fa414de360f76" class="src_link" title="app/controllers/redirected_parent_objects_controller.rb">app/controllers/redirected_parent_objects_controller.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>12</td>
        <td>8</td>
        <td>0</td>
        <td>8</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#b98eb997174d95750d66cce867c71ff35e2168ef" class="src_link" title="app/controllers/reoccurring_jobs_controller.rb">app/controllers/reoccurring_jobs_controller.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>43</td>
        <td>37</td>
        <td>0</td>
        <td>37</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#2110ca64f9e4dd2d8da54557150e92f5ee025757" class="src_link" title="app/controllers/roles_controller.rb">app/controllers/roles_controller.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>54</td>
        <td>41</td>
        <td>0</td>
        <td>41</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#b2da084446acfc25d80c1c77c21e843a2b54d9fe" class="src_link" title="app/controllers/users_controller.rb">app/controllers/users_controller.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>57</td>
        <td>45</td>
        <td>0</td>
        <td>45</td>
        <td>0.0</td>
      </tr>
      
    </tbody>
  </table>
</div>

        
          <div class="file_list_container" id="Models">
  <h2>
    <span class="group_name">Models</span>
    (<span class="covered_percent"><span class="red">22.62%</span></span>
     covered at
     <span class="covered_strength">
       <span class="red">
         0.36
       </span>
    </span> hits/line)
  </h2>
  <a name="Models"></a>
  <div>
    <b>38</b> files in total.
    <b>2241</b> relevant lines. 
    <span class="green"><b>507</b> lines covered</span> and
    <span class="red"><b>1734</b> lines missed </span>
  </div>
  <table class="file_list">
    <thead>
      <tr>
        <th>File</th>
        <th>% covered</th>
        <th>Lines</th>
        <th>Relevant Lines</th>
        <th>Lines covered</th>
        <th>Lines missed</th>
        <th>Avg. Hits / Line</th>
      </tr>
    </thead>
    <tbody>
      
      <tr>
        <td class="strong"><a href="#2bc6a29882573554f8cd99b81786a049ff6ab00f" class="src_link" title="app/models/ability.rb">app/models/ability.rb</a></td>
        <td class="red strong">62.07 %</td>
        <td>42</td>
        <td>29</td>
        <td>18</td>
        <td>11</td>
        <td>1.3</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#c6467705302b68c4ce333e6cd043ad3ae414ff1f" class="src_link" title="app/models/activity_stream_log.rb">app/models/activity_stream_log.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>4</td>
        <td>2</td>
        <td>0</td>
        <td>2</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#556aedd0f16de3642c6b8b641e775e0de01bcd0e" class="src_link" title="app/models/admin_set.rb">app/models/admin_set.rb</a></td>
        <td class="red strong">50.0 %</td>
        <td>49</td>
        <td>24</td>
        <td>12</td>
        <td>12</td>
        <td>0.5</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#dfd13e26507655b8df42f582f81d00f182338150" class="src_link" title="app/models/application_record.rb">app/models/application_record.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>5</td>
        <td>2</td>
        <td>2</td>
        <td>0</td>
        <td>1.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#6969bbe0a288d2999c0c9a14454002c3e70facca" class="src_link" title="app/models/batch_connection.rb">app/models/batch_connection.rb</a></td>
        <td class="green strong">90.91 %</td>
        <td>20</td>
        <td>11</td>
        <td>10</td>
        <td>1</td>
        <td>1.8</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#0ea6fbfd2150a7a9b66ada2ebffed2223b304922" class="src_link" title="app/models/batch_process.rb">app/models/batch_process.rb</a></td>
        <td class="red strong">32.61 %</td>
        <td>519</td>
        <td>276</td>
        <td>90</td>
        <td>186</td>
        <td>0.5</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#debc041c42081c545d1bd39008ac41e2079b88c0" class="src_link" title="app/models/child_object.rb">app/models/child_object.rb</a></td>
        <td class="red strong">51.46 %</td>
        <td>184</td>
        <td>103</td>
        <td>53</td>
        <td>50</td>
        <td>0.8</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#16c1f454139d1a65576bfb1dc4802cbe2cd697f6" class="src_link" title="app/models/concerns/csv_exportable.rb">app/models/concerns/csv_exportable.rb</a></td>
        <td class="red strong">17.33 %</td>
        <td>165</td>
        <td>75</td>
        <td>13</td>
        <td>62</td>
        <td>0.2</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#fe96f9aa7420c3ea3683a838f7e1f63fb71d691a" class="src_link" title="app/models/concerns/delayable.rb">app/models/concerns/delayable.rb</a></td>
        <td class="red strong">60.0 %</td>
        <td>31</td>
        <td>15</td>
        <td>9</td>
        <td>6</td>
        <td>0.6</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#c55180af3fbbab36c3e6e8a59acf943274554159" class="src_link" title="app/models/concerns/deletable.rb">app/models/concerns/deletable.rb</a></td>
        <td class="red strong">12.77 %</td>
        <td>72</td>
        <td>47</td>
        <td>6</td>
        <td>41</td>
        <td>0.1</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#76386b2d974d971e3b5944d17ce162a96780b006" class="src_link" title="app/models/concerns/digital_object_management.rb">app/models/concerns/digital_object_management.rb</a></td>
        <td class="red strong">23.81 %</td>
        <td>88</td>
        <td>42</td>
        <td>10</td>
        <td>32</td>
        <td>0.2</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#d77006734a3555089d3607e26d16fa3f9528f6a2" class="src_link" title="app/models/concerns/json_file.rb">app/models/concerns/json_file.rb</a></td>
        <td class="red strong">33.33 %</td>
        <td>14</td>
        <td>9</td>
        <td>3</td>
        <td>6</td>
        <td>0.3</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#7f33d24ee327110d70de1b9f242b18ddc6a48bc4" class="src_link" title="app/models/concerns/metadata_cloud_url_parsable.rb">app/models/concerns/metadata_cloud_url_parsable.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>72</td>
        <td>53</td>
        <td>0</td>
        <td>53</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#e642132fd520434fca52ab01599d232183b03325" class="src_link" title="app/models/concerns/pdf_representable.rb">app/models/concerns/pdf_representable.rb</a></td>
        <td class="red strong">23.53 %</td>
        <td>159</td>
        <td>85</td>
        <td>20</td>
        <td>65</td>
        <td>0.2</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#9a7ac4df9003ed8a0d3854f110e28104bbcc7433" class="src_link" title="app/models/concerns/reassociatable.rb">app/models/concerns/reassociatable.rb</a></td>
        <td class="red strong">17.17 %</td>
        <td>184</td>
        <td>99</td>
        <td>17</td>
        <td>82</td>
        <td>0.2</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#58fcc178fd8bc086d0ec70a6798877a60967897a" class="src_link" title="app/models/concerns/solr_indexable.rb">app/models/concerns/solr_indexable.rb</a></td>
        <td class="red strong">20.69 %</td>
        <td>315</td>
        <td>116</td>
        <td>24</td>
        <td>92</td>
        <td>0.2</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#d72c0d287c21dbbfdd9d2ae0ae4fba0ac23ff1c6" class="src_link" title="app/models/concerns/statable.rb">app/models/concerns/statable.rb</a></td>
        <td class="red strong">67.35 %</td>
        <td>89</td>
        <td>49</td>
        <td>33</td>
        <td>16</td>
        <td>3.2</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#17dd4de8907d0e7d2ea829106c22786317d9a4ac" class="src_link" title="app/models/concerns/updatable.rb">app/models/concerns/updatable.rb</a></td>
        <td class="red strong">17.02 %</td>
        <td>158</td>
        <td>94</td>
        <td>16</td>
        <td>78</td>
        <td>0.2</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#b29f6b11743643f08e90223b6137d0586cdcad06" class="src_link" title="app/models/csv_export.rb">app/models/csv_export.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>18</td>
        <td>12</td>
        <td>0</td>
        <td>12</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#bd4c3de8b94cf620d67bbbafe5778291d05f6708" class="src_link" title="app/models/dependent_object.rb">app/models/dependent_object.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>5</td>
        <td>3</td>
        <td>0</td>
        <td>3</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#fed2bf7deaf5ad819cffedd84d84c4d854d625e3" class="src_link" title="app/models/digital_object_json.rb">app/models/digital_object_json.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>5</td>
        <td>3</td>
        <td>0</td>
        <td>3</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#75c5cff65a276c77b06b336a2a6e27b0bf426700" class="src_link" title="app/models/iiif_presentation_v3.rb">app/models/iiif_presentation_v3.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>287</td>
        <td>244</td>
        <td>0</td>
        <td>244</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#32ad6ffafa6b2170e7cf39435bfbdda9738302e4" class="src_link" title="app/models/ingest_event.rb">app/models/ingest_event.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>5</td>
        <td>2</td>
        <td>2</td>
        <td>0</td>
        <td>1.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#9bac5f8e6b54f78003f46c1bee2737dd3822c9e7" class="src_link" title="app/models/metadata_source.rb">app/models/metadata_source.rb</a></td>
        <td class="red strong">28.26 %</td>
        <td>81</td>
        <td>46</td>
        <td>13</td>
        <td>33</td>
        <td>0.3</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#74605905f1f4acf88e5dba3bfbe0f6aa7d8a3ce6" class="src_link" title="app/models/mets_document.rb">app/models/mets_document.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>210</td>
        <td>167</td>
        <td>0</td>
        <td>167</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#d21dccce01f4efa2b8b0c4abad7be653aff59c1c" class="src_link" title="app/models/parent_object.rb">app/models/parent_object.rb</a></td>
        <td class="red strong">32.92 %</td>
        <td>580</td>
        <td>322</td>
        <td>106</td>
        <td>216</td>
        <td>0.5</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#3b71ddcd5b42257d88fd6ceee42a4b871c03c626" class="src_link" title="app/models/preservica/bitstream.rb">app/models/preservica/bitstream.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>55</td>
        <td>44</td>
        <td>0</td>
        <td>44</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#ae7510421e94bec401ed50776372f4ceb864d06c" class="src_link" title="app/models/preservica/content_object.rb">app/models/preservica/content_object.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>33</td>
        <td>25</td>
        <td>0</td>
        <td>25</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#44e92fa54168865d8cec4eaf51acbcbcdb7fb4e4" class="src_link" title="app/models/preservica/generation.rb">app/models/preservica/generation.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>52</td>
        <td>39</td>
        <td>0</td>
        <td>39</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#1e0b824c05175b548f70c6627d2947ed110a4d1e" class="src_link" title="app/models/preservica/information_object.rb">app/models/preservica/information_object.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>50</td>
        <td>37</td>
        <td>0</td>
        <td>37</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#8d8256e1054ecb4072be7cfe9a1188d15c086455" class="src_link" title="app/models/preservica/preservica_object.rb">app/models/preservica/preservica_object.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>6</td>
        <td>4</td>
        <td>0</td>
        <td>4</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#507d99957289d16a6198be29c92ae8fe39ec68bd" class="src_link" title="app/models/preservica/representation.rb">app/models/preservica/representation.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>45</td>
        <td>34</td>
        <td>0</td>
        <td>34</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#cb099bc2e3144de55713ebb89761069dc390b856" class="src_link" title="app/models/preservica/structural_object.rb">app/models/preservica/structural_object.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>33</td>
        <td>25</td>
        <td>0</td>
        <td>25</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#219b1961ac32c8c70d7f80b9ed3e0522956fd30b" class="src_link" title="app/models/preservica_ingest.rb">app/models/preservica_ingest.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>4</td>
        <td>2</td>
        <td>0</td>
        <td>2</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#ec443c59eff4740389c7707223bc723458e6bbf3" class="src_link" title="app/models/pyramidal_tiff.rb">app/models/pyramidal_tiff.rb</a></td>
        <td class="red strong">41.67 %</td>
        <td>101</td>
        <td>60</td>
        <td>25</td>
        <td>35</td>
        <td>0.6</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#a2c95fa46c8da8e41ec1de35bf6d3d7d68c86e98" class="src_link" title="app/models/role.rb">app/models/role.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>16</td>
        <td>5</td>
        <td>5</td>
        <td>0</td>
        <td>1.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#560e1180e2f82ccecb0681b6560771c3f3e269a6" class="src_link" title="app/models/user.rb">app/models/user.rb</a></td>
        <td class="red strong">51.52 %</td>
        <td>59</td>
        <td>33</td>
        <td>17</td>
        <td>16</td>
        <td>0.5</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#9b6af46cad0b11874edc42f3e1fee1491d927bac" class="src_link" title="app/models/users_role.rb">app/models/users_role.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>6</td>
        <td>3</td>
        <td>3</td>
        <td>0</td>
        <td>1.0</td>
      </tr>
      
    </tbody>
  </table>
</div>

        
          <div class="file_list_container" id="Mailers">
  <h2>
    <span class="group_name">Mailers</span>
    (<span class="covered_percent"><span class="red">0.0%</span></span>
     covered at
     <span class="covered_strength">
       <span class="red">
         0.0
       </span>
    </span> hits/line)
  </h2>
  <a name="Mailers"></a>
  <div>
    <b>1</b> files in total.
    <b>4</b> relevant lines. 
    <span class="green"><b>0</b> lines covered</span> and
    <span class="red"><b>4</b> lines missed </span>
  </div>
  <table class="file_list">
    <thead>
      <tr>
        <th>File</th>
        <th>% covered</th>
        <th>Lines</th>
        <th>Relevant Lines</th>
        <th>Lines covered</th>
        <th>Lines missed</th>
        <th>Avg. Hits / Line</th>
      </tr>
    </thead>
    <tbody>
      
      <tr>
        <td class="strong"><a href="#e13bed53c789df603fd18623c79d8a3e8b0b35e1" class="src_link" title="app/mailers/application_mailer.rb">app/mailers/application_mailer.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>6</td>
        <td>4</td>
        <td>0</td>
        <td>4</td>
        <td>0.0</td>
      </tr>
      
    </tbody>
  </table>
</div>

        
          <div class="file_list_container" id="Helpers">
  <h2>
    <span class="group_name">Helpers</span>
    (<span class="covered_percent"><span class="red">66.67%</span></span>
     covered at
     <span class="covered_strength">
       <span class="red">
         0.67
       </span>
    </span> hits/line)
  </h2>
  <a name="Helpers"></a>
  <div>
    <b>5</b> files in total.
    <b>9</b> relevant lines. 
    <span class="green"><b>6</b> lines covered</span> and
    <span class="red"><b>3</b> lines missed </span>
  </div>
  <table class="file_list">
    <thead>
      <tr>
        <th>File</th>
        <th>% covered</th>
        <th>Lines</th>
        <th>Relevant Lines</th>
        <th>Lines covered</th>
        <th>Lines missed</th>
        <th>Avg. Hits / Line</th>
      </tr>
    </thead>
    <tbody>
      
      <tr>
        <td class="strong"><a href="#2e1d9f7c0527ed02e6e63adb4a10eb13a082dc0b" class="src_link" title="app/helpers/admin_sets_helper.rb">app/helpers/admin_sets_helper.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>4</td>
        <td>1</td>
        <td>1</td>
        <td>0</td>
        <td>1.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#b8c6313cec3a31a656a56e8903d8f0039855c70e" class="src_link" title="app/helpers/application_helper.rb">app/helpers/application_helper.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>4</td>
        <td>1</td>
        <td>1</td>
        <td>0</td>
        <td>1.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#9fae1db60ceb079d12800e9ccb4b4b7f647d72a2" class="src_link" title="app/helpers/batch_processes_helper.rb">app/helpers/batch_processes_helper.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>4</td>
        <td>1</td>
        <td>1</td>
        <td>0</td>
        <td>1.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#c36acb1105b1855a660f08ca6bd73400bbb27f0c" class="src_link" title="app/helpers/json_helper.rb">app/helpers/json_helper.rb</a></td>
        <td class="red strong">40.0 %</td>
        <td>10</td>
        <td>5</td>
        <td>2</td>
        <td>3</td>
        <td>0.4</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#1f31b9ed0a13fcea49b6205180709c64cd8f1ed6" class="src_link" title="app/helpers/users_helper.rb">app/helpers/users_helper.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>4</td>
        <td>1</td>
        <td>1</td>
        <td>0</td>
        <td>1.0</td>
      </tr>
      
    </tbody>
  </table>
</div>

        
          <div class="file_list_container" id="Jobs">
  <h2>
    <span class="group_name">Jobs</span>
    (<span class="covered_percent"><span class="red">10.0%</span></span>
     covered at
     <span class="covered_strength">
       <span class="red">
         0.22
       </span>
    </span> hits/line)
  </h2>
  <a name="Jobs"></a>
  <div>
    <b>25</b> files in total.
    <b>350</b> relevant lines. 
    <span class="green"><b>35</b> lines covered</span> and
    <span class="red"><b>315</b> lines missed </span>
  </div>
  <table class="file_list">
    <thead>
      <tr>
        <th>File</th>
        <th>% covered</th>
        <th>Lines</th>
        <th>Relevant Lines</th>
        <th>Lines covered</th>
        <th>Lines missed</th>
        <th>Avg. Hits / Line</th>
      </tr>
    </thead>
    <tbody>
      
      <tr>
        <td class="strong"><a href="#9ccd2405b73add10fffff1231088f0218c1527d7" class="src_link" title="app/jobs/activity_stream_job.rb">app/jobs/activity_stream_job.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>9</td>
        <td>6</td>
        <td>0</td>
        <td>6</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#18561932383e1f412256f80a3e17be42ccacb2f2" class="src_link" title="app/jobs/activity_stream_manual_job.rb">app/jobs/activity_stream_manual_job.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>8</td>
        <td>5</td>
        <td>0</td>
        <td>5</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#1967e7cc678c57df31119f8de6b17d4923c2e716" class="src_link" title="app/jobs/add_extent_of_digitization_to_parent_objects_job.rb">app/jobs/add_extent_of_digitization_to_parent_objects_job.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>18</td>
        <td>12</td>
        <td>0</td>
        <td>12</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#09de5d45923ed6ab78a5c59ec4408d8989b99832" class="src_link" title="app/jobs/add_rights_to_parent_objects_job.rb">app/jobs/add_rights_to_parent_objects_job.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>18</td>
        <td>12</td>
        <td>0</td>
        <td>12</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#b8e823a678581b4974f1fbf215219e4072f84827" class="src_link" title="app/jobs/application_job.rb">app/jobs/application_job.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>19</td>
        <td>5</td>
        <td>5</td>
        <td>0</td>
        <td>5.8</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#3f7db38c3aa6c92ed23cfd45505377d634c185ab" class="src_link" title="app/jobs/create_child_oid_csv_job.rb">app/jobs/create_child_oid_csv_job.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>13</td>
        <td>9</td>
        <td>0</td>
        <td>9</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#d4369abb634be67a41b8d1d9f4db662d1ebc9688" class="src_link" title="app/jobs/create_new_parent_job.rb">app/jobs/create_new_parent_job.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>13</td>
        <td>9</td>
        <td>0</td>
        <td>9</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#ef79036001b6348d7f8a4a46e0c625a7b06638e0" class="src_link" title="app/jobs/create_parent_oid_csv_job.rb">app/jobs/create_parent_oid_csv_job.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>13</td>
        <td>9</td>
        <td>0</td>
        <td>9</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#00f43bcf15d0a7b8121f83196a2e08196673b3f4" class="src_link" title="app/jobs/delete_child_objects_job.rb">app/jobs/delete_child_objects_job.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>13</td>
        <td>9</td>
        <td>0</td>
        <td>9</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#7f44b38764737b76334454d73dab7400d185f019" class="src_link" title="app/jobs/delete_parent_objects_job.rb">app/jobs/delete_parent_objects_job.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>13</td>
        <td>9</td>
        <td>0</td>
        <td>9</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#c4a6cf0a70b3f70b69e5cb66ba44aa4dba5ad825" class="src_link" title="app/jobs/generate_manifest_job.rb">app/jobs/generate_manifest_job.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>39</td>
        <td>30</td>
        <td>0</td>
        <td>30</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#554c6a3cc942c45b3e1b21b8fb02696154f8760f" class="src_link" title="app/jobs/generate_output_csv_job.rb">app/jobs/generate_output_csv_job.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>16</td>
        <td>12</td>
        <td>0</td>
        <td>12</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#4a4152c875b27d060019fe9d0471187e1e3798c8" class="src_link" title="app/jobs/generate_pdf_job.rb">app/jobs/generate_pdf_job.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>20</td>
        <td>16</td>
        <td>0</td>
        <td>16</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#d0c9bb9e11fcc8d3fced176b27863c8b4160e903" class="src_link" title="app/jobs/generate_ptiff_job.rb">app/jobs/generate_ptiff_job.rb</a></td>
        <td class="green strong">94.44 %</td>
        <td>32</td>
        <td>18</td>
        <td>17</td>
        <td>1</td>
        <td>1.7</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#2c2beef6211dc4dcdd5daf24012f7eba325edeee" class="src_link" title="app/jobs/mets_directory_scan_job.rb">app/jobs/mets_directory_scan_job.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>15</td>
        <td>9</td>
        <td>0</td>
        <td>9</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#181fa2ed0eff77202ce9e6631074e6c7019f4972" class="src_link" title="app/jobs/reassociate_child_oids_job.rb">app/jobs/reassociate_child_oids_job.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>15</td>
        <td>11</td>
        <td>0</td>
        <td>11</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#a90d3e8237ae1f8a44fbec25625145591481dd69" class="src_link" title="app/jobs/recreate_child_oid_ptiffs_job.rb">app/jobs/recreate_child_oid_ptiffs_job.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>13</td>
        <td>6</td>
        <td>6</td>
        <td>0</td>
        <td>1.2</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#1a0b6fa617d46db6f36ca67868484a7310696d21" class="src_link" title="app/jobs/setup_metadata_job.rb">app/jobs/setup_metadata_job.rb</a></td>
        <td class="red strong">15.56 %</td>
        <td>78</td>
        <td>45</td>
        <td>7</td>
        <td>38</td>
        <td>0.2</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#bff33abfa2cd3d4ff9579bed67fd7658a433f230" class="src_link" title="app/jobs/solr_index_job.rb">app/jobs/solr_index_job.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>15</td>
        <td>11</td>
        <td>0</td>
        <td>11</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#f39b578c0e65f8a5635746d9c9b2cf46877775a7" class="src_link" title="app/jobs/solr_reindex_all_job.rb">app/jobs/solr_reindex_all_job.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>41</td>
        <td>34</td>
        <td>0</td>
        <td>34</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#bff22620fcd7d78d3ebe45eec5a5033ea81ee10f" class="src_link" title="app/jobs/sync_from_preservica_job.rb">app/jobs/sync_from_preservica_job.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>13</td>
        <td>9</td>
        <td>0</td>
        <td>9</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#398c813b0f9852f93a4ef2b46114d2e6f554f1e8" class="src_link" title="app/jobs/update_all_metadata_job.rb">app/jobs/update_all_metadata_job.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>20</td>
        <td>16</td>
        <td>0</td>
        <td>16</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#cafff5f7a86b313a057477058a0d8e6a097e2c01" class="src_link" title="app/jobs/update_fulltext_status_job.rb">app/jobs/update_fulltext_status_job.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>35</td>
        <td>29</td>
        <td>0</td>
        <td>29</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#9131f0b58ef225c8ce63dd0bab27666e4f679b9f" class="src_link" title="app/jobs/update_fulltext_status_sub_job.rb">app/jobs/update_fulltext_status_sub_job.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>13</td>
        <td>9</td>
        <td>0</td>
        <td>9</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#6a4ea372c493b55615de29240cb674138279e524" class="src_link" title="app/jobs/update_parent_objects_job.rb">app/jobs/update_parent_objects_job.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>15</td>
        <td>10</td>
        <td>0</td>
        <td>10</td>
        <td>0.0</td>
      </tr>
      
    </tbody>
  </table>
</div>

        
          <div class="file_list_container" id="Libraries">
  <h2>
    <span class="group_name">Libraries</span>
    (<span class="covered_percent"><span class="red">0.0%</span></span>
     covered at
     <span class="covered_strength">
       <span class="red">
         0.0
       </span>
    </span> hits/line)
  </h2>
  <a name="Libraries"></a>
  <div>
    <b>5</b> files in total.
    <b>291</b> relevant lines. 
    <span class="green"><b>0</b> lines covered</span> and
    <span class="red"><b>291</b> lines missed </span>
  </div>
  <table class="file_list">
    <thead>
      <tr>
        <th>File</th>
        <th>% covered</th>
        <th>Lines</th>
        <th>Relevant Lines</th>
        <th>Lines covered</th>
        <th>Lines missed</th>
        <th>Avg. Hits / Line</th>
      </tr>
    </thead>
    <tbody>
      
      <tr>
        <td class="strong"><a href="#837b27b23ebfac0de52918661fbd4a2bb7e3d0f6" class="src_link" title="app/lib/activity_stream_reader.rb">app/lib/activity_stream_reader.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>173</td>
        <td>117</td>
        <td>0</td>
        <td>117</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#91f31c564792f4b129d09f27064785deceaa3cb3" class="src_link" title="app/lib/json_validator.rb">app/lib/json_validator.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>12</td>
        <td>8</td>
        <td>0</td>
        <td>8</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#c369233904be2951c2d6753cb38a395bebf8e28f" class="src_link" title="app/lib/mets_directory_scanner.rb">app/lib/mets_directory_scanner.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>69</td>
        <td>50</td>
        <td>0</td>
        <td>50</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#61fe50cb81a005eca8666b96e4d768aceea104ec" class="src_link" title="app/lib/preservica_client.rb">app/lib/preservica_client.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>136</td>
        <td>107</td>
        <td>0</td>
        <td>107</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#9ef4732ba0c2a9abbcd2e3571699773c650235a7" class="src_link" title="lib/download_images.rb">lib/download_images.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>13</td>
        <td>9</td>
        <td>0</td>
        <td>9</td>
        <td>0.0</td>
      </tr>
      
    </tbody>
  </table>
</div>

        
          <div class="file_list_container" id="Ungrouped">
  <h2>
    <span class="group_name">Ungrouped</span>
    (<span class="covered_percent"><span class="red">2.34%</span></span>
     covered at
     <span class="covered_strength">
       <span class="red">
         0.03
       </span>
    </span> hits/line)
  </h2>
  <a name="Ungrouped"></a>
  <div>
    <b>18</b> files in total.
    <b>768</b> relevant lines. 
    <span class="green"><b>18</b> lines covered</span> and
    <span class="red"><b>750</b> lines missed </span>
  </div>
  <table class="file_list">
    <thead>
      <tr>
        <th>File</th>
        <th>% covered</th>
        <th>Lines</th>
        <th>Relevant Lines</th>
        <th>Lines covered</th>
        <th>Lines missed</th>
        <th>Avg. Hits / Line</th>
      </tr>
    </thead>
    <tbody>
      
      <tr>
        <td class="strong"><a href="#d90f43a456e9317fb3609a66a12474a3478ffc70" class="src_link" title="app/channels/application_cable/channel.rb">app/channels/application_cable/channel.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>6</td>
        <td>4</td>
        <td>0</td>
        <td>4</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#45cb0c041c58164965a935e2deda0967365ef722" class="src_link" title="app/channels/application_cable/connection.rb">app/channels/application_cable/connection.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>6</td>
        <td>4</td>
        <td>0</td>
        <td>4</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#36a66f34bdaece141e7dbc8e8cc2df572e4880ca" class="src_link" title="app/datatables/admin_set_datatable.rb">app/datatables/admin_set_datatable.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>43</td>
        <td>33</td>
        <td>0</td>
        <td>33</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#0e7f298e66f63a5ef7cb9b567e186f660ce5fb85" class="src_link" title="app/datatables/batch_process_datatable.rb">app/datatables/batch_process_datatable.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>48</td>
        <td>37</td>
        <td>0</td>
        <td>37</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#e7ee03a5db248076edc0bb015fea2ee1e2595a06" class="src_link" title="app/datatables/batch_process_detail_datatable.rb">app/datatables/batch_process_detail_datatable.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>42</td>
        <td>31</td>
        <td>0</td>
        <td>31</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#e99446c7b559f6d0219e36fbc04504ef821ded02" class="src_link" title="app/datatables/batch_process_parent_datatable.rb">app/datatables/batch_process_parent_datatable.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>39</td>
        <td>29</td>
        <td>0</td>
        <td>29</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#77653a807a5304165be2cf68ad6c248b6cc99c7f" class="src_link" title="app/datatables/child_object_datatable.rb">app/datatables/child_object_datatable.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>71</td>
        <td>57</td>
        <td>0</td>
        <td>57</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#484feee8fde92adcbffcb2e3455853e53b104eb3" class="src_link" title="app/datatables/parent_object_datatable.rb">app/datatables/parent_object_datatable.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>93</td>
        <td>78</td>
        <td>0</td>
        <td>78</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#8bb3c008a511724983479744eec825f3ea67ee7e" class="src_link" title="app/datatables/preservica_ingest_datatable.rb">app/datatables/preservica_ingest_datatable.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>43</td>
        <td>34</td>
        <td>0</td>
        <td>34</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#22bebc02d913dd3afcb6c9101215cb4300073835" class="src_link" title="app/datatables/redirected_parent_object_datatable.rb">app/datatables/redirected_parent_object_datatable.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>61</td>
        <td>46</td>
        <td>0</td>
        <td>46</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#f5dba6404cb6d24f2e5e0c2c2e91c05edecd093f" class="src_link" title="app/datatables/reoccurring_job_datatable.rb">app/datatables/reoccurring_job_datatable.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>46</td>
        <td>35</td>
        <td>0</td>
        <td>35</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#b28c03fae835fbba1b3590ad329265f41d545298" class="src_link" title="app/datatables/user_datatable.rb">app/datatables/user_datatable.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>48</td>
        <td>38</td>
        <td>0</td>
        <td>38</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#beca431a1b978a79e1a5fb983977bc90b0fd081f" class="src_link" title="app/services/csv_row_parent_service.rb">app/services/csv_row_parent_service.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>120</td>
        <td>89</td>
        <td>0</td>
        <td>89</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#2e9c1bc41a59b291ee8cd660641cf8af86f2848e" class="src_link" title="app/services/fixture_parsing_service.rb">app/services/fixture_parsing_service.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>53</td>
        <td>43</td>
        <td>0</td>
        <td>43</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#95354c7249fb5fbc0510dae7d66278abfb8efd85" class="src_link" title="app/services/oid_minter_service.rb">app/services/oid_minter_service.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>20</td>
        <td>16</td>
        <td>0</td>
        <td>16</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#d6e6a1f0efeb8a61c5e20db59381325488d9819c" class="src_link" title="app/services/preservica_image_service.rb">app/services/preservica_image_service.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>82</td>
        <td>67</td>
        <td>0</td>
        <td>67</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#aaf21e66f2911224e6b5a537ad0b46830b8dc070" class="src_link" title="app/services/s3_service.rb">app/services/s3_service.rb</a></td>
        <td class="red strong">35.29 %</td>
        <td>115</td>
        <td>51</td>
        <td>18</td>
        <td>33</td>
        <td>0.4</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#cb328b0fce87a4f5bd88a3193411b09607011502" class="src_link" title="app/services/solr_service.rb">app/services/solr_service.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>111</td>
        <td>76</td>
        <td>0</td>
        <td>76</td>
        <td>0.0</td>
      </tr>
      
    </tbody>
  </table>
</div>

        
      </div>
    
      <div id="footer">
        Generated by <a href="http://github.com/colszowka/simplecov">simplecov</a> v0.16.1 
        and simplecov-html v0.10.2<br/>
        using RSpec
      </div>
    
      <div class="source_files">
      
        <div class="source_table" id="d90f43a456e9317fb3609a66a12474a3478ffc70">
  <div class="header">
    <h3>app/channels/application_cable/channel.rb</h3>
    <h4><span class="red">0.0 %</span> covered</h4>
    <div>
      <b>4</b> relevant lines. 
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>4</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># frozen_string_literal: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="3">
          
          
          <code class="ruby">module ApplicationCable</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="4">
          
          
          <code class="ruby">  class Channel &lt; ActionCable::Channel::Base</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="5">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="6">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="45cb0c041c58164965a935e2deda0967365ef722">
  <div class="header">
    <h3>app/channels/application_cable/connection.rb</h3>
    <h4><span class="red">0.0 %</span> covered</h4>
    <div>
      <b>4</b> relevant lines. 
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>4</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># frozen_string_literal: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="3">
          
          
          <code class="ruby">module ApplicationCable</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="4">
          
          
          <code class="ruby">  class Connection &lt; ActionCable::Connection::Base</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="5">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="6">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="dc5a61aa28018c8fefcdbdfe79b5842b90711183">
  <div class="header">
    <h3>app/controllers/admin_sets_controller.rb</h3>
    <h4><span class="red">0.0 %</span> covered</h4>
    <div>
      <b>58</b> relevant lines. 
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>58</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># frozen_string_literal: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="3">
          
          
          <code class="ruby">class AdminSetsController &lt; ApplicationController</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="4">
          
          
          <code class="ruby">  load_and_authorize_resource</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="5">
          
          
          <code class="ruby">  before_action :set_admin_set, only: [:show, :edit, :update, :destroy]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">  # GET /admin_sets</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">  # GET /admin_sets.json</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="9">
          
          
          <code class="ruby">  def index</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">    @admin_sets = AdminSet.all</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="11">
          
          
          <code class="ruby">    respond_to do |format|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">      format.html</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby">      format.json { render json: AdminSetDatatable.new(params, view_context: view_context) }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="14">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="15">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">  # GET /admin_sets/1</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">  # GET /admin_sets/1.json</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="19">
          
          
          <code class="ruby">  def show</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="20">
          
          
          <code class="ruby">    respond_to do |format|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="21">
          
          
          <code class="ruby">      format.html</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="22">
          
          
          <code class="ruby">      format.json { render json: BatchProcessDetailDatatable.new(params, view_context: view_context) }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="23">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="24">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">  # GET /admin_sets/new</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="27">
          
          
          <code class="ruby">  def new</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="28">
          
          
          <code class="ruby">    @admin_set = AdminSet.new</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="29">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">  # GET /admin_sets/1/edit</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="32">
          
          
          <code class="ruby">  def edit; end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">  # POST /admin_sets</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">  # POST /admin_sets.json</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="36">
          
          
          <code class="ruby">  def create</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="37">
          
          
          <code class="ruby">    @admin_set = AdminSet.new(admin_set_params)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="39">
          
          
          <code class="ruby">    respond_to do |format|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="40">
          
          
          <code class="ruby">      if @admin_set.save</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="41">
          
          
          <code class="ruby">        format.html { redirect_to @admin_set, notice: &#39;Admin set was successfully created.&#39; }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="42">
          
          
          <code class="ruby">        format.json { render :show, status: :created, location: @admin_set }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="43">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="44">
          
          
          <code class="ruby">        format.html { render :new }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="45">
          
          
          <code class="ruby">        format.json { render json: @admin_set.errors, status: :unprocessable_entity }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="46">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="47">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="48">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby">  # PATCH/PUT /admin_sets/1</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby">  # PATCH/PUT /admin_sets/1.json</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="52">
          
          
          <code class="ruby">  def update</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="53">
          
          
          <code class="ruby">    respond_to do |format|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="54">
          
          
          <code class="ruby">      if @admin_set.update(admin_set_params)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="55">
          
          
          <code class="ruby">        format.html { redirect_to @admin_set, notice: &#39;Admin set was successfully updated.&#39; }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="56">
          
          
          <code class="ruby">        format.json { render :show, status: :ok, location: @admin_set }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="57">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="58">
          
          
          <code class="ruby">        format.html { render :edit }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="59">
          
          
          <code class="ruby">        format.json { render json: @admin_set.errors, status: :unprocessable_entity }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="60">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="61">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="62">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby">  # DELETE /admin_sets/1</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby">  # DELETE /admin_sets/1.json</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="66">
          
          
          <code class="ruby">  def destroy</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="67">
          
          
          <code class="ruby">    @admin_set.destroy</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="68">
          
          
          <code class="ruby">    respond_to do |format|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="69">
          
          
          <code class="ruby">      format.html { redirect_to admin_sets_url, notice: &#39;Admin set was successfully destroyed.&#39; }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="70">
          
          
          <code class="ruby">      format.json { head :no_content }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="71">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="72">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="74">
          
          
          <code class="ruby">  private</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="75">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="76">
          
          
          <code class="ruby">    # Use callbacks to share common setup or constraints between actions.</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="77">
          
          
          <code class="ruby">    def set_admin_set</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="78">
          
          
          <code class="ruby">      @admin_set = AdminSet.find(params[:id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="79">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="81">
          
          
          <code class="ruby">    # Only allow a list of trusted parameters through.</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="82">
          
          
          <code class="ruby">    def admin_set_params</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="83">
          
          
          <code class="ruby">      params.require(:admin_set).permit(:key, :label, :homepage, :summary)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="84">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="85">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="8ed88db25718897073c08ec6242208933f54c0ae">
  <div class="header">
    <h3>app/controllers/application_controller.rb</h3>
    <h4><span class="red">0.0 %</span> covered</h4>
    <div>
      <b>18</b> relevant lines. 
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>18</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># frozen_string_literal: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="3">
          
          
          <code class="ruby">class ApplicationController &lt; ActionController::Base</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="4">
          
          
          <code class="ruby">  before_action :authenticate_user!</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="5">
          
          
          <code class="ruby">  rescue_from CanCan::AccessDenied do |exception|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="6">
          
          
          <code class="ruby">    @error_message = exception.message</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="7">
          
          
          <code class="ruby">    render plain: &quot;Access denied&quot;, status: 401</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="8">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">  def access_denied</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="11">
          
          
          <code class="ruby">    render(plain: &#39;Access denied&#39;, status: 401)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="14">
          
          
          <code class="ruby">  protected</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="16">
          
          
          <code class="ruby">    def authenticate_user!</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="17">
          
          
          <code class="ruby">      if user_signed_in?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">        super</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="19">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="20">
          
          
          <code class="ruby">        redirect_to user_cas_omniauth_authorize_path</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="21">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="22">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="23">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="a5b7656fa412c2da0c53d4969e6b972822d5e102">
  <div class="header">
    <h3>app/controllers/batch_processes_controller.rb</h3>
    <h4><span class="red">0.0 %</span> covered</h4>
    <div>
      <b>105</b> relevant lines. 
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>105</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># frozen_string_literal: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="3">
          
          
          <code class="ruby">class BatchProcessesController &lt; ApplicationController</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="4">
          
          
          <code class="ruby">  before_action :set_batch_process, only: [:show, :edit, :update, :destroy, :download, :download_csv, :download_xml, :download_created, :show_parent, :show_child]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="5">
          
          
          <code class="ruby">  before_action :set_parent_object, only: [:show_parent, :show_child]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="6">
          
          
          <code class="ruby">  before_action :find_notes, only: [:show_parent]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="7">
          
          
          <code class="ruby">  before_action :latest_failure, only: [:show_parent]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="8">
          
          
          <code class="ruby">  before_action :set_child_object, only: [:show_child]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">  def index</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="11">
          
          
          <code class="ruby">    @batch_process = BatchProcess.new</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">    # force user to choose action in form</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby">    @batch_process.batch_action = nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="15">
          
          
          <code class="ruby">    respond_to do |format|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="16">
          
          
          <code class="ruby">      format.html</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="17">
          
          
          <code class="ruby">      format.json { render json: BatchProcessDatatable.new(params, view_context: view_context) }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="19">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="21">
          
          
          <code class="ruby">  def show</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="22">
          
          
          <code class="ruby">    respond_to do |format|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="23">
          
          
          <code class="ruby">      format.html</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="24">
          
          
          <code class="ruby">      format.json { render json: BatchProcessDetailDatatable.new(params, view_context: view_context) }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="25">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="26">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="28">
          
          
          <code class="ruby">  def new</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="29">
          
          
          <code class="ruby">    @batch_process = BatchProcess.new</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="30">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="32">
          
          
          <code class="ruby">  def create</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="33">
          
          
          <code class="ruby">    @batch_process = BatchProcess.new(batch_process_params.merge(user: current_user))</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="34">
          
          
          <code class="ruby">    respond_to do |format|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="35">
          
          
          <code class="ruby">      if @batch_process.save</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="36">
          
          
          <code class="ruby">        format.html do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="37">
          
          
          <code class="ruby">          redirect_to batch_processes_path,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="38">
          
          
          <code class="ruby">                      notice: &quot;Your job is queued for processing in the background&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="39">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="40">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="41">
          
          
          <code class="ruby">        format.html { render :new }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="42">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="43">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="44">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="46">
          
          
          <code class="ruby">  def download</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="47">
          
          
          <code class="ruby">    @batch_process.csv.nil? ? download_xml : download_csv</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="48">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="50">
          
          
          <code class="ruby">  def download_template</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="51">
          
          
          <code class="ruby">    batch_action = params[:batch_action]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="53">
          
          
          <code class="ruby">    begin</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="55">
          
          
          <code class="ruby">      csv_template = BatchProcess.csv_template(batch_action)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby">      # Add BOM to force Excel to open correctly</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="58">
          
          
          <code class="ruby">      send_data &quot;\xEF\xBB\xBF&quot; + csv_template,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="59">
          
          
          <code class="ruby">                type: &#39;text/csv; charset=utf-8; header=present&#39;,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="60">
          
          
          <code class="ruby">                disposition: &quot;attachment; filename=#{batch_action.parameterize.underscore + &#39;_template.csv&#39;}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="61">
          
          
          <code class="ruby">    rescue</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="62">
          
          
          <code class="ruby">      redirect_to batch_processes_path</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="63">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="64">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="66">
          
          
          <code class="ruby">  def export_parent_objects</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby">    # RETURNS ADMIN SET KEY:</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="68">
          
          
          <code class="ruby">    admin_set = params.dig(:admin_set)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby">    # RETURNS ADMIN SET ID FOR REDIRECTING</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="71">
          
          
          <code class="ruby">    admin_set_id = params.dig(:admin_set_id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="72">
          
          
          <code class="ruby">    redirect_to admin_set_path(admin_set_id), notice: &quot;CSV is being generated. Please visit the Batch Process page to download.&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="74">
          
          
          <code class="ruby">    batch_process = BatchProcess.new(batch_action: &#39;export all parent objects by admin set&#39;, user: current_user, file_name: &quot;#{admin_set}_export.csv&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="75">
          
          
          <code class="ruby">    batch_process.save</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="76">
          
          
          <code class="ruby">    CreateParentOidCsvJob.perform_later(batch_process, *admin_set_id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="77">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="79">
          
          
          <code class="ruby">  def download_csv</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby">    # Add BOM to force Excel to open correctly</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="81">
          
          
          <code class="ruby">    send_data &quot;\xEF\xBB\xBF&quot; + @batch_process.csv,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="82">
          
          
          <code class="ruby">              type: &#39;text/csv; charset=utf-8; header=present&#39;,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="83">
          
          
          <code class="ruby">              disposition: &quot;attachment; filename=#{@batch_process.file_name}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="84">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="85">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="86">
          
          
          <code class="ruby">  def download_xml</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="87">
          
          
          <code class="ruby">    send_data @batch_process.mets_xml,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="88">
          
          
          <code class="ruby">              type: &#39;application/xml&#39;,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="89">
          
          
          <code class="ruby">              disposition: &quot;attachment; filename=#{@batch_process.file_name}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="90">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="91">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="92">
          
          
          <code class="ruby">  def show_parent</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="93">
          
          
          <code class="ruby">    respond_to do |format|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="94">
          
          
          <code class="ruby">      format.html</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="95">
          
          
          <code class="ruby">      format.json { render json: BatchProcessParentDatatable.new(params, view_context: view_context, batch_process: @batch_process) }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="96">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="97">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="98">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="99">
          
          
          <code class="ruby">  def show_child; end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="100">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="101">
          
          
          <code class="ruby">  # This is temporary for testing until we enable scheduling</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="102">
          
          
          <code class="ruby">  def trigger_mets_scan</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="103">
          
          
          <code class="ruby">    authorize!(:trigger_mets_scan, ParentObject)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="104">
          
          
          <code class="ruby">    MetsDirectoryScanJob.perform_later</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="105">
          
          
          <code class="ruby">    respond_to do |format|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="106">
          
          
          <code class="ruby">      format.html { redirect_to batch_processes_path, notice: &#39;Mets scan has been triggered.&#39; }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="107">
          
          
          <code class="ruby">      format.json { head :no_content }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="108">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="109">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="110">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="111">
          
          
          <code class="ruby">  private</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="112">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="113">
          
          
          <code class="ruby">    def set_batch_process</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="114">
          
          
          <code class="ruby">      @batch_process = BatchProcess.find(params[:id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="115">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="116">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="117">
          
          
          <code class="ruby">    def set_parent_object</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="118">
          
          
          <code class="ruby">      @parent_object = ParentObject.find_by(oid: params[:oid])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="119">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="120">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="121">
          
          
          <code class="ruby">    def set_child_object</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="122">
          
          
          <code class="ruby">      @child_object = ChildObject.find(params[:child_oid])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="123">
          
          
          <code class="ruby">      @notes = @child_object.notes_for_batch_process(@batch_process)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="124">
          
          
          <code class="ruby">      # TODO: Find failure related only to child object?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="125">
          
          
          <code class="ruby">      @failure = @child_object.latest_failure(@batch_process)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="126">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="127">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="128">
          
          
          <code class="ruby">    def find_notes</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="129">
          
          
          <code class="ruby">      @notes = @parent_object.notes_for_batch_process(@batch_process) if @parent_object</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="130">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="131">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="132">
          
          
          <code class="ruby">    def latest_failure</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="133">
          
          
          <code class="ruby">      @latest_failure = @parent_object.latest_failure(@batch_process) if @parent_object</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="134">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="135">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="136">
          
          
          <code class="ruby">    def batch_process_params</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="137">
          
          
          <code class="ruby">      params.require(:batch_process).permit(:file, :batch_action)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="138">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="139">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="32dad210ba7097a9ef94e05d6c4d43976b741c10">
  <div class="header">
    <h3>app/controllers/child_objects_controller.rb</h3>
    <h4><span class="red">0.0 %</span> covered</h4>
    <div>
      <b>60</b> relevant lines. 
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>60</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># frozen_string_literal: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="3">
          
          
          <code class="ruby">class ChildObjectsController &lt; ApplicationController</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="4">
          
          
          <code class="ruby">  before_action :set_child_object, only: [:show, :edit, :update, :destroy]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="5">
          
          
          <code class="ruby">  before_action :set_paper_trail_whodunnit</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="6">
          
          
          <code class="ruby">  load_and_authorize_resource except: [:new, :create]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">  # GET /child_objects</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">  # GET /child_objects.json</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">  def index</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="11">
          
          
          <code class="ruby">    respond_to do |format|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">      format.html</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby">      format.json { render json: ChildObjectDatatable.new(params, view_context: view_context, current_ability: current_ability) }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="14">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="15">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">  # GET /child_objects/1</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">  # GET /child_objects/1.json</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="19">
          
          
          <code class="ruby">  def show; end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">  # GET /child_objects/new</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="22">
          
          
          <code class="ruby">  def new</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="23">
          
          
          <code class="ruby">    @child_object = ChildObject.new</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="24">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">  # GET /child_objects/1/edit</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="27">
          
          
          <code class="ruby">  def edit; end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">  # POST /child_objects</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">  # POST /child_objects.json</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="31">
          
          
          <code class="ruby">  def create</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="32">
          
          
          <code class="ruby">    @child_object = ChildObject.new(child_object_params)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="33">
          
          
          <code class="ruby">    authorize!(:create, @child_object)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="34">
          
          
          <code class="ruby">    respond_to do |format|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="35">
          
          
          <code class="ruby">      if @child_object.save</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="36">
          
          
          <code class="ruby">        format.html { redirect_to @child_object, notice: &#39;Child object was successfully created.&#39; }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="37">
          
          
          <code class="ruby">        format.json { render :show, status: :created, location: @child_object }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="38">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="39">
          
          
          <code class="ruby">        format.html { render :new }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="40">
          
          
          <code class="ruby">        format.json { render json: @child_object.errors, status: :unprocessable_entity }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="41">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="42">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="43">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby">  # PATCH/PUT /child_objects/1</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby">  # PATCH/PUT /child_objects/1.json</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="47">
          
          
          <code class="ruby">  def update</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="48">
          
          
          <code class="ruby">    respond_to do |format|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="49">
          
          
          <code class="ruby">      if @child_object.update(child_object_params)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="50">
          
          
          <code class="ruby">        format.html { redirect_to @child_object, notice: &#39;Child object was successfully updated.&#39; }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="51">
          
          
          <code class="ruby">        format.json { render :show, status: :ok, location: @child_object }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="52">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="53">
          
          
          <code class="ruby">        format.html { render :edit }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="54">
          
          
          <code class="ruby">        format.json { render json: @child_object.errors, status: :unprocessable_entity }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="55">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="56">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="57">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby">  # DELETE /child_objects/1</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby">  # DELETE /child_objects/1.json</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="61">
          
          
          <code class="ruby">  def destroy</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="62">
          
          
          <code class="ruby">    @child_object.destroy</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="63">
          
          
          <code class="ruby">    respond_to do |format|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="64">
          
          
          <code class="ruby">      format.html { redirect_to child_objects_url, notice: &#39;Child object was successfully destroyed.&#39; }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="65">
          
          
          <code class="ruby">      format.json { head :no_content }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="66">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="67">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="69">
          
          
          <code class="ruby">  private</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby">    # Use callbacks to share common setup or constraints between actions.</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="72">
          
          
          <code class="ruby">    def set_child_object</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="73">
          
          
          <code class="ruby">      @child_object = ChildObject.find(params[:id]) if params[:id]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="74">
          
          
          <code class="ruby">    rescue ActiveRecord::RecordNotFound</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="75">
          
          
          <code class="ruby">      respond_to do |format|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="76">
          
          
          <code class="ruby">        format.html { redirect_to child_objects_url, notice: &quot;Child object, oid: #{params[:id]}, was not found in local database.&quot; }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="77">
          
          
          <code class="ruby">        format.json { head :no_content }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="78">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="79">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="81">
          
          
          <code class="ruby">    # Only allow a list of trusted parameters through.</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="82">
          
          
          <code class="ruby">    def child_object_params</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="83">
          
          
          <code class="ruby">      params.require(:child_object).permit(:oid, :caption, :label, :width, :height, :order, :viewing_hint,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="84">
          
          
          <code class="ruby">                                           :parent_object_oid, :preservica_content_object_uri, :preservica_generation_uri, :preservica_bitstream_uri)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="85">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="86">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="be81abd7aafcec892e3433c0723be8e20ce93558">
  <div class="header">
    <h3>app/controllers/delayed_job_dashboard_controller.rb</h3>
    <h4><span class="red">0.0 %</span> covered</h4>
    <div>
      <b>42</b> relevant lines. 
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>42</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># frozen_string_literal: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby">#</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="4">
          
          
          <code class="ruby">class DelayedJobDashboardController &lt; ApplicationController</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="5">
          
          
          <code class="ruby">  def index</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="6">
          
          
          <code class="ruby">    res = Delayed::Job.connection.execute(&quot;select count(*) as total,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="7">
          
          
          <code class="ruby">              sum(case when locked_at is not null and failed_at is null then 1 else 0 end) as working,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="8">
          
          
          <code class="ruby">              sum(case when last_error is not null then 1 else 0 end) as failed,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="9">
          
          
          <code class="ruby">              sum(case when attempts=0 and locked_at is null then 1 else 0 end) as pending</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">              from delayed_jobs&quot;).first</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="11">
          
          
          <code class="ruby">    @all_jobs_count = res[&#39;total&#39;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">    @working = res[&#39;working&#39;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby">    @failed = res[&#39;failed&#39;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="14">
          
          
          <code class="ruby">    @pending = res[&#39;pending&#39;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="15">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="17">
          
          
          <code class="ruby">  def failed_jobs</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">    @jobs = Delayed::Job.page(params[:page]).where(&quot;last_error is not null&quot;).order(&quot;run_at desc&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="19">
          
          
          <code class="ruby">    @job_types = &quot;Failed&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="20">
          
          
          <code class="ruby">    render :jobs</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="21">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="23">
          
          
          <code class="ruby">  def working_jobs</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="24">
          
          
          <code class="ruby">    @jobs = Delayed::Job.page(params[:page]).where(&quot;locked_at is not null and failed_at is null&quot;).order(&quot;run_at desc&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="25">
          
          
          <code class="ruby">    @job_types = &quot;Working&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="26">
          
          
          <code class="ruby">    render :jobs</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="27">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="29">
          
          
          <code class="ruby">  def pending_jobs</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="30">
          
          
          <code class="ruby">    @jobs = Delayed::Job.page(params[:page]).where(&quot;attempts=0 and locked_at is null&quot;).order(&quot;run_at desc&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="31">
          
          
          <code class="ruby">    @job_types = &quot;Pending&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="32">
          
          
          <code class="ruby">    render :jobs</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="33">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="35">
          
          
          <code class="ruby">  def show</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="36">
          
          
          <code class="ruby">    @job = Delayed::Job.find(params[:id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="37">
          
          
          <code class="ruby">    @handler = YAML.safe_load(@job.handler, [ActiveJob::QueueAdapters::DelayedJobAdapter::JobWrapper])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="38">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="40">
          
          
          <code class="ruby">  def delete_job</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="41">
          
          
          <code class="ruby">    Delayed::Job.find(params[:id]).destroy</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="42">
          
          
          <code class="ruby">    flash[:notice] = &quot;Job #{params[:id]} deleted.&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="43">
          
          
          <code class="ruby">    redirect_to dashboard_path</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="44">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="46">
          
          
          <code class="ruby">  def requeue</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="47">
          
          
          <code class="ruby">    Delayed::Job.find(params[:id]).update!(run_at: Time.now.utc, last_error: nil)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="48">
          
          
          <code class="ruby">    flash[:notice] = &quot;Job was re-queued&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="49">
          
          
          <code class="ruby">    redirect_to show_job_path(params[:id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="50">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="51">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="86669f013b49e9857ef8f780a58b0589ba6c1c17">
  <div class="header">
    <h3>app/controllers/management_controller.rb</h3>
    <h4><span class="red">0.0 %</span> covered</h4>
    <div>
      <b>6</b> relevant lines. 
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>6</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># frozen_string_literal: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="3">
          
          
          <code class="ruby">class ManagementController &lt; ApplicationController</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="4">
          
          
          <code class="ruby">  skip_before_action :authenticate_user!</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="6">
          
          
          <code class="ruby">  def index</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="7">
          
          
          <code class="ruby">    @batch_process = BatchProcess.new</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="8">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="9">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="602e7fc8db38513662cea28fc63a5353c90482e2">
  <div class="header">
    <h3>app/controllers/oid_minter_controller.rb</h3>
    <h4><span class="red">0.0 %</span> covered</h4>
    <div>
      <b>21</b> relevant lines. 
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>21</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># frozen_string_literal: true</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="2">
          
          
          <code class="ruby">class OidMinterController &lt; ActionController::Base</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby">  # Allowing unauthenticated access</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby">  # before_action :authenticate_user!</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="6">
          
          
          <code class="ruby">  def generate_oids</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="7">
          
          
          <code class="ruby">    number = params[:number]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="8">
          
          
          <code class="ruby">    number ||= 1</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="9">
          
          
          <code class="ruby">    if an_integer?(number)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">      oids = OidMinterService.generate_oids(number.to_i)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="11">
          
          
          <code class="ruby">      respond_to do |format|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">        format.json { render json: { oids: oids } }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby">        format.text { render plain: oids.join(&quot;\n&quot;) }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="14">
          
          
          <code class="ruby">        format.any  { render plain: &quot;Please request text/plain or application/json content types.&quot;, status: :not_acceptable }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="15">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="16">
          
          
          <code class="ruby">      oid_request_info = { ip_address: request.remote_ip.to_s, oids: oids.to_s }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="17">
          
          
          <code class="ruby">      Rails.logger.info(&quot;OIDs Created: #{oid_request_info.to_json}&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="19">
          
          
          <code class="ruby">      render plain: &quot;Invalid request, please supply an integer value&quot;, status: :bad_request</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="20">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="21">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="23">
          
          
          <code class="ruby">  def an_integer?(number)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="24">
          
          
          <code class="ruby">    number.to_s !~ /\D/</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="25">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="26">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="12bceef399a62054591d656c65bdec9aa5893f4b">
  <div class="header">
    <h3>app/controllers/omniauth_callbacks_controller.rb</h3>
    <h4><span class="red">0.0 %</span> covered</h4>
    <div>
      <b>22</b> relevant lines. 
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>22</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># frozen_string_literal: true</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="2">
          
          
          <code class="ruby">class OmniauthCallbacksController &lt; Devise::OmniauthCallbacksController</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="3">
          
          
          <code class="ruby">  prepend_before_action { request.env[&quot;devise.skip_timeout&quot;] = true }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="4">
          
          
          <code class="ruby">  skip_before_action :authenticate_user!</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="6">
          
          
          <code class="ruby">  def auth</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="7">
          
          
          <code class="ruby">    request.env[&#39;omniauth.auth&#39;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="8">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">  def cas</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="11">
          
          
          <code class="ruby">    @user = User.where(provider: auth.provider, uid: auth.uid).first</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">    if @user&amp;.active_for_authentication?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby">      sign_in @user, event: :authentication # this will throw if @user is not activated</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="14">
          
          
          <code class="ruby">      redirect_to request.env[&#39;omniauth.origin&#39;] || root_path</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="15">
          
          
          <code class="ruby">      set_flash_message(:notice, :success, kind: &quot;CAS&quot;) if is_navigational_format?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="16">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="17">
          
          
          <code class="ruby">      set_flash_message(:alert, :failure, kind: &quot;CAS&quot;, reason: @user ? &quot;the account has been deactivated&quot; : &quot;the user is not in the database&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">      redirect_to root_path</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="19">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="20">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="22">
          
          
          <code class="ruby">  protected</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="24">
          
          
          <code class="ruby">    def after_omniauth_failure_path_for(_resource)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="25">
          
          
          <code class="ruby">      root_path</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="26">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="27">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="13b1ee54980f70c8c502b35457131db12a0aa0d5">
  <div class="header">
    <h3>app/controllers/parent_objects_controller.rb</h3>
    <h4><span class="red">0.0 %</span> covered</h4>
    <div>
      <b>182</b> relevant lines. 
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>182</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># frozen_string_literal: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="3">
          
          
          <code class="ruby">class ParentObjectsController &lt; ApplicationController</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="4">
          
          
          <code class="ruby">  before_action :set_parent_object, only: [:show, :edit, :update, :destroy, :update_metadata, :select_thumbnail, :solr_document]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="5">
          
          
          <code class="ruby">  before_action :set_paper_trail_whodunnit</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="6">
          
          
          <code class="ruby">  load_and_authorize_resource except: [:solr_document, :new, :create, :update_metadata, :all_metadata, :reindex, :select_thumbnail]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">  # GET /parent_objects</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">  # GET /parent_objects.json</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">  def index</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="11">
          
          
          <code class="ruby">    respond_to do |format|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">      format.html</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby">      format.json { render json: ParentObjectDatatable.new(params, view_context: view_context, current_ability: current_ability) }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="14">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="15">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">  # GET /parent_objects/1</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">  # GET /parent_objects/1.json</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="19">
          
          
          <code class="ruby">  def show; end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">  # GET /parent_objects/new</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="22">
          
          
          <code class="ruby">  def new</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="23">
          
          
          <code class="ruby">    @parent_object = ParentObject.new</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="24">
          
          
          <code class="ruby">    @parent_object.oid = OidMinterService.generate_oids(1).first</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="25">
          
          
          <code class="ruby">    @parent_object.authoritative_metadata_source = MetadataSource.find_by(metadata_cloud_name: &#39;aspace&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="26">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">  # GET /parent_objects/1/edit</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="29">
          
          
          <code class="ruby">  def edit; end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">  # POST /parent_objects</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">  # POST /parent_objects.json</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="33">
          
          
          <code class="ruby">  def create</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="34">
          
          
          <code class="ruby">    return unless valid_request?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="35">
          
          
          <code class="ruby">    @parent_object = ParentObject.new(parent_object_params)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="36">
          
          
          <code class="ruby">    authorize!(:create, @parent_object)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="37">
          
          
          <code class="ruby">    batch_process_of_one</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="38">
          
          
          <code class="ruby">    respond_to do |format|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="39">
          
          
          <code class="ruby">      if @parent_object.save</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="40">
          
          
          <code class="ruby">        queue_parent_metadata_update</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="41">
          
          
          <code class="ruby">        format.html { redirect_to @parent_object, notice: &#39;Parent object was successfully created.&#39; }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="42">
          
          
          <code class="ruby">        format.json { render :show, status: :created, location: @parent_object }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="43">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="44">
          
          
          <code class="ruby">        format.html { render :new }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="45">
          
          
          <code class="ruby">        format.json { render json: @parent_object.errors, status: :unprocessable_entity }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="46">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="47">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="48">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="50">
          
          
          <code class="ruby">  def valid_request?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="51">
          
          
          <code class="ruby">    return true if !ParentObject.exists?(oid: parent_object_params[:oid]) &amp;&amp; parent_object_params[:admin_set]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="52">
          
          
          <code class="ruby">    alert = parent_object_params[:admin_set] ? &quot;The oid already exists: [#{parent_object_params[:oid]}]&quot; : &quot;Admin set is required to create parent object&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="53">
          
          
          <code class="ruby">    respond_to do |format|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="54">
          
          
          <code class="ruby">      format.html { redirect_to new_parent_object_path, flash: { alert: alert } }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="55">
          
          
          <code class="ruby">      format.json { render json: { error: alert }, status: :unprocessable_entit }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="56">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="57">
          
          
          <code class="ruby">    false</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="58">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby">  # PATCH/PUT /parent_objects/1</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby">  # PATCH/PUT /parent_objects/1.json</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="62">
          
          
          <code class="ruby">  def update</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="63">
          
          
          <code class="ruby">    respond_to do |format|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="64">
          
          
          <code class="ruby">      invalidate_admin_set_edit unless valid_admin_set_edit?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="65">
          
          
          <code class="ruby">      invalidate_redirect_to_edit unless valid_redirect_to_edit?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="67">
          
          
          <code class="ruby">      updated = valid_admin_set_edit? ? @parent_object.update(parent_object_params) : false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="69">
          
          
          <code class="ruby">      if updated</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="70">
          
          
          <code class="ruby">        @parent_object.minify if valid_redirect_to_edit?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="71">
          
          
          <code class="ruby">        @parent_object.save</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="72">
          
          
          <code class="ruby">        queue_parent_metadata_update</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="73">
          
          
          <code class="ruby">        format.html { redirect_to @parent_object, notice: &#39;Parent object was successfully saved, a full update has been queued.&#39; }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="74">
          
          
          <code class="ruby">        format.json { render :show, status: :ok, location: @parent_object }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="75">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="76">
          
          
          <code class="ruby">        format.html { render :edit }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="77">
          
          
          <code class="ruby">        format.json { render json: @parent_object.errors, status: :unprocessable_entity }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="78">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="79">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="80">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="81">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="82">
          
          
          <code class="ruby">  # DELETE /parent_objects/1</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="83">
          
          
          <code class="ruby">  # DELETE /parent_objects/1.json</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="84">
          
          
          <code class="ruby">  def destroy</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="85">
          
          
          <code class="ruby">    @parent_object.destroy</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="86">
          
          
          <code class="ruby">    respond_to do |format|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="87">
          
          
          <code class="ruby">      format.html { redirect_to parent_objects_url, notice: &#39;Parent object was successfully destroyed.&#39; }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="88">
          
          
          <code class="ruby">      format.json { head :no_content }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="89">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="90">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="91">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="92">
          
          
          <code class="ruby">  def reindex</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="93">
          
          
          <code class="ruby">    authorize!(:reindex_all, ParentObject)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="94">
          
          
          <code class="ruby">    if ParentObject.cannot_reindex</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="95">
          
          
          <code class="ruby">      redirect_back(fallback_location: root_path, notice: &#39;There is already a Reindex job in progress, please wait for that job to complete before submitting a new reindex request&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="96">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="97">
          
          
          <code class="ruby">      ParentObject.solr_index</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="98">
          
          
          <code class="ruby">      respond_to do |format|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="99">
          
          
          <code class="ruby">        format.html { redirect_to parent_objects_url, notice: &#39;Parent objects have been reindexed.&#39; }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="100">
          
          
          <code class="ruby">        format.json { head :no_content }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="101">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="102">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="103">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="104">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="105">
          
          
          <code class="ruby">  def all_metadata_where</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="106">
          
          
          <code class="ruby">    where = { redirect_to: nil }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="107">
          
          
          <code class="ruby">    admin_set_ids = params[:admin_set]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="108">
          
          
          <code class="ruby">    admin_set_ids&amp;.compact!</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="109">
          
          
          <code class="ruby">    if !admin_set_ids</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="110">
          
          
          <code class="ruby">      authorize!(:update_metadata, ParentObject)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="111">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="112">
          
          
          <code class="ruby">      where[:admin_set_id] = admin_set_ids</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="113">
          
          
          <code class="ruby">      unless authorize!(:update_metadata, ParentObject)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="114">
          
          
          <code class="ruby">        admin_set_ids.map { |id| AdminSet.find_by(id: id) }.compact.each.each do |admin_set|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="115">
          
          
          <code class="ruby">          raise(&quot;Access Denied&quot;) unless current_ability.can?(:reindex_admin_set, admin_set)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="116">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="117">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="118">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="119">
          
          
          <code class="ruby">    metadata_source_ids = params[:metadata_source_ids]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="120">
          
          
          <code class="ruby">    where[:authoritative_metadata_source_id] = metadata_source_ids if metadata_source_ids</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="121">
          
          
          <code class="ruby">    where</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="122">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="123">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="124">
          
          
          <code class="ruby">  def all_metadata</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="125">
          
          
          <code class="ruby">    UpdateAllMetadataJob.perform_later(0, all_metadata_where)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="126">
          
          
          <code class="ruby">    respond_to do |format|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="127">
          
          
          <code class="ruby">      format.html { redirect_back fallback_location: parent_objects_url, notice: &#39;Parent objects have been queued for metadata update.&#39; }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="128">
          
          
          <code class="ruby">      format.json { head :no_content }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="129">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="130">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="131">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="132">
          
          
          <code class="ruby">  def update_metadata</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="133">
          
          
          <code class="ruby">    queue_parent_metadata_update</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="134">
          
          
          <code class="ruby">    respond_to do |format|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="135">
          
          
          <code class="ruby">      format.html { redirect_back fallback_location: parent_object_url(@parent_object), notice: &#39;This object has been queued for a metadata update.&#39; }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="136">
          
          
          <code class="ruby">      format.json { head :no_content }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="137">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="138">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="139">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="140">
          
          
          <code class="ruby">  def sync_from_preservica</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="141">
          
          
          <code class="ruby">    queue_parent_sync_from_preservica</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="142">
          
          
          <code class="ruby">    respond_to do |format|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="143">
          
          
          <code class="ruby">      format.html { redirect_back fallback_location: parent_object_url(@parent_object), notice: &#39;This object has been queued for synchronization of child objects from Preservica.&#39; }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="144">
          
          
          <code class="ruby">      format.json { head :no_content }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="145">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="146">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="147">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="148">
          
          
          <code class="ruby">  def select_thumbnail</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="149">
          
          
          <code class="ruby">    authorize!(:update, @parent_object)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="150">
          
          
          <code class="ruby">    @child_objects = ChildObject.select([:oid, :parent_object_oid, :order]).where(parent_object: @parent_object).group(:oid, :parent_object_oid, :order).order(:order).page(params[:page]).per(10)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="151">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="152">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="153">
          
          
          <code class="ruby">  def solr_document</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="154">
          
          
          <code class="ruby">    authorize!(:read, @parent_object)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="155">
          
          
          <code class="ruby">    solr = SolrService.connection</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="156">
          
          
          <code class="ruby">    oid = params[:id].to_i</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="157">
          
          
          <code class="ruby">    response = solr.get &#39;select&#39;, params: { q: &quot;id:#{oid}&quot; }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="158">
          
          
          <code class="ruby">    render json: response[&quot;response&quot;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="159">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="160">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="161">
          
          
          <code class="ruby">  private</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="162">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="163">
          
          
          <code class="ruby">    def queue_parent_metadata_update</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="164">
          
          
          <code class="ruby">      authorize!(:update, @parent_object)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="165">
          
          
          <code class="ruby">      @parent_object.metadata_update = true</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="166">
          
          
          <code class="ruby">      @parent_object.setup_metadata_job</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="167">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="168">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="169">
          
          
          <code class="ruby">    def queue_parent_sync_from_preservica</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="170">
          
          
          <code class="ruby">      authorize!(:update, @parent_object)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="171">
          
          
          <code class="ruby">      @batch_process = BatchProcess.new(user: current_user,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="172">
          
          
          <code class="ruby">                                        oid: @parent_object.oid,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="173">
          
          
          <code class="ruby">                                        batch_action: &#39;sync from preservica&#39;,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="174">
          
          
          <code class="ruby">                                        csv: CSV.generate do |csv|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="175">
          
          
          <code class="ruby">                                               csv &lt;&lt; [&#39;oid&#39;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="176">
          
          
          <code class="ruby">                                               csv &lt;&lt; [@parent_object.oid.to_s]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="177">
          
          
          <code class="ruby">                                             end)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="178">
          
          
          <code class="ruby">      @parent_object.current_batch_connection = @batch_process.batch_connections.build(connectable: @parent_object)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="179">
          
          
          <code class="ruby">      @batch_process.save!</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="180">
          
          
          <code class="ruby">      @parent_object.current_batch_process = @batch_process</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="181">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="182">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="183">
          
          
          <code class="ruby">    def valid_admin_set_edit?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="184">
          
          
          <code class="ruby">      !parent_object_params[:admin_set] || (parent_object_params[:admin_set] &amp;&amp; current_user.editor(parent_object_params[:admin_set]))</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="185">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="186">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="187">
          
          
          <code class="ruby">    def invalidate_admin_set_edit</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="188">
          
          
          <code class="ruby">      @parent_object.errors.add :admin_set, :invalid, message: &quot;cannot be assigned to a set the User cannot edit&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="189">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="190">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="191">
          
          
          <code class="ruby">    # Use callbacks to share common setup or constraints between actions.</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="192">
          
          
          <code class="ruby">    def set_parent_object</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="193">
          
          
          <code class="ruby">      @parent_object = ParentObject.find(params[:id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="194">
          
          
          <code class="ruby">    rescue ActiveRecord::RecordNotFound</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="195">
          
          
          <code class="ruby">      respond_to do |format|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="196">
          
          
          <code class="ruby">        format.html { redirect_to parent_objects_url, notice: &quot;Parent object, oid: #{params[:id]}, was not found in local database.&quot; }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="197">
          
          
          <code class="ruby">        format.json { head :no_content }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="198">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="199">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="200">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="201">
          
          
          <code class="ruby">    def batch_process_of_one</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="202">
          
          
          <code class="ruby">      @batch_process = BatchProcess.new(user: current_user, oid: @parent_object.oid)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="203">
          
          
          <code class="ruby">      @parent_object.current_batch_connection = @batch_process.batch_connections.build(connectable: @parent_object)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="204">
          
          
          <code class="ruby">      @batch_process.save!</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="205">
          
          
          <code class="ruby">      @parent_object.current_batch_process = @batch_process</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="206">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="207">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="208">
          
          
          <code class="ruby">    # rubocop:disable Metrics/LineLength</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="209">
          
          
          <code class="ruby">    def valid_redirect_to_edit?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="210">
          
          
          <code class="ruby">      !parent_object_params[:redirect_to] || (parent_object_params[:redirect_to]&amp;.match(/\A((http|https):\/\/)?(collections-test.|collections-uat.|collections.)?library.yale.edu\/catalog\//)) if parent_object_params[:redirect_to].present?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="211">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="212">
          
          
          <code class="ruby">    # rubocop:enable Metrics/LineLength</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="213">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="214">
          
          
          <code class="ruby">    def invalidate_redirect_to_edit</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="215">
          
          
          <code class="ruby">      @parent_object.errors.add :redirect_to, :invalid, message: &quot;must be in format https://collections.library.yale.edu/catalog/1234567&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="216">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="217">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="218">
          
          
          <code class="ruby">    # Only allow a list of trusted parameters through.</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="219">
          
          
          <code class="ruby">    def parent_object_params</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="220">
          
          
          <code class="ruby">      cur_params = params.require(:parent_object).permit(:oid, :admin_set, :project_identifier, :bib, :holding, :item, :barcode, :aspace_uri, :last_ladybird_update, :last_voyager_update,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="221">
          
          
          <code class="ruby">                                                         :last_aspace_update, :visibility, :last_id_update, :authoritative_metadata_source_id, :viewing_direction,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="222">
          
          
          <code class="ruby">                                                         :display_layout, :representative_child_oid, :rights_statement, :extent_of_digitization,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="223">
          
          
          <code class="ruby">                                                         :digitization_note, :redirect_to, :preservica_uri, :digital_object_source, :preservica_representation_name)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="224">
          
          
          <code class="ruby">      cur_params[:admin_set] = AdminSet.find_by(key: cur_params[:admin_set]) if cur_params[:admin_set]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="225">
          
          
          <code class="ruby">      cur_params</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="226">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="227">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="2470e440229660ee7a02fcd32fd4b764a937ec8c">
  <div class="header">
    <h3>app/controllers/preservica_ingests_controller.rb</h3>
    <h4><span class="red">0.0 %</span> covered</h4>
    <div>
      <b>8</b> relevant lines. 
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>8</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># frozen_string_literal: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="3">
          
          
          <code class="ruby">class PreservicaIngestsController &lt; ApplicationController</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby">  # GET /preservica_ingest</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby">  # GET /preservica_ingest.json</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="6">
          
          
          <code class="ruby">  def index</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="7">
          
          
          <code class="ruby">    respond_to do |format|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="8">
          
          
          <code class="ruby">      format.html</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="9">
          
          
          <code class="ruby">      format.json { render json: PreservicaIngestDatatable.new(params, view_context: view_context, current_ability: current_ability) }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="11">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="b3d54654a3b0f970a1e457c5177fa414de360f76">
  <div class="header">
    <h3>app/controllers/redirected_parent_objects_controller.rb</h3>
    <h4><span class="red">0.0 %</span> covered</h4>
    <div>
      <b>8</b> relevant lines. 
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>8</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># frozen_string_literal: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="3">
          
          
          <code class="ruby">class RedirectedParentObjectsController &lt; ApplicationController</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby">  # GET /redirected_parent_objects</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby">  # GET /redirected_parent_objects.json</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="6">
          
          
          <code class="ruby">  def index</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="7">
          
          
          <code class="ruby">    respond_to do |format|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="8">
          
          
          <code class="ruby">      format.html</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="9">
          
          
          <code class="ruby">      format.json { render json: RedirectedParentObjectDatatable.new(params, view_context: view_context, current_ability: current_ability) }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="11">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="b98eb997174d95750d66cce867c71ff35e2168ef">
  <div class="header">
    <h3>app/controllers/reoccurring_jobs_controller.rb</h3>
    <h4><span class="red">0.0 %</span> covered</h4>
    <div>
      <b>37</b> relevant lines. 
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>37</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># frozen_string_literal: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="3">
          
          
          <code class="ruby">class ReoccurringJobsController &lt; ApplicationController</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="4">
          
          
          <code class="ruby">  def index</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="5">
          
          
          <code class="ruby">    if params[&#39;check_status&#39;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="6">
          
          
          <code class="ruby">      @check_status = true</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="7">
          
          
          <code class="ruby">      @scheduled_job_exists = Delayed::Job.page(params[:page]).where(&#39;handler LIKE ?&#39;, &#39;%job_class: ActivityStreamJob%&#39;).exists?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="8">
          
          
          <code class="ruby">      @manual_job_exists = Delayed::Job.page(params[:page]).where(&#39;handler LIKE ?&#39;, &#39;%job_class: ActivityStreamManualJob%&#39;).exists?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="9">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">    @reoccurring_jobs = ActivityStreamLog.all</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="11">
          
          
          <code class="ruby">    respond_to do |format|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">      format.html</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby">      format.json { render json: ReoccurringJobDatatable.new(params, view_context: view_context) }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="14">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="15">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">  # POST ActivityStreamReader</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">  def create_recurring</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="19">
          
          
          <code class="ruby">    ActivityStreamJob.perform_later unless Delayed::Job.page(params[:page]).where(&#39;handler LIKE ?&#39;, &#39;%job_class: ActivityStreamJob%&#39;).exists?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="20">
          
          
          <code class="ruby">    respond_to do |format|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="21">
          
          
          <code class="ruby">      format.html { redirect_to reoccurring_jobs_url, notice: &#39;The recurring job has been queued.&#39; }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="22">
          
          
          <code class="ruby">      format.json { head :no_content }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="23">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="24">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">  # POST ActivityStreamReader</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="27">
          
          
          <code class="ruby">  def create</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="28">
          
          
          <code class="ruby">    if params[&#39;queue_recurring&#39;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="29">
          
          
          <code class="ruby">      create_recurring</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="30">
          
          
          <code class="ruby">    elsif ActivityStreamLog.where(status: &quot;Running&quot;).exists?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="31">
          
          
          <code class="ruby">      respond_to do |format|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="32">
          
          
          <code class="ruby">        format.html { redirect_to reoccurring_jobs_url, notice: &#39;An update is already in progress.&#39; }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="33">
          
          
          <code class="ruby">        format.json { head :no_content }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="34">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="35">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="36">
          
          
          <code class="ruby">      ActivityStreamManualJob.perform_later</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="37">
          
          
          <code class="ruby">      respond_to do |format|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="38">
          
          
          <code class="ruby">        format.html { redirect_to reoccurring_jobs_url, notice: &#39;The manual job has been queued.&#39; }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="39">
          
          
          <code class="ruby">        format.json { head :no_content }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="40">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="41">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="42">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="43">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="2110ca64f9e4dd2d8da54557150e92f5ee025757">
  <div class="header">
    <h3>app/controllers/roles_controller.rb</h3>
    <h4><span class="red">0.0 %</span> covered</h4>
    <div>
      <b>41</b> relevant lines. 
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>41</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># frozen_string_literal: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="3">
          
          
          <code class="ruby">class RolesController &lt; ApplicationController</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="4">
          
          
          <code class="ruby">  before_action :set_user</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="5">
          
          
          <code class="ruby">  before_action :set_item</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="6">
          
          
          <code class="ruby">  before_action :set_role</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="7">
          
          
          <code class="ruby">  before_action :verify_user</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="9">
          
          
          <code class="ruby">  def create</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">    if @item &amp;&amp; @user.has_role?(@role, @item)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="11">
          
          
          <code class="ruby">      redirect_back(fallback_location: root_path, flash: { alert: &quot;User: #{@user.uid} is already assigned as #{@role}&quot; })</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">    elsif @item</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">      # each user only gets one role per item, remove all others first.</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="14">
          
          
          <code class="ruby">      @user.users_roles.joins(:role).where(roles: { resource: @item }).delete_all</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="16">
          
          
          <code class="ruby">      @user.add_role(@role, @item)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="17">
          
          
          <code class="ruby">      redirect_back(fallback_location: root_path, notice: show_notice(@user, @role))</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="19">
          
          
          <code class="ruby">      @user.add_role(@role)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="20">
          
          
          <code class="ruby">      redirect_back(fallback_location: root_path, notice: show_notice(@user, @role))</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="21">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="22">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="24">
          
          
          <code class="ruby">  def remove</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="25">
          
          
          <code class="ruby">    @user.users_roles.joins(:role).where(roles: { resource: @item }).delete_all</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="26">
          
          
          <code class="ruby">    redirect_back(fallback_location: root_path, notice: &quot;User: #{@user.uid} removed as #{@role}&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="27">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="29">
          
          
          <code class="ruby">  private</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="31">
          
          
          <code class="ruby">    def verify_user</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="32">
          
          
          <code class="ruby">      authorize!(current_ability, :manage, @item) unless current_user.has_role? :sysadmin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="33">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="35">
          
          
          <code class="ruby">    def set_user</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="36">
          
          
          <code class="ruby">      @user = User.find_by(uid: params[:uid])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="37">
          
          
          <code class="ruby">      return true if @user</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="39">
          
          
          <code class="ruby">      redirect_back(fallback_location: root_path, flash: { alert: &quot;User: #{params[:uid]} not found&quot; })</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="40">
          
          
          <code class="ruby">      false</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="41">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="43">
          
          
          <code class="ruby">    def set_role</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="44">
          
          
          <code class="ruby">      @role = params[:role]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="45">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="47">
          
          
          <code class="ruby">    def set_item</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="48">
          
          
          <code class="ruby">      @item = params[:item_class]&amp;.constantize&amp;.find(params[:item_id]) if params[:item_id]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="49">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="51">
          
          
          <code class="ruby">    def show_notice(user, role)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="52">
          
          
          <code class="ruby">      user.deactivated ? &quot;User: #{user.uid} added as #{role}, but is deactivated&quot; : &quot;User: #{user.uid} added as #{role}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="53">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="54">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="b2da084446acfc25d80c1c77c21e843a2b54d9fe">
  <div class="header">
    <h3>app/controllers/users_controller.rb</h3>
    <h4><span class="red">0.0 %</span> covered</h4>
    <div>
      <b>45</b> relevant lines. 
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>45</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># frozen_string_literal: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="3">
          
          
          <code class="ruby">class UsersController &lt; ApplicationController</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="4">
          
          
          <code class="ruby">  load_and_authorize_resource</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="5">
          
          
          <code class="ruby">  before_action :set_user, only: [:edit, :update, :show]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="7">
          
          
          <code class="ruby">  def index</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="8">
          
          
          <code class="ruby">    respond_to do |format|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="9">
          
          
          <code class="ruby">      format.html</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">      format.json { render json: UserDatatable.new(params, view_context: view_context) }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="11">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="14">
          
          
          <code class="ruby">  def edit; end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="16">
          
          
          <code class="ruby">  def new</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="17">
          
          
          <code class="ruby">    @user = User.new(provider: &#39;cas&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="20">
          
          
          <code class="ruby">  def create</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="21">
          
          
          <code class="ruby">    @user = User.new(user_params.merge(provider: &#39;cas&#39;))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="23">
          
          
          <code class="ruby">    respond_to do |format|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="24">
          
          
          <code class="ruby">      if @user.save</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="25">
          
          
          <code class="ruby">        format.html { redirect_to @user, notice: &#39;User was successfully created.&#39; }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="26">
          
          
          <code class="ruby">        format.json { render :show, status: :created, location: @admin_set }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="27">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="28">
          
          
          <code class="ruby">        format.html { render :new }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="29">
          
          
          <code class="ruby">        format.json { render json: @user.errors, status: :unprocessable_entity }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="30">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="31">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="32">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="34">
          
          
          <code class="ruby">  def update</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="35">
          
          
          <code class="ruby">    respond_to do |format|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="36">
          
          
          <code class="ruby">      if @user.update(user_params)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="37">
          
          
          <code class="ruby">        format.html { redirect_to @user, notice: &#39;User was successfully updated.&#39; }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="38">
          
          
          <code class="ruby">        format.json { render :show, status: :ok }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="39">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="40">
          
          
          <code class="ruby">        format.html { render :edit }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="41">
          
          
          <code class="ruby">        format.json { render json: @user.errors, status: :unprocessable_entity }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="42">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="43">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="44">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="46">
          
          
          <code class="ruby">  def show; end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="48">
          
          
          <code class="ruby">  private</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="50">
          
          
          <code class="ruby">    def user_params</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="51">
          
          
          <code class="ruby">      params.require(:user).permit(:email, :deactivated, :sysadmin, :first_name, :last_name, :uid)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="52">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="54">
          
          
          <code class="ruby">    def set_user</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="55">
          
          
          <code class="ruby">      @user = User.find(params[:id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="56">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="57">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="36a66f34bdaece141e7dbc8e8cc2df572e4880ca">
  <div class="header">
    <h3>app/datatables/admin_set_datatable.rb</h3>
    <h4><span class="red">0.0 %</span> covered</h4>
    <div>
      <b>33</b> relevant lines. 
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>33</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># frozen_string_literal: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="3">
          
          
          <code class="ruby">class AdminSetDatatable &lt; AjaxDatatablesRails::ActiveRecord</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="4">
          
          
          <code class="ruby">  extend Forwardable</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="6">
          
          
          <code class="ruby">  def_delegators :@view, :link_to, :admin_set_path, :edit_admin_set_path, :content_tag</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="8">
          
          
          <code class="ruby">  def initialize(params, opts = {})</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="9">
          
          
          <code class="ruby">    @view = opts[:view_context]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">    super</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="11">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby">  def view_columns</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">    # Declare strings in this format: ModelName.column_name</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">    # or in aliased_join_table.column_name format</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="16">
          
          
          <code class="ruby">    @view_columns ||= {</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="17">
          
          
          <code class="ruby">      key: { source: &quot;AdminSet.key&quot;, cond: :start_with, searchable: true, orderable: true },</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">      label: { source: &quot;AdminSet.label&quot;, cond: :start_with, searchable: true, orderable: true },</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="19">
          
          
          <code class="ruby">      homepage: { source: &quot;AdminSet.homepage&quot;, cond: :like, searchable: true, orderable: true }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="20">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="21">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="23">
          
          
          <code class="ruby">  def data</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="24">
          
          
          <code class="ruby">    records.map do |admin_set|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="25">
          
          
          <code class="ruby">      {</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="26">
          
          
          <code class="ruby">        key: link_to(admin_set.key, admin_set_path(admin_set)) + with_icon(&#39;fa fa-pencil-alt&#39;, edit_admin_set_path(admin_set)),</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="27">
          
          
          <code class="ruby">        label: admin_set.label,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="28">
          
          
          <code class="ruby">        homepage: link_to(admin_set.homepage, admin_set.homepage),</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="29">
          
          
          <code class="ruby">        DT_RowId: &quot;admin_set_#{admin_set.id}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="30">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="31">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="32">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="34">
          
          
          <code class="ruby">  def with_icon(class_name, path, options = {})</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="35">
          
          
          <code class="ruby">    link_to(path, options) do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="36">
          
          
          <code class="ruby">      content_tag(:i, &#39;&#39;, class: class_name)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="37">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="38">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="40">
          
          
          <code class="ruby">  def get_raw_records # rubocop:disable Naming/AccessorMethodName</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="41">
          
          
          <code class="ruby">    AdminSet.all</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="42">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="43">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="0e7f298e66f63a5ef7cb9b567e186f660ce5fb85">
  <div class="header">
    <h3>app/datatables/batch_process_datatable.rb</h3>
    <h4><span class="red">0.0 %</span> covered</h4>
    <div>
      <b>37</b> relevant lines. 
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>37</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># frozen_string_literal: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="3">
          
          
          <code class="ruby">class BatchProcessDatatable &lt; AjaxDatatablesRails::ActiveRecord</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="4">
          
          
          <code class="ruby">  extend Forwardable</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="6">
          
          
          <code class="ruby">  def_delegators :@view, :link_to, :batch_process_path</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="8">
          
          
          <code class="ruby">  def initialize(params, opts = {})</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="9">
          
          
          <code class="ruby">    @view = opts[:view_context]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">    super</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="11">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby">  def view_columns</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">    # Declare strings in this format: ModelName.column_name</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">    # or in aliased_join_table.column_name format</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="16">
          
          
          <code class="ruby">    @view_columns ||= {</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="17">
          
          
          <code class="ruby">      process_id: { source: &quot;BatchProcess.id&quot;, cond: :eq, searchable: true, orderable: true },</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">      user: { source: &quot;User.uid&quot;, cond: :start_with, searchable: true, orderable: true },</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="19">
          
          
          <code class="ruby">      time: { source: &quot;BatchProcess.created_at&quot;, cond: :like, orderable: true },</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="20">
          
          
          <code class="ruby">      size: { source: &quot;BatchProcess.oid&quot;, searchable: false, orderable: false },</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="21">
          
          
          <code class="ruby">      status: { source: &quot;BatchProcess.batch_status&quot;, searchable: false, orderable: false },</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="22">
          
          
          <code class="ruby">      batch_ingest_events_count: { source: &quot;BatchProcess.batch_ingest_events_count&quot;, searchable: false, orderable: false },</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="23">
          
          
          <code class="ruby">      batch_action: { source: &quot;BatchProcess.batch_action&quot;, searchable: true, orderable: true, options: BatchProcess.batch_actions }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="24">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="25">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="27">
          
          
          <code class="ruby">  def data</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">    # rubocop:disable Rails/OutputSafety</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="29">
          
          
          <code class="ruby">    records.map do |batch_process|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="30">
          
          
          <code class="ruby">      {</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="31">
          
          
          <code class="ruby">        process_id: link_to(batch_process.id, batch_process_path(batch_process)),</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="32">
          
          
          <code class="ruby">        user: batch_process.user.uid,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="33">
          
          
          <code class="ruby">        time: batch_process.created_at,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="34">
          
          
          <code class="ruby">        size: batch_process.oids&amp;.count,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="35">
          
          
          <code class="ruby">        status: batch_process.batch_status,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="36">
          
          
          <code class="ruby">        batch_ingest_events_count: link_to(batch_process.batch_ingest_events_count, batch_process_path(batch_process),</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="37">
          
          
          <code class="ruby">                                           class: batch_process.batch_ingest_events_count.positive? ? &quot;btn btn-warning&quot; : &quot;&quot;),</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="38">
          
          
          <code class="ruby">        batch_action: batch_process.batch_action,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="39">
          
          
          <code class="ruby">        DT_RowId: batch_process.id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="40">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="41">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">    # rubocop:enable Rails/OutputSafety</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="43">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="45">
          
          
          <code class="ruby">  def get_raw_records # rubocop:disable Naming/AccessorMethodName</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="46">
          
          
          <code class="ruby">    BatchProcess.joins(:user)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="47">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="48">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="e7ee03a5db248076edc0bb015fea2ee1e2595a06">
  <div class="header">
    <h3>app/datatables/batch_process_detail_datatable.rb</h3>
    <h4><span class="red">0.0 %</span> covered</h4>
    <div>
      <b>31</b> relevant lines. 
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>31</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># frozen_string_literal: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="3">
          
          
          <code class="ruby">class BatchProcessDetailDatatable &lt; AjaxDatatablesRails::ActiveRecord</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="4">
          
          
          <code class="ruby">  extend Forwardable</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="6">
          
          
          <code class="ruby">  def_delegators :@view, :link_to, :show_parent_batch_process_path</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="8">
          
          
          <code class="ruby">  def initialize(params, opts = {})</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="9">
          
          
          <code class="ruby">    @view = opts[:view_context]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">    super</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="11">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby">  def view_columns</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">    # Declare strings in this format: ModelName.column_name</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">    # or in aliased_join_table.column_name format</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="16">
          
          
          <code class="ruby">    @view_columns ||= {</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="17">
          
          
          <code class="ruby">      parent_oid: { source: &#39;BatchConnection.connectable_id&#39;, cond: :like, searchable: true, orderable: true },</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">      time: { source: &#39;BatchConnection.created_at&#39;, cond: :like, searchable: true, orderable: true },</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="19">
          
          
          <code class="ruby">      children: { source: &#39;ParentObject.child_object_count&#39;, cond: :like, searchable: true, orderable: true },</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="20">
          
          
          <code class="ruby">      status: { source: &#39;BatchConnection.status&#39;, cond: :like, searchable: true, orderable: true }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="21">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="22">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="24">
          
          
          <code class="ruby">  def data</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">    # rubocop:disable Rails/OutputSafety</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="26">
          
          
          <code class="ruby">    records.map do |batch_connection|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="27">
          
          
          <code class="ruby">      {</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="28">
          
          
          <code class="ruby">        parent_oid: link_to(batch_connection&amp;.connectable_id, show_parent_batch_process_path(oid: batch_connection&amp;.connectable_id.to_s)),</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="29">
          
          
          <code class="ruby">        time: batch_connection&amp;.created_at,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="30">
          
          
          <code class="ruby">        children: batch_connection.connectable&amp;.child_object_count || &#39;pending, or parent deleted&#39;,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="31">
          
          
          <code class="ruby">        status: batch_connection.status,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="32">
          
          
          <code class="ruby">        DT_RowId: batch_connection&amp;.connectable_id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="33">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="34">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">    # rubocop:enable Rails/OutputSafety</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="36">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="38">
          
          
          <code class="ruby">  def get_raw_records # rubocop:disable Naming/AccessorMethodName</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="39">
          
          
          <code class="ruby">    sql = &quot;LEFT OUTER JOIN parent_objects ON batch_connections.connectable_id = parent_objects.oid AND batch_connections.connectable_type = &#39;ParentObject&#39;&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="40">
          
          
          <code class="ruby">    BatchConnection.joins(sql).where(batch_process_id: params[:id], connectable_type: &quot;ParentObject&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="41">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="42">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="e99446c7b559f6d0219e36fbc04504ef821ded02">
  <div class="header">
    <h3>app/datatables/batch_process_parent_datatable.rb</h3>
    <h4><span class="red">0.0 %</span> covered</h4>
    <div>
      <b>29</b> relevant lines. 
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>29</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># frozen_string_literal: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="3">
          
          
          <code class="ruby">class BatchProcessParentDatatable &lt; AjaxDatatablesRails::ActiveRecord</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="4">
          
          
          <code class="ruby">  extend Forwardable</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="6">
          
          
          <code class="ruby">  def_delegators :@view, :link_to, :show_child_batch_process_path</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="8">
          
          
          <code class="ruby">  def initialize(params, opts = {})</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="9">
          
          
          <code class="ruby">    @view = opts[:view_context]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">    @batch_process = opts[:batch_process]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="11">
          
          
          <code class="ruby">    super</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="14">
          
          
          <code class="ruby">  def view_columns</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="15">
          
          
          <code class="ruby">    @view_columns ||= {</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="16">
          
          
          <code class="ruby">      child_oid: { source: &#39;ChildObject.oid&#39;, orderable: true },</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="17">
          
          
          <code class="ruby">      time: { source: &#39;ChildObject.created_at&#39;, orderable: true },</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">      status: { source: &#39;&#39;, cond: :null_value, searchable: false, orderable: false }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="19">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="20">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="22">
          
          
          <code class="ruby">  def data</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">    # rubocop:disable Rails/OutputSafety</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="24">
          
          
          <code class="ruby">    records.map do |child_object|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="25">
          
          
          <code class="ruby">      {</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="26">
          
          
          <code class="ruby">        child_oid: link_to(child_object&amp;.oid, show_child_batch_process_path(oid: child_object&amp;.parent_object_oid, child_oid: child_object&amp;.oid)),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">        # time: child_object&amp;.created_at,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="28">
          
          
          <code class="ruby">        time: child_object.events_for_batch_process(@batch_process).maximum(:created_at),</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="29">
          
          
          <code class="ruby">        status: child_object&amp;.status_for_batch_process(@batch_process).to_s,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="30">
          
          
          <code class="ruby">        DT_RowId: child_object&amp;.oid</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="31">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="32">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">    # rubocop:enable Rails/OutputSafety</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="34">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="36">
          
          
          <code class="ruby">  def get_raw_records # rubocop:disable Naming/AccessorMethodName</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="37">
          
          
          <code class="ruby">    @batch_process.child_objects.where(parent_object_oid: params[:oid])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="38">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="39">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="77653a807a5304165be2cf68ad6c248b6cc99c7f">
  <div class="header">
    <h3>app/datatables/child_object_datatable.rb</h3>
    <h4><span class="red">0.0 %</span> covered</h4>
    <div>
      <b>57</b> relevant lines. 
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>57</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># frozen_string_literal: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="3">
          
          
          <code class="ruby">class ChildObjectDatatable &lt; AjaxDatatablesRails::ActiveRecord</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="4">
          
          
          <code class="ruby">  extend Forwardable</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="6">
          
          
          <code class="ruby">  def_delegators :@view, :link_to, :child_object_path, :edit_child_object_path, :content_tag</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="8">
          
          
          <code class="ruby">  def initialize(params, opts = {})</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="9">
          
          
          <code class="ruby">    @view = opts[:view_context]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">    @current_ability = opts[:current_ability]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="11">
          
          
          <code class="ruby">    super</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="14">
          
          
          <code class="ruby">  def view_columns</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">    # default values: &#39;searchable: true&#39;, &#39;orderable: true&#39;, &#39;cond: :like&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">    # add those values here only for override purposes</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="17">
          
          
          <code class="ruby">    @view_columns ||= {</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">      oid: { source: &#39;ChildObject.oid&#39; },</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="19">
          
          
          <code class="ruby">      label: { source: &#39;ChildObject.label&#39; },</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="20">
          
          
          <code class="ruby">      caption: { source: &#39;ChildObject.caption&#39; },</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="21">
          
          
          <code class="ruby">      width: { source: &#39;ChildObject.width&#39; },</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="22">
          
          
          <code class="ruby">      height: { source: &#39;ChildObject.height&#39; },</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="23">
          
          
          <code class="ruby">      order: { source: &#39;ChildObject.order&#39; },</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="24">
          
          
          <code class="ruby">      parent_object: { source: &#39;ChildObject.parent_object_oid&#39; },</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="25">
          
          
          <code class="ruby">      original_oid: { source: &#39;ChildObject.original_oid&#39; },</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="26">
          
          
          <code class="ruby">      preservica_content_object_uri: { source: &#39;ChildObject.preservica_content_object_uri&#39; },</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="27">
          
          
          <code class="ruby">      preservica_generation_uri: { source: &#39;ChildObject.preservica_generation_uri&#39; },</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="28">
          
          
          <code class="ruby">      preservica_bitstream_uri: { source: &#39;ChildObject.preservica_bitstream_uri&#39; },</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="29">
          
          
          <code class="ruby">      actions: { source: &#39;ChildObject.oid&#39; }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="30">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="31">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">  # rubocop:disable Rails/OutputSafety</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="34">
          
          
          <code class="ruby">  def data</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="35">
          
          
          <code class="ruby">    records.map do |child_object|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="36">
          
          
          <code class="ruby">      {</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="37">
          
          
          <code class="ruby">        oid: link_to(child_object.oid, child_object_path(child_object)) + (with_icon(&#39;fa fa-pencil-alt&#39;, edit_child_object_path(child_object)) if @current_ability.can? :edit, child_object),</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="38">
          
          
          <code class="ruby">        label: child_object.label,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="39">
          
          
          <code class="ruby">        caption: child_object.caption,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="40">
          
          
          <code class="ruby">        width: child_object.width,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="41">
          
          
          <code class="ruby">        height: child_object.height,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="42">
          
          
          <code class="ruby">        order: child_object.order,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="43">
          
          
          <code class="ruby">        parent_object: child_object.parent_object_oid,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="44">
          
          
          <code class="ruby">        original_oid: child_object.original_oid,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="45">
          
          
          <code class="ruby">        preservica_content_object_uri: child_object.preservica_content_object_uri,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="46">
          
          
          <code class="ruby">        preservica_generation_uri: child_object.preservica_generation_uri,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="47">
          
          
          <code class="ruby">        preservica_bitstream_uri: child_object.preservica_bitstream_uri,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="48">
          
          
          <code class="ruby">        actions: actions(child_object).html_safe,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="49">
          
          
          <code class="ruby">        DT_RowId: child_object.oid</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="50">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="51">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="52">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby">  # rubocop:enable Rails/OutputSafety</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="55">
          
          
          <code class="ruby">  def actions(child_object)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="56">
          
          
          <code class="ruby">    actions = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="57">
          
          
          <code class="ruby">    actions &lt;&lt; with_icon(&#39;fa fa-trash&#39;, child_object_path(child_object), method: :delete, data: { confirm: &#39;Are you sure?&#39; }) if @current_ability.can? :destroy, child_object</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="58">
          
          
          <code class="ruby">    actions.join(&#39; | &#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="59">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="61">
          
          
          <code class="ruby">  def with_icon(class_name, path, options = {})</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="62">
          
          
          <code class="ruby">    link_to(path, options) do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="63">
          
          
          <code class="ruby">      content_tag(:i, &#39;&#39;, class: class_name)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="64">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="65">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby">  # rubocop:disable Naming/AccessorMethodName</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="68">
          
          
          <code class="ruby">  def get_raw_records</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="69">
          
          
          <code class="ruby">    ChildObject.accessible_by(@current_ability, :read)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="70">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="71">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="484feee8fde92adcbffcb2e3455853e53b104eb3">
  <div class="header">
    <h3>app/datatables/parent_object_datatable.rb</h3>
    <h4><span class="red">0.0 %</span> covered</h4>
    <div>
      <b>78</b> relevant lines. 
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>78</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># frozen_string_literal: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="3">
          
          
          <code class="ruby">class ParentObjectDatatable &lt; AjaxDatatablesRails::ActiveRecord</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="4">
          
          
          <code class="ruby">  extend Forwardable</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="6">
          
          
          <code class="ruby">  def_delegators :@view, :link_to, :parent_object_path, :edit_parent_object_path, :update_metadata_parent_object_path, :content_tag</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="8">
          
          
          <code class="ruby">  def initialize(params, opts = {})</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="9">
          
          
          <code class="ruby">    @view = opts[:view_context]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">    @current_ability = opts[:current_ability]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="11">
          
          
          <code class="ruby">    @set_keys = AdminSet.order(:key).distinct.pluck(:key)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">    super</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">  # rubocop:disable Metrics/MethodLength</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="16">
          
          
          <code class="ruby">  def view_columns</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">    # Declare strings in this format: ModelName.column_name</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">    # or in aliased_join_table.column_name format</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="19">
          
          
          <code class="ruby">    @view_columns ||= {</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="20">
          
          
          <code class="ruby">      oid: { source: &quot;ParentObject.oid&quot;, cond: :start_with, searchable: true, orderable: true },</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="21">
          
          
          <code class="ruby">      admin_set: { source: &quot;AdminSet.key&quot;, cond: :string_eq, searchable: true, options: @set_keys, orderable: true },</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="22">
          
          
          <code class="ruby">      authoritative_source: { source: &quot;MetadataSource.metadata_cloud_name&quot;, cond: :string_eq, searchable: true, options: [&quot;ladybird&quot;, &quot;aspace&quot;, &quot;ils&quot;], orderable: true },</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="23">
          
          
          <code class="ruby">      child_object_count: { source: &quot;ParentObject.child_object_count&quot;, orderable: true },</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="24">
          
          
          <code class="ruby">      call_number: { source: &quot;ParentObject.call_number&quot;, searchable: true, orderable: true },</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="25">
          
          
          <code class="ruby">      container_grouping: { source: &quot;ParentObject.container_grouping&quot;, searchable: true, orderable: true },</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="26">
          
          
          <code class="ruby">      bib: { source: &quot;ParentObject.bib&quot;, cond: :string_eq, searchable: true, orderable: true },</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="27">
          
          
          <code class="ruby">      holding: { source: &quot;ParentObject.holding&quot;, cond: :string_eq, searchable: true, orderable: true },</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="28">
          
          
          <code class="ruby">      item: { source: &quot;ParentObject.item&quot;, cond: :string_eq, searchable: true, orderable: true },</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="29">
          
          
          <code class="ruby">      barcode: { source: &quot;ParentObject.barcode&quot;, cond: :string_eq, searchable: true, orderable: true },</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="30">
          
          
          <code class="ruby">      aspace_uri: { source: &quot;ParentObject.aspace_uri&quot;, cond: :like, searchable: true, orderable: true },</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="31">
          
          
          <code class="ruby">      digital_object_source: { source: &quot;ParentObject.digital_object_source&quot;, cond: :like, searchable: true, options: [&quot;None&quot;, &quot;Preservica&quot;], orderable: true },</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="32">
          
          
          <code class="ruby">      preservica_uri: { source: &quot;ParentObject.preservica_uri&quot;, cond: :like, searchable: true, orderable: true },</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="33">
          
          
          <code class="ruby">      last_ladybird_update: { source: &quot;ParentObject.last_ladybird_update&quot;, orderable: true },</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="34">
          
          
          <code class="ruby">      last_voyager_update: { source: &quot;ParentObject.last_voyager_update&quot;, orderable: true },</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="35">
          
          
          <code class="ruby">      last_aspace_update: { source: &quot;ParentObject.last_aspace_update&quot;, orderable: true },</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="36">
          
          
          <code class="ruby">      last_id_update: { source: &quot;ParentObject.last_id_update&quot;, orderable: true },</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="37">
          
          
          <code class="ruby">      visibility: { source: &quot;ParentObject.visibility&quot;, cond: :string_eq, searchable: true, options: [&quot;Public&quot;, &quot;Yale Community Only&quot;, &quot;Private&quot;], orderable: true },</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="38">
          
          
          <code class="ruby">      extent_of_digitization: { source: &quot;ParentObject.extent_of_digitization&quot;, cond: :string_eq, searchable: true, options: [&quot;Completely digitized&quot;, &quot;Partially digitized&quot;], orderable: true },</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="39">
          
          
          <code class="ruby">      digitization_note: { source: &quot;ParentObject.digitization_note&quot;, cond: :like, searchable: true, orderable: true },</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="40">
          
          
          <code class="ruby">      project_identifier: { source: &quot;ParentObject.project_identifier&quot;, searchable: true, orderable: true }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="41">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="42">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby">  # rubocop: enable Metrics/MethodLength</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby">  # rubocop:disable Rails/OutputSafety,Metrics/MethodLength</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="46">
          
          
          <code class="ruby">  def data</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="47">
          
          
          <code class="ruby">    records.map do |parent_object|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="48">
          
          
          <code class="ruby">      {</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="49">
          
          
          <code class="ruby">        oid: oid_column(parent_object).html_safe,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="50">
          
          
          <code class="ruby">        admin_set: parent_object.admin_set.key,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="51">
          
          
          <code class="ruby">        authoritative_source: parent_object.source_name,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="52">
          
          
          <code class="ruby">        child_object_count: parent_object.child_object_count,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="53">
          
          
          <code class="ruby">        call_number: parent_object.call_number,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="54">
          
          
          <code class="ruby">        container_grouping: parent_object.container_grouping,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="55">
          
          
          <code class="ruby">        bib: parent_object.bib,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="56">
          
          
          <code class="ruby">        holding: parent_object.holding,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="57">
          
          
          <code class="ruby">        item: parent_object.item,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="58">
          
          
          <code class="ruby">        barcode: parent_object.barcode,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="59">
          
          
          <code class="ruby">        aspace_uri: parent_object.aspace_uri,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="60">
          
          
          <code class="ruby">        digital_object_source: parent_object.digital_object_source,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="61">
          
          
          <code class="ruby">        preservica_uri: parent_object.preservica_uri,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="62">
          
          
          <code class="ruby">        last_ladybird_update: parent_object.last_ladybird_update,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="63">
          
          
          <code class="ruby">        last_voyager_update: parent_object.last_voyager_update,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="64">
          
          
          <code class="ruby">        last_aspace_update: parent_object.last_aspace_update,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="65">
          
          
          <code class="ruby">        last_id_update: parent_object.last_id_update,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="66">
          
          
          <code class="ruby">        visibility: parent_object.visibility,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="67">
          
          
          <code class="ruby">        extent_of_digitization: parent_object.extent_of_digitization,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="68">
          
          
          <code class="ruby">        digitization_note: parent_object.digitization_note,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="69">
          
          
          <code class="ruby">        DT_RowId: parent_object.oid,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="70">
          
          
          <code class="ruby">        project_identifier: parent_object.project_identifier</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="71">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="72">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="73">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby">  # rubocop:enable Rails/OutputSafety,Metrics/MethodLength</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="75">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="76">
          
          
          <code class="ruby">  def oid_column(parent_object)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="77">
          
          
          <code class="ruby">    result = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="78">
          
          
          <code class="ruby">    result &lt;&lt; link_to(parent_object.oid, parent_object_path(parent_object))</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="79">
          
          
          <code class="ruby">    result &lt;&lt; with_icon(&#39;fa fa-pencil-alt&#39;, edit_parent_object_path(parent_object)) if @current_ability.can? :edit, parent_object</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="80">
          
          
          <code class="ruby">    result &lt;&lt; with_icon(&#39;fa fa-eye&#39;, parent_object.dl_show_url, target: :_blank)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="81">
          
          
          <code class="ruby">    result.join(&#39; &#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="82">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="83">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="84">
          
          
          <code class="ruby">  def with_icon(class_name, path, options = {})</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="85">
          
          
          <code class="ruby">    link_to(path, options) do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="86">
          
          
          <code class="ruby">      content_tag(:i, &#39;&#39;, class: class_name)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="87">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="88">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="89">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="90">
          
          
          <code class="ruby">  def get_raw_records # rubocop:disable Naming/AccessorMethodName</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="91">
          
          
          <code class="ruby">    ParentObject.accessible_by(@current_ability, :read).joins(:authoritative_metadata_source, :admin_set).where(&quot;visibility != &#39;Redirect&#39;&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="92">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="93">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="8bb3c008a511724983479744eec825f3ea67ee7e">
  <div class="header">
    <h3>app/datatables/preservica_ingest_datatable.rb</h3>
    <h4><span class="red">0.0 %</span> covered</h4>
    <div>
      <b>34</b> relevant lines. 
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>34</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># frozen_string_literal: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="3">
          
          
          <code class="ruby">class PreservicaIngestDatatable &lt; AjaxDatatablesRails::ActiveRecord</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="4">
          
          
          <code class="ruby">  extend Forwardable</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="6">
          
          
          <code class="ruby">  def_delegators :@view</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="8">
          
          
          <code class="ruby">  def initialize(params, opts = {})</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="9">
          
          
          <code class="ruby">    @view = opts[:view_context]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">    @current_ability = opts[:current_ability]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="11">
          
          
          <code class="ruby">    super</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="14">
          
          
          <code class="ruby">  def view_columns</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">    # Declare strings in this format: ModelName.column_name</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">    # or in aliased_join_table.column_name format</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="17">
          
          
          <code class="ruby">    @view_columns ||= {</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">      parent_oid: { source: &quot;PreservicaIngest.parent_oid&quot;, searchable: true, orderable: true },</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="19">
          
          
          <code class="ruby">      child_oid: { source: &quot;PreservicaIngest.child_oid&quot;, searchable: true, orderable: true },</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="20">
          
          
          <code class="ruby">      parent_preservica_id: { source: &quot;PreservicaIngest.preservica_id&quot;, searchable: true, orderable: false },</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="21">
          
          
          <code class="ruby">      child_preservica_id: { source: &quot;PreservicaIngest.preservica_id&quot;, searchable: true, orderable: false },</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="22">
          
          
          <code class="ruby">      batch_process_id: { source: &quot;PreservicaIngest.batch_process_id&quot;, searchable: true, orderable: true },</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="23">
          
          
          <code class="ruby">      timestamp: { source: &quot;PreservicaIngest.ingest_time&quot;, orderable: true }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="24">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="25">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="27">
          
          
          <code class="ruby">  def data</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="28">
          
          
          <code class="ruby">    records.map do |preservica_ingest|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="29">
          
          
          <code class="ruby">      {</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="30">
          
          
          <code class="ruby">        parent_oid: preservica_ingest.parent_oid,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="31">
          
          
          <code class="ruby">        child_oid: preservica_ingest.child_oid,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="32">
          
          
          <code class="ruby">        parent_preservica_id: preservica_ingest.preservica_id,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="33">
          
          
          <code class="ruby">        child_preservica_id: preservica_ingest.preservica_child_id,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="34">
          
          
          <code class="ruby">        batch_process_id: preservica_ingest.batch_process_id,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="35">
          
          
          <code class="ruby">        timestamp: preservica_ingest.ingest_time</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="36">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="37">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="38">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="40">
          
          
          <code class="ruby">  def get_raw_records # rubocop:disable Naming/AccessorMethodName</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="41">
          
          
          <code class="ruby">    PreservicaIngest.accessible_by(@current_ability, :read)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="42">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="43">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="22bebc02d913dd3afcb6c9101215cb4300073835">
  <div class="header">
    <h3>app/datatables/redirected_parent_object_datatable.rb</h3>
    <h4><span class="red">0.0 %</span> covered</h4>
    <div>
      <b>46</b> relevant lines. 
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>46</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># frozen_string_literal: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="3">
          
          
          <code class="ruby">class RedirectedParentObjectDatatable &lt; AjaxDatatablesRails::ActiveRecord</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="4">
          
          
          <code class="ruby">  extend Forwardable</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="6">
          
          
          <code class="ruby">  def_delegators :@view, :link_to, :parent_object_path, :edit_parent_object_path, :content_tag</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="8">
          
          
          <code class="ruby">  def initialize(params, opts = {})</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="9">
          
          
          <code class="ruby">    @view = opts[:view_context]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">    @current_ability = opts[:current_ability]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="11">
          
          
          <code class="ruby">    @set_keys = AdminSet.order(:key).distinct.pluck(:key)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">    super</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">  # rubocop:disable Metrics/MethodLength</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="16">
          
          
          <code class="ruby">  def view_columns</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">    # Declare strings in this format: ModelName.column_name</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">    # or in aliased_join_table.column_name format</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="19">
          
          
          <code class="ruby">    @view_columns ||= {</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="20">
          
          
          <code class="ruby">      oid: { source: &quot;ParentObject.oid&quot;, cond: :start_with, searchable: true, orderable: true },</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="21">
          
          
          <code class="ruby">      admin_set: { source: &quot;AdminSet.key&quot;, cond: :string_eq, searchable: true, options: @set_keys, orderable: true },</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="22">
          
          
          <code class="ruby">      authoritative_source: { source: &quot;MetadataSource.metadata_cloud_name&quot;, cond: :string_eq, searchable: true, options: [&quot;ladybird&quot;, &quot;aspace&quot;, &quot;ils&quot;], orderable: true },</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="23">
          
          
          <code class="ruby">      visibility: { source: &quot;ParentObject.visibility&quot;, cond: :string_eq, searchable: true, orderable: true },</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="24">
          
          
          <code class="ruby">      redirect_to: { source: &quot;ParentObject.redirect_to&quot;, searchable: true, orderable: true }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="25">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="26">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">  # rubocop: enable Metrics/MethodLength</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">  # rubocop:disable Rails/OutputSafety,Metrics/MethodLength</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="30">
          
          
          <code class="ruby">  def data</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="31">
          
          
          <code class="ruby">    records.map do |parent_object|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="32">
          
          
          <code class="ruby">      {</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="33">
          
          
          <code class="ruby">        oid: oid_column(parent_object).html_safe,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="34">
          
          
          <code class="ruby">        admin_set: parent_object.admin_set.key,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="35">
          
          
          <code class="ruby">        authoritative_source: parent_object.source_name,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="36">
          
          
          <code class="ruby">        visibility: parent_object.visibility,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="37">
          
          
          <code class="ruby">        DT_RowId: parent_object.oid,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="38">
          
          
          <code class="ruby">        redirect_to: parent_object.redirect_to</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="39">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="40">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="41">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">  # rubocop:enable Rails/OutputSafety,Metrics/MethodLength</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="44">
          
          
          <code class="ruby">  def oid_column(parent_object)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="45">
          
          
          <code class="ruby">    result = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="46">
          
          
          <code class="ruby">    result &lt;&lt; link_to(parent_object.oid, parent_object_path(parent_object))</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="47">
          
          
          <code class="ruby">    result &lt;&lt; with_icon(&#39;fa fa-pencil-alt&#39;, edit_parent_object_path(parent_object)) if @current_ability.can? :edit, parent_object</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="48">
          
          
          <code class="ruby">    result &lt;&lt; with_icon(&#39;fa fa-eye&#39;, parent_object.dl_show_url, target: :_blank)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="49">
          
          
          <code class="ruby">    result.join(&#39; &#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="50">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="52">
          
          
          <code class="ruby">  def with_icon(class_name, path, options = {})</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="53">
          
          
          <code class="ruby">    link_to(path, options) do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="54">
          
          
          <code class="ruby">      content_tag(:i, &#39;&#39;, class: class_name)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="55">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="56">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="58">
          
          
          <code class="ruby">  def get_raw_records # rubocop:disable Naming/AccessorMethodName</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="59">
          
          
          <code class="ruby">    ParentObject.accessible_by(@current_ability, :read).joins(:authoritative_metadata_source, :admin_set).where(&quot;redirect_to != &#39;&#39;&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="60">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="61">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="f5dba6404cb6d24f2e5e0c2c2e91c05edecd093f">
  <div class="header">
    <h3>app/datatables/reoccurring_job_datatable.rb</h3>
    <h4><span class="red">0.0 %</span> covered</h4>
    <div>
      <b>35</b> relevant lines. 
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>35</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># frozen_string_literal: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="3">
          
          
          <code class="ruby">class ReoccurringJobDatatable &lt; AjaxDatatablesRails::ActiveRecord</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="4">
          
          
          <code class="ruby">  extend Forwardable</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="6">
          
          
          <code class="ruby">  def_delegators :@view, :link_to, :reoccurring_jobs_path</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="8">
          
          
          <code class="ruby">  def initialize(params, opts = {})</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="9">
          
          
          <code class="ruby">    @view = opts[:view_context]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">    super</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="11">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby">  def view_columns</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">    # Declare strings in this format: ModelName.column_name</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">    # or in aliased_join_table.column_name format</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="16">
          
          
          <code class="ruby">    @view_columns ||= {</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="17">
          
          
          <code class="ruby">      process_id: { source: &quot;ActivityStreamLog.id&quot;, cond: :eq, orderable: true },</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">      run_time: { source: &quot;ActivityStreamLog.run_time&quot;, cond: :start_with, orderable: true },</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="19">
          
          
          <code class="ruby">      items: { source: &quot;ActivityStreamLog.activity_stream_items&quot;, cond: :like, orderable: true },</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="20">
          
          
          <code class="ruby">      status: { source: &quot;ActivityStreamLog.status&quot;, searchable: false, orderable: true },</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="21">
          
          
          <code class="ruby">      created: { source:  &quot;ActivityStreamLog.created_at&quot;, searchable: false, orderable: true },</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="22">
          
          
          <code class="ruby">      updated: { source:  &quot;ActivityStreamLog.updated_at&quot;, searchable: false, orderable: true },</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="23">
          
          
          <code class="ruby">      retrieved_records: { source: &quot;ActivityStreamLog.retrieved_records&quot;, orderable: true }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="24">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="25">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="27">
          
          
          <code class="ruby">  def data</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">    # rubocop:disable Rails/OutputSafety</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="29">
          
          
          <code class="ruby">    records.map do |activity_stream|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="30">
          
          
          <code class="ruby">      {</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="31">
          
          
          <code class="ruby">        process_id: activity_stream.id,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="32">
          
          
          <code class="ruby">        run_time: activity_stream.run_time,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="33">
          
          
          <code class="ruby">        items: activity_stream.activity_stream_items,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="34">
          
          
          <code class="ruby">        status: activity_stream.status,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="35">
          
          
          <code class="ruby">        created: activity_stream.created_at,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="36">
          
          
          <code class="ruby">        updated: activity_stream.updated_at,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="37">
          
          
          <code class="ruby">        retrieved_records: activity_stream.retrieved_records</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="38">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="39">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">    # rubocop:enable Rails/OutputSafety</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="41">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="43">
          
          
          <code class="ruby">  def get_raw_records # rubocop:disable Naming/AccessorMethodName</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="44">
          
          
          <code class="ruby">    ActivityStreamLog.all</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="45">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="46">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="b28c03fae835fbba1b3590ad329265f41d545298">
  <div class="header">
    <h3>app/datatables/user_datatable.rb</h3>
    <h4><span class="red">0.0 %</span> covered</h4>
    <div>
      <b>38</b> relevant lines. 
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>38</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># frozen_string_literal: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="3">
          
          
          <code class="ruby">class UserDatatable &lt; AjaxDatatablesRails::ActiveRecord</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="4">
          
          
          <code class="ruby">  extend Forwardable</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="6">
          
          
          <code class="ruby">  def_delegators :@view, :link_to, :user_path, :edit_user_path, :content_tag</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="8">
          
          
          <code class="ruby">  def initialize(params, opts = {})</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="9">
          
          
          <code class="ruby">    @view = opts[:view_context]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">    super</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="11">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby">  def view_columns</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">    # Declare strings in this format: ModelName.column_name</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">    # or in aliased_join_table.column_name format</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="16">
          
          
          <code class="ruby">    @view_columns ||= {</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="17">
          
          
          <code class="ruby">      netid: { source: &quot;User.uid&quot;, cond: :like, searchable: true, orderable: true, sort_order: &#39;asc&#39; },</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">      email: { source: &quot;User.email&quot;, cond: :like, searchable: true, orderable: true },</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="19">
          
          
          <code class="ruby">      first_name: { source: &quot;User.first_name&quot;, cond: :like, searchable: true, orderable: true },</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="20">
          
          
          <code class="ruby">      last_name: { source: &quot;User.last_name&quot;, cond: :like, searchable: true, orderable: true },</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="21">
          
          
          <code class="ruby">      system_admin: { source: &quot;User.id&quot;, cond: :null_value, searchable: false, orderable: false },</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="22">
          
          
          <code class="ruby">      deactivated: { source: &quot;User.deactivated&quot;, cond: :like, searchable: true, orderable: true, options: [{ value: true, label: &quot;Inactive&quot; }, { value: false, label: &quot;Active&quot;, selected: true }] }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="23">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="24">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="26">
          
          
          <code class="ruby">  def data</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="27">
          
          
          <code class="ruby">    records.map do |user|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="28">
          
          
          <code class="ruby">      {</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="29">
          
          
          <code class="ruby">        netid: link_to(user.uid, user_path(user)) + with_icon(&#39;fa fa-pencil-alt&#39;, edit_user_path(user)),</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="30">
          
          
          <code class="ruby">        email: user.email,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="31">
          
          
          <code class="ruby">        first_name: user.first_name,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="32">
          
          
          <code class="ruby">        last_name: user.last_name,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="33">
          
          
          <code class="ruby">        system_admin: user.sysadmin,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="34">
          
          
          <code class="ruby">        deactivated: user.deactivated ? &quot;Inactive&quot; : &quot;Active&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="35">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="36">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="37">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="39">
          
          
          <code class="ruby">  def with_icon(class_name, path, options = {})</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="40">
          
          
          <code class="ruby">    link_to(path, options) do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="41">
          
          
          <code class="ruby">      content_tag(:i, &#39;&#39;, class: class_name)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="42">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="43">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="45">
          
          
          <code class="ruby">  def get_raw_records # rubocop:disable Naming/AccessorMethodName</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="46">
          
          
          <code class="ruby">    User.all</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="47">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="48">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="2e1d9f7c0527ed02e6e63adb4a10eb13a082dc0b">
  <div class="header">
    <h3>app/helpers/admin_sets_helper.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>1</b> relevant lines. 
      <span class="green"><b>1</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># frozen_string_literal: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">module AdminSetsHelper</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="b8c6313cec3a31a656a56e8903d8f0039855c70e">
  <div class="header">
    <h3>app/helpers/application_helper.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>1</b> relevant lines. 
      <span class="green"><b>1</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># frozen_string_literal: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">module ApplicationHelper</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="9fae1db60ceb079d12800e9ccb4b4b7f647d72a2">
  <div class="header">
    <h3>app/helpers/batch_processes_helper.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>1</b> relevant lines. 
      <span class="green"><b>1</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># frozen_string_literal: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">module BatchProcessesHelper</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="c36acb1105b1855a660f08ca6bd73400bbb27f0c">
  <div class="header">
    <h3>app/helpers/json_helper.rb</h3>
    <h4><span class="red">40.0 %</span> covered</h4>
    <div>
      <b>5</b> relevant lines. 
      <span class="green"><b>2</b> lines covered</span> and
      <span class="red"><b>3</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># frozen_string_literal: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">module JsonHelper</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby">  # Note, only use this helper on trusted, known JSON sources, since we are declaring the output as html_safe</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">  def formatted_json(json)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="6">
          
          
          <code class="ruby">    json = JSON.pretty_generate(json)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="7">
          
          
          <code class="ruby">    html = CodeRay.scan(json, :json).div</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="8">
          
          
          <code class="ruby">    html.html_safe</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="1f31b9ed0a13fcea49b6205180709c64cd8f1ed6">
  <div class="header">
    <h3>app/helpers/users_helper.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>1</b> relevant lines. 
      <span class="green"><b>1</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># frozen_string_literal: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">module UsersHelper</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="9ccd2405b73add10fffff1231088f0218c1527d7">
  <div class="header">
    <h3>app/jobs/activity_stream_job.rb</h3>
    <h4><span class="red">0.0 %</span> covered</h4>
    <div>
      <b>6</b> relevant lines. 
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>6</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># frozen_string_literal: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="3">
          
          
          <code class="ruby">class ActivityStreamJob &lt; ApplicationJob</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="4">
          
          
          <code class="ruby">  repeat &#39;every day at 1am&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="6">
          
          
          <code class="ruby">  def perform</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="7">
          
          
          <code class="ruby">    ActivityStreamReader.update unless ActivityStreamLog.where(status: &quot;Running&quot;).exists?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="8">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="9">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="18561932383e1f412256f80a3e17be42ccacb2f2">
  <div class="header">
    <h3>app/jobs/activity_stream_manual_job.rb</h3>
    <h4><span class="red">0.0 %</span> covered</h4>
    <div>
      <b>5</b> relevant lines. 
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>5</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># frozen_string_literal: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"># A separate job is needed for manual run, or it will enqueue itself again after it has finished</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="4">
          
          
          <code class="ruby">class ActivityStreamManualJob &lt; ApplicationJob</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="5">
          
          
          <code class="ruby">  def perform</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="6">
          
          
          <code class="ruby">    ActivityStreamReader.update unless ActivityStreamLog.where(status: &quot;Running&quot;).exists?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="7">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="8">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="1967e7cc678c57df31119f8de6b17d4923c2e716">
  <div class="header">
    <h3>app/jobs/add_extent_of_digitization_to_parent_objects_job.rb</h3>
    <h4><span class="red">0.0 %</span> covered</h4>
    <div>
      <b>12</b> relevant lines. 
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>12</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># frozen_string_literal: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"># TODO: this is a onetime thing for a data migration</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby"># it can be removed after 4/1/2021</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="5">
          
          
          <code class="ruby">class AddExtentOfDigitizationToParentObjectsJob &lt; ApplicationJob</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="6">
          
          
          <code class="ruby">  queue_as :default</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="8">
          
          
          <code class="ruby">  def default_priority</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="9">
          
          
          <code class="ruby">    -100</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">  def perform(*_args)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby">    ParentObject.where(extent_of_digitization: nil).find_each do |parent|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="14">
          
          
          <code class="ruby">      parent.extent_of_digitization = parent.normalize_extent_of_digitization</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="15">
          
          
          <code class="ruby">      parent.save!</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="16">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="17">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="09de5d45923ed6ab78a5c59ec4408d8989b99832">
  <div class="header">
    <h3>app/jobs/add_rights_to_parent_objects_job.rb</h3>
    <h4><span class="red">0.0 %</span> covered</h4>
    <div>
      <b>12</b> relevant lines. 
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>12</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># frozen_string_literal: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"># TODO: this is a onetime thing for a data migration</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby"># it can be removed after 3/1/2021</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="5">
          
          
          <code class="ruby">class AddRightsToParentObjectsJob &lt; ApplicationJob</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="6">
          
          
          <code class="ruby">  queue_as :default</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="8">
          
          
          <code class="ruby">  def default_priority</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="9">
          
          
          <code class="ruby">    -100</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">  def perform(*_args)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby">    ParentObject.where(rights_statement: nil).find_each do |parent|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="14">
          
          
          <code class="ruby">      parent.rights_statement = parent.ladybird_json&amp;.[](&quot;rights&quot;)&amp;.first</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="15">
          
          
          <code class="ruby">      parent.save!</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="16">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="17">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="b8e823a678581b4974f1fbf215219e4072f84827">
  <div class="header">
    <h3>app/jobs/application_job.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>5</b> relevant lines. 
      <span class="green"><b>5</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># frozen_string_literal: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">class ApplicationJob &lt; ActiveJob::Base</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby">  # Automatically retry jobs that encountered a deadlock</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby">  # retry_on ActiveRecord::Deadlocked</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">  # Most jobs are safe to ignore if the underlying records are no longer available</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">  # discard_on ActiveJob::DeserializationError</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">  # Override default_priority  to set the default priority for a job w/o sacrificing the ability</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">  # to set priority at run time via `Job.set(priority: 55).perform_later`</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>
          
          <code class="ruby">  def default_priority</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="13">
          <span class="hits">12</span>
          
          <code class="ruby">    0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">  def priority</code>
        </li>
      
        <li class="covered" data-hits="14" data-linenumber="17">
          <span class="hits">14</span>
          
          <code class="ruby">    @priority || default_priority</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="3f7db38c3aa6c92ed23cfd45505377d634c185ab">
  <div class="header">
    <h3>app/jobs/create_child_oid_csv_job.rb</h3>
    <h4><span class="red">0.0 %</span> covered</h4>
    <div>
      <b>9</b> relevant lines. 
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>9</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># frozen_string_literal: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="3">
          
          
          <code class="ruby">class CreateChildOidCsvJob &lt; ApplicationJob</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="4">
          
          
          <code class="ruby">  queue_as :default</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="6">
          
          
          <code class="ruby">  def default_priority</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="7">
          
          
          <code class="ruby">    -100</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="8">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">  def perform(batch_process)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="11">
          
          
          <code class="ruby">    batch_process.child_output_csv</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="d4369abb634be67a41b8d1d9f4db662d1ebc9688">
  <div class="header">
    <h3>app/jobs/create_new_parent_job.rb</h3>
    <h4><span class="red">0.0 %</span> covered</h4>
    <div>
      <b>9</b> relevant lines. 
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>9</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># frozen_string_literal: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="3">
          
          
          <code class="ruby">class CreateNewParentJob &lt; ApplicationJob</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="4">
          
          
          <code class="ruby">  queue_as :default</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="6">
          
          
          <code class="ruby">  def default_priority</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="7">
          
          
          <code class="ruby">    -50</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="8">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">  def perform(batch_process)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="11">
          
          
          <code class="ruby">    batch_process.create_new_parent_csv</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="ef79036001b6348d7f8a4a46e0c625a7b06638e0">
  <div class="header">
    <h3>app/jobs/create_parent_oid_csv_job.rb</h3>
    <h4><span class="red">0.0 %</span> covered</h4>
    <div>
      <b>9</b> relevant lines. 
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>9</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># frozen_string_literal: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="3">
          
          
          <code class="ruby">class CreateParentOidCsvJob &lt; ApplicationJob</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="4">
          
          
          <code class="ruby">  queue_as :default</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="6">
          
          
          <code class="ruby">  def default_priority</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="7">
          
          
          <code class="ruby">    -100</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="8">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">  def perform(batch_process, *admin_set_id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="11">
          
          
          <code class="ruby">    batch_process.parent_output_csv(*admin_set_id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="00f43bcf15d0a7b8121f83196a2e08196673b3f4">
  <div class="header">
    <h3>app/jobs/delete_child_objects_job.rb</h3>
    <h4><span class="red">0.0 %</span> covered</h4>
    <div>
      <b>9</b> relevant lines. 
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>9</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># frozen_string_literal: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="3">
          
          
          <code class="ruby">class DeleteChildObjectsJob &lt; ApplicationJob</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="4">
          
          
          <code class="ruby">  queue_as :default</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="6">
          
          
          <code class="ruby">  def default_priority</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="7">
          
          
          <code class="ruby">    -50</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="8">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">  def perform(batch_process)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="11">
          
          
          <code class="ruby">    batch_process.delete_child_objects</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="7f44b38764737b76334454d73dab7400d185f019">
  <div class="header">
    <h3>app/jobs/delete_parent_objects_job.rb</h3>
    <h4><span class="red">0.0 %</span> covered</h4>
    <div>
      <b>9</b> relevant lines. 
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>9</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># frozen_string_literal: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="3">
          
          
          <code class="ruby">class DeleteParentObjectsJob &lt; ApplicationJob</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="4">
          
          
          <code class="ruby">  queue_as :default</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="6">
          
          
          <code class="ruby">  def default_priority</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="7">
          
          
          <code class="ruby">    -50</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="8">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">  def perform(batch_process)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="11">
          
          
          <code class="ruby">    batch_process.delete_parent_objects</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="c4a6cf0a70b3f70b69e5cb66ba44aa4dba5ad825">
  <div class="header">
    <h3>app/jobs/generate_manifest_job.rb</h3>
    <h4><span class="red">0.0 %</span> covered</h4>
    <div>
      <b>30</b> relevant lines. 
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>30</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># frozen_string_literal: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="3">
          
          
          <code class="ruby">class GenerateManifestJob &lt; ApplicationJob</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="4">
          
          
          <code class="ruby">  queue_as :manifest</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="6">
          
          
          <code class="ruby">  def default_priority</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="7">
          
          
          <code class="ruby">    -30</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="8">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">  def perform(parent_object, current_batch_process, current_batch_connection = parent_object.current_batch_connection)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="11">
          
          
          <code class="ruby">    parent_object.current_batch_process = current_batch_process</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">    parent_object.current_batch_connection = current_batch_connection</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby">    if parent_object.should_create_manifest_and_pdf?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="14">
          
          
          <code class="ruby">      generate_manifest(parent_object)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="15">
          
          
          <code class="ruby">      parent_object.save</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="16">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="17">
          
          
          <code class="ruby">    parent_object.solr_index_job</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">    GeneratePdfJob.perform_later(parent_object, current_batch_process, current_batch_connection) if parent_object.should_create_manifest_and_pdf?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="19">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="21">
          
          
          <code class="ruby">  def generate_manifest(parent_object)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">    # generate iiif manifest and save it to s3</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="23">
          
          
          <code class="ruby">    upload = parent_object.iiif_presentation.save</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="24">
          
          
          <code class="ruby">    if upload</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="25">
          
          
          <code class="ruby">      parent_object.processing_event(&quot;IIIF Manifest saved to S3&quot;, &quot;manifest-saved&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="26">
          
          
          <code class="ruby">      parent_object.generate_manifest = false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">      # Once we have successfully created all the ptiffs &amp; created the manifest,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">      # we should no longer need access to the original Goobi package, and should create any further</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">      # artifacts from the more persistent data available through the MetadataCloud, database, and access masters</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="30">
          
          
          <code class="ruby">      parent_object.from_mets = false</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="31">
          
          
          <code class="ruby">      parent_object.save!</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="32">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="33">
          
          
          <code class="ruby">      parent_object.processing_event(&quot;IIIF Manifest not saved to S3&quot;, &quot;failed&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="34">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="35">
          
          
          <code class="ruby">  rescue =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="36">
          
          
          <code class="ruby">    parent_object.processing_event(&quot;IIIF Manifest generation failed due to #{e.message}&quot;, &quot;failed&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="37">
          
          
          <code class="ruby">    raise # this reraises the error after we document it</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="38">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="39">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="554c6a3cc942c45b3e1b21b8fb02696154f8760f">
  <div class="header">
    <h3>app/jobs/generate_output_csv_job.rb</h3>
    <h4><span class="red">0.0 %</span> covered</h4>
    <div>
      <b>12</b> relevant lines. 
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>12</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># frozen_string_literal: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="3">
          
          
          <code class="ruby">class GenerateOutputCsvJob &lt; ApplicationJob</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="4">
          
          
          <code class="ruby">  queue_as :default</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="6">
          
          
          <code class="ruby">  def default_priority</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="7">
          
          
          <code class="ruby">    -100</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="8">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">  def perform(batch_process)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="11">
          
          
          <code class="ruby">    batch_process.child_output_csv</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">  rescue =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby">    batch_process.batch_processing_event(&quot;Setup job failed to save: #{e.message}&quot;, &quot;failed&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="14">
          
          
          <code class="ruby">    raise # this reraises the error after we document it</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="15">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="16">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="4a4152c875b27d060019fe9d0471187e1e3798c8">
  <div class="header">
    <h3>app/jobs/generate_pdf_job.rb</h3>
    <h4><span class="red">0.0 %</span> covered</h4>
    <div>
      <b>16</b> relevant lines. 
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>16</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># frozen_string_literal: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="3">
          
          
          <code class="ruby">class GeneratePdfJob &lt; ApplicationJob</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="4">
          
          
          <code class="ruby">  queue_as :pdf</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="6">
          
          
          <code class="ruby">  def default_priority</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="7">
          
          
          <code class="ruby">    50</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="8">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">  def perform(parent_object, current_batch_process = parent_object.current_batch_process, current_batch_connection = parent_object.current_batch_connection)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="11">
          
          
          <code class="ruby">    return unless parent_object.should_create_manifest_and_pdf?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">    parent_object.current_batch_process = current_batch_process</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby">    parent_object.current_batch_connection = current_batch_connection</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="14">
          
          
          <code class="ruby">    parent_object.generate_pdf</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="15">
          
          
          <code class="ruby">    parent_object.processing_event(&quot;PDF has been generated&quot;, &quot;pdf-generated&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="16">
          
          
          <code class="ruby">  rescue =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="17">
          
          
          <code class="ruby">    parent_object.processing_event(&quot;Unable to generate PDF, #{e.message}&quot;, &quot;failed&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">    raise</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="19">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="20">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="d0c9bb9e11fcc8d3fced176b27863c8b4160e903">
  <div class="header">
    <h3>app/jobs/generate_ptiff_job.rb</h3>
    <h4><span class="green">94.44 %</span> covered</h4>
    <div>
      <b>18</b> relevant lines. 
      <span class="green"><b>17</b> lines covered</span> and
      <span class="red"><b>1</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># frozen_string_literal: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">class GeneratePtiffJob &lt; ApplicationJob</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  queue_as :ptiff</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">  def default_priority</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="7">
          <span class="hits">2</span>
          
          <code class="ruby">    10</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="10">
          <span class="hits">1</span>
          
          <code class="ruby">  def perform(child_object, batch_process)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="11">
          <span class="hits">2</span>
          
          <code class="ruby">    return if child_object.nil?</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="12">
          <span class="hits">2</span>
          
          <code class="ruby">    child_object.current_batch_process = batch_process</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="13">
          <span class="hits">2</span>
          
          <code class="ruby">    child_object.current_batch_connection = batch_process&amp;.batch_connections&amp;.find_or_create_by(connectable: child_object)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="14">
          <span class="hits">2</span>
          
          <code class="ruby">    parent_object = child_object.parent_object</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="15">
          <span class="hits">2</span>
          
          <code class="ruby">    parent_object.current_batch_process = batch_process</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="16">
          <span class="hits">2</span>
          
          <code class="ruby">    parent_object.current_batch_connection = batch_process&amp;.batch_connections&amp;.find_or_create_by(connectable: parent_object)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">    # TODO: Uncomment the line below to re-implement Goobi ingest and copy to the access master pair-tree.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">    # There is a test in spec/models/batch_process_spec.rb that should fail, take out the &quot;pending&quot; and logger</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">    # mocks there to see if it passes</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="21">
          <span class="hits">2</span>
          
          <code class="ruby">    if child_object.parent_object.from_mets</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="22">
          
          
          <code class="ruby">      raise &quot;Copy to pair tree failed for child object: #{child_object.oid}&quot; unless child_object.copy_to_access_master_pairtree</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="24">
          <span class="hits">2</span>
          
          <code class="ruby">    is_recreate_job = child_object.current_batch_process&amp;.batch_action == &#39;recreate child oid ptiffs&#39;</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="25">
          <span class="hits">2</span>
          
          <code class="ruby">    success = child_object.convert_to_ptiff!(is_recreate_job)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="26">
          <span class="hits">2</span>
          
          <code class="ruby">    raise &quot;Unable to convert to PTIFF and save child object: #{child_object.oid}&quot; unless success</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">    # Only generate manifest if all children are ready</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="28">
          <span class="hits">2</span>
          
          <code class="ruby">    GenerateManifestJob.perform_later(parent_object, parent_object.current_batch_process, parent_object.current_batch_connection) if parent_object.needs_a_manifest?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="30">
          <span class="hits">2</span>
          
          <code class="ruby">    parent_object.processing_event(&#39;Ptiffs recreated&#39;, &#39;ptiffs-recreated&#39;) if is_recreate_job &amp;&amp; batch_process.are_all_children_complete?(parent_object)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="2c2beef6211dc4dcdd5daf24012f7eba325edeee">
  <div class="header">
    <h3>app/jobs/mets_directory_scan_job.rb</h3>
    <h4><span class="red">0.0 %</span> covered</h4>
    <div>
      <b>9</b> relevant lines. 
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>9</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># frozen_string_literal: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"># Very simple job.  Scan needs to occur in a job so that the mounts are available</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="4">
          
          
          <code class="ruby">class MetsDirectoryScanJob &lt; ApplicationJob</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="5">
          
          
          <code class="ruby">  queue_as :default</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">  # Low priority, TODO: reconsider priority</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="8">
          
          
          <code class="ruby">  def default_priority</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="9">
          
          
          <code class="ruby">    100</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">  def perform</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby">    MetsDirectoryScanner.perform_scan</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="14">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="15">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="181fa2ed0eff77202ce9e6631074e6c7019f4972">
  <div class="header">
    <h3>app/jobs/reassociate_child_oids_job.rb</h3>
    <h4><span class="red">0.0 %</span> covered</h4>
    <div>
      <b>11</b> relevant lines. 
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>11</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># frozen_string_literal: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="3">
          
          
          <code class="ruby">class ReassociateChildOidsJob &lt; ApplicationJob</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="4">
          
          
          <code class="ruby">  queue_as :default</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="6">
          
          
          <code class="ruby">  def default_priority</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="7">
          
          
          <code class="ruby">    -100</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="8">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">  def perform(batch_process)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="11">
          
          
          <code class="ruby">    batch_process.reassociate_child_oids</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">  rescue =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby">    batch_process.batch_processing_event(&quot;ReassociateChildOidsJob failed due to #{e.message}&quot;, &quot;failed&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="14">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="15">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="a90d3e8237ae1f8a44fbec25625145591481dd69">
  <div class="header">
    <h3>app/jobs/recreate_child_oid_ptiffs_job.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>6</b> relevant lines. 
      <span class="green"><b>6</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># frozen_string_literal: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">class RecreateChildOidPtiffsJob &lt; ApplicationJob</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  queue_as :default</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">  def default_priority</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">    9</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="10">
          <span class="hits">1</span>
          
          <code class="ruby">  def perform(batch_process)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="11">
          <span class="hits">2</span>
          
          <code class="ruby">    batch_process.recreate_child_oid_ptiffs</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="1a0b6fa617d46db6f36ca67868484a7310696d21">
  <div class="header">
    <h3>app/jobs/setup_metadata_job.rb</h3>
    <h4><span class="red">15.56 %</span> covered</h4>
    <div>
      <b>45</b> relevant lines. 
      <span class="green"><b>7</b> lines covered</span> and
      <span class="red"><b>38</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># frozen_string_literal: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">class SetupMetadataJob &lt; ApplicationJob</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  queue_as :metadata</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">  ONE_GB = 1_073_741_824</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">  def perform(parent_object, current_batch_process, current_batch_connection = parent_object.current_batch_connection)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="8">
          
          
          <code class="ruby">    parent_object.current_batch_process = current_batch_process</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="9">
          
          
          <code class="ruby">    parent_object.current_batch_connection = current_batch_connection</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">    return if redirect(parent_object)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="11">
          
          
          <code class="ruby">    parent_object.generate_manifest = true</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">    mets_images_present = check_mets_images(parent_object, current_batch_process, current_batch_connection)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby">    unless mets_images_present</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="14">
          
          
          <code class="ruby">      parent_object.processing_event(&quot;SetupMetadataJob failed to find all images.&quot;, &quot;failed&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="15">
          
          
          <code class="ruby">      return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="17">
          
          
          <code class="ruby">    unless parent_object.default_fetch(current_batch_process, current_batch_connection)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">      # Don&#39;t retry in this case. default_fetch() will throw an exception if it&#39;s a network error and trigger retry</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="19">
          
          
          <code class="ruby">      parent_object.processing_event(&quot;SetupMetadataJob failed to retrieve authoritative metadata. [#{parent_object.metadata_cloud_url}]&quot;, &quot;failed&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="20">
          
          
          <code class="ruby">      return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="22">
          
          
          <code class="ruby">    setup_child_object_jobs(parent_object, current_batch_process)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">  rescue =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="24">
          
          
          <code class="ruby">    parent_object.processing_event(&quot;Setup job failed to save: #{e.message}&quot;, &quot;failed&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="25">
          
          
          <code class="ruby">    raise # this reraises the error after we document it</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">  # index and return true if parent is a redirect</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="29">
          <span class="hits">1</span>
          
          <code class="ruby">  def redirect(parent_object)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="30">
          
          
          <code class="ruby">    if parent_object.redirect_to.present?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="31">
          
          
          <code class="ruby">      parent_object.solr_index</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="32">
          
          
          <code class="ruby">      true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="34">
          
          
          <code class="ruby">      false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="38">
          <span class="hits">1</span>
          
          <code class="ruby">  def check_mets_images(parent_object, current_batch_process, _current_batch_connection)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="39">
          
          
          <code class="ruby">    if parent_object.from_mets</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="40">
          
          
          <code class="ruby">      current_batch_process.mets_doc.all_images_present?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="42">
          
          
          <code class="ruby">      true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby">  # rubocop:disable Metrics/MethodLength</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby">  # rubocop:disable Metrics/AbcSize</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby">  # rubocop:disable Metrics/CyclomaticComplexity</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">  # rubocop:disable Metrics/PerceivedComplexity</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="50">
          <span class="hits">1</span>
          
          <code class="ruby">  def setup_child_object_jobs(parent_object, current_batch_process)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="51">
          
          
          <code class="ruby">    parent_object.create_child_records if parent_object.from_upstream_for_the_first_time?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="52">
          
          
          <code class="ruby">    parent_object.save!</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="53">
          
          
          <code class="ruby">    parent_object.processing_event(&quot;Child object records have been created&quot;, &quot;child-records-created&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="54">
          
          
          <code class="ruby">    ptiff_jobs_queued = false</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="55">
          
          
          <code class="ruby">    parent_object.child_objects.each do |child|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="56">
          
          
          <code class="ruby">      parent_object.current_batch_process&amp;.setup_for_background_jobs(child, nil)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="57">
          
          
          <code class="ruby">      if child.pyramidal_tiff.height_and_width? &amp;&amp; S3Service.s3_exists?(child.remote_ptiff_path)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="58">
          
          
          <code class="ruby">        child.processing_event(&quot;PTIFF exists on S3, not converting: #{child.oid}&quot;, &#39;ptiff-ready-skipped&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="60">
          
          
          <code class="ruby">        path = Pathname.new(child.access_master_path)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="61">
          
          
          <code class="ruby">        file_size = File.exist?(path) ? File.size(path) : 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="62">
          
          
          <code class="ruby">        GeneratePtiffJob.set(queue: :large_ptiff).perform_later(child, current_batch_process) if file_size &gt; ONE_GB</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="63">
          
          
          <code class="ruby">        GeneratePtiffJob.perform_later(child, current_batch_process) if file_size &lt;= ONE_GB</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="64">
          
          
          <code class="ruby">        child.processing_event(&quot;Ptiff Queued&quot;, &quot;ptiff-queued&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="65">
          
          
          <code class="ruby">        ptiff_jobs_queued = true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="68">
          
          
          <code class="ruby">    unless ptiff_jobs_queued</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="69">
          
          
          <code class="ruby">      GenerateManifestJob.perform_later(parent_object, parent_object.current_batch_process, parent_object.current_batch_connection) if parent_object.needs_a_manifest?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby">  rescue =&gt; child_create_error</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="72">
          
          
          <code class="ruby">    parent_object.processing_event(child_create_error.message, &quot;failed&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby">  # rubocop:enable Metrics/MethodLength</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="75">
          
          
          <code class="ruby">  # rubocop:enable Metrics/AbcSize</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="76">
          
          
          <code class="ruby">  # rubocop:enable Metrics/CyclomaticComplexity</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby">  # rubocop:enable Metrics/PerceivedComplexity</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="bff33abfa2cd3d4ff9579bed67fd7658a433f230">
  <div class="header">
    <h3>app/jobs/solr_index_job.rb</h3>
    <h4><span class="red">0.0 %</span> covered</h4>
    <div>
      <b>11</b> relevant lines. 
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>11</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># frozen_string_literal: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="3">
          
          
          <code class="ruby">class SolrIndexJob &lt; ApplicationJob</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="4">
          
          
          <code class="ruby">  queue_as :solr_index</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="6">
          
          
          <code class="ruby">  def default_priority</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="7">
          
          
          <code class="ruby">    -50</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="8">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">  def perform(parent_object, current_batch_process = nil, current_batch_connection = parent_object.current_batch_connection)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="11">
          
          
          <code class="ruby">    parent_object.current_batch_process = current_batch_process</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">    parent_object.current_batch_connection = current_batch_connection</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby">    parent_object.solr_index</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="14">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="15">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="f39b578c0e65f8a5635746d9c9b2cf46877775a7">
  <div class="header">
    <h3>app/jobs/solr_reindex_all_job.rb</h3>
    <h4><span class="red">0.0 %</span> covered</h4>
    <div>
      <b>34</b> relevant lines. 
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>34</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># frozen_string_literal: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="3">
          
          
          <code class="ruby">class SolrReindexAllJob &lt; ApplicationJob</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="4">
          
          
          <code class="ruby">  queue_as :solr_index</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="6">
          
          
          <code class="ruby">  def self.job_limit</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="7">
          
          
          <code class="ruby">    5000</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="8">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">  def self.solr_batch_limit</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="11">
          
          
          <code class="ruby">    500</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="14">
          
          
          <code class="ruby">  def perform(start_position = 0)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="15">
          
          
          <code class="ruby">    solr = SolrService.connection</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">    # Groups of limit</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="17">
          
          
          <code class="ruby">    parent_objects = ParentObject.order(:oid).offset(start_position).limit(SolrReindexAllJob.job_limit)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">    last_job = parent_objects.count &lt; SolrReindexAllJob.job_limit</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="19">
          
          
          <code class="ruby">    if parent_objects.count.positive?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="20">
          
          
          <code class="ruby">      parent_objects.each_slice(SolrReindexAllJob.solr_batch_limit) do |parent_objects_group|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="21">
          
          
          <code class="ruby">        child_documents = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="22">
          
          
          <code class="ruby">        solr.add(parent_objects_group.map do |parent_object|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="23">
          
          
          <code class="ruby">          results, child_results = parent_object.to_solr_full_text</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="24">
          
          
          <code class="ruby">          child_documents += child_results unless child_results.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="25">
          
          
          <code class="ruby">          results</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="26">
          
          
          <code class="ruby">        end.compact)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="27">
          
          
          <code class="ruby">        solr.commit</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="28">
          
          
          <code class="ruby">        reindex_child_documents(solr, child_documents)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="29">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="30">
          
          
          <code class="ruby">      SolrReindexAllJob.perform_later(start_position + parent_objects.count) unless last_job</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="31">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="32">
          
          
          <code class="ruby">    SolrService.clean_index_orphans if last_job</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="33">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="35">
          
          
          <code class="ruby">  def reindex_child_documents(solr, child_documents)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="36">
          
          
          <code class="ruby">    child_documents.each_slice(SolrReindexAllJob.solr_batch_limit) do |child_documents_group|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="37">
          
          
          <code class="ruby">      solr.add(child_documents_group.compact)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="38">
          
          
          <code class="ruby">      solr.commit</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="39">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="40">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="41">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="bff22620fcd7d78d3ebe45eec5a5033ea81ee10f">
  <div class="header">
    <h3>app/jobs/sync_from_preservica_job.rb</h3>
    <h4><span class="red">0.0 %</span> covered</h4>
    <div>
      <b>9</b> relevant lines. 
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>9</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># frozen_string_literal: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="3">
          
          
          <code class="ruby">class SyncFromPreservicaJob &lt; ApplicationJob</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="4">
          
          
          <code class="ruby">  queue_as :default</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="6">
          
          
          <code class="ruby">  def default_priority</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="7">
          
          
          <code class="ruby">    50</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="8">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">  def perform(batch_process)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="11">
          
          
          <code class="ruby">    batch_process.sync_from_preservica</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="398c813b0f9852f93a4ef2b46114d2e6f554f1e8">
  <div class="header">
    <h3>app/jobs/update_all_metadata_job.rb</h3>
    <h4><span class="red">0.0 %</span> covered</h4>
    <div>
      <b>16</b> relevant lines. 
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>16</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># frozen_string_literal: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="3">
          
          
          <code class="ruby">class UpdateAllMetadataJob &lt; ApplicationJob</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="4">
          
          
          <code class="ruby">  queue_as :metadata</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="6">
          
          
          <code class="ruby">  def self.job_limit</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="7">
          
          
          <code class="ruby">    5000</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="8">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">  def perform(start_position = 0, where = &#39;redirect_to: nil&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="11">
          
          
          <code class="ruby">    parent_objects = ParentObject.where(where).order(:oid).offset(start_position).limit(UpdateAllMetadataJob.job_limit)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">    last_job = parent_objects.count &lt; UpdateAllMetadataJob.job_limit</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby">    return unless parent_objects.count.positive? # stop if nothing is found</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="14">
          
          
          <code class="ruby">    parent_objects.each do |po|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="15">
          
          
          <code class="ruby">      po.metadata_update = true</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="16">
          
          
          <code class="ruby">      po.setup_metadata_job</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="17">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">    UpdateAllMetadataJob.perform_later(start_position + parent_objects.count, where) unless last_job</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="19">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="20">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="cafff5f7a86b313a057477058a0d8e6a097e2c01">
  <div class="header">
    <h3>app/jobs/update_fulltext_status_job.rb</h3>
    <h4><span class="red">0.0 %</span> covered</h4>
    <div>
      <b>29</b> relevant lines. 
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>29</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># frozen_string_literal: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="3">
          
          
          <code class="ruby">class UpdateFulltextStatusJob &lt; ApplicationJob</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="4">
          
          
          <code class="ruby">  queue_as :default</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="6">
          
          
          <code class="ruby">  def default_priority</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="7">
          
          
          <code class="ruby">    50</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="8">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">  # rubocop:disable Metrics/MethodLength</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="11">
          
          
          <code class="ruby">  def perform(batch_process)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">    child_limit = 10_000</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby">    current_offset = 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="14">
          
          
          <code class="ruby">    current_limit = 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="15">
          
          
          <code class="ruby">    child_count = 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="16">
          
          
          <code class="ruby">    job_count = 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="17">
          
          
          <code class="ruby">    batch_process.oids.each_with_index do |oid, index|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">      po = ParentObject.find_by_oid(oid)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="19">
          
          
          <code class="ruby">      next unless po</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="20">
          
          
          <code class="ruby">      child_count += po.child_objects.count</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="21">
          
          
          <code class="ruby">      current_limit = index - current_offset + 1</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="22">
          
          
          <code class="ruby">      next unless child_count &gt; child_limit</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="23">
          
          
          <code class="ruby">      UpdateFulltextStatusSubJob.perform_later(batch_process, current_offset, current_limit)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="24">
          
          
          <code class="ruby">      job_count += 1</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="25">
          
          
          <code class="ruby">      current_offset = index</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="26">
          
          
          <code class="ruby">      child_count = 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="27">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="28">
          
          
          <code class="ruby">    if child_count&amp;.positive?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="29">
          
          
          <code class="ruby">      UpdateFulltextStatusSubJob.perform_later(batch_process, current_offset, current_limit)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="30">
          
          
          <code class="ruby">      job_count += 1</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="31">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="32">
          
          
          <code class="ruby">    batch_process.batch_processing_event(&quot;There were no parents to process.  No work has been completed&quot;, &quot;failed&quot;) if job_count.zero?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="33">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">  # rubocop:enable Metrics/MethodLength</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="35">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="9131f0b58ef225c8ce63dd0bab27666e4f679b9f">
  <div class="header">
    <h3>app/jobs/update_fulltext_status_sub_job.rb</h3>
    <h4><span class="red">0.0 %</span> covered</h4>
    <div>
      <b>9</b> relevant lines. 
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>9</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># frozen_string_literal: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="3">
          
          
          <code class="ruby">class UpdateFulltextStatusSubJob &lt; ApplicationJob</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="4">
          
          
          <code class="ruby">  queue_as :default</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="6">
          
          
          <code class="ruby">  def default_priority</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="7">
          
          
          <code class="ruby">    50</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="8">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">  def perform(batch_process, offset, limit)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="11">
          
          
          <code class="ruby">    batch_process.update_fulltext_status(offset, limit)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="6a4ea372c493b55615de29240cb674138279e524">
  <div class="header">
    <h3>app/jobs/update_parent_objects_job.rb</h3>
    <h4><span class="red">0.0 %</span> covered</h4>
    <div>
      <b>10</b> relevant lines. 
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>10</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># frozen_string_literal: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="3">
          
          
          <code class="ruby">class UpdateParentObjectsJob &lt; ApplicationJob</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="4">
          
          
          <code class="ruby">  queue_as :default</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="6">
          
          
          <code class="ruby">  discard_on StandardError, Net::OpenTimeout</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="8">
          
          
          <code class="ruby">  def default_priority</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="9">
          
          
          <code class="ruby">    50</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">  def perform(batch_process)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby">    batch_process.update_parent_objects</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="14">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="15">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="837b27b23ebfac0de52918661fbd4a2bb7e3d0f6">
  <div class="header">
    <h3>app/lib/activity_stream_reader.rb</h3>
    <h4><span class="red">0.0 %</span> covered</h4>
    <div>
      <b>117</b> relevant lines. 
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>117</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># frozen_string_literal: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"># An ActivityStreamReader reads json formatted activity stream documents from the MetadataCloud</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby"># rubocop:disable Metrics/ClassLength</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="5">
          
          
          <code class="ruby">class ActivityStreamReader</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="6">
          
          
          <code class="ruby">  attr_reader :tally_activity_stream_items, :tally_queued_records</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">  # This is the primary way that automated updates will happen.</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="9">
          
          
          <code class="ruby">  def self.update</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">    asr = ActivityStreamReader.new</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="11">
          
          
          <code class="ruby">    asr.process_activity_stream</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="14">
          
          
          <code class="ruby">  def initialize</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="15">
          
          
          <code class="ruby">    @tally_activity_stream_items = 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="16">
          
          
          <code class="ruby">    @tally_queued_records = 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="17">
          
          
          <code class="ruby">    @parent_object_refs = Set.new</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">  # Logs and kicks off processing the activity stream from the MetadataCloud</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">  # rubocop:disable Metrics/MethodLength</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="22">
          
          
          <code class="ruby">  def process_activity_stream</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="23">
          
          
          <code class="ruby">    @updated_uris = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="24">
          
          
          <code class="ruby">    @most_recent_update = nil</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="25">
          
          
          <code class="ruby">    @log = ActivityStreamLog.create(status: &quot;Running&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="26">
          
          
          <code class="ruby">    @log.save</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="27">
          
          
          <code class="ruby">    begin</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">      # recursively look at activity stream and add to parent_object_refs</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="29">
          
          
          <code class="ruby">      process_recursive(&quot;https://#{MetadataSource.metadata_cloud_host}/metadatacloud/streams/activity&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="30">
          
          
          <code class="ruby">      refresh_updated_items(parent_object_refs)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="31">
          
          
          <code class="ruby">      return unless @most_recent_update</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="32">
          
          
          <code class="ruby">      @log.run_time = @most_recent_update</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="33">
          
          
          <code class="ruby">      @log.activity_stream_items = @tally_activity_stream_items</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="34">
          
          
          <code class="ruby">      @log.retrieved_records = @tally_queued_records</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="35">
          
          
          <code class="ruby">    rescue =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="36">
          
          
          <code class="ruby">      @log.status = &quot;Failed: #{e}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="37">
          
          
          <code class="ruby">    rescue SignalException =&gt; sigterm</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="38">
          
          
          <code class="ruby">      @log.status = &quot;Terminated: #{sigterm}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="39">
          
          
          <code class="ruby">      @log.save</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="40">
          
          
          <code class="ruby">      raise sigterm</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="41">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="42">
          
          
          <code class="ruby">      @log.status = &quot;Success&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="43">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="44">
          
          
          <code class="ruby">    @log.save</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="45">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby">  # rubocop:enable Metrics/MethodLength</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby">  ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">  # It takes the url for an Activity Stream page, and if there is a link to a previous page,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby">  # recursively processes that page as well, until all pages have been processed.</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="51">
          
          
          <code class="ruby">  def process_recursive(page_url)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="52">
          
          
          <code class="ruby">    page = fetch_and_parse_page(page_url)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="53">
          
          
          <code class="ruby">    page[&quot;orderedItems&quot;].each do |item|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="54">
          
          
          <code class="ruby">      @most_recent_update = item[&quot;endTime&quot;] if @most_recent_update.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="55">
          
          
          <code class="ruby">      @tally_activity_stream_items += 1</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="56">
          
          
          <code class="ruby">      process_item(item) if relevant?(item)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="57">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="58">
          
          
          <code class="ruby">    earliest_item_on_page = page[&quot;orderedItems&quot;].last[&quot;endTime&quot;].to_datetime</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="59">
          
          
          <code class="ruby">    @parent_object_refs += parents_for_update_from_dependent_uris(updated_uris)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="60">
          
          
          <code class="ruby">    @updated_uris = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="61">
          
          
          <code class="ruby">    @update_time_uri_map = {}</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="62">
          
          
          <code class="ruby">    @log.activity_stream_items = @tally_activity_stream_items</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="63">
          
          
          <code class="ruby">    @log.retrieved_records = @tally_queued_records</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="64">
          
          
          <code class="ruby">    @log.save</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="65">
          
          
          <code class="ruby">    Rails.logger.info(&quot;Processed activity stream page back to #{earliest_item_on_page}&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="66">
          
          
          <code class="ruby">    process_recursive(previous_page_link(page)) if (previous_page_link(page) &amp;&amp; last_run_time.nil?) || (previous_page_link(page) &amp;&amp; earliest_item_on_page.after?(last_run_time))</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="67">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby">  ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby">  # Adds the item&#39;s uri to the array of updated_uris, for later comparison to the set of local_dependent_uris</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="71">
          
          
          <code class="ruby">  def process_item(item)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="72">
          
          
          <code class="ruby">    uri = item[&quot;object&quot;][&quot;id&quot;].match(/.*\/api(.*)/)[1] # strip everything from the URL except after /api</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="73">
          
          
          <code class="ruby">    updated_uris.push(uri)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="74">
          
          
          <code class="ruby">    update_time_uri_map[uri] = item[&quot;endTime&quot;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="75">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="76">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby">  ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby">  # It takes an item from the activity stream and returns either true or false depending on whether that object is an update</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="79">
          
          
          <code class="ruby">  def relevant?(item)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby">    # Don&#39;t process changes which occur after last_run_time</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="81">
          
          
          <code class="ruby">    return false unless item[&quot;type&quot;] == &quot;Update&quot; &amp;&amp; (item[&#39;endTime&#39;].to_datetime.after?(last_run_time) || item[&#39;endTime&#39;].to_datetime == last_run_time)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="82">
          
          
          <code class="ruby">    true</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="83">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="84">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="85">
          
          
          <code class="ruby">  ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="86">
          
          
          <code class="ruby">  # Return the last time the Activity Stream was successfully read</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="87">
          
          
          <code class="ruby">  # If the ActivityStreamReader has not yet successfully run (if the ActivityStreamLog is empty or does not have successes),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="88">
          
          
          <code class="ruby">  # then the ActivityStreamReader starts at the current time.</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="89">
          
          
          <code class="ruby">  def last_run_time</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="90">
          
          
          <code class="ruby">    @last_run_time ||= ActivityStreamLog.where(status: &quot;Success&quot;).last&amp;.run_time&amp;.to_datetime || Time.current</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="91">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="92">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="93">
          
          
          <code class="ruby">  def updated_uris</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="94">
          
          
          <code class="ruby">    @updated_uris ||= []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="95">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="96">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="97">
          
          
          <code class="ruby">  def update_time_uri_map</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="98">
          
          
          <code class="ruby">    @update_time_uri_map ||= {}</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="99">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="100">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="101">
          
          
          <code class="ruby">  def update_time_oid_map</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="102">
          
          
          <code class="ruby">    @update_time_oid_map ||= {}</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="103">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="104">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="105">
          
          
          <code class="ruby">  attr_reader :parent_object_refs</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="106">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="107">
          
          
          <code class="ruby">  def parents_for_update_from_dependent_uris(updated_uris)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="108">
          
          
          <code class="ruby">    # See: https://guides.rubyonrails.org/active_record_querying.html#subset-conditions</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="109">
          
          
          <code class="ruby">    dependent_objects = DependentObject.where(dependent_uri: updated_uris)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="110">
          
          
          <code class="ruby">    parent_object_refs_list = dependent_objects.map do |depobj|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="111">
          
          
          <code class="ruby">      update_time_oid_map[depobj.parent_object_id] = update_time_uri_map[depobj.dependent_uri] unless update_time_uri_map[depobj.dependent_uri].nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="112">
          
          
          <code class="ruby">      [depobj.parent_object_id, depobj.metadata_source]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="113">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="114">
          
          
          <code class="ruby">    parent_object_refs_list.to_set</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="115">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="116">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="117">
          
          
          <code class="ruby">  ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="118">
          
          
          <code class="ruby">  # Takes a set of parent object refs, sets up a batch job, and queues a SetupMetadataJob</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="119">
          
          
          <code class="ruby">  def refresh_updated_items(parent_object_refs)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="120">
          
          
          <code class="ruby">    #  Create a single batch for this update</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="121">
          
          
          <code class="ruby">    parent_object_refs.each do |parent_object_array|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="122">
          
          
          <code class="ruby">      oid = parent_object_array[0]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="123">
          
          
          <code class="ruby">      metadata_source = parent_object_array[1]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="124">
          
          
          <code class="ruby">      # skip ladybird updates</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="125">
          
          
          <code class="ruby">      next if metadata_source == &quot;ladybird&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="126">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="127">
          
          
          <code class="ruby">      po = ParentObject.find_by_oid(oid)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="128">
          
          
          <code class="ruby">      # skip it if the metadata source does not match (This should never happen after dependent uris are updating properly)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="129">
          
          
          <code class="ruby">      next unless po&amp;.authoritative_metadata_source&amp;.metadata_cloud_name == metadata_source</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="130">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="131">
          
          
          <code class="ruby">      #  if po was updated after the most recent update of one of all the dependent uris, skip it</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="132">
          
          
          <code class="ruby">      last_update = metadata_source == &#39;aspace&#39; ? po.last_aspace_update : po.last_voyager_update</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="133">
          
          
          <code class="ruby">      most_recent_dependend_object_update = update_time_oid_map[oid]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="134">
          
          
          <code class="ruby">      next if last_update&amp;.after?(most_recent_dependend_object_update)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="135">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="136">
          
          
          <code class="ruby">      #  if po has a Metadata Job queued or in progress, skip it.</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="137">
          
          
          <code class="ruby">      next unless po.setup_metadata_jobs.empty?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="138">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="139">
          
          
          <code class="ruby">      queue_parent_object(po)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="140">
          
          
          <code class="ruby">      @tally_queued_records += 1</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="141">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="142">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="143">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="144">
          
          
          <code class="ruby">  def batch_process</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="145">
          
          
          <code class="ruby">    @batch_process ||= BatchProcess.create!(batch_action: &#39;activity stream updates&#39;, user: User.system_user)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="146">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="147">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="148">
          
          
          <code class="ruby">  def queue_parent_object(po)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="149">
          
          
          <code class="ruby">    po.metadata_update = true</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="150">
          
          
          <code class="ruby">    po.current_batch_connection = batch_process.batch_connections.build(connectable: po)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="151">
          
          
          <code class="ruby">    batch_process.save</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="152">
          
          
          <code class="ruby">    po.current_batch_process = batch_process</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="153">
          
          
          <code class="ruby">    po.save! # save will cause SetupMetadataJob to be queued since metadata_update is true.</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="154">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="155">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="156">
          
          
          <code class="ruby">  ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="157">
          
          
          <code class="ruby">  # Takes a MetadataCloud url as a string and returns a parsed JSON object</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="158">
          
          
          <code class="ruby">  # containing the body of the response</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="159">
          
          
          <code class="ruby">  def fetch_and_parse_page(page_url)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="160">
          
          
          <code class="ruby">    latest_page = MetadataSource.new.mc_get(page_url).body.to_s</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="161">
          
          
          <code class="ruby">    JSON.parse(latest_page)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="162">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="163">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="164">
          
          
          <code class="ruby">  ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="165">
          
          
          <code class="ruby">  # Takes a parsed json Activity Stream page and returns the link to the previous page</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="166">
          
          
          <code class="ruby">  def previous_page_link(page)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="167">
          
          
          <code class="ruby">    http_url = page[&quot;prev&quot;][&quot;id&quot;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="168">
          
          
          <code class="ruby">    http_url.gsub(&quot;http://&quot;, &quot;https://&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="169">
          
          
          <code class="ruby">  rescue</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="170">
          
          
          <code class="ruby">    false</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="171">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="172">
          
          
          <code class="ruby">end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="173">
          
          
          <code class="ruby"># rubocop:enable Metrics/ClassLength</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="91f31c564792f4b129d09f27064785deceaa3cb3">
  <div class="header">
    <h3>app/lib/json_validator.rb</h3>
    <h4><span class="red">0.0 %</span> covered</h4>
    <div>
      <b>8</b> relevant lines. 
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>8</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># frozen_string_literal: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"># Inspired by https://gist.github.com/ascendbruce/7070951 on 8/5/2020</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="4">
          
          
          <code class="ruby">class JsonValidator</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="5">
          
          
          <code class="ruby">  def self.valid?(value)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="6">
          
          
          <code class="ruby">    result = JSON.parse(value)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="8">
          
          
          <code class="ruby">    result.is_a?(Hash) || result.is_a?(Array)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="9">
          
          
          <code class="ruby">  rescue JSON::ParserError, TypeError</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">    false</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="11">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="c369233904be2951c2d6753cb38a395bebf8e28f">
  <div class="header">
    <h3>app/lib/mets_directory_scanner.rb</h3>
    <h4><span class="red">0.0 %</span> covered</h4>
    <div>
      <b>50</b> relevant lines. 
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>50</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># frozen_string_literal: true</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="2">
          
          
          <code class="ruby">require &#39;find&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby"># performs scans on directories for XML files and processes them if they are not already done or in progress</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="5">
          
          
          <code class="ruby">class MetsDirectoryScanner</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="6">
          
          
          <code class="ruby">  def self.perform_scan # rubocop:disable Metrics/AbcSize</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="7">
          
          
          <code class="ruby">    MetsDirectoryScanner.scan_directories.each do |directory|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="8">
          
          
          <code class="ruby">      Dir.glob(File.join(directory, &#39;*/*_mets.xml&#39;)) do |path|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="9">
          
          
          <code class="ruby">        next unless path =~ /.*_mets\.xml$/ &amp;&amp; path !~ /.*xslt_result_mets\.xml$/</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">        check_file(path)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="11">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="15">
          
          
          <code class="ruby">  def self.indicator_file_prefix</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="16">
          
          
          <code class="ruby">    env_info = (ENV[&#39;METS_SCAN_LOCK_NAME&#39;]) || (ENV[&#39;BLACKLIGHT_BASE_URL&#39;] &amp;&amp; URI.parse(ENV[&#39;BLACKLIGHT_BASE_URL&#39;]).host.split(&#39;.&#39;).first) || &#39;NO_ENV_NAME&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="17">
          
          
          <code class="ruby">    &quot;dcs-#{env_info}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="20">
          
          
          <code class="ruby">  def self.scan_directories</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="21">
          
          
          <code class="ruby">    scans_by_goobi_mount = ENV[&#39;GOOBI_MOUNT&#39;] &amp;&amp; [File.join(&#39;/&#39;, ENV[&#39;GOOBI_MOUNT&#39;], &#39;dcs&#39;), File.join(&#39;/&#39;, ENV[&#39;GOOBI_MOUNT&#39;], &#39;jss_export&#39;)]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="22">
          
          
          <code class="ruby">    ENV[&#39;GOOBI_SCAN_DIRECTORIES&#39;]&amp;.split(&#39;,&#39;) || scans_by_goobi_mount || [&#39;/brbl-dsu/dcs&#39;, &#39;/brbl-dsu/jss_export&#39;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="23">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="25">
          
          
          <code class="ruby">  def self.check_file(path)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="26">
          
          
          <code class="ruby">    is_done = File.exist?(File.join(File.dirname(path), &quot;#{indicator_file_prefix}.done&quot;))</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="27">
          
          
          <code class="ruby">    progress_file = File.join(File.dirname(path), &quot;#{indicator_file_prefix}.progress&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="28">
          
          
          <code class="ruby">    File.delete(progress_file) if File.exist?(progress_file) &amp;&amp; File.mtime(progress_file) &lt; (Time.now.utc - 1.day)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="29">
          
          
          <code class="ruby">    is_in_progress = File.exist?(progress_file)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="30">
          
          
          <code class="ruby">    begin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="31">
          
          
          <code class="ruby">      unless is_done || is_in_progress</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">        #  The following will fail if file is not created by this call because of Fcntl::O_EXCL option:</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="33">
          
          
          <code class="ruby">        IO.sysopen(progress_file, Fcntl::O_WRONLY | Fcntl::O_EXCL | Fcntl::O_CREAT)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">        #  If we get here, the done file doesn&#39;t exist, and we just created the progress file....so we are ready to go</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="35">
          
          
          <code class="ruby">        process_file path</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="36">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="37">
          
          
          <code class="ruby">    rescue Errno::EEXIST # rubocop:disable Lint/HandleExceptions</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">      # If we get here it means some other instance of a scanner just put in a progress file,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">      # it&#39;s ok to let them handle it</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="40">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="41">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="43">
          
          
          <code class="ruby">  def self.process_file(xml_file_path)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="44">
          
          
          <code class="ruby">    file = ActionDispatch::Http::UploadedFile.new(</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="45">
          
          
          <code class="ruby">      filename: File.basename(xml_file_path),</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="46">
          
          
          <code class="ruby">      type: &#39;text/xml&#39;,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="47">
          
          
          <code class="ruby">      tempfile: File.new(xml_file_path.to_s)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="48">
          
          
          <code class="ruby">    )</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="49">
          
          
          <code class="ruby">    begin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="50">
          
          
          <code class="ruby">      batch_process = BatchProcess.new(batch_action: &#39;create parent objects&#39;, user: User.system_user, file: file)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="51">
          
          
          <code class="ruby">      if batch_process.save!</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby">        # Jobs have been kicked off and batch job has been created, so we&#39;ll mark it as done and</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby">        # check for errors in management.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby">        # If we wait to create the done file until it is successful through the entire process,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby">        # we may pile up failed jobs if there&#39;s something wrong with the mets that makes it error out on</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby">        # some step of the import.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby">        # The process will restart using delayed jobs without kicking it off again from a scan.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby">        # If we need to force a retry, we will manually delete the done file for a mets directory after the problem</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby">        # is corrected.</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="60">
          
          
          <code class="ruby">        done_file = File.join(File.dirname(xml_file_path), &quot;#{indicator_file_prefix}.done&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="61">
          
          
          <code class="ruby">        progress_file = File.join(File.dirname(xml_file_path), &quot;#{indicator_file_prefix}.progress&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="62">
          
          
          <code class="ruby">        File.new(done_file, &quot;w&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="63">
          
          
          <code class="ruby">        File.delete(progress_file) if File.exist?(progress_file)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="64">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="65">
          
          
          <code class="ruby">    rescue =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="66">
          
          
          <code class="ruby">      Rails.logger.error(&quot;Error processing mets #{xml_file_path} #{e}&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="67">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="68">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="69">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="61fe50cb81a005eca8666b96e4d768aceea104ec">
  <div class="header">
    <h3>app/lib/preservica_client.rb</h3>
    <h4><span class="red">0.0 %</span> covered</h4>
    <div>
      <b>107</b> relevant lines. 
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>107</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># frozen_string_literal: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby">#</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"># Client for archive space tied to an admin set</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby">#</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"># Uses environment variables: PRESERVICA_HOST and PRESERVICA_CREDENTIALS</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">#</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"># rubocop:disable Metrics/ClassLength</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="8">
          
          
          <code class="ruby">class PreservicaClient</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="9">
          
          
          <code class="ruby">  def initialize(args)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">    @host = args[:base_url] || &quot;https://#{ENV[&#39;PRESERVICA_HOST&#39;]}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="11">
          
          
          <code class="ruby">    if args[:admin_set_key]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">      credentials = JSON.parse(ENV[&#39;PRESERVICA_CREDENTIALS&#39;])[args[:admin_set_key]]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby">      @username = credentials[&#39;username&#39;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="14">
          
          
          <code class="ruby">      @password = credentials[&#39;password&#39;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="15">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="16">
          
          
          <code class="ruby">    login</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="17">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="19">
          
          
          <code class="ruby">  def login</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="20">
          
          
          <code class="ruby">    uri = URI(@host)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="21">
          
          
          <code class="ruby">    Net::HTTP.start(uri.host, uri.port,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="22">
          
          
          <code class="ruby">                    use_ssl: uri.scheme == &#39;https&#39;,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="23">
          
          
          <code class="ruby">                    verify_mode: OpenSSL::SSL::VERIFY_NONE) do |http|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="24">
          
          
          <code class="ruby">      request = Net::HTTP::Post.new &#39;/api/accesstoken/login&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="25">
          
          
          <code class="ruby">      request.set_form_data(&#39;username&#39; =&gt; @username, &#39;password&#39; =&gt; @password)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="26">
          
          
          <code class="ruby">      response = http.request request # Net::HTTPResponse object</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="27">
          
          
          <code class="ruby">      raise StandardError, &#39;Unable to login&#39; unless response.is_a? Net::HTTPSuccess</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="29">
          
          
          <code class="ruby">      @login_info = JSON.parse(response.body)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="30">
          
          
          <code class="ruby">      class &lt;&lt; @login_info</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="31">
          
          
          <code class="ruby">        define_method(:inspect, proc { &quot;Login Info&quot; })</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="32">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="33">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="34">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="36">
          
          
          <code class="ruby">  def refresh</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="37">
          
          
          <code class="ruby">    authenticated_post URI(&quot;#{@host}/api/accesstoken/refresh&quot;) do |http, request|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="38">
          
          
          <code class="ruby">      request.set_form_data(&#39;refreshToken&#39; =&gt; @login_info[&#39;refresh-token&#39;])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="39">
          
          
          <code class="ruby">      @login_info = http.request request</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="40">
          
          
          <code class="ruby">      class &lt;&lt; @login_info</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="41">
          
          
          <code class="ruby">        define_method(:inspect, proc { &quot;Login Info&quot; })</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="42">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="43">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="44">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="46">
          
          
          <code class="ruby">  def content_structural_object_details(id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="47">
          
          
          <code class="ruby">    get &quot;/api/content/object-details?id=sdb%3ASO%7C#{id}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="48">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="50">
          
          
          <code class="ruby">  def structural_object(id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="51">
          
          
          <code class="ruby">    get &quot;/api/entity/structural-objects/#{id}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="52">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="54">
          
          
          <code class="ruby">  def structural_object_children(id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="55">
          
          
          <code class="ruby">    get &quot;/api/entity/structural-objects/#{id}/children&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="56">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="58">
          
          
          <code class="ruby">  def information_object(id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="59">
          
          
          <code class="ruby">    get &quot;/api/entity/information-objects/#{id}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="60">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="62">
          
          
          <code class="ruby">  def information_object_representations(id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="63">
          
          
          <code class="ruby">    get &quot;/api/entity/information-objects/#{id}/representations&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="64">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="66">
          
          
          <code class="ruby">  def information_object_representation(id, representation)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="67">
          
          
          <code class="ruby">    get &quot;/api/entity/information-objects/#{id}/representations/#{representation}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="68">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="70">
          
          
          <code class="ruby">  def content_object(id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="71">
          
          
          <code class="ruby">    get &quot;/api/entity/content-objects/#{id}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="72">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="74">
          
          
          <code class="ruby">  def content_object_generations(id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="75">
          
          
          <code class="ruby">    get &quot;/api/entity/content-objects/#{id}/generations&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="76">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="78">
          
          
          <code class="ruby">  def content_object_generation(id, generation)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="79">
          
          
          <code class="ruby">    get &quot;/api/entity/content-objects/#{id}/generations/#{generation}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="80">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="81">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="82">
          
          
          <code class="ruby">  def content_object_generation_bitstream(id, generation, bitstream)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="83">
          
          
          <code class="ruby">    get &quot;/api/entity/content-objects/#{id}/generations/#{generation}/bitstreams/#{bitstream}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="84">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="85">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="86">
          
          
          <code class="ruby">  def content_object_generation_bitstream_content(id, generation, bitstream)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="87">
          
          
          <code class="ruby">    get &quot;/api/entity/content-objects/#{id}/generations/#{generation}/bitstreams/#{bitstream}/content&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="88">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="89">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="90">
          
          
          <code class="ruby">  def get(uri)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="91">
          
          
          <code class="ruby">    return get_body(uri) unless block_given?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="92">
          
          
          <code class="ruby">    authenticated_get URI(&quot;#{@host}#{uri}&quot;) do |http, request|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="93">
          
          
          <code class="ruby">      http.request request do |response|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="94">
          
          
          <code class="ruby">        raise StandardError, &quot;Request error #{response.code} #{response.body}&quot; unless response.is_a? Net::HTTPSuccess</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="95">
          
          
          <code class="ruby">        response.read_body do |chunk|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="96">
          
          
          <code class="ruby">          yield chunk</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="97">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="98">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="99">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="100">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="101">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="102">
          
          
          <code class="ruby">  def get_body(uri)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="103">
          
          
          <code class="ruby">    authenticated_get URI(&quot;#{@host}#{uri}&quot;) do |http, request|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="104">
          
          
          <code class="ruby">      response = http.request request</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="105">
          
          
          <code class="ruby">      raise StandardError, &quot;Request error #{response.code} #{response.body}&quot; unless response.is_a? Net::HTTPSuccess</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="106">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="107">
          
          
          <code class="ruby">      return response.body</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="108">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="109">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="110">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="111">
          
          
          <code class="ruby">  def authenticated_post(uri)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="112">
          
          
          <code class="ruby">    Net::HTTP.start(uri.host, uri.port,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="113">
          
          
          <code class="ruby">                    use_ssl: uri.scheme == &#39;https&#39;,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="114">
          
          
          <code class="ruby">                    verify_mode: OpenSSL::SSL::VERIFY_NONE) do |http|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="115">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="116">
          
          
          <code class="ruby">      request = Net::HTTP::Post.new uri.request_uri</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="117">
          
          
          <code class="ruby">      request[&#39;Preservica-Access-Token&#39;] = @login_info[&#39;token&#39;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="118">
          
          
          <code class="ruby">      yield http, request</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="119">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="120">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="121">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="122">
          
          
          <code class="ruby">  def authenticated_get(uri)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="123">
          
          
          <code class="ruby">    Net::HTTP.start(uri.host, uri.port,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="124">
          
          
          <code class="ruby">                    use_ssl: uri.scheme == &#39;https&#39;,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="125">
          
          
          <code class="ruby">                    verify_mode: OpenSSL::SSL::VERIFY_NONE) do |http|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="126">
          
          
          <code class="ruby">      request = Net::HTTP::Get.new uri.request_uri</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="127">
          
          
          <code class="ruby">      request[&#39;Preservica-Access-Token&#39;] = @login_info[&#39;token&#39;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="128">
          
          
          <code class="ruby">      yield http, request</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="129">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="130">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="131">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="132">
          
          
          <code class="ruby">  def inspect</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="133">
          
          
          <code class="ruby">    &quot;Preservica Client&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="134">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="135">
          
          
          <code class="ruby">end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="136">
          
          
          <code class="ruby"># rubocop:enable Metrics/ClassLength</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="e13bed53c789df603fd18623c79d8a3e8b0b35e1">
  <div class="header">
    <h3>app/mailers/application_mailer.rb</h3>
    <h4><span class="red">0.0 %</span> covered</h4>
    <div>
      <b>4</b> relevant lines. 
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>4</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># frozen_string_literal: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="3">
          
          
          <code class="ruby">class ApplicationMailer &lt; ActionMailer::Base</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="4">
          
          
          <code class="ruby">  default from: &#39;from@example.com&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="5">
          
          
          <code class="ruby">  layout &#39;mailer&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="6">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="2bc6a29882573554f8cd99b81786a049ff6ab00f">
  <div class="header">
    <h3>app/models/ability.rb</h3>
    <h4><span class="red">62.07 %</span> covered</h4>
    <div>
      <b>29</b> relevant lines. 
      <span class="green"><b>18</b> lines covered</span> and
      <span class="red"><b>11</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># frozen_string_literal: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">class Ability</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  include CanCan::Ability</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">  def initialize(user)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="7">
          <span class="hits">2</span>
          
          <code class="ruby">    alias_action :create, :read, :update, :destroy, to: :crud</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="8">
          <span class="hits">2</span>
          
          <code class="ruby">    return unless user</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="9">
          <span class="hits">2</span>
          
          <code class="ruby">    can :create_new, ParentObject if user.roles.find_by(name: :editor)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="10">
          <span class="hits">2</span>
          
          <code class="ruby">    if user.has_role? :sysadmin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="11">
          
          
          <code class="ruby">      apply_sysadmin_abilities</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="13">
          <span class="hits">2</span>
          
          <code class="ruby">      can :read, ParentObject, admin_set: { roles: { name: viewer_roles, users: { id: user.id } } }</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="14">
          <span class="hits">2</span>
          
          <code class="ruby">      can :read, ChildObject, parent_object: { admin_set: { roles: { name: viewer_roles, users: { id: user.id } } } }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="16">
          <span class="hits">2</span>
          
          <code class="ruby">    can :add_member, AdminSet, roles: { name: editor_roles, users: { id: user.id } }</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="17">
          <span class="hits">2</span>
          
          <code class="ruby">    can :reindex_admin_set, AdminSet, roles: { name: editor_roles, users: { id: user.id } }</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="18">
          <span class="hits">2</span>
          
          <code class="ruby">    can [:crud], ChildObject, parent_object: { admin_set: { roles: { name: editor_roles, users: { id: user.id } } } }</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="19">
          <span class="hits">2</span>
          
          <code class="ruby">    can [:crud], ParentObject, admin_set: { roles: { name: editor_roles, users: { id: user.id } } }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="22">
          <span class="hits">1</span>
          
          <code class="ruby">  def apply_sysadmin_abilities</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="23">
          
          
          <code class="ruby">    can :manage, User</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="24">
          
          
          <code class="ruby">    can :crud, AdminSet</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="25">
          
          
          <code class="ruby">    can :read, ParentObject</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="26">
          
          
          <code class="ruby">    can :read, ChildObject</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="27">
          
          
          <code class="ruby">    can :read, PreservicaIngest</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="28">
          
          
          <code class="ruby">    can :read, ReoccurringJobDatatable</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="29">
          
          
          <code class="ruby">    can :reindex_all, ParentObject</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="30">
          
          
          <code class="ruby">    can :update_metadata, ParentObject</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="31">
          
          
          <code class="ruby">    can :sync_from_preservica, ParentObject</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="32">
          
          
          <code class="ruby">    can :trigger_mets_scan, ParentObject</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="35">
          <span class="hits">1</span>
          
          <code class="ruby">  def viewer_roles</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="36">
          <span class="hits">4</span>
          
          <code class="ruby">    %w[viewer editor]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="39">
          <span class="hits">1</span>
          
          <code class="ruby">  def editor_roles</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="40">
          <span class="hits">8</span>
          
          <code class="ruby">    [&#39;editor&#39;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="c6467705302b68c4ce333e6cd043ad3ae414ff1f">
  <div class="header">
    <h3>app/models/activity_stream_log.rb</h3>
    <h4><span class="red">0.0 %</span> covered</h4>
    <div>
      <b>2</b> relevant lines. 
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>2</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># frozen_string_literal: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="3">
          
          
          <code class="ruby">class ActivityStreamLog &lt; ApplicationRecord</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="4">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="556aedd0f16de3642c6b8b641e775e0de01bcd0e">
  <div class="header">
    <h3>app/models/admin_set.rb</h3>
    <h4><span class="red">50.0 %</span> covered</h4>
    <div>
      <b>24</b> relevant lines. 
      <span class="green"><b>12</b> lines covered</span> and
      <span class="red"><b>12</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># frozen_string_literal: true</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">class AdminSet &lt; ApplicationRecord</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">  resourcify</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :key, presence: true</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :label, presence: true</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :homepage, presence: true</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :homepage, format: URI.regexp(%w[http https])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">  def add_viewer(user)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">    remove_editor(user) if user.editor(self)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="11">
          
          
          <code class="ruby">    user.add_role(:viewer, self)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="14">
          <span class="hits">1</span>
          
          <code class="ruby">  def remove_viewer(user)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="15">
          
          
          <code class="ruby">    user.remove_role(:viewer, self)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="18">
          <span class="hits">1</span>
          
          <code class="ruby">  def add_editor(user)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="19">
          
          
          <code class="ruby">    remove_viewer(user) if user.viewer(self)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="20">
          
          
          <code class="ruby">    user.add_role(:editor, self)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="23">
          <span class="hits">1</span>
          
          <code class="ruby">  def remove_editor(user)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="24">
          
          
          <code class="ruby">    user.remove_role(:editor, self)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="27">
          <span class="hits">1</span>
          
          <code class="ruby">  def preservica_credentials_verified</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="28">
          
          
          <code class="ruby">    valid_format?(ENV[&#39;PRESERVICA_CREDENTIALS&#39;]) ? true : false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="31">
          <span class="hits">1</span>
          
          <code class="ruby">  def valid_format?(json)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">    # valid JSON,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="33">
          
          
          <code class="ruby">    parsed_json = JSON.parse(json) unless json.nil?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">    # exists,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="36">
          
          
          <code class="ruby">    if ENV[&#39;PRESERVICA_CREDENTIALS&#39;].present? &amp;&amp;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">       # contains admin set key,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">       parsed_json.include?(key) &amp;&amp;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">       # and key references username and password with not blank values</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">       parsed_json[key.to_s][&#39;username&#39;].present? &amp;&amp;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">       parsed_json[key.to_s][&#39;password&#39;].present?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="42">
          
          
          <code class="ruby">      return true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="44">
          
          
          <code class="ruby">      return false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby">  rescue JSON::ParserError</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="47">
          
          
          <code class="ruby">    false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="dfd13e26507655b8df42f582f81d00f182338150">
  <div class="header">
    <h3>app/models/application_record.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>2</b> relevant lines. 
      <span class="green"><b>2</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># frozen_string_literal: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">class ApplicationRecord &lt; ActiveRecord::Base</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  self.abstract_class = true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="6969bbe0a288d2999c0c9a14454002c3e70facca">
  <div class="header">
    <h3>app/models/batch_connection.rb</h3>
    <h4><span class="green">90.91 %</span> covered</h4>
    <div>
      <b>11</b> relevant lines. 
      <span class="green"><b>10</b> lines covered</span> and
      <span class="red"><b>1</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># frozen_string_literal: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">class BatchConnection &lt; ApplicationRecord</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  include Statable</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :batch_process</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :connectable, polymorphic: true</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :ingest_events</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">  def update_status</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="10">
          <span class="hits">6</span>
          
          <code class="ruby">    self.status = connectable.status_for_batch_process(batch_process)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">  def update_status!</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="14">
          <span class="hits">6</span>
          
          <code class="ruby">    update_status &amp;&amp; save!</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="17">
          <span class="hits">1</span>
          
          <code class="ruby">  def batch_connections_for(_batch_process)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">    [self]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="0ea6fbfd2150a7a9b66ada2ebffed2223b304922">
  <div class="header">
    <h3>app/models/batch_process.rb</h3>
    <h4><span class="red">32.61 %</span> covered</h4>
    <div>
      <b>276</b> relevant lines. 
      <span class="green"><b>90</b> lines covered</span> and
      <span class="red"><b>186</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># frozen_string_literal: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">class BatchProcess &lt; ApplicationRecord # rubocop:disable Metrics/ClassLength</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby">  # CSV EXPORT CHILD OIDS:</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">  include CsvExportable</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">  # DELETE PARENT / CHILD OBJECTS:</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">  include Deletable</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">  # REASSOCIATE CHILD OIDS:</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">  include Reassociatable</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="10">
          <span class="hits">1</span>
          
          <code class="ruby">  include Statable</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">  # UPDATE PARENT OBJECTS:</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>
          
          <code class="ruby">  include Updatable</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">  attr_reader :file</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="14">
          <span class="hits">1</span>
          
          <code class="ruby">  after_create :determine_background_jobs</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="15">
          <span class="hits">1</span>
          
          <code class="ruby">  before_create :mets_oid</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">  validate :validate_import</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="17">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :user, class_name: &quot;User&quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="18">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :batch_connections</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="19">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :parent_objects, through: :batch_connections, source_type: &quot;ParentObject&quot;, source: :connectable</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="20">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :child_objects, through: :batch_connections, source_type: &quot;ChildObject&quot;, source: :connectable</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="22">
          <span class="hits">1</span>
          
          <code class="ruby">  CSV_MAXIMUM_ENTRIES = 10_000</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">  # SHARED BY ALL BATCH ACTIONS: ------------------------------------------------------------------- #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">  # LISTS AVAILABLE BATCH ACTIONS</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="27">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.batch_actions</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="28">
          
          
          <code class="ruby">    [&#39;create parent objects&#39;, &#39;update parent objects&#39;, &#39;delete parent objects&#39;, &#39;delete child objects&#39;, &#39;export all parent objects by admin set&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">     &#39;export child oids&#39;, &#39;reassociate child oids&#39;, &#39;recreate child oid ptiffs&#39;, &#39;update fulltext status&#39;, &#39;sync from preservica&#39;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">  # LOGS BATCH PROCESSING MESSAGES AND SETS STATUSES</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="33">
          <span class="hits">1</span>
          
          <code class="ruby">  def batch_processing_event(message, status = &#39;info&#39;)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="34">
          <span class="hits">1</span>
          
          <code class="ruby">    current_batch_connection = batch_connections.find_or_create_by!(connectable: self)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="35">
          <span class="hits">1</span>
          
          <code class="ruby">    IngestEvent.create!(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">      status: status,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">      reason: message,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">      batch_connection: current_batch_connection</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">    )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">  # PROVIDES ROUTE TO CSV TEMPLATE</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="43">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.csv_template(batch_action)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="44">
          
          
          <code class="ruby">    File.read(Rails.root.join(&quot;public&quot;, &quot;batch_processes&quot;, &quot;templates&quot;, &quot;#{batch_action.parameterize.underscore}.csv&quot;))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby">  # GETS LISTS OF INGEST EVENTS</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="48">
          <span class="hits">1</span>
          
          <code class="ruby">  def batch_ingest_events</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="49">
          
          
          <code class="ruby">    current_batch_connection = batch_connections.find_or_create_by!(connectable: self)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="50">
          
          
          <code class="ruby">    IngestEvent.where(batch_connection: current_batch_connection)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby">  # GETS COUNT OF INGEST EVENTS</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="54">
          <span class="hits">1</span>
          
          <code class="ruby">  def batch_ingest_events_count</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="55">
          
          
          <code class="ruby">    current_batch_connection = batch_connections.find_or_create_by!(connectable: self)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="56">
          
          
          <code class="ruby">    IngestEvent.where(batch_connection: current_batch_connection).count</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby">  # CHECKS TO SEE IF THE FILE UPLOADED IS A VALID FILE TYPE (CSV or XML)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="60">
          <span class="hits">1</span>
          
          <code class="ruby">  def validate_import</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="61">
          <span class="hits">7</span>
          
          <code class="ruby">    return if file.blank?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="62">
          
          
          <code class="ruby">    if File.extname(file) == &#39;.csv&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="63">
          
          
          <code class="ruby">      errors.add(:file, &#39;must be a csv&#39;) if CSV.read(file).blank?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="64">
          
          
          <code class="ruby">    elsif File.extname(file) == &#39;.xml&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby">      begin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="66">
          
          
          <code class="ruby">          mets_doc.valid_mets?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby">      rescue =&gt; error</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="68">
          
          
          <code class="ruby">        return errors.add(:file, error)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="71">
          
          
          <code class="ruby">      return errors.add(:file, &#39;not a valid file type. Must be a CSV or XML.&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="72">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="75">
          
          
          <code class="ruby">  # READS FILE</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="76">
          <span class="hits">1</span>
          
          <code class="ruby">  def file=(value)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="77">
          
          
          <code class="ruby">    @file = value</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="78">
          
          
          <code class="ruby">    self[:file_name] = file.original_filename</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="79">
          
          
          <code class="ruby">    if File.extname(file) == &#39;.csv&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby">      # Remove BOM if present</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="81">
          
          
          <code class="ruby">      self[:csv] = CSV.open(value, &#39;rb:bom|utf-8&#39;, headers: true, return_headers: true).read</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="82">
          
          
          <code class="ruby">    elsif File.extname(file) == &#39;.xml&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="83">
          
          
          <code class="ruby">      self[:mets_xml] = value.read</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="84">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="85">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="86">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="87">
          
          
          <code class="ruby">  # PARSES THE CSV</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="88">
          <span class="hits">1</span>
          
          <code class="ruby">  def parsed_csv</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="89">
          
          
          <code class="ruby">    @parsed_csv ||= CSV.parse(csv, headers: true, encoding: &quot;utf-8&quot;, skip_blanks: true) if csv.present?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="90">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="91">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="92">
          
          
          <code class="ruby">  # CHECKS TO SEE IF CSV ROWS EXCEEDS MAXIMUM ENTRIES</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="93">
          <span class="hits">1</span>
          
          <code class="ruby">  def check_csv_size</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="94">
          
          
          <code class="ruby">    if parsed_csv.length &gt; CSV_MAXIMUM_ENTRIES</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="95">
          
          
          <code class="ruby">      error = &quot;CSV contains #{parsed_csv.length} entries, which is more than the maximum number of #{CSV_MAXIMUM_ENTRIES}.  The job was not started.&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="96">
          
          
          <code class="ruby">      batch_processing_event(error, &#39;error&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="97">
          
          
          <code class="ruby">      return false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="98">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="99">
          
          
          <code class="ruby">    true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="100">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="101">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="102">
          
          
          <code class="ruby">  # CREATES METS DOCUMENT</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="103">
          <span class="hits">1</span>
          
          <code class="ruby">  def mets_doc</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="104">
          <span class="hits">7</span>
          
          <code class="ruby">    @mets_doc ||= MetsDocument.new(mets_xml) if mets_xml.present?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="105">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="106">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="107">
          
          
          <code class="ruby">  # GETS THE OIDS FROM METS DOCUMENT</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="108">
          <span class="hits">1</span>
          
          <code class="ruby">  def mets_oid</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="109">
          <span class="hits">7</span>
          
          <code class="ruby">    self[:oid] = mets_doc&amp;.oid&amp;.to_i unless self[:oid]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="110">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="111">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="112">
          
          
          <code class="ruby">  # GETS THE OIDS FROM PARSED CSV</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="113">
          <span class="hits">1</span>
          
          <code class="ruby">  def oids</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="114">
          
          
          <code class="ruby">    return @oids ||= parsed_csv.entries.map { |r| r[&#39;oid&#39;] } unless csv.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="115">
          
          
          <code class="ruby">    @oids ||= [oid]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="116">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="117">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="118">
          
          
          <code class="ruby">  # APPENDS ID TO CSV FILENAME</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="119">
          <span class="hits">1</span>
          
          <code class="ruby">  def created_file_name</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="120">
          
          
          <code class="ruby">    return nil unless file_name</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="121">
          
          
          <code class="ruby">    &quot;#{file_name.delete_suffix(&#39;.csv&#39;)}_bp_#{id}.csv&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="122">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="123">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="124">
          
          
          <code class="ruby">  # FETCHES USERS ABILITIES</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="125">
          <span class="hits">1</span>
          
          <code class="ruby">  def current_ability</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="126">
          <span class="hits">2</span>
          
          <code class="ruby">    @current_ability ||= Ability.new(user)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="127">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="128">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="129">
          
          
          <code class="ruby">  # ASSIGNS PARENT/CHILD OBJECT TO BATCH PROCESS FOR REASSOCIATE/RECREATE CHILD PTIFF</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="130">
          <span class="hits">1</span>
          
          <code class="ruby">  def attach_item(connectable)</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="131">
          <span class="hits">5</span>
          
          <code class="ruby">    connectable.current_batch_process = self</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="132">
          <span class="hits">5</span>
          
          <code class="ruby">    connectable.current_batch_connection = batch_connections.find_or_create_by(connectable: connectable)</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="133">
          <span class="hits">5</span>
          
          <code class="ruby">    connectable.current_batch_connection.save!</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="134">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="135">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="136">
          
          
          <code class="ruby">  # ASSIGN JOBS TO BATCH ACTIONS</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="137">
          
          
          <code class="ruby">  # rubocop:disable Metrics/CyclomaticComplexity</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="138">
          
          
          <code class="ruby">  # rubocop:disable Metrics/MethodLength</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="139">
          <span class="hits">1</span>
          
          <code class="ruby">  def determine_background_jobs</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="140">
          <span class="hits">7</span>
          
          <code class="ruby">    if csv.present? &amp;&amp; check_csv_size</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="141">
          
          
          <code class="ruby">      case batch_action</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="142">
          
          
          <code class="ruby">      when &#39;create parent objects&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="143">
          
          
          <code class="ruby">        CreateNewParentJob.perform_later(self)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="144">
          
          
          <code class="ruby">      when &#39;delete parent objects&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="145">
          
          
          <code class="ruby">        DeleteParentObjectsJob.perform_later(self)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="146">
          
          
          <code class="ruby">      when &#39;delete child objects&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="147">
          
          
          <code class="ruby">        DeleteChildObjectsJob.perform_later(self)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="148">
          
          
          <code class="ruby">      when &#39;export all parent objects by admin set&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="149">
          
          
          <code class="ruby">        CreateParentOidCsvJob.perform_later(self)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="150">
          
          
          <code class="ruby">      when &#39;export child oids&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="151">
          
          
          <code class="ruby">        CreateChildOidCsvJob.perform_later(self)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="152">
          
          
          <code class="ruby">      when &#39;update parent objects&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="153">
          
          
          <code class="ruby">        UpdateParentObjectsJob.perform_later(self)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="154">
          
          
          <code class="ruby">      when &#39;reassociate child oids&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="155">
          
          
          <code class="ruby">        ReassociateChildOidsJob.perform_later(self)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="156">
          
          
          <code class="ruby">      when &#39;recreate child oid ptiffs&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="157">
          
          
          <code class="ruby">        RecreateChildOidPtiffsJob.perform_later(self)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="158">
          
          
          <code class="ruby">      when &#39;update fulltext status&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="159">
          
          
          <code class="ruby">        UpdateFulltextStatusJob.perform_later(self)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="160">
          
          
          <code class="ruby">      when &#39;sync from preservica&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="161">
          
          
          <code class="ruby">        SyncFromPreservicaJob.perform_later(self)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="162">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="163">
          <span class="hits">7</span>
          
          <code class="ruby">    elsif mets_xml.present?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="164">
          
          
          <code class="ruby">      refresh_metadata_cloud_mets</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="165">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="166">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="167">
          
          
          <code class="ruby">  # rubocop:enable Metrics/CyclomaticComplexity</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="168">
          
          
          <code class="ruby">  # rubocop:enable Metrics/MethodLength</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="169">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="170">
          
          
          <code class="ruby">  # CREATE PARENT OBJECTS: ------------------------------------------------------------------------- #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="171">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="172">
          
          
          <code class="ruby">  # CREATES PARENT OBJECTS FROM INGESTED CSV</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="173">
          
          
          <code class="ruby">  # rubocop:disable  Metrics/AbcSize</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="174">
          
          
          <code class="ruby">  # rubocop:disable  Metrics/MethodLength</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="175">
          
          
          <code class="ruby">  # rubocop:disable  Metrics/PerceivedComplexity</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="176">
          
          
          <code class="ruby">  # rubocop:disable  Metrics/CyclomaticComplexity</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="177">
          <span class="hits">1</span>
          
          <code class="ruby">  def create_new_parent_csv</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="178">
          
          
          <code class="ruby">    parsed_csv.each_with_index do |row, index|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="179">
          
          
          <code class="ruby">      if row[&#39;digital_object_source&#39;].present? &amp;&amp; row[&#39;preservica_uri&#39;].present?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="180">
          
          
          <code class="ruby">        begin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="181">
          
          
          <code class="ruby">          parent_object = CsvRowParentService.new(row, index, current_ability, user).parent_object</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="182">
          
          
          <code class="ruby">          setup_for_background_jobs(parent_object, row[&#39;source&#39;])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="183">
          
          
          <code class="ruby">        rescue CsvRowParentService::BatchProcessingError =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="184">
          
          
          <code class="ruby">          batch_processing_event(e.message, e.kind)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="185">
          
          
          <code class="ruby">          next</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="186">
          
          
          <code class="ruby">        rescue PreservicaImageService::PreservicaImageServiceError =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="187">
          
          
          <code class="ruby">          batch_processing_event(&quot;Skipping row [#{index + 2}] #{e.message}.&quot;, &quot;Skipped Row&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="188">
          
          
          <code class="ruby">          next</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="189">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="190">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="191">
          
          
          <code class="ruby">        oid = row[&#39;oid&#39;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="192">
          
          
          <code class="ruby">        metadata_source = row[&#39;source&#39;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="193">
          
          
          <code class="ruby">        model = row[&#39;parent_model&#39;] || &#39;complex&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="194">
          
          
          <code class="ruby">        admin_set = editable_admin_set(row[&#39;admin_set&#39;], oid, index)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="195">
          
          
          <code class="ruby">        next unless admin_set</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="196">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="197">
          
          
          <code class="ruby">        parent_object = ParentObject.find_or_initialize_by(oid: oid)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="198">
          
          
          <code class="ruby">        # Only runs on newly created parent objects</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="199">
          
          
          <code class="ruby">        unless parent_object.new_record?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="200">
          
          
          <code class="ruby">          batch_processing_event(&quot;Skipping row [#{index + 2}] with existing parent oid: #{oid}&quot;, &#39;Skipped Row&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="201">
          
          
          <code class="ruby">          next</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="202">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="203">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="204">
          
          
          <code class="ruby">        parent_object.parent_model = model</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="205">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="206">
          
          
          <code class="ruby">        setup_for_background_jobs(parent_object, metadata_source)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="207">
          
          
          <code class="ruby">        parent_object.admin_set = admin_set</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="208">
          
          
          <code class="ruby">        # TODO: enable edit action when added to batch actions</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="209">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="210">
          
          
          <code class="ruby">      begin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="211">
          
          
          <code class="ruby">        parent_object.save!</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="212">
          
          
          <code class="ruby">      rescue StandardError =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="213">
          
          
          <code class="ruby">        batch_processing_event(&quot;Skipping row [#{index + 2}] Unable to save parent: #{e.message}.&quot;, &quot;Skipped Row&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="214">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="215">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="216">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="217">
          
          
          <code class="ruby">  # rubocop:enable  Metrics/AbcSize</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="218">
          
          
          <code class="ruby">  # rubocop:enable  Metrics/MethodLength</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="219">
          
          
          <code class="ruby">  # rubocop:enable  Metrics/PerceivedComplexity</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="220">
          
          
          <code class="ruby">  # rubocop:enable  Metrics/CyclomaticComplexity</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="221">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="222">
          
          
          <code class="ruby">  # CHECKS TO SEE IF USER HAS ABILITY TO EDIT AN ADMIN SET:</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="223">
          <span class="hits">1</span>
          
          <code class="ruby">  def editable_admin_set(admin_set_key, oid, index)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="224">
          
          
          <code class="ruby">    admin_sets_hash = {}</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="225">
          
          
          <code class="ruby">    admin_sets_hash[admin_set_key] ||= AdminSet.find_by(key: admin_set_key)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="226">
          
          
          <code class="ruby">    admin_set = admin_sets_hash[admin_set_key]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="227">
          
          
          <code class="ruby">    if admin_set.blank?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="228">
          
          
          <code class="ruby">      batch_processing_event(&quot;Skipping row [#{index + 2}] with unknown admin set [#{admin_set_key}] for parent: #{oid}&quot;, &#39;Skipped Row&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="229">
          
          
          <code class="ruby">      return false</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="230">
          
          
          <code class="ruby">    elsif !current_ability.can?(:add_member, admin_set)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="231">
          
          
          <code class="ruby">      batch_processing_event(&quot;Skipping row [#{index + 2}] because #{user.uid} does not have permission to create or update parent: #{oid}&quot;, &#39;Permission Denied&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="232">
          
          
          <code class="ruby">      return false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="233">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="234">
          
          
          <code class="ruby">      admin_set</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="235">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="236">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="237">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="238">
          
          
          <code class="ruby">  # SHARED BY DELETE, CREATE, AND UPDATE: --------------------------------------------------------- #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="239">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="240">
          
          
          <code class="ruby">  # ASSIGNS PARENT/CHILD OBJECT TO BATCH PROCESS FOR CREATE/DELETE/UPDATE</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="241">
          <span class="hits">1</span>
          
          <code class="ruby">  def setup_for_background_jobs(object, metadata_source)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="242">
          
          
          <code class="ruby">    object.authoritative_metadata_source = MetadataSource.find_by(metadata_cloud_name: (metadata_source.presence || &#39;ladybird&#39;)) if object.class == ParentObject</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="243">
          
          
          <code class="ruby">    object.current_batch_process = self</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="244">
          
          
          <code class="ruby">    object.current_batch_connection = batch_connections.build(connectable: object)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="245">
          
          
          <code class="ruby">    object.current_batch_connection.save! if object.class == ChildObject</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="246">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="247">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="248">
          
          
          <code class="ruby">  # RECREATE CHILD OID PTIFFS: -------------------------------------------------------------------- #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="249">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="250">
          
          
          <code class="ruby">  # RECREATES CHILD OID PTIFFS FROM INGESTED CSV</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="251">
          <span class="hits">1</span>
          
          <code class="ruby">  def update_fulltext_status(offset = 0, limit = -1)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="252">
          
          
          <code class="ruby">    job_oids = oids</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="253">
          
          
          <code class="ruby">    job_oids = job_oids.drop(offset) if offset&amp;.positive?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="254">
          
          
          <code class="ruby">    job_oids = job_oids.first(limit) if limit&amp;.positive?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="255">
          
          
          <code class="ruby">    job_oids.each_with_index do |parent_oid, index|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="256">
          
          
          <code class="ruby">      parent_object = ParentObject.find_by(oid: parent_oid)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="257">
          
          
          <code class="ruby">      if parent_object.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="258">
          
          
          <code class="ruby">        batch_processing_event(&quot;Skipping row [#{index + 2}] because unknown parent: #{parent_oid}&quot;, &#39;Unknown Parent&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="259">
          
          
          <code class="ruby">      elsif current_ability.can?(:update, parent_object)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="260">
          
          
          <code class="ruby">        attach_item(parent_object)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="261">
          
          
          <code class="ruby">        parent_object.child_objects.each { |co| attach_item(co) }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="262">
          
          
          <code class="ruby">        parent_object.processing_event(&quot;Parent #{parent_object.oid} is being processed&quot;, &#39;processing-queued&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="263">
          
          
          <code class="ruby">        parent_object.update_fulltext_for_children</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="264">
          
          
          <code class="ruby">        parent_object.processing_event(&quot;Parent #{parent_object.oid} has been updated&quot;, &#39;update-complete&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="265">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="266">
          
          
          <code class="ruby">        batch_processing_event(&quot;Skipping row [#{index + 2}] because #{user.uid} does not have permission to create or update parent: #{parent_oid}&quot;, &#39;Permission Denied&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="267">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="268">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="269">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="270">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="271">
          
          
          <code class="ruby">  # CHECKS THAT METADATA SOURCE IS VALID - USED BY UPDATE</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="272">
          <span class="hits">1</span>
          
          <code class="ruby">  def validate_metadata_source(metadata_source, index)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="273">
          
          
          <code class="ruby">    if metadata_source == &#39;aspace&#39; || metadata_source == &#39;ils&#39; || metadata_source == &#39;ladybird&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="274">
          
          
          <code class="ruby">      true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="275">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="276">
          
          
          <code class="ruby">      batch_processing_event(&quot;Skipping row [#{index + 2}] with unknown metadata source: #{metadata_source}.  Accepted values are &#39;ladybird&#39;, &#39;aspace&#39;, or &#39;ils&#39;.&quot;, &#39;Skipped Row&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="277">
          
          
          <code class="ruby">      false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="278">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="279">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="280">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="281">
          
          
          <code class="ruby">  # RECREATE CHILD OID PTIFFS: -------------------------------------------------------------------- #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="282">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="283">
          
          
          <code class="ruby">  # RECREATES CHILD OID PTIFFS FROM INGESTED CSV</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="284">
          <span class="hits">1</span>
          
          <code class="ruby">  def recreate_child_oid_ptiffs</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="285">
          <span class="hits">2</span>
          
          <code class="ruby">    parents = Set[]</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="286">
          <span class="hits">2</span>
          
          <code class="ruby">    oids.each_with_index do |oid, index|</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="287">
          <span class="hits">2</span>
          
          <code class="ruby">      child_object = ChildObject.find_by_oid(oid.to_i)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="288">
          <span class="hits">2</span>
          
          <code class="ruby">      unless child_object</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="289">
          
          
          <code class="ruby">        batch_processing_event(&quot;Skipping row [#{index + 2}] with unknown Child: #{oid}&quot;, &#39;Skipped Row&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="290">
          
          
          <code class="ruby">        next</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="291">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="292">
          <span class="hits">2</span>
          
          <code class="ruby">      next unless child_object</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="293">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="294">
          <span class="hits">2</span>
          
          <code class="ruby">      configure_parent_object(child_object, parents)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="295">
          <span class="hits">2</span>
          
          <code class="ruby">      attach_item(child_object)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="296">
          <span class="hits">2</span>
          
          <code class="ruby">      next unless user_update_child_permission(child_object, child_object.parent_object)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="297">
          <span class="hits">1</span>
          
          <code class="ruby">      path = Pathname.new(child_object.access_master_path)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="298">
          <span class="hits">1</span>
          
          <code class="ruby">      file_size = File.exist?(path) ? File.size(path) : 0</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="299">
          <span class="hits">1</span>
          
          <code class="ruby">      GeneratePtiffJob.set(queue: :large_ptiff).perform_later(child_object, self) if file_size &gt; SetupMetadataJob::ONE_GB</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="300">
          <span class="hits">1</span>
          
          <code class="ruby">      GeneratePtiffJob.perform_later(child_object, self) if file_size &lt;= SetupMetadataJob::ONE_GB</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="301">
          <span class="hits">1</span>
          
          <code class="ruby">      attach_item(child_object)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="302">
          <span class="hits">1</span>
          
          <code class="ruby">      child_object.processing_event(&quot;Ptiff Queued&quot;, &quot;ptiff-queued&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="303">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="304">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="305">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="306">
          
          
          <code class="ruby">  # SETS COMPLETE STATUS FOR RECREATE JOB</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="307">
          <span class="hits">1</span>
          
          <code class="ruby">  def are_all_children_complete?(parent_object)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="308">
          <span class="hits">1</span>
          
          <code class="ruby">    child_objects.where(parent_object: parent_object).all? do |co|</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="309">
          <span class="hits">1</span>
          
          <code class="ruby">      co.status_for_batch_process(self) == &#39;Complete&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="310">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="311">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="312">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="313">
          
          
          <code class="ruby">  # CHECKS TO SEE IF USER HAS THE ABILITY TO UPDATE CHILD OBJECTS:</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="314">
          <span class="hits">1</span>
          
          <code class="ruby">  def user_update_child_permission(child_object, parent_object)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="315">
          <span class="hits">2</span>
          
          <code class="ruby">    user = self.user</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="316">
          <span class="hits">2</span>
          
          <code class="ruby">    unless current_ability.can? :update, child_object</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="317">
          <span class="hits">1</span>
          
          <code class="ruby">      batch_processing_event(&quot;#{user.uid} does not have permission to update Child: #{child_object.oid} on Parent: #{child_object.parent_object.oid}&quot;, &#39;Permission Denied&#39;)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="318">
          <span class="hits">1</span>
          
          <code class="ruby">      child_object.processing_event(&quot;#{user.uid} does not have permission to update Child: #{child_object.oid}&quot;, &#39;Permission Denied&#39;)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="319">
          <span class="hits">1</span>
          
          <code class="ruby">      parent_object.processing_event(&quot;#{user.uid} does not have permission to update Child: #{child_object.oid}&quot;, &#39;Permission Denied&#39;)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="320">
          <span class="hits">1</span>
          
          <code class="ruby">      return false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="321">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="322">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="323">
          <span class="hits">1</span>
          
          <code class="ruby">    true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="324">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="325">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="326">
          
          
          <code class="ruby">  # USED BY RECREATE CHILD OID PTIFF BATCH PROCESS: ----------------------------------------------- #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="327">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="328">
          
          
          <code class="ruby">  # CONNECTS CHILD OIDS BATCH PROCESS TO PARENT OBJECT</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="329">
          <span class="hits">1</span>
          
          <code class="ruby">  def configure_parent_object(child_object, parents)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="330">
          <span class="hits">2</span>
          
          <code class="ruby">    parent_object = child_object.parent_object</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="331">
          <span class="hits">2</span>
          
          <code class="ruby">    unless parents.include? parent_object.oid</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="332">
          <span class="hits">2</span>
          
          <code class="ruby">      attach_item(parent_object)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="333">
          <span class="hits">2</span>
          
          <code class="ruby">      parent_object.processing_event(&quot;Connection to batch created&quot;, &quot;parent-connection-created&quot;)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="334">
          <span class="hits">2</span>
          
          <code class="ruby">      parents.add parent_object.oid</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="335">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="336">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="337">
          <span class="hits">2</span>
          
          <code class="ruby">    parents</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="338">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="339">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="340">
          
          
          <code class="ruby">  # METS METADATA CLOUD: ------------------------------------------------------------------------- #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="341">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="342">
          
          
          <code class="ruby">  # MAKES CALL FOR UPDATED DATA</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="343">
          <span class="hits">1</span>
          
          <code class="ruby">  def refresh_metadata_cloud_mets</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="344">
          
          
          <code class="ruby">    metadata_source = mets_doc.metadata_source</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="345">
          
          
          <code class="ruby">    if ParentObject.exists?(oid: oid)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="346">
          
          
          <code class="ruby">      batch_processing_event(&quot;Skipping mets import for existing parent: #{oid}&quot;, &#39;Skipped Import&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="347">
          
          
          <code class="ruby">      return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="348">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="349">
          
          
          <code class="ruby">    ParentObject.create(oid: oid) do |parent_object|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="350">
          
          
          <code class="ruby">      set_values_from_mets(parent_object, metadata_source)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="351">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="352">
          
          
          <code class="ruby">    PreservicaIngest.create(parent_oid: oid, preservica_id: mets_doc.parent_uuid, batch_process_id: id, ingest_time: Time.current) unless mets_doc.parent_uuid.nil?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="353">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="354">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="355">
          
          
          <code class="ruby">  # SETS VALUES FROM METS METADATA</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="356">
          
          
          <code class="ruby">  # rubocop:disable Metrics/AbcSize</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="357">
          <span class="hits">1</span>
          
          <code class="ruby">  def set_values_from_mets(parent_object, metadata_source)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="358">
          
          
          <code class="ruby">    parent_object.bib = mets_doc.bib</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="359">
          
          
          <code class="ruby">    parent_object.barcode = mets_doc.barcode</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="360">
          
          
          <code class="ruby">    parent_object.holding = mets_doc.holding</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="361">
          
          
          <code class="ruby">    parent_object.item = mets_doc.item</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="362">
          
          
          <code class="ruby">    parent_object.visibility = mets_doc.visibility</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="363">
          
          
          <code class="ruby">    parent_object.rights_statement = mets_doc.rights_statement</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="364">
          
          
          <code class="ruby">    parent_object.viewing_direction = mets_doc.viewing_direction</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="365">
          
          
          <code class="ruby">    parent_object.display_layout = mets_doc.viewing_hint</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="366">
          
          
          <code class="ruby">    parent_object.aspace_uri = mets_doc.aspace_uri if mets_doc.valid_aspace?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="367">
          
          
          <code class="ruby">    setup_for_background_jobs(parent_object, metadata_source)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="368">
          
          
          <code class="ruby">    parent_object.from_mets = true</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="369">
          
          
          <code class="ruby">    parent_object.last_mets_update = Time.current</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="370">
          
          
          <code class="ruby">    parent_object.representative_child_oid = mets_doc.thumbnail_image</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="371">
          
          
          <code class="ruby">    parent_object.admin_set = mets_doc.admin_set</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="372">
          
          
          <code class="ruby">    parent_object.extent_of_digitization = mets_doc.extent_of_dig</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="373">
          
          
          <code class="ruby">    parent_object.digitization_note = mets_doc.dig_note</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="374">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="375">
          
          
          <code class="ruby">  # rubocop:enable Metrics/AbcSize</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="376">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="377">
          
          
          <code class="ruby">  # FETCHES CHILD OBJECTS FROM PRESERVICA</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="378">
          
          
          <code class="ruby">  # rubocop:disable Metrics/MethodLength</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="379">
          
          
          <code class="ruby">  # rubocop:disable Metrics/AbcSize</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="380">
          <span class="hits">1</span>
          
          <code class="ruby">  def sync_from_preservica</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="381">
          
          
          <code class="ruby">    parsed_csv.each_with_index do |row, _index|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="382">
          
          
          <code class="ruby">      begin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="383">
          
          
          <code class="ruby">        parent_object = ParentObject.find(row[&#39;oid&#39;])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="384">
          
          
          <code class="ruby">      rescue</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="385">
          
          
          <code class="ruby">        batch_processing_event(&quot;Parent OID: #{row[&#39;oid&#39;]} not found in database&quot;, &#39;Skipped Import&#39;) if parent_object.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="386">
          
          
          <code class="ruby">        next</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="387">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="388">
          
          
          <code class="ruby">      next unless validate_preservica_sync(parent_object, row)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="389">
          
          
          <code class="ruby">      local_children_hash = {}</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="390">
          
          
          <code class="ruby">      parent_object.child_objects.each do |local_co|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="391">
          
          
          <code class="ruby">        local_children_hash[&quot;hash_#{local_co.order}&quot;.to_sym] = { order: local_co.order,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="392">
          
          
          <code class="ruby">                                                                 content_uri: local_co.preservica_content_object_uri,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="393">
          
          
          <code class="ruby">                                                                 generation_uri: local_co.preservica_generation_uri,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="394">
          
          
          <code class="ruby">                                                                 bitstream_uri: local_co.preservica_bitstream_uri }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="395">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="396">
          
          
          <code class="ruby">      begin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="397">
          
          
          <code class="ruby">        preservica_children_hash = {}</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="398">
          
          
          <code class="ruby">        PreservicaImageService.new(parent_object.preservica_uri, parent_object.admin_set.key).image_list(parent_object.preservica_representation_name).each_with_index do |preservica_co, index|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="399">
          
          
          <code class="ruby">          # increment by one so index lines up with order</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="400">
          
          
          <code class="ruby">          index_plus_one = index + 1</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="401">
          
          
          <code class="ruby">          preservica_children_hash[&quot;hash_#{index_plus_one}&quot;.to_sym] = { order: index_plus_one,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="402">
          
          
          <code class="ruby">                                                                        content_uri: preservica_co[:preservica_content_object_uri],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="403">
          
          
          <code class="ruby">                                                                        generation_uri: preservica_co[:preservica_generation_uri],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="404">
          
          
          <code class="ruby">                                                                        bitstream_uri: preservica_co[:preservica_bitstream_uri] }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="405">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="406">
          
          
          <code class="ruby">      rescue PreservicaImageServiceNetworkError =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="407">
          
          
          <code class="ruby">        batch_processing_event(&quot;Parent OID: #{row[&#39;oid&#39;]} because of #{e.message}&quot;, &#39;Skipped Import&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="408">
          
          
          <code class="ruby">        raise</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="409">
          
          
          <code class="ruby">      rescue PreservicaImageServiceError =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="410">
          
          
          <code class="ruby">        batch_processing_event(&quot;Parent OID: #{row[&#39;oid&#39;]} because of #{e.message}&quot;, &#39;Skipped Import&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="411">
          
          
          <code class="ruby">        next</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="412">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="413">
          
          
          <code class="ruby">      sync_images_preservica(local_children_hash, preservica_children_hash, parent_object)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="414">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="415">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="416">
          
          
          <code class="ruby">  # rubocop:enable Metrics/MethodLength</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="417">
          
          
          <code class="ruby">  # rubocop:enable Metrics/AbcSize</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="418">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="419">
          
          
          <code class="ruby">  # SYNC IMAGES FROM PRESERVICA</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="420">
          <span class="hits">1</span>
          
          <code class="ruby">  def sync_images_preservica(local_children_hash, preservica_children_hash, parent_object)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="421">
          
          
          <code class="ruby">    if local_children_hash != preservica_children_hash</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="422">
          
          
          <code class="ruby">      parent_object.sync_from_preservica(local_children_hash, preservica_children_hash)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="423">
          
          
          <code class="ruby">      setup_for_background_jobs(parent_object, parent_object.source_name)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="424">
          
          
          <code class="ruby">    elsif fails_fixity_check(parent_object)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="425">
          
          
          <code class="ruby">      batch_processing_event(&quot;Checksum mismatch found on parent object: #{parent_object.oid}&quot;, &quot;Row Processed&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="426">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="427">
          
          
          <code class="ruby">      batch_processing_event(&quot;Child object count and order is the same.  No update needed.&quot;, &quot;Skipped Row&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="428">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="429">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="430">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="431">
          <span class="hits">1</span>
          
          <code class="ruby">  def fails_fixity_check(parent_object)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="432">
          
          
          <code class="ruby">    # iterate through images in pairtree and get checksums</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="433">
          
          
          <code class="ruby">    local_checksums = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="434">
          
          
          <code class="ruby">    parent_object.child_objects.each do |co|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="435">
          
          
          <code class="ruby">      local_checksums &lt;&lt; co.sha512_checksum</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="436">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="437">
          
          
          <code class="ruby">    # iterate through preservica images and get checksums</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="438">
          
          
          <code class="ruby">    preservica_checksums = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="439">
          
          
          <code class="ruby">    PreservicaImageService.new(parent_object.preservica_uri, parent_object.admin_set.key).image_list(parent_object.preservica_representation_name).each do |preservica_co|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="440">
          
          
          <code class="ruby">      preservica_checksums &lt;&lt; preservica_co[:sha512_checksum]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="441">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="442">
          
          
          <code class="ruby">    # compare and return true if there is a mismatch</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="443">
          
          
          <code class="ruby">    if local_checksums != preservica_checksums</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="444">
          
          
          <code class="ruby">      true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="445">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="446">
          
          
          <code class="ruby">      false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="447">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="448">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="449">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="450">
          
          
          <code class="ruby">  # rubocop:disable Metrics/MethodLength</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="451">
          
          
          <code class="ruby">  # ERROR HANDLING FOR PRESERVICA SYNC</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="452">
          <span class="hits">1</span>
          
          <code class="ruby">  def validate_preservica_sync(parent_object, row)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="453">
          
          
          <code class="ruby">    if parent_object.redirect_to.present?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="454">
          
          
          <code class="ruby">      batch_processing_event(&quot;Parent OID: #{row[&#39;oid&#39;]} is a redirected parent object&quot;, &#39;Skipped Import&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="455">
          
          
          <code class="ruby">      false</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="456">
          
          
          <code class="ruby">    elsif parent_object.preservica_uri.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="457">
          
          
          <code class="ruby">      batch_processing_event(&quot;Parent OID: #{row[&#39;oid&#39;]} does not have a Preservica URI&quot;, &#39;Skipped Import&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="458">
          
          
          <code class="ruby">      false</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="459">
          
          
          <code class="ruby">    elsif parent_object.digital_object_source != &quot;Preservica&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="460">
          
          
          <code class="ruby">      batch_processing_event(&quot;Parent OID: #{row[&#39;oid&#39;]} does not have a Preservica digital object source&quot;, &#39;Skipped Import&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="461">
          
          
          <code class="ruby">      false</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="462">
          
          
          <code class="ruby">    elsif parent_object.preservica_representation_name.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="463">
          
          
          <code class="ruby">      batch_processing_event(&quot;Parent OID: #{row[&#39;oid&#39;]} does not have a Preservica representation name&quot;, &#39;Skipped Import&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="464">
          
          
          <code class="ruby">      false</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="465">
          
          
          <code class="ruby">    elsif !parent_object.admin_set.preservica_credentials_verified</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="466">
          
          
          <code class="ruby">      batch_processing_event(&quot;Admin set #{parent_object.admin_set.key} does not have Preservica credentials set&quot;, &#39;Skipped Import&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="467">
          
          
          <code class="ruby">      false</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="468">
          
          
          <code class="ruby">    elsif !current_ability.can?(:update, parent_object)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="469">
          
          
          <code class="ruby">      batch_processing_event(&quot;Skipping row with parent oid: #{parent_object.oid}, user does not have permission to update&quot;, &#39;Permission Denied&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="470">
          
          
          <code class="ruby">      false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="471">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="472">
          
          
          <code class="ruby">      true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="473">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="474">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="475">
          
          
          <code class="ruby">  # rubocop:enable Metrics/MethodLength</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="476">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="477">
          
          
          <code class="ruby">  # BATCH STATUSES: ------------------------------------------------------------------------------ #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="478">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="479">
          
          
          <code class="ruby">  # SETS BATCH STATUS BASED ON CURRENT STATUS</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="480">
          <span class="hits">1</span>
          
          <code class="ruby">  def batch_status</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="481">
          
          
          <code class="ruby">    current_status = status_hash</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="482">
          
          
          <code class="ruby">    if single_status(current_status)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="483">
          
          
          <code class="ruby">      single_status(current_status)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="484">
          
          
          <code class="ruby">    elsif current_status[:failed] != 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="485">
          
          
          <code class="ruby">      &quot;#{current_status[:failed]} out of #{current_status[:total].to_i} parent objects have a failure.&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="486">
          
          
          <code class="ruby">    elsif current_status[:in_progress] != 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="487">
          
          
          <code class="ruby">      &quot;#{current_status[:in_progress]} out of #{current_status[:total].to_i} parent objects are in progress.&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="488">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="489">
          
          
          <code class="ruby">      &quot;View Messages&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="490">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="491">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="492">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="493">
          
          
          <code class="ruby">  # SETS BATCH SINGLE STATUS</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="494">
          <span class="hits">1</span>
          
          <code class="ruby">  def single_status(current_status)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="495">
          
          
          <code class="ruby">    if current_status[:in_progress] / current_status[:total] == 1</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="496">
          
          
          <code class="ruby">      &quot;Batch in progress - no failures&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="497">
          
          
          <code class="ruby">    elsif current_status[:complete] / current_status[:total] == 1</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="498">
          
          
          <code class="ruby">      &quot;Batch complete&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="499">
          
          
          <code class="ruby">    elsif current_status[:failed] / current_status[:total] == 1</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="500">
          
          
          <code class="ruby">      &quot;Batch failed&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="501">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="502">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="503">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="504">
          
          
          <code class="ruby">  # GETS LIST OF CONNECTED STATUSES</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="505">
          <span class="hits">1</span>
          
          <code class="ruby">  def connected_statuses</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="506">
          
          
          <code class="ruby">    @connected_statuses ||= batch_connections.where(connectable_type: &quot;ParentObject&quot;).map(&amp;:status)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="507">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="508">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="509">
          
          
          <code class="ruby">  # COUNTS CURRENT STATUSES</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="510">
          <span class="hits">1</span>
          
          <code class="ruby">  def status_hash</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="511">
          
          
          <code class="ruby">    @status_hash ||= {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="512">
          
          
          <code class="ruby">      complete: connected_statuses.count(&quot;Complete&quot;) + connected_statuses.count(&quot;Parent object deleted successfully&quot;),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="513">
          
          
          <code class="ruby">      in_progress: connected_statuses.count(&quot;In progress - no failures&quot;),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="514">
          
          
          <code class="ruby">      failed: connected_statuses.count(&quot;Failed&quot;),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="515">
          
          
          <code class="ruby">      unknown: connected_statuses.count(&quot;Unknown&quot;),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="516">
          
          
          <code class="ruby">      total: connected_statuses.count.to_f</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="517">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="518">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="519">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="debc041c42081c545d1bd39008ac41e2079b88c0">
  <div class="header">
    <h3>app/models/child_object.rb</h3>
    <h4><span class="red">51.46 %</span> covered</h4>
    <div>
      <b>103</b> relevant lines. 
      <span class="green"><b>53</b> lines covered</span> and
      <span class="red"><b>50</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># frozen_string_literal: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby">#</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby"># ChildObjects are _deleted_ when parents are destroyed; expect that ChildObjects will be</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"># deleted _without_ any destroy hooks called.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">#</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby"># rubocop:disable ClassLength</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">class ChildObject &lt; ApplicationRecord</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">  # rubocop:enable ClassLength</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">  has_paper_trail</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>
          
          <code class="ruby">  include Statable</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">  include Delayable</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="14">
          <span class="hits">1</span>
          
          <code class="ruby">  include SolrIndexable</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="15">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :parent_object, foreign_key: &#39;parent_object_oid&#39;, class_name: &quot;ParentObject&quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :batch_connections, as: :connectable</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="17">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :batch_processes, through: :batch_connections</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="18">
          <span class="hits">1</span>
          
          <code class="ruby">  has_one :admin_set, through: :parent_object</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="19">
          <span class="hits">1</span>
          
          <code class="ruby">  self.primary_key = &#39;oid&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="20">
          <span class="hits">1</span>
          
          <code class="ruby">  paginates_per 50</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="21">
          <span class="hits">1</span>
          
          <code class="ruby">  attr_accessor :current_batch_process</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="22">
          <span class="hits">1</span>
          
          <code class="ruby">  attr_accessor :current_batch_connection</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">  # Does not get called because we use upsert to create children</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">  # before_create :check_for_size_and_file</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">  # Options from iiif presentation api 2.1 - see https://iiif.io/api/presentation/2.1/#viewinghint</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">  # These are added to the manifest on the canvas level</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="29">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.viewing_hints</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="30">
          
          
          <code class="ruby">    [nil, &quot;non-paged&quot;, &quot;facing-pages&quot;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="33">
          <span class="hits">1</span>
          
          <code class="ruby">  def start_states</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="34">
          
          
          <code class="ruby">    [&quot;ptiff-queued&quot;, &quot;processing-queued&quot;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="37">
          <span class="hits">1</span>
          
          <code class="ruby">  def finished_states</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="38">
          <span class="hits">3</span>
          
          <code class="ruby">    [&#39;deleted&#39;, &#39;ptiff-ready-skipped&#39;, &#39;ptiff-ready&#39;, &#39;reassociate-complete&#39;, &#39;update-complete&#39;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="41">
          <span class="hits">1</span>
          
          <code class="ruby">  def check_for_size_and_file</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="42">
          
          
          <code class="ruby">    width_and_height(remote_metadata)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="45">
          <span class="hits">1</span>
          
          <code class="ruby">  def remote_ptiff_exists?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="46">
          
          
          <code class="ruby">    remote_metadata</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="49">
          <span class="hits">1</span>
          
          <code class="ruby">  def remote_metadata</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="50">
          
          
          <code class="ruby">    S3Service.remote_metadata(remote_ptiff_path)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="53">
          <span class="hits">1</span>
          
          <code class="ruby">  def remote_ocr</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="54">
          
          
          <code class="ruby">    S3Service.full_text_exists?(remote_ocr_path)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="57">
          <span class="hits">1</span>
          
          <code class="ruby">  def access_master_path</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="58">
          <span class="hits">3</span>
          
          <code class="ruby">    return @access_master_path if @access_master_path</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="59">
          <span class="hits">3</span>
          
          <code class="ruby">    image_mount = ENV[&#39;ACCESS_MASTER_MOUNT&#39;] || &quot;data&quot;</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="60">
          <span class="hits">3</span>
          
          <code class="ruby">    pairtree_path = Partridge::Pairtree.oid_to_pairtree(oid)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="61">
          <span class="hits">3</span>
          
          <code class="ruby">    directory = format(&quot;%02d&quot;, pairtree_path.first)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="62">
          <span class="hits">3</span>
          
          <code class="ruby">    @access_master_path = File.join(image_mount, directory, pairtree_path, &quot;#{oid}.tif&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby">  # rubocop:disable  Metrics/MethodLength</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="66">
          <span class="hits">1</span>
          
          <code class="ruby">  def copy_to_access_master_pairtree</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby">    # Don&#39;t copy over existing access masters if they already exist</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby">    # TODO: Determine what happens if it&#39;s an intentional re-shoot of a child image</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby">    #  1. How is that signalled? (ensure that it&#39;s an intentional re-shoot, not accidental duplication)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby">    #  2. We assume that there is only one access master at a time - BUT we only have one access master pair-tree</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby">    #     across *all* environments (no separation of dev, test, uat, production)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="72">
          
          
          <code class="ruby">    #     how do we ensure we don&#39;t accidentally overwrite something we want to keep?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="73">
          
          
          <code class="ruby">    if access_master_exists? &amp;&amp; access_master_checksum_matches?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="74">
          
          
          <code class="ruby">      processing_event(&quot;Not copied from Goobi package to access master pair-tree, already exists&quot;, &#39;access-master-exists&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="75">
          
          
          <code class="ruby">      return true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="76">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="77">
          
          
          <code class="ruby">    unless mets_access_master_checksum_matches?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="78">
          
          
          <code class="ruby">      processing_event(&quot;Original Copy of checksum does not match&quot;, &#39;failed&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="79">
          
          
          <code class="ruby">      false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="81">
          
          
          <code class="ruby">    image_mount = ENV[&#39;ACCESS_MASTER_MOUNT&#39;] || &quot;data&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="82">
          
          
          <code class="ruby">    pairtree_path = Partridge::Pairtree.oid_to_pairtree(oid)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="83">
          
          
          <code class="ruby">    directory = format(&quot;%02d&quot;, pairtree_path.first)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="84">
          
          
          <code class="ruby">    # Create path to access master if it doesn&#39;t exist</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="85">
          
          
          <code class="ruby">    FileUtils.mkdir_p(File.join(image_mount, directory, pairtree_path))</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="86">
          
          
          <code class="ruby">    FileUtils.cp(mets_access_master_path, access_master_path)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="87">
          
          
          <code class="ruby">    if access_master_checksum_matches?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="88">
          
          
          <code class="ruby">      processing_event(&quot;Copied from Goobi package to access master pair-tree&quot;, &#39;goobi-copied&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="89">
          
          
          <code class="ruby">      true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="90">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="91">
          
          
          <code class="ruby">      processing_event(&quot;Copy from Goobi to access master failed checksum check&quot;, &#39;failed&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="92">
          
          
          <code class="ruby">      false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="93">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="94">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="95">
          
          
          <code class="ruby">  # rubocop:enable  Metrics/MethodLength</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="96">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="97">
          <span class="hits">1</span>
          
          <code class="ruby">  def access_master_checksum_matches?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="98">
          
          
          <code class="ruby">    access_master_checksum = Digest::SHA1.file(access_master_path).to_s</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="99">
          
          
          <code class="ruby">    checksum == access_master_checksum</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="100">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="101">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="102">
          <span class="hits">1</span>
          
          <code class="ruby">  def mets_access_master_checksum_matches?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="103">
          
          
          <code class="ruby">    mets_master_checksum = Digest::SHA1.file(mets_access_master_path).to_s</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="104">
          
          
          <code class="ruby">    checksum == mets_master_checksum</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="105">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="106">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="107">
          <span class="hits">1</span>
          
          <code class="ruby">  def access_master_exists?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="108">
          
          
          <code class="ruby">    File.exist?(access_master_path)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="109">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="110">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="111">
          <span class="hits">1</span>
          
          <code class="ruby">  def remote_access_master_path</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="112">
          
          
          <code class="ruby">    return @remote_access_master_path if @remote_access_master_path</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="113">
          
          
          <code class="ruby">    image_bucket = &quot;originals&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="114">
          
          
          <code class="ruby">    pairtree_path = Partridge::Pairtree.oid_to_pairtree(oid)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="115">
          
          
          <code class="ruby">    @remote_access_master_path = File.join(image_bucket, pairtree_path, &quot;#{oid}.tif&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="116">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="117">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="118">
          <span class="hits">1</span>
          
          <code class="ruby">  def remote_ptiff_path</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="119">
          <span class="hits">2</span>
          
          <code class="ruby">    return @remote_ptiff_path if @remote_ptiff_path</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="120">
          <span class="hits">2</span>
          
          <code class="ruby">    pairtree_path = Partridge::Pairtree.oid_to_pairtree(oid)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="121">
          <span class="hits">2</span>
          
          <code class="ruby">    @remote_ptiff_path = File.join(&quot;ptiffs&quot;, pairtree_path, File.basename(access_master_path))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="122">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="123">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="124">
          <span class="hits">1</span>
          
          <code class="ruby">  def remote_ocr_path</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="125">
          
          
          <code class="ruby">    return @remote_ocr_path if @remote_ocr_path</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="126">
          
          
          <code class="ruby">    pairtree_path = Partridge::Pairtree.oid_to_pairtree(oid)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="127">
          
          
          <code class="ruby">    @remote_ocr_path = File.join(&#39;fulltext&#39;, pairtree_path, &quot;#{oid}.txt&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="128">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="129">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="130">
          <span class="hits">1</span>
          
          <code class="ruby">  def remote_ocr_exists?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="131">
          
          
          <code class="ruby">    return @remote_ocr_exists if @remote_ocr_exists</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="132">
          
          
          <code class="ruby">    @remote_ocr_exists = ChildObject.remote_ocr_exists?(oid)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="133">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="134">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="135">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.remote_ocr_exists?(oid)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="136">
          
          
          <code class="ruby">    pairtree_path = Partridge::Pairtree.oid_to_pairtree(oid)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="137">
          
          
          <code class="ruby">    remote_ocr_path = File.join(&#39;fulltext&#39;, pairtree_path, &quot;#{oid}.txt&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="138">
          
          
          <code class="ruby">    S3Service.full_text_exists?(remote_ocr_path)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="139">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="140">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="141">
          <span class="hits">1</span>
          
          <code class="ruby">  def pyramidal_tiff</code>
        </li>
      
        <li class="covered" data-hits="10" data-linenumber="142">
          <span class="hits">10</span>
          
          <code class="ruby">    @pyramidal_tiff ||= PyramidalTiff.new(self)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="143">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="144">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="145">
          <span class="hits">1</span>
          
          <code class="ruby">  def thumbnail_url</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="146">
          
          
          <code class="ruby">    &quot;#{IiifPresentationV3.new(parent_object).image_service_url(oid)}/full/!200,200/0/default.jpg&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="147">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="148">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="149">
          <span class="hits">1</span>
          
          <code class="ruby">  def width_and_height(size)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="150">
          
          
          <code class="ruby">    return unless size.present? &amp;&amp; size[:width].to_i.positive? &amp;&amp; size[:height].to_i.positive?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="151">
          
          
          <code class="ruby">    self.width = size[:width].to_i</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="152">
          
          
          <code class="ruby">    self.height = size[:height].to_i</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="153">
          
          
          <code class="ruby">    self.ptiff_conversion_at = Time.zone.now if remote_ptiff_exists?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="154">
          
          
          <code class="ruby">    size</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="155">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="156">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="157">
          <span class="hits">1</span>
          
          <code class="ruby">  def convert_to_ptiff</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="158">
          <span class="hits">2</span>
          
          <code class="ruby">    if pyramidal_tiff.valid?</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="159">
          <span class="hits">2</span>
          
          <code class="ruby">      if pyramidal_tiff.conversion_information&amp;.[](:width)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="160">
          
          
          <code class="ruby">        processing_event(&quot;PTIFF ready for #{oid}&quot;, &#39;ptiff-ready&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="161">
          
          
          <code class="ruby">        width_and_height(pyramidal_tiff.conversion_information)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="162">
          
          
          <code class="ruby">        # Conversion info is true if the ptiff was skipped as already present</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="163">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="164">
          <span class="hits">2</span>
          
          <code class="ruby">      true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="165">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="166">
          
          
          <code class="ruby">      report_ptiff_generation_error</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="167">
          
          
          <code class="ruby">      raise &quot;Child Object #{oid} failed to convert PTIFF due to #{pyramidal_tiff.errors.full_messages.join(&#39;\n&#39;)}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="168">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="169">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="170">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="171">
          <span class="hits">1</span>
          
          <code class="ruby">  def report_ptiff_generation_error</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="172">
          
          
          <code class="ruby">    parent_object&amp;.processing_event(&quot;Child Object #{oid} failed to convert PTIFF due to #{pyramidal_tiff.errors.full_messages.join(&quot;\n&quot;)}&quot;, &quot;failed&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="173">
          
          
          <code class="ruby">    processing_event(&quot;Child Object #{oid} failed to convert PTIFF due to #{pyramidal_tiff.errors.full_messages.join(&quot;\n&quot;)}&quot;, &quot;failed&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="174">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="175">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="176">
          <span class="hits">1</span>
          
          <code class="ruby">  def convert_to_ptiff!(force = false)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="177">
          <span class="hits">2</span>
          
          <code class="ruby">    pyramidal_tiff.force_update = force</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="178">
          <span class="hits">2</span>
          
          <code class="ruby">    convert_to_ptiff &amp;&amp; save!</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="179">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="180">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="181">
          <span class="hits">1</span>
          
          <code class="ruby">  def batch_connections_for(batch_process)</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="182">
          <span class="hits">4</span>
          
          <code class="ruby">    batch_connections.where(batch_process: batch_process)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="183">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="184">
          
          
          <code class="ruby">end # rubocop:enable  Metrics/ClassLength</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="16c1f454139d1a65576bfb1dc4802cbe2cd697f6">
  <div class="header">
    <h3>app/models/concerns/csv_exportable.rb</h3>
    <h4><span class="red">17.33 %</span> covered</h4>
    <div>
      <b>75</b> relevant lines. 
      <span class="green"><b>13</b> lines covered</span> and
      <span class="red"><b>62</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># frozen_string_literal: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"># rubocop:disable Metrics/ModuleLength</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">module CsvExportable</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">  extend ActiveSupport::Concern</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">  ########################</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">  # Parent Object Export</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">  ########################</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="10">
          <span class="hits">1</span>
          
          <code class="ruby">  def parent_headers</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="11">
          
          
          <code class="ruby">    [&#39;oid&#39;, &#39;admin_set&#39;, &#39;authoritative_source&#39;, &#39;child_object_count&#39;, &#39;call_number&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">     &#39;container_grouping&#39;, &#39;bib&#39;, &#39;holding&#39;, &#39;item&#39;, &#39;barcode&#39;, &#39;aspace_uri&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">     &#39;digital_object_source&#39;, &#39;preservica_uri&#39;, &#39;last_ladybird_update&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">     &#39;last_voyager_update&#39;, &#39;last_aspace_update&#39;, &#39;last_id_update&#39;, &#39;visibility&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">     &#39;extent_of_digitization&#39;, &#39;digitization_note&#39;, &#39;project_identifier&#39;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">  # rubocop:disable Metrics/AbcSize</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="19">
          <span class="hits">1</span>
          
          <code class="ruby">  def parent_output_csv(*admin_set_id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="20">
          
          
          <code class="ruby">    return nil unless batch_action == &#39;export all parent objects by admin set&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="21">
          
          
          <code class="ruby">    csv_rows = parent_object_csv_rows(*admin_set_id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="22">
          
          
          <code class="ruby">    add_error_rows(csv_rows)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">    # sort first by the admin set label, then by the parent object oid</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="24">
          
          
          <code class="ruby">    csv_rows.sort_by! { |row| [row[1], row[0]&amp;.to_s] }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="25">
          
          
          <code class="ruby">    output_csv = CSV.generate do |csv|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="26">
          
          
          <code class="ruby">      csv &lt;&lt; parent_headers</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="27">
          
          
          <code class="ruby">      csv_rows.each do |row|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="28">
          
          
          <code class="ruby">        csv &lt;&lt; row</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="31">
          
          
          <code class="ruby">    save_to_s3(output_csv, self)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="32">
          
          
          <code class="ruby">    output_csv</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">  # rubocop:enable Metrics/AbcSize</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="36">
          <span class="hits">1</span>
          
          <code class="ruby">  def parent_object_csv_rows(*admin_set_id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="37">
          
          
          <code class="ruby">    parent_objects_array(*admin_set_id).map do |po|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="38">
          
          
          <code class="ruby">      [po.oid, po.admin_set.label, po.source_name,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">       po.child_object_count, po.call_number, po.container_grouping, po.bib, po.holding, po.item,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">       po.barcode, po.aspace_uri, po.digital_object_source, po.preservica_uri,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">       po.last_ladybird_update, po.last_voyager_update,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">       po.last_aspace_update, po.last_id_update, po.visibility, po.extent_of_digitization,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby">       po.digitization_note, po.project_identifier]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby">  # rubocop:disable Metrics/AbcSize</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby">  # rubocop:disable Metrics/MethodLength</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">  # rubocop:disable Metrics/PerceivedComplexity</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby">  # rubocop:disable Lint/UselessAssignment</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="51">
          <span class="hits">1</span>
          
          <code class="ruby">  def parent_objects_array(*admin_set_id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="52">
          
          
          <code class="ruby">    arr = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="53">
          
          
          <code class="ruby">    if csv.present?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="54">
          
          
          <code class="ruby">      imported_csv = CSV.parse(csv, headers: true).presence</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="55">
          
          
          <code class="ruby">      imported_csv.each_with_index do |row, index|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby">        begin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="57">
          
          
          <code class="ruby">          admin_set = AdminSet.find_by(key: row[0])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="58">
          
          
          <code class="ruby">          raise ActiveRecord::RecordNotFound if admin_set.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="59">
          
          
          <code class="ruby">          if user.viewer(admin_set) || user.editor(admin_set)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="60">
          
          
          <code class="ruby">            ParentObject.where(admin_set_id: admin_set.id).find_each do |parent|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="61">
          
          
          <code class="ruby">              arr &lt;&lt; parent</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby">          else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="64">
          
          
          <code class="ruby">            (@error_rows ||= []) &lt;&lt; { row2: admin_set.key, csv_message: &#39;Access denied for admin set&#39;, batch_message: &quot;Skipping row [#{index + 2}] due to  admin set permissions: #{admin_set.key}&quot; }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby">        rescue ActiveRecord::RecordNotFound</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="67">
          
          
          <code class="ruby">          (@error_rows ||= []) &lt;&lt; { row2: row[0], csv_message: &#39;Admin Set not found in database&#39;, batch_message: &quot;Skipping row [#{index + 2}]  due to Admin Set not found: #{row[0]}&quot; }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="71">
          
          
          <code class="ruby">      admin_set_id.each do |id|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="72">
          
          
          <code class="ruby">        admin_set = AdminSet.find_by(id: id.to_i)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="73">
          
          
          <code class="ruby">        if user.viewer(admin_set) || user.editor(admin_set)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="74">
          
          
          <code class="ruby">          ParentObject.where(admin_set_id: id.to_i).find_each do |parent|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="75">
          
          
          <code class="ruby">            arr &lt;&lt; parent</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="76">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="78">
          
          
          <code class="ruby">          (@error_rows ||= []) &lt;&lt; { row2: admin_set.key, csv_message: &#39;Access denied for admin set&#39;, batch_message: &quot;Skipping admin set due to admin set permissions: #{admin_set.key}&quot; }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="79">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="81">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="82">
          
          
          <code class="ruby">    arr</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="83">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="84">
          
          
          <code class="ruby">  # rubocop:enable Metrics/AbcSize</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="85">
          
          
          <code class="ruby">  # rubocop:enable Metrics/MethodLength</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="86">
          
          
          <code class="ruby">  # rubocop:enable Metrics/PerceivedComplexity</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="87">
          
          
          <code class="ruby">  # rubocop:enable Lint/UselessAssignment</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="88">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="89">
          
          
          <code class="ruby">  ########################</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="90">
          
          
          <code class="ruby">  # Child Object Export</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="91">
          
          
          <code class="ruby">  ########################</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="92">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="93">
          <span class="hits">1</span>
          
          <code class="ruby">  def child_headers</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="94">
          
          
          <code class="ruby">    [&#39;parent_oid&#39;, &#39;child_oid&#39;, &#39;order&#39;, &#39;parent_title&#39;, &#39;call_number&#39;, &#39;label&#39;, &#39;caption&#39;, &#39;viewing_hint&#39;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="95">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="96">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="97">
          
          
          <code class="ruby">  # rubocop:disable Metrics/AbcSize</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="98">
          <span class="hits">1</span>
          
          <code class="ruby">  def child_output_csv</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="99">
          
          
          <code class="ruby">    return nil unless batch_action == &#39;export child oids&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="100">
          
          
          <code class="ruby">    csv_rows = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="101">
          
          
          <code class="ruby">    parent_title_hash = {}</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="102">
          
          
          <code class="ruby">    child_objects_array.each do |co|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="103">
          
          
          <code class="ruby">      parent_title = lookup_parent_title(co, parent_title_hash)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="104">
          
          
          <code class="ruby">      row = [co.parent_object.oid, co.oid, co.order, parent_title.presence, co.parent_object.call_number, co.label, co.caption, co.viewing_hint]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="105">
          
          
          <code class="ruby">      csv_rows &lt;&lt; row</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="106">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="107">
          
          
          <code class="ruby">    add_error_rows(csv_rows)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="108">
          
          
          <code class="ruby">    csv_rows.sort_by! { |row| [row[0].to_i, row[2].to_i] }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="109">
          
          
          <code class="ruby">    output_csv = CSV.generate do |csv|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="110">
          
          
          <code class="ruby">      csv &lt;&lt; child_headers</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="111">
          
          
          <code class="ruby">      csv_rows.each { |row| csv &lt;&lt; row }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="112">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="113">
          
          
          <code class="ruby">    save_to_s3(output_csv, self)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="114">
          
          
          <code class="ruby">    output_csv</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="115">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="116">
          
          
          <code class="ruby">  # rubocop:enable Metrics/AbcSize</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="117">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="118">
          <span class="hits">1</span>
          
          <code class="ruby">  def lookup_parent_title(co, parent_title_hash)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="119">
          
          
          <code class="ruby">    parent_title_hash[co.parent_object.oid] ||= co.parent_object.authoritative_json&amp;.[](&#39;title&#39;)&amp;.first</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="120">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="121">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="122">
          <span class="hits">1</span>
          
          <code class="ruby">  def remote_csv_path</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="123">
          
          
          <code class="ruby">    @remote_csv_path ||= &quot;batch/job/#{id}/#{created_file_name}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="124">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="125">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="126">
          <span class="hits">1</span>
          
          <code class="ruby">  def child_objects_array</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="127">
          
          
          <code class="ruby">    arr = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="128">
          
          
          <code class="ruby">    oids.each_with_index do |oid, index|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="129">
          
          
          <code class="ruby">      begin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="130">
          
          
          <code class="ruby">        po = ParentObject.find(oid.to_i)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="131">
          
          
          <code class="ruby">        if current_ability.can?(:read, po)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="132">
          
          
          <code class="ruby">          po.child_objects.each { |co| arr &lt;&lt; co }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="133">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="134">
          
          
          <code class="ruby">          (@error_rows ||= []) &lt;&lt; { id: oid, csv_message: &#39;Access denied for parent object&#39;, batch_message: &quot;Skipping row [#{index + 2}] due to parent permissions: #{oid}&quot; }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="135">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="136">
          
          
          <code class="ruby">      rescue ActiveRecord::RecordNotFound</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="137">
          
          
          <code class="ruby">        (@error_rows ||= []) &lt;&lt; { id: oid, csv_message: &#39;Parent Not Found in database&#39;, batch_message: &quot;Skipping row [#{index + 2}] due to parent not found: #{oid}&quot; }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="138">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="139">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="140">
          
          
          <code class="ruby">    arr</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="141">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="142">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="143">
          
          
          <code class="ruby">  ########################</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="144">
          
          
          <code class="ruby">  # common</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="145">
          
          
          <code class="ruby">  ########################</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="146">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="147">
          <span class="hits">1</span>
          
          <code class="ruby">  def add_error_rows(csv_rows)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="148">
          
          
          <code class="ruby">    # only add errors on first run of job</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="149">
          
          
          <code class="ruby">    had_events = batch_ingest_events_count.positive?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="150">
          
          
          <code class="ruby">    @error_rows&amp;.each do |error_row|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="151">
          
          
          <code class="ruby">      csv_rows &lt;&lt; [error_row[:id], error_row[:row2], &#39;-&#39;, error_row[:csv_message], &#39;&#39;, &#39;&#39;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="152">
          
          
          <code class="ruby">      batch_processing_event(error_row[:batch_message], &#39;Skipped Row&#39;) unless had_events</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="153">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="154">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="155">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="156">
          <span class="hits">1</span>
          
          <code class="ruby">  def save_to_s3(csv, batch_process)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="157">
          
          
          <code class="ruby">    # generate csv export and save it to s3, save will return s3 response if successful, or raise error</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="158">
          
          
          <code class="ruby">    batch_processing_event(&quot;CSV saved to S3&quot;, &quot;csv-saved&quot;) if CsvExport.new(csv, batch_process).save</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="159">
          
          
          <code class="ruby">  rescue =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="160">
          
          
          <code class="ruby">    batch_processing_event(&quot;CSV generation failed due to #{e.message}&quot;, &quot;failed&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="161">
          
          
          <code class="ruby">    # do not re-raise Error so job only runs once and fails if CSV can not be saved to S3</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="162">
          
          
          <code class="ruby">    # raise # this reraises the error after we document it</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="163">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="164">
          
          
          <code class="ruby">end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="165">
          
          
          <code class="ruby"># rubocop:enable Metrics/ModuleLength</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="fe96f9aa7420c3ea3683a838f7e1f63fb71d691a">
  <div class="header">
    <h3>app/models/concerns/delayable.rb</h3>
    <h4><span class="red">60.0 %</span> covered</h4>
    <div>
      <b>15</b> relevant lines. 
      <span class="green"><b>9</b> lines covered</span> and
      <span class="red"><b>6</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># frozen_string_literal: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">module Delayable</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  extend ActiveSupport::Concern</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">  def delayed_jobs</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="7">
          
          
          <code class="ruby">    Delayed::Job.where(&quot;handler LIKE ? or handler LIKE ?&quot;, &quot;%#{self.class}/#{oid}&quot;, &quot;%#{self.class}/#{oid}\n%&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="10">
          <span class="hits">1</span>
          
          <code class="ruby">  def setup_metadata_jobs</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="11">
          
          
          <code class="ruby">    Delayed::Job.where(&quot;handler LIKE ? AND (handler LIKE ? or handler LIKE ?)&quot;, &quot;%job_class: %SetupMetadataJob%&quot;, &quot;%#{self.class}/#{oid}&quot;, &quot;%#{self.class}/#{oid}\n%&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="14">
          <span class="hits">1</span>
          
          <code class="ruby">  def solr_index_jobs</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="15">
          
          
          <code class="ruby">    Delayed::Job.where(&quot;handler LIKE ? AND (handler LIKE ? or handler LIKE ?)&quot;, &quot;%job_class: %SolrIndexJob%&quot;, &quot;%#{self.class}/#{oid}&quot;, &quot;%#{self.class}/#{oid}\n%&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="18">
          <span class="hits">1</span>
          
          <code class="ruby">  def queued_solr_index_jobs</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="19">
          
          
          <code class="ruby">    Delayed::Job.where(&quot;locked_by IS NULL AND handler LIKE ? AND (handler LIKE ? or handler LIKE ?)&quot;, &quot;%job_class: %SolrIndexJob%&quot;, &quot;%#{self.class}/#{oid}&quot;, &quot;%#{self.class}/#{oid}\n%&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="22">
          <span class="hits">1</span>
          
          <code class="ruby">  def solr_reindex_jobs</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="23">
          
          
          <code class="ruby">    Delayed::Job.where(&quot;handler LIKE ?&quot;, &quot;%job_class: SolrReindexAllJob%&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="26">
          <span class="hits">1</span>
          
          <code class="ruby">  module_function :solr_reindex_jobs</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="28">
          <span class="hits">1</span>
          
          <code class="ruby">  def delayed_jobs_deletion</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="29">
          
          
          <code class="ruby">    delayed_jobs.destroy_all</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="c55180af3fbbab36c3e6e8a59acf943274554159">
  <div class="header">
    <h3>app/models/concerns/deletable.rb</h3>
    <h4><span class="red">12.77 %</span> covered</h4>
    <div>
      <b>47</b> relevant lines. 
      <span class="green"><b>6</b> lines covered</span> and
      <span class="red"><b>41</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># frozen_string_literal: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">module Deletable</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  extend ActiveSupport::Concern</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">  # DELETE PARENT OBJECTS: ------------------------------------------------------------------------ #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">  # DELETES PARENT OBJECTS FROM INGESTED CSV</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">  def delete_parent_objects</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">    parsed_csv.each_with_index do |row, index|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="11">
          
          
          <code class="ruby">      oid = row[&#39;oid&#39;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">      action = row[&#39;action&#39;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby">      metadata_source = row[&#39;source&#39;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="14">
          
          
          <code class="ruby">      batch_processing_event(&quot;Skipping row [#{index + 2}] with parent oid: #{oid}, action value for oid must be &#39;delete&#39; to complete deletion.&quot;, &#39;Invalid Vocab&#39;) if action != &quot;delete&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="15">
          
          
          <code class="ruby">      next unless action == &#39;delete&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="16">
          
          
          <code class="ruby">      parent_object = deletable_parent_object(oid, index)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="17">
          
          
          <code class="ruby">      next unless parent_object</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">      setup_for_background_jobs(parent_object, metadata_source)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="19">
          
          
          <code class="ruby">      parent_object.destroy</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="20">
          
          
          <code class="ruby">      parent_object.processing_event(&quot;Parent #{parent_object.oid} has been deleted&quot;, &#39;deleted&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">  # CHECKS TO SEE IF USER HAS ABILITY TO DELETE OBJECTS:</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="25">
          <span class="hits">1</span>
          
          <code class="ruby">  def deletable_parent_object(oid, index)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="26">
          
          
          <code class="ruby">    parent_object = ParentObject.find_by(oid: oid)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="27">
          
          
          <code class="ruby">    if parent_object.blank?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="28">
          
          
          <code class="ruby">      batch_processing_event(&quot;Skipping row [#{index + 2}] with parent oid: #{oid} because it was not found in local database&quot;, &#39;Skipped Row&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="29">
          
          
          <code class="ruby">      return false</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="30">
          
          
          <code class="ruby">    elsif !current_ability.can?(:destroy, parent_object)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="31">
          
          
          <code class="ruby">      batch_processing_event(&quot;Skipping row [#{index + 2}] with parent oid: #{oid}, user does not have permission to delete.&quot;, &#39;Permission Denied&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="32">
          
          
          <code class="ruby">      return false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="34">
          
          
          <code class="ruby">      parent_object</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">  # DELETE CHILD OBJECTS: ------------------------------------------------------------------------ #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">  # DELETES CHILD OBJECTS FROM INGESTED CSV</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="41">
          <span class="hits">1</span>
          
          <code class="ruby">  def delete_child_objects</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="42">
          
          
          <code class="ruby">    parents_needing_update = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="43">
          
          
          <code class="ruby">    parsed_csv.each_with_index do |row, index|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="44">
          
          
          <code class="ruby">      oid = row[&#39;oid&#39;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="45">
          
          
          <code class="ruby">      action = row[&#39;action&#39;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="46">
          
          
          <code class="ruby">      metadata_source = row[&#39;source&#39;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="47">
          
          
          <code class="ruby">      batch_processing_event(&quot;Skipping row [#{index + 2}] with child oid: #{oid}, action value for oid must be &#39;delete&#39; to complete deletion.&quot;, &#39;Invalid Vocab&#39;) if action != &quot;delete&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="48">
          
          
          <code class="ruby">      next unless action == &#39;delete&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="49">
          
          
          <code class="ruby">      child_object = deletable_child_object(oid, index)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="50">
          
          
          <code class="ruby">      next unless child_object</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="51">
          
          
          <code class="ruby">      parents_needing_update &lt;&lt; child_object.parent_object.oid</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="52">
          
          
          <code class="ruby">      setup_for_background_jobs(child_object, metadata_source)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="53">
          
          
          <code class="ruby">      child_object.destroy</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="54">
          
          
          <code class="ruby">      child_object.parent_object.processing_event(&quot;child #{child_object.oid} has been deleted&quot;, &#39;deleted&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="56">
          
          
          <code class="ruby">    update_related_parent_objects(parents_needing_update, {})</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby">  # CHECKS TO SEE IF USER HAS ABILITY TO DELETE OBJECTS:</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="60">
          <span class="hits">1</span>
          
          <code class="ruby">  def deletable_child_object(oid, index)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="61">
          
          
          <code class="ruby">    child_object = ChildObject.find_by(oid: oid)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="62">
          
          
          <code class="ruby">    if child_object.blank?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="63">
          
          
          <code class="ruby">      batch_processing_event(&quot;Skipping row [#{index + 2}] with child oid: #{oid} because it was not found in local database&quot;, &#39;Skipped Row&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="64">
          
          
          <code class="ruby">      return false</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="65">
          
          
          <code class="ruby">    elsif !current_ability.can?(:destroy, child_object)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="66">
          
          
          <code class="ruby">      batch_processing_event(&quot;Skipping row [#{index + 2}] with child oid: #{oid}, user does not have permission to delete.&quot;, &#39;Permission Denied&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="67">
          
          
          <code class="ruby">      return false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="69">
          
          
          <code class="ruby">      child_object</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="72">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="76386b2d974d971e3b5944d17ce162a96780b006">
  <div class="header">
    <h3>app/models/concerns/digital_object_management.rb</h3>
    <h4><span class="red">23.81 %</span> covered</h4>
    <div>
      <b>42</b> relevant lines. 
      <span class="green"><b>10</b> lines covered</span> and
      <span class="red"><b>32</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># frozen_string_literal: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">module DigitalObjectManagement</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  extend ActiveSupport::Concern</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">  def digital_object_json_available?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="7">
          
          
          <code class="ruby">    return false unless child_object_count&amp;.positive?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="8">
          
          
          <code class="ruby">    return false unless authoritative_metadata_source &amp;&amp; authoritative_metadata_source.metadata_cloud_name == &quot;aspace&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="9">
          
          
          <code class="ruby">    return false unless [&#39;Public&#39;, &#39;Yale Community Only&#39;].include? visibility</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">    return false unless digital_object_title</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="11">
          
          
          <code class="ruby">    true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="14">
          <span class="hits">1</span>
          
          <code class="ruby">  def generate_digital_object_json</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="15">
          
          
          <code class="ruby">    return nil unless digital_object_json_available?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">    # create digital object from data and return JSON</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="17">
          
          
          <code class="ruby">    {   oid: oid,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">        title: digital_object_title,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">        thumbnailOid: representative_child &amp;&amp; representative_child.oid || nil,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">        thumbnailCaption: representative_child &amp;&amp; representative_child.label || nil,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">        archivesSpaceUri: aspace_uri,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">        childCount: child_object_count,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">        visibility: visibility }.to_json</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="26">
          <span class="hits">1</span>
          
          <code class="ruby">  def digital_object_title</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="27">
          
          
          <code class="ruby">    authoritative_json &amp;&amp; authoritative_json[&quot;title&quot;] &amp;&amp; authoritative_json[&quot;title&quot;][0]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">  # rubocop:disable Metrics/CyclomaticComplexity</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">  # rubocop:disable Metrics/PerceivedComplexity</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="32">
          <span class="hits">1</span>
          
          <code class="ruby">  def digital_object_check</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="33">
          
          
          <code class="ruby">    new_digital_object = generate_digital_object_json</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="34">
          
          
          <code class="ruby">    return unless (digital_object_json &amp;&amp; digital_object_json.json || nil) != new_digital_object</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">    #  There has been a change that needs to be reported to metadata cloud</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="36">
          
          
          <code class="ruby">    if send_digital_object_update(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">      priorDigitalObject: digital_object_json&amp;.json.present? &amp;&amp; JSON.parse(digital_object_json.json) || nil,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">      digitalObject: new_digital_object.present? &amp;&amp; JSON.parse(new_digital_object) || nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">    )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">      # Only update the database is the update was sent to MC successfully.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">      # This will cause unsuccessful sends to MC to be resent when the ParentObject is next updated.</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="42">
          
          
          <code class="ruby">      apply_new_digital_object_json(new_digital_object)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby">  # rubocop:enable Metrics/CyclomaticComplexity</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby">  # rubocop:enable Metrics/PerceivedComplexity</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="48">
          <span class="hits">1</span>
          
          <code class="ruby">  def digital_object_delete</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="49">
          
          
          <code class="ruby">    unless digital_object_json&amp;.json</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="50">
          
          
          <code class="ruby">      digital_object_json&amp;.delete</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="51">
          
          
          <code class="ruby">      return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="53">
          
          
          <code class="ruby">    if send_digital_object_update(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby">      priorDigitalObject: JSON.parse(digital_object_json.json),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby">      digitalObject: nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby">    )</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="57">
          
          
          <code class="ruby">      digital_object_json.delete</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="61">
          <span class="hits">1</span>
          
          <code class="ruby">  def apply_new_digital_object_json(json)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="62">
          
          
          <code class="ruby">    self.digital_object_json = DigitalObjectJson.new if digital_object_json.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="63">
          
          
          <code class="ruby">    digital_object_json.json = json</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="64">
          
          
          <code class="ruby">    digital_object_json.save</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="67">
          <span class="hits">1</span>
          
          <code class="ruby">  def mc_post(mc_url, data)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="68">
          
          
          <code class="ruby">    metadata_cloud_username = ENV[&quot;MC_USER&quot;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="69">
          
          
          <code class="ruby">    metadata_cloud_password = ENV[&quot;MC_PW&quot;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="70">
          
          
          <code class="ruby">    HTTP.basic_auth(user: metadata_cloud_username, pass: metadata_cloud_password).post(mc_url, json: data)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="72">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="73">
          <span class="hits">1</span>
          
          <code class="ruby">  def send_digital_object_update(digital_object_update)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="74">
          
          
          <code class="ruby">    return false unless ENV[&quot;VPN&quot;] == &quot;true&quot; &amp;&amp; ENV[&quot;FEATURE_FLAGS&quot;]&amp;.include?(&quot;|DO-SEND|&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="75">
          
          
          <code class="ruby">    full_response = mc_post(&quot;https://#{MetadataSource.metadata_cloud_host}/metadatacloud/api/digital_object_updates&quot;, digital_object_update)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="76">
          
          
          <code class="ruby">    case full_response.status</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby">    when 200</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="78">
          
          
          <code class="ruby">      Rails.logger.info &quot;Update sent successfully #{digital_object_update}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="79">
          
          
          <code class="ruby">      return true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="81">
          
          
          <code class="ruby">      Rails.logger.info &quot;Error sending digital object update: #{full_response.status}, #{digital_object_update}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="82">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="83">
          
          
          <code class="ruby">    false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="84">
          
          
          <code class="ruby">  rescue =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="85">
          
          
          <code class="ruby">    Rails.logger.info &quot;Error sending digital object update: #{e}, #{digital_object_update}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="86">
          
          
          <code class="ruby">    false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="87">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="88">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="d77006734a3555089d3607e26d16fa3f9528f6a2">
  <div class="header">
    <h3>app/models/concerns/json_file.rb</h3>
    <h4><span class="red">33.33 %</span> covered</h4>
    <div>
      <b>9</b> relevant lines. 
      <span class="green"><b>3</b> lines covered</span> and
      <span class="red"><b>6</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># frozen_string_literal: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">module JsonFile</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  extend ActiveSupport::Concern</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">  def to_json_file(args = {})</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="7">
          
          
          <code class="ruby">    metadata_source = args[:metadata_source] || authoritative_metadata_source</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="8">
          
          
          <code class="ruby">    json_to_use = json_for(metadata_source.metadata_cloud_name)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="9">
          
          
          <code class="ruby">    return if json_to_use.blank?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">    args[:folder] ||= Rails.root.join(&quot;spec&quot;, &quot;fixtures&quot;, metadata_source.metadata_cloud_name)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="11">
          
          
          <code class="ruby">    file_prefix = metadata_source.file_prefix</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">    File.write(args[:folder].join(&quot;#{file_prefix}#{oid}.json&quot;), JSON.pretty_generate(json_to_use))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="7f33d24ee327110d70de1b9f242b18ddc6a48bc4">
  <div class="header">
    <h3>app/models/concerns/metadata_cloud_url_parsable.rb</h3>
    <h4><span class="red">0.0 %</span> covered</h4>
    <div>
      <b>53</b> relevant lines. 
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>53</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># frozen_string_literal: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="3">
          
          
          <code class="ruby">module MetadataCloudUrlParsable</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="4">
          
          
          <code class="ruby">  extend ActiveSupport::Concern</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="6">
          
          
          <code class="ruby">  def parsed_metadata_source_path</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="7">
          
          
          <code class="ruby">    @parsed_metadata_source_path ||= metadata_source_path.match(/\/(\w*)\/(\w*)\/(\d*)\W(\w*)\W(\w*)/)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="8">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">  def full_metadata_cloud_url</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="11">
          
          
          <code class="ruby">    &quot;https://#{MetadataSource.metadata_cloud_host}/metadatacloud/api/#{MetadataSource.metadata_cloud_version}#{metadata_source_path}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="14">
          
          
          <code class="ruby">  def metadata_source</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="15">
          
          
          <code class="ruby">    parsed_metadata_source_path.captures.first</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="16">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">  def bib</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="19">
          
          
          <code class="ruby">    parsed_metadata_source_path.captures.last if metadata_source == &quot;ils&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="20">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="22">
          
          
          <code class="ruby">  def barcode</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="23">
          
          
          <code class="ruby">    parsed_metadata_source_path.captures.third if parsed_metadata_source_path.captures.include?(&quot;barcode&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="24">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="26">
          
          
          <code class="ruby">  def holding</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="27">
          
          
          <code class="ruby">    parsed_metadata_source_path.captures.third if parsed_metadata_source_path.captures.include?(&quot;holding&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="28">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="30">
          
          
          <code class="ruby">  def item</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="31">
          
          
          <code class="ruby">    parsed_metadata_source_path.captures.third if parsed_metadata_source_path.captures.include?(&quot;item&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="32">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">  # leave of the first &quot;aspace&quot; to match Ladybird archiveSpaceUri. parsed_metadata_source_path.captures</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">  # is 0-indexed</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="36">
          
          
          <code class="ruby">  def aspace_uri</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="37">
          
          
          <code class="ruby">    return nil unless valid_aspace?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="38">
          
          
          <code class="ruby">    parsed_path = parsed_metadata_source_path.captures</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="39">
          
          
          <code class="ruby">    File.join(&quot;\/&quot;, parsed_path[1], parsed_path[2],</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="40">
          
          
          <code class="ruby">              parsed_path[3], parsed_path[4])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="41">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="43">
          
          
          <code class="ruby">  def valid_metadata_source_path?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="44">
          
          
          <code class="ruby">    return false unless parsed_metadata_source_path</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="45">
          
          
          <code class="ruby">    return false unless valid_ils? || valid_aspace?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="46">
          
          
          <code class="ruby">    true</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="47">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="49">
          
          
          <code class="ruby">  def valid_aspace?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="50">
          
          
          <code class="ruby">    metadata_source == &#39;aspace&#39; &amp;&amp; (metadata_source_path =~ %r{\A\/aspace\/repositories\/\d+\/archival_objects\/\d+\z})</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="51">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="53">
          
          
          <code class="ruby">  def valid_ils?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="54">
          
          
          <code class="ruby">    metadata_source == &#39;ils&#39; &amp;&amp; (valid_bib? &amp;&amp; (valid_item? || valid_holding? || valid_barcode?))</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="55">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="57">
          
          
          <code class="ruby">  def valid_barcode?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="58">
          
          
          <code class="ruby">    barcode &amp;&amp; (barcode !~ /\D/)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="59">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="61">
          
          
          <code class="ruby">  def valid_bib?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="62">
          
          
          <code class="ruby">    bib =~ /\A\d+b?\z/</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="63">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="65">
          
          
          <code class="ruby">  def valid_item?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="66">
          
          
          <code class="ruby">    item &amp;&amp; (item !~ /\D/)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="67">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="69">
          
          
          <code class="ruby">  def valid_holding?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="70">
          
          
          <code class="ruby">    holding &amp;&amp; (holding !~ /\D/)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="71">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="72">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="e642132fd520434fca52ab01599d232183b03325">
  <div class="header">
    <h3>app/models/concerns/pdf_representable.rb</h3>
    <h4><span class="red">23.53 %</span> covered</h4>
    <div>
      <b>85</b> relevant lines. 
      <span class="green"><b>20</b> lines covered</span> and
      <span class="red"><b>65</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># frozen_string_literal: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"># rubocop:disable Metrics/ModuleLength</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">module PdfRepresentable</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">  extend ActiveSupport::Concern</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">  # rubocop:enable Metrics/ModuleLength</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">  NORMALIZED_COVER_FIELDS = %w[</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">    callNumber</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">    creator</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">    date</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">    sourceTitle</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">    rights</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">    extentOfDigitization</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">  ].freeze</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">  # rubocop:disable Metrics/MethodLength, Metrics/AbcSize</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="18">
          <span class="hits">1</span>
          
          <code class="ruby">  def generate_pdf</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="19">
          
          
          <code class="ruby">    raise &quot;No authoritative_json to create PDF for #{oid}&quot; unless authoritative_json</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="20">
          
          
          <code class="ruby">    changed_pdf_checksum = new_pdf_checksum # new_pdf_checksum will be false if there were no changes</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="21">
          
          
          <code class="ruby">    return false unless changed_pdf_checksum</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="22">
          
          
          <code class="ruby">    Dir.mktmpdir do |pdf_tmpdir|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="23">
          
          
          <code class="ruby">      temp_json_file = File.new(&quot;#{pdf_tmpdir}/#{oid}_pdf_json&quot;, &quot;w&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="24">
          
          
          <code class="ruby">      temp_json_file.write(pdf_generator_json)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="25">
          
          
          <code class="ruby">      temp_json_file.close</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="26">
          
          
          <code class="ruby">      temp_pdf_file = &quot;#{temp_json_file.path}.pdf&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="27">
          
          
          <code class="ruby">      cmd = &quot;java -Djava.io.tmpdir=#{pdf_tmpdir} -jar jpegs2pdf-1.3.jar #{temp_json_file.path} #{temp_pdf_file}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="28">
          
          
          <code class="ruby">      stdout, stderr, status = Open3.capture3({ &quot;MAGICK_TMPDIR&quot; =&gt; pdf_tmpdir }, cmd)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="29">
          
          
          <code class="ruby">      success = status.success?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="30">
          
          
          <code class="ruby">      if success</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="31">
          
          
          <code class="ruby">        raise &quot;Java app did not create PDF file for #{oid}&quot; unless File.exist? temp_pdf_file</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="32">
          
          
          <code class="ruby">        S3Service.upload_image(temp_pdf_file.to_s, remote_pdf_path, &quot;application/pdf&quot;, &#39;pdfchecksum&#39;: changed_pdf_checksum)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="33">
          
          
          <code class="ruby">        File.delete temp_pdf_file</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="35">
          
          
          <code class="ruby">        File.delete temp_pdf_file if File.exist?(temp_pdf_file)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="36">
          
          
          <code class="ruby">        raise &quot;PDF Java app returned non zero response code for #{oid}: #{PdfRepresentable.clean_up_error(stderr)} #{PdfRepresentable.clean_up_error(stdout)}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="39">
          
          
          <code class="ruby">    true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">  # rubocop:enable Metrics/MethodLength, Metrics/AbcSize</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="43">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.clean_up_error(msg)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="44">
          
          
          <code class="ruby">    msg.gsub(/(X-Amz-[^=]*)[^&amp;)]*/, &#39;\1=redacted&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="47">
          <span class="hits">1</span>
          
          <code class="ruby">  def new_pdf_checksum</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="48">
          
          
          <code class="ruby">    metadata = S3Service.remote_metadata(remote_pdf_path)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="49">
          
          
          <code class="ruby">    checksum = pdf_json_checksum</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="50">
          
          
          <code class="ruby">    return checksum if !metadata || metadata[:pdfchecksum] != checksum</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="53">
          <span class="hits">1</span>
          
          <code class="ruby">  def pdf_deletion</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="54">
          
          
          <code class="ruby">    S3Service.delete(remote_pdf_path)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="57">
          <span class="hits">1</span>
          
          <code class="ruby">  def remote_pdf_path</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="58">
          
          
          <code class="ruby">    &quot;pdfs/#{Partridge::Pairtree.oid_to_pairtree(oid)}/#{oid}.pdf&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="61">
          <span class="hits">1</span>
          
          <code class="ruby">  def pdf_json_checksum</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="62">
          
          
          <code class="ruby">    Digest::MD5.hexdigest(pdf_json(&quot;same&quot;, :child_modification))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="65">
          <span class="hits">1</span>
          
          <code class="ruby">  def pdf_generator_json</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="66">
          
          
          <code class="ruby">    pdf_json(Time.now.utc.to_s, :s3_presigned_url)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="69">
          <span class="hits">1</span>
          
          <code class="ruby">  def pdf_json(generated, child_page_file = :s3_presigned_url)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="70">
          
          
          <code class="ruby">    title = extract_flat_field_value(authoritative_json, &quot;title&quot;, &quot;No Title&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="71">
          
          
          <code class="ruby">    properties = pdf_properties title, generated</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="72">
          
          
          <code class="ruby">    children = child_pages(child_page_file)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby">    json_hash = {</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="74">
          
          
          <code class="ruby">      &quot;displayCoverPage&quot; =&gt; true,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="75">
          
          
          <code class="ruby">      &quot;title&quot; =&gt; title,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="76">
          
          
          <code class="ruby">      &quot;header&quot; =&gt; &quot;Yale University Library Digital Collections&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby">      &quot;properties&quot; =&gt; properties,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby">      &quot;pages&quot; =&gt; children,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="79">
          
          
          <code class="ruby">      &quot;imageProcessingCommand&quot; =&gt; &quot;convert -resize 2000x2000 %s[0] %s&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="81">
          
          
          <code class="ruby">    # only add color space with :s3_presigned_url so it does not affect the checksum:</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="82">
          
          
          <code class="ruby">    json_hash[&quot;imageProcessingCommand&quot;] = &quot;convert -resize 2000x2000 %s[0] -colorspace sRGB %s&quot; if child_page_file == :s3_presigned_url</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="83">
          
          
          <code class="ruby">    json_hash.to_json</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="84">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="85">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="86">
          <span class="hits">1</span>
          
          <code class="ruby">  private</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="87">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="88">
          <span class="hits">1</span>
          
          <code class="ruby">    def child_pages(child_page_file)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="89">
          
          
          <code class="ruby">      pages = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="90">
          
          
          <code class="ruby">      child_objects = ChildObject.where(parent_object: self).order(:order)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="91">
          
          
          <code class="ruby">      child_objects.map do |child|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="92">
          
          
          <code class="ruby">        page = {</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="93">
          
          
          <code class="ruby">          &quot;caption&quot; =&gt; child[&#39;label&#39;] || &quot;&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="94">
          
          
          <code class="ruby">          &quot;file&quot; =&gt; send(child_page_file, child)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="95">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="96">
          
          
          <code class="ruby">        properties = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="97">
          
          
          <code class="ruby">        properties &lt;&lt; { &#39;name&#39; =&gt; &#39;Caption:&#39;, &#39;value&#39; =&gt; child.caption } if child.caption.present?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="98">
          
          
          <code class="ruby">        properties &lt;&lt; { &#39;name&#39; =&gt; &#39;Image ID:&#39;, &#39;value&#39; =&gt; child.oid.to_s }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="99">
          
          
          <code class="ruby">        page[&#39;properties&#39;] = properties if properties.present?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="100">
          
          
          <code class="ruby">        pages &lt;&lt; page</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="101">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="102">
          
          
          <code class="ruby">      pages</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="103">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="104">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="105">
          <span class="hits">1</span>
          
          <code class="ruby">    def s3_presigned_url(child)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="106">
          
          
          <code class="ruby">      S3Service.presigned_url(child.remote_ptiff_path, 24_000)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="107">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="108">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="109">
          <span class="hits">1</span>
          
          <code class="ruby">    def child_modification(child)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="110">
          
          
          <code class="ruby">      child.updated_at.to_s</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="111">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="112">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="113">
          <span class="hits">1</span>
          
          <code class="ruby">    def pdf_properties(title, generated)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="114">
          
          
          <code class="ruby">      properties = {</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="115">
          
          
          <code class="ruby">        &quot;Title&quot; =&gt; title</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="116">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="117">
          
          
          <code class="ruby">      properties = cover_page(properties, generated)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="118">
          
          
          <code class="ruby">      reshape_properties properties</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="119">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="120">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="121">
          <span class="hits">1</span>
          
          <code class="ruby">    def reshape_properties(properties)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="122">
          
          
          <code class="ruby">      properties.keys.map do |key|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="123">
          
          
          <code class="ruby">        value = properties[key]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="124">
          
          
          <code class="ruby">        {</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="125">
          
          
          <code class="ruby">          &quot;name&quot; =&gt; key,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="126">
          
          
          <code class="ruby">          &quot;value&quot; =&gt; value</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="127">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="128">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="129">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="130">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="131">
          <span class="hits">1</span>
          
          <code class="ruby">    def cover_page(properties, generated)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="132">
          
          
          <code class="ruby">      # for normalized fields</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="133">
          
          
          <code class="ruby">      NORMALIZED_COVER_FIELDS.each do |field|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="134">
          
          
          <code class="ruby">        hash = METADATA_FIELDS[field.to_sym]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="135">
          
          
          <code class="ruby">        properties = add_field_if_present(authoritative_json, field, hash[:label], properties)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="136">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="137">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="138">
          
          
          <code class="ruby">      container_information = extract_container_information(authoritative_json)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="139">
          
          
          <code class="ruby">      properties[&quot;Container information&quot;] = container_information if container_information.present?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="140">
          
          
          <code class="ruby">      properties[&quot;Digitization Note&quot;] = digitization_note if digitization_note.present?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="141">
          
          
          <code class="ruby">      properties[&quot;Generated&quot;] = generated</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="142">
          
          
          <code class="ruby">      properties[&quot;Terms of Use&quot;] = &quot;https://guides.library.yale.edu/about/policies/access&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="143">
          
          
          <code class="ruby">      properties[&quot;View in DL&quot;] = &quot;https://collections.library.yale.edu/catalog/#{oid}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="144">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="145">
          
          
          <code class="ruby">      properties</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="146">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="147">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="148">
          <span class="hits">1</span>
          
          <code class="ruby">    def add_field_if_present(json, field_name, hash_field, hash)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="149">
          
          
          <code class="ruby">      value = extract_flat_field_value(json, field_name, nil)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="150">
          
          
          <code class="ruby">      hash[hash_field] = value if value</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="151">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="152">
          
          
          <code class="ruby">      hash</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="153">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="154">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="155">
          <span class="hits">1</span>
          
          <code class="ruby">    def extract_flat_field_value(json, field_name, default)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="156">
          
          
          <code class="ruby">      return default unless json &amp;&amp; json[field_name].present?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="157">
          
          
          <code class="ruby">      Array(json[field_name]).join(&quot;, &quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="158">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="159">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="9a7ac4df9003ed8a0d3854f110e28104bbcc7433">
  <div class="header">
    <h3>app/models/concerns/reassociatable.rb</h3>
    <h4><span class="red">17.17 %</span> covered</h4>
    <div>
      <b>99</b> relevant lines. 
      <span class="green"><b>17</b> lines covered</span> and
      <span class="red"><b>82</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># frozen_string_literal: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"># rubocop:disable Metrics/ModuleLength</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">module Reassociatable</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">  extend ActiveSupport::Concern</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">  BLANK_VALUE = &quot;_blank_&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">  # triggers the reassociate process</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="10">
          <span class="hits">1</span>
          
          <code class="ruby">  def reassociate_child_oids</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="11">
          
          
          <code class="ruby">    return unless batch_action == &quot;reassociate child oids&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">    parents_needing_update, parent_destination_map = update_child_objects</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby">    update_related_parent_objects(parents_needing_update, parent_destination_map)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">  # rubocop:disable Metrics/AbcSize</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">  # finds which parents are needed to update</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="18">
          <span class="hits">1</span>
          
          <code class="ruby">  def update_child_objects</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="19">
          
          
          <code class="ruby">    return unless batch_action == &quot;reassociate child oids&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="20">
          
          
          <code class="ruby">    parents_needing_update = []</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="22">
          
          
          <code class="ruby">    parent_destination_map = {}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="24">
          
          
          <code class="ruby">    parsed_csv.each_with_index do |row, index|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="25">
          
          
          <code class="ruby">      co = load_child(index, row[&quot;child_oid&quot;].to_i)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="26">
          
          
          <code class="ruby">      po = load_parent(index, row[&quot;parent_oid&quot;].to_i)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="27">
          
          
          <code class="ruby">      next unless co.present? &amp;&amp; po.present?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="29">
          
          
          <code class="ruby">      attach_item(po)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="30">
          
          
          <code class="ruby">      attach_item(co)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="32">
          
          
          <code class="ruby">      next unless user_update_child_permission(co, po)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="34">
          
          
          <code class="ruby">      parents_needing_update &lt;&lt; co.parent_object.oid</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="35">
          
          
          <code class="ruby">      parents_needing_update &lt;&lt; row[&quot;parent_oid&quot;].to_i</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="36">
          
          
          <code class="ruby">      parent_destination_map[co.parent_object.oid] = (parent_destination_map[co.parent_object.oid] || Set.new) &lt;&lt; row[&quot;parent_oid&quot;].to_i</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="38">
          
          
          <code class="ruby">      reassociate_child(co, po)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="40">
          
          
          <code class="ruby">      values_to_update = check_headers(child_headers, row)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="41">
          
          
          <code class="ruby">      update_child_values(values_to_update, co, row, index)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="43">
          
          
          <code class="ruby">    [parents_needing_update, parent_destination_map]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby">  # rubocop:enable Metrics/AbcSize</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby">  # verifies headers are included. child headers found in csv_exportable:90</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="48">
          <span class="hits">1</span>
          
          <code class="ruby">  def check_headers(headers, row)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="49">
          
          
          <code class="ruby">    possible_headers = headers</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="50">
          
          
          <code class="ruby">    values_to_update = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="51">
          
          
          <code class="ruby">    possible_headers.each do |h|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="52">
          
          
          <code class="ruby">      values_to_update &lt;&lt; h if row.headers.include?(h)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="54">
          
          
          <code class="ruby">    values_to_update</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="57">
          <span class="hits">1</span>
          
          <code class="ruby">  def check_for_blank(value)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="58">
          
          
          <code class="ruby">    return nil if value == BLANK_VALUE</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="59">
          
          
          <code class="ruby">    value</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby">  # rubocop:disable Metrics/PerceivedComplexity</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby">  # rubocop:disable Metrics/MethodLength</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby">  # rubocop:disable Metrics/CyclomaticComplexity</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby">  # updates values based on column values for child object</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="66">
          <span class="hits">1</span>
          
          <code class="ruby">  def update_child_values(values_to_update, co, row, index)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="67">
          
          
          <code class="ruby">    values_to_update.each do |h|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="68">
          
          
          <code class="ruby">      if h == &#39;viewing_hint&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="69">
          
          
          <code class="ruby">        co.viewing_hint = valid_view(check_for_blank(row[h]), co.oid)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby">        # should not update parent title or call number</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="71">
          
          
          <code class="ruby">      elsif values_to_update.include? h</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="72">
          
          
          <code class="ruby">        if h == &#39;label&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="73">
          
          
          <code class="ruby">          co.label = check_for_blank(row[h])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="74">
          
          
          <code class="ruby">        elsif h == &#39;caption&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="75">
          
          
          <code class="ruby">          co.caption = check_for_blank(row[h])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="76">
          
          
          <code class="ruby">        elsif h == &#39;order&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="77">
          
          
          <code class="ruby">          order = extract_order(index, row)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="78">
          
          
          <code class="ruby">          return false if order == :invalid_order # message says skipping row, returning</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="79">
          
          
          <code class="ruby">          co.order = order</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="80">
          
          
          <code class="ruby">        elsif h == &#39;child_oid&#39; || h == &#39;parent_oid&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="81">
          
          
          <code class="ruby">          next</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="82">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="83">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="84">
          
          
          <code class="ruby">        next</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="85">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="86">
          
          
          <code class="ruby">      co.save</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="87">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="88">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="89">
          
          
          <code class="ruby">  # rubocop:enable Metrics/PerceivedComplexity</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="90">
          
          
          <code class="ruby">  # rubocop:enable Metrics/MethodLength</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="91">
          
          
          <code class="ruby">  # rubocop:enable Metrics/CyclomaticComplexity</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="92">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="93">
          
          
          <code class="ruby">  # assigns the child to the new parent</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="94">
          <span class="hits">1</span>
          
          <code class="ruby">  def reassociate_child(co, po)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="95">
          
          
          <code class="ruby">    if po.redirect_to.present?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="96">
          
          
          <code class="ruby">      failure_event_for_child(co, po.oid)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="97">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="98">
          
          
          <code class="ruby">      co.parent_object = po</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="99">
          
          
          <code class="ruby">      processing_event_for_child(co)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="100">
          
          
          <code class="ruby">      co.save!</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="101">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="102">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="103">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="104">
          
          
          <code class="ruby">  # alerts user of unsuccessful reassociation event</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="105">
          <span class="hits">1</span>
          
          <code class="ruby">  def failure_event_for_child(co, po_oid)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="106">
          
          
          <code class="ruby">    batch_processing_event(&quot;Child #{co.oid} cannot be reassociated to redirected parent object: #{po_oid}&quot;, &#39;Skipped Row&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="107">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="108">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="109">
          
          
          <code class="ruby">  # alerts user of successful reassociation event</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="110">
          <span class="hits">1</span>
          
          <code class="ruby">  def processing_event_for_child(co)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="111">
          
          
          <code class="ruby">    co.current_batch_process = self</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="112">
          
          
          <code class="ruby">    co.current_batch_connection = batch_connections.find_or_create_by(connectable: co)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="113">
          
          
          <code class="ruby">    co.current_batch_connection.save!</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="114">
          
          
          <code class="ruby">    co.processing_event(&quot;Child has parent #{co.parent_object.oid}&quot;, &#39;reassociate-complete&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="115">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="116">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="117">
          
          
          <code class="ruby">  # checks the increment is correct and in order</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="118">
          <span class="hits">1</span>
          
          <code class="ruby">  def extract_order(index, row)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="119">
          
          
          <code class="ruby">    unless row[&quot;order&quot;]&amp;.to_i&amp;.positive? || row[&quot;order&quot;] == &#39;0&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="120">
          
          
          <code class="ruby">      batch_processing_event(&quot;Skipping row [#{index + 2}] with invalid order [#{row[&#39;order&#39;]}] (Parent: #{row[&#39;parent_oid&#39;]}, Child: #{row[&#39;child_oid&#39;]})&quot;, &#39;Skipped Row&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="121">
          
          
          <code class="ruby">      return :invalid_order</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="122">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="123">
          
          
          <code class="ruby">    row[&quot;order&quot;].to_i</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="124">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="125">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="126">
          
          
          <code class="ruby">  # finds child object and adds alert if child cannot be found</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="127">
          <span class="hits">1</span>
          
          <code class="ruby">  def load_child(index, oid)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="128">
          
          
          <code class="ruby">    co = ChildObject.find_by_oid(oid)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="129">
          
          
          <code class="ruby">    batch_processing_event(&quot;Skipping row [#{index + 2}] with Child Missing #{oid}&quot;, &#39;Skipped Row&#39;) unless co</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="130">
          
          
          <code class="ruby">    co</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="131">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="132">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="133">
          
          
          <code class="ruby">  # finds parent object and adds alert if parent cannot be found</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="134">
          <span class="hits">1</span>
          
          <code class="ruby">  def load_parent(index, oid)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="135">
          
          
          <code class="ruby">    po = ParentObject.find_by_oid(oid)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="136">
          
          
          <code class="ruby">    batch_processing_event(&quot;Skipping row [#{index + 2}] with Parent Missing #{oid}&quot;, &#39;Skipped Row&#39;) unless po</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="137">
          
          
          <code class="ruby">    po</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="138">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="139">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="140">
          
          
          <code class="ruby">  # rubocop:disable Metrics/LineLength</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="141">
          
          
          <code class="ruby">  # checks if viewing hint is valid</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="142">
          <span class="hits">1</span>
          
          <code class="ruby">  def valid_view(viewing_hint, oid)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="143">
          
          
          <code class="ruby">    if ChildObject.viewing_hints.include? viewing_hint</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="144">
          
          
          <code class="ruby">      viewing_hint</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="145">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="146">
          
          
          <code class="ruby">      batch_processing_event(&quot;Child #{oid} did not update value for Viewing Hint. Value: #{viewing_hint} is invalid. For field Viewing Hint please use: non-paged, facing-pages, or leave column empty&quot;, &#39;Invalid Vocabulary&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="147">
          
          
          <code class="ruby">      nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="148">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="149">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="150">
          
          
          <code class="ruby">  # rubocop:enable Metrics/LineLength</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="151">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="152">
          
          
          <code class="ruby">  # rubocop:disable Metrics/AbcSize</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="153">
          
          
          <code class="ruby">  # updates count of parent objects and regenerates manifest pdf and reindexes solr.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="154">
          <span class="hits">1</span>
          
          <code class="ruby">  def update_related_parent_objects(parents_needing_update, parent_destination_map)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="155">
          
          
          <code class="ruby">    return unless batch_action == &quot;reassociate child oids&quot; || batch_action == &quot;delete child objects&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="156">
          
          
          <code class="ruby">    parents_needing_update.uniq.each do |oid|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="157">
          
          
          <code class="ruby">      po = ParentObject.find(oid)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="158">
          
          
          <code class="ruby">      update_child_count(po, parent_destination_map)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="159">
          
          
          <code class="ruby">      # If the child objects have changed, we&#39;ll need to re-create the manifest and PDF objects</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="160">
          
          
          <code class="ruby">      # and re-index to Solr</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="161">
          
          
          <code class="ruby">      po.current_batch_process = self</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="162">
          
          
          <code class="ruby">      po.current_batch_connection = batch_connections.find_or_create_by(connectable: po)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="163">
          
          
          <code class="ruby">      po.current_batch_connection.save!</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="164">
          
          
          <code class="ruby">      po.save!</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="165">
          
          
          <code class="ruby">      if po.should_create_manifest_and_pdf?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="166">
          
          
          <code class="ruby">        GenerateManifestJob.perform_later(po, self, po.current_batch_connection)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="167">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="168">
          
          
          <code class="ruby">        po.solr_index_job</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="169">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="170">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="171">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="172">
          
          
          <code class="ruby">  # rubocop:enable Metrics/AbcSize</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="173">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="174">
          <span class="hits">1</span>
          
          <code class="ruby">  def update_child_count(po, parent_destination_map)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="175">
          
          
          <code class="ruby">    po.child_object_count = po.child_objects.count</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="176">
          
          
          <code class="ruby">    return unless po.child_object_count.zero?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="177">
          
          
          <code class="ruby">    if parent_destination_map[po.oid]&amp;.length == 1</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="178">
          
          
          <code class="ruby">      po.redirect_to = &quot;https://collections.library.yale.edu/catalog/#{parent_destination_map[po.oid].first}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="179">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="180">
          
          
          <code class="ruby">      batch_processing_event(&quot;Unable to redirect parent with 0 children: [Parent #{po.oid} had children moved to #{parent_destination_map[po.oid]}]&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="181">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="182">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="183">
          
          
          <code class="ruby">end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="184">
          
          
          <code class="ruby"># rubocop:enable Metrics/ModuleLength</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="58fcc178fd8bc086d0ec70a6798877a60967897a">
  <div class="header">
    <h3>app/models/concerns/solr_indexable.rb</h3>
    <h4><span class="red">20.69 %</span> covered</h4>
    <div>
      <b>116</b> relevant lines. 
      <span class="green"><b>24</b> lines covered</span> and
      <span class="red"><b>92</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># frozen_string_literal: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">module SolrIndexable</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  extend ActiveSupport::Concern</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">  class_methods do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">    def solr_index</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="7">
          
          
          <code class="ruby">      SolrReindexAllJob.perform_later</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">  # rubocop:disable Metrics/PerceivedComplexity</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>
          
          <code class="ruby">  def solr_index</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">    begin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="14">
          
          
          <code class="ruby">      if self&amp;.should_index?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="15">
          
          
          <code class="ruby">        if self&amp;.redirect_to.present?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="16">
          
          
          <code class="ruby">          indexable = to_solr</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">          indexable, child_solr_documents = to_solr_full_text</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="20">
          
          
          <code class="ruby">        return unless indexable.present?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="21">
          
          
          <code class="ruby">        solr = SolrService.connection</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="22">
          
          
          <code class="ruby">        solr.add([indexable])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="23">
          
          
          <code class="ruby">        solr.add(child_solr_documents) unless child_solr_documents.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="24">
          
          
          <code class="ruby">        result = solr.commit</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="25">
          
          
          <code class="ruby">        if (result&amp;.[](&quot;responseHeader&quot;)&amp;.[](&quot;status&quot;))&amp;.zero?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="26">
          
          
          <code class="ruby">          processing_event(&quot;Solr index updated&quot;, &quot;solr-indexed&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="28">
          
          
          <code class="ruby">          processing_event(&quot;Solr index after manifest generation failed&quot;, &quot;failed&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="31">
          
          
          <code class="ruby">        result = solr_delete</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="32">
          
          
          <code class="ruby">        processing_event(&quot;Solr record deleted&quot;, &quot;solr-indexed&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">    rescue =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="35">
          
          
          <code class="ruby">      processing_event(&quot;Solr indexing failed due to #{e.message}&quot;, &quot;failed&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="36">
          
          
          <code class="ruby">      raise # this reraises the error after we document it</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="38">
          
          
          <code class="ruby">    result</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">  # rubocop:enable Metrics/PerceivedComplexity</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="42">
          <span class="hits">1</span>
          
          <code class="ruby">  def solr_delete</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="43">
          
          
          <code class="ruby">    solr = SolrService.connection</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="44">
          
          
          <code class="ruby">    solr.delete_by_id(oid.to_s)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="45">
          
          
          <code class="ruby">    solr.delete_by_query(&quot;parent_ssi:#{oid}&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="46">
          
          
          <code class="ruby">    solr.commit</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="49">
          <span class="hits">1</span>
          
          <code class="ruby">  def solr_index_job</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="50">
          
          
          <code class="ruby">    current_batch_connection&amp;.save</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="51">
          
          
          <code class="ruby">    return unless queued_solr_index_jobs.empty?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="52">
          
          
          <code class="ruby">    if full_text?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="53">
          
          
          <code class="ruby">      SolrIndexJob.set(queue: :intensive_solr_index).perform_later(self, current_batch_process, current_batch_connection)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="55">
          
          
          <code class="ruby">      SolrIndexJob.perform_later(self, current_batch_process, current_batch_connection)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="59">
          <span class="hits">1</span>
          
          <code class="ruby">  def extract_creator(json_to_index)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="60">
          
          
          <code class="ruby">    all_creators = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="61">
          
          
          <code class="ruby">    [json_to_index[&quot;creator&quot;], json_to_index[&quot;ancestorCreator&quot;]].compact.each { |creator| all_creators += creator }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="62">
          
          
          <code class="ruby">    all_creators.uniq</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="65">
          <span class="hits">1</span>
          
          <code class="ruby">  def from_the_collections(json_to_index)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="66">
          
          
          <code class="ruby">    from_the_collections = json_to_index[&quot;ancestorCreator&quot;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="67">
          
          
          <code class="ruby">    from_the_collections -= json_to_index[&quot;creator&quot;] if from_the_collections.present? &amp;&amp; json_to_index[&quot;creator&quot;].present?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="68">
          
          
          <code class="ruby">    from_the_collections&amp;.uniq</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="71">
          <span class="hits">1</span>
          
          <code class="ruby">  def to_solr(json_to_index = nil)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="72">
          
          
          <code class="ruby">    if redirect_to.present?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby">      {</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="74">
          
          
          <code class="ruby">        id: self&amp;.oid,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="75">
          
          
          <code class="ruby">        visibility_ssi: &quot;Redirect&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="76">
          
          
          <code class="ruby">        redirect_to_tesi: self&amp;.redirect_to</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="79">
          
          
          <code class="ruby">      json_to_index ||= authoritative_json</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="80">
          
          
          <code class="ruby">      return nil if json_to_index.blank? || !manifest_completed?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="81">
          
          
          <code class="ruby">      {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="82">
          
          
          <code class="ruby">        # example_suffix: json_to_index[&quot;&quot;],</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="83">
          
          
          <code class="ruby">        id: oid.to_s,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="84">
          
          
          <code class="ruby">        abstract_tesim: json_to_index[&quot;abstract&quot;],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="85">
          
          
          <code class="ruby">        accessionNumber_ssi: json_to_index[&quot;accessionNumber&quot;],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="86">
          
          
          <code class="ruby">        accessRestrictions_tesim: json_to_index[&quot;accessRestrictions&quot;],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="87">
          
          
          <code class="ruby">        alternativeTitle_tesim: json_to_index[&quot;alternativeTitle&quot;],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="88">
          
          
          <code class="ruby">        alternativeTitleDisplay_tesim: json_to_index[&quot;alternativeTitleDisplay&quot;],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="89">
          
          
          <code class="ruby">        ancestorDisplayStrings_tesim: json_to_index[&quot;ancestorDisplayStrings&quot;],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="90">
          
          
          <code class="ruby">        # collectionCreator name in mdc is ancestorCreator</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="91">
          
          
          <code class="ruby">        collectionCreators_ssim: from_the_collections(json_to_index),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="92">
          
          
          <code class="ruby">        ancestorTitles_tesim: generate_ancestor_title(json_to_index[&quot;ancestorTitles&quot;]),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="93">
          
          
          <code class="ruby">        ancestor_titles_hierarchy_ssim: ancestor_structure(generate_ancestor_title(json_to_index[&quot;ancestorTitles&quot;])),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="94">
          
          
          <code class="ruby">        archivalSort_ssi: json_to_index[&quot;archivalSort&quot;],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="95">
          
          
          <code class="ruby">        archiveSpaceUri_ssi: aspace_uri,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="96">
          
          
          <code class="ruby">        box_ssim: extract_container_information(json_to_index),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="97">
          
          
          <code class="ruby">        callNumber_ssim: json_to_index[&quot;callNumber&quot;],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="98">
          
          
          <code class="ruby">        callNumber_tesim: json_to_index[&quot;callNumber&quot;],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="99">
          
          
          <code class="ruby">        caption_tesim: child_captions,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="100">
          
          
          <code class="ruby">        child_oids_ssim: child_oids,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="101">
          
          
          <code class="ruby">        collection_title_ssi: json_to_index[&quot;ancestorTitles&quot;]&amp;.[](-2),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="102">
          
          
          <code class="ruby">        collectionId_ssim: json_to_index[&quot;collectionId&quot;],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="103">
          
          
          <code class="ruby">        collectionId_tesim: json_to_index[&quot;collectionId&quot;],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="104">
          
          
          <code class="ruby">        containerGrouping_ssim: extract_container_information(json_to_index),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="105">
          
          
          <code class="ruby">        containerGrouping_tesim: extract_container_information(json_to_index),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="106">
          
          
          <code class="ruby">        contents_tesim: json_to_index[&quot;contents&quot;],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="107">
          
          
          <code class="ruby">        contributor_tsim: json_to_index[&quot;contributor&quot;],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="108">
          
          
          <code class="ruby">        contributorDisplay_tsim: json_to_index[&quot;contributorDisplay&quot;],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="109">
          
          
          <code class="ruby">        coordinates_ssim: json_to_index[&quot;coordinate&quot;],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="110">
          
          
          <code class="ruby">        coordinateDisplay_ssim: json_to_index[&quot;coordinateDisplay&quot;].presence || json_to_index[&quot;coordinate&quot;],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="111">
          
          
          <code class="ruby">        copyrightDate_ssim: json_to_index[&quot;copyrightDate&quot;],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="112">
          
          
          <code class="ruby">        creator_ssim: extract_creator(json_to_index),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="113">
          
          
          <code class="ruby">        creator_tesim: extract_creator(json_to_index),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="114">
          
          
          <code class="ruby">        creatorDisplay_tsim: json_to_index[&quot;creatorDisplay&quot;],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="115">
          
          
          <code class="ruby">        creationPlace_ssim: json_to_index[&quot;creationPlace&quot;],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="116">
          
          
          <code class="ruby">        creationPlace_tesim: json_to_index[&quot;creationPlace&quot;],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="117">
          
          
          <code class="ruby">        date_ssim: json_to_index[&quot;date&quot;],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="118">
          
          
          <code class="ruby">        dateDepicted_ssim: json_to_index[&quot;dateDepicted&quot;],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="119">
          
          
          <code class="ruby">        year_isim: expand_date_structured(json_to_index[&quot;dateStructured&quot;]),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="120">
          
          
          <code class="ruby">        dateStructured_ssim: json_to_index[&quot;dateStructured&quot;],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="121">
          
          
          <code class="ruby">        dependentUris_ssim: json_to_index[&quot;dependentUris&quot;],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="122">
          
          
          <code class="ruby">        description_tesim: json_to_index[&quot;description&quot;],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="123">
          
          
          <code class="ruby">        digital_ssim: json_to_index[&quot;digital&quot;],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="124">
          
          
          <code class="ruby">        digitization_note_tesi: generate_digitization_note(json_to_index[&quot;digitization_note&quot;]),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="125">
          
          
          <code class="ruby">        edition_ssim: json_to_index[&quot;edition&quot;],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="126">
          
          
          <code class="ruby">        extent_ssim: json_to_index[&quot;extent&quot;],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="127">
          
          
          <code class="ruby">        extentOfDigitization_ssim: extent_of_digitization,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="128">
          
          
          <code class="ruby">        findingAid_ssim: json_to_index[&quot;findingAid&quot;],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="129">
          
          
          <code class="ruby">        folder_ssim: json_to_index[&quot;folder&quot;],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="130">
          
          
          <code class="ruby">        format: json_to_index[&quot;format&quot;],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="131">
          
          
          <code class="ruby">        format_tesim: json_to_index[&quot;format&quot;],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="132">
          
          
          <code class="ruby">        genre_ssim: json_to_index[&quot;genre&quot;],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="133">
          
          
          <code class="ruby">        genre_tesim: json_to_index[&quot;genre&quot;],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="134">
          
          
          <code class="ruby">        geoSubject_ssim: json_to_index[&quot;geoSubject&quot;],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="135">
          
          
          <code class="ruby">        hashed_id_ssi: generate_hash,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="136">
          
          
          <code class="ruby">        has_fulltext_ssi: &quot;No&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="137">
          
          
          <code class="ruby">        identifierMfhd_ssim: json_to_index[&quot;identifierMfhd&quot;],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="138">
          
          
          <code class="ruby">        imageCount_isi: child_object_count,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="139">
          
          
          <code class="ruby">        indexedBy_tsim: json_to_index[&quot;indexedBy&quot;],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="140">
          
          
          <code class="ruby">        label_tesim: child_labels,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="141">
          
          
          <code class="ruby">        language_ssim: json_to_index[&quot;language&quot;],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="142">
          
          
          <code class="ruby">        languageCode_ssim: json_to_index[&quot;languageCode&quot;],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="143">
          
          
          <code class="ruby">        localRecordNumber_ssim: json_to_index[&quot;localRecordNumber&quot;],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="144">
          
          
          <code class="ruby">        material_tesim: json_to_index[&quot;material&quot;],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="145">
          
          
          <code class="ruby">        number_of_pages_ss: json_to_index[&quot;numberOfPages&quot;],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="146">
          
          
          <code class="ruby">        oid_ssi: oid,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="147">
          
          
          <code class="ruby">        orbisBarcode_ssi: barcode,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="148">
          
          
          <code class="ruby">        orbisBibId_ssi: generate_orbis_id(bib),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="149">
          
          
          <code class="ruby">        partOf_tesim: json_to_index[&quot;partOf&quot;],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="150">
          
          
          <code class="ruby">        preferredCitation_tesim: json_to_index[&quot;preferredCitation&quot;],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="151">
          
          
          <code class="ruby">        project_identifier_tesi: generate_pid(json_to_index[&quot;project_identifier&quot;]),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="152">
          
          
          <code class="ruby">        projection_tesim: json_to_index[&quot;projection&quot;],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="153">
          
          
          <code class="ruby">        public_bsi: true, # TEMPORARY, makes everything public</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="154">
          
          
          <code class="ruby">        publisher_tesim: json_to_index[&quot;publisher&quot;],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="155">
          
          
          <code class="ruby">        publisher_ssim: json_to_index[&quot;publisher&quot;],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="156">
          
          
          <code class="ruby">        quicksearchId_ssi: generate_quicksearch_id(bib),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="157">
          
          
          <code class="ruby">        recordType_ssi: json_to_index[&quot;recordType&quot;],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="158">
          
          
          <code class="ruby">        relatedResourceOnline_ssim: json_to_index[&quot;relatedResourceOnline&quot;],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="159">
          
          
          <code class="ruby">        repository_ssi: self&amp;.admin_set&amp;.label,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="160">
          
          
          <code class="ruby">        repository_ssim: self&amp;.admin_set&amp;.label,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="161">
          
          
          <code class="ruby">        resourceType_ssim: json_to_index[&quot;itemType&quot;],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="162">
          
          
          <code class="ruby">        resourceType_tesim: json_to_index[&quot;itemType&quot;],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="163">
          
          
          <code class="ruby">        resourceVersionOnline_ssim: json_to_index[&quot;resourceVersionOnline&quot;],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="164">
          
          
          <code class="ruby">        rights_ssim: rights_statement,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="165">
          
          
          <code class="ruby">        rights_tesim: rights_statement,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="166">
          
          
          <code class="ruby">        scale_tesim: json_to_index[&quot;scale&quot;],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="167">
          
          
          <code class="ruby">        series_ssi: json_to_index[&quot;series&quot;],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="168">
          
          
          <code class="ruby">        series_sort_ssi: series_sort(json_to_index),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="169">
          
          
          <code class="ruby">        source_ssim: json_to_index[&quot;source&quot;], # refers to source of metadata, e.g. Ladybird, Voyager, etc.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="170">
          
          
          <code class="ruby">        sourceCreated_tesim: json_to_index[&quot;sourceCreated&quot;],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="171">
          
          
          <code class="ruby">        sourceDate_tesim: json_to_index[&quot;sourceDate&quot;],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="172">
          
          
          <code class="ruby">        sourceEdition_tesim: json_to_index[&quot;sourceEdition&quot;], # Not currently in Blacklight application</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="173">
          
          
          <code class="ruby">        sourceNote_tesim: json_to_index[&quot;sourceNote&quot;],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="174">
          
          
          <code class="ruby">        sourceTitle_tesim: json_to_index[&quot;sourceTitle&quot;],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="175">
          
          
          <code class="ruby">        sourceCreator_tesim: json_to_index[&quot;sourceCreator&quot;],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="176">
          
          
          <code class="ruby">        subjectEra_ssim: json_to_index[&quot;subjectEra&quot;],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="177">
          
          
          <code class="ruby">        subjectGeographic_ssim: json_to_index[&quot;subjectGeographic&quot;],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="178">
          
          
          <code class="ruby">        subjectGeographic_tesim: json_to_index[&quot;subjectGeographic&quot;],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="179">
          
          
          <code class="ruby">        subjectHeading_ssim: json_to_index[&quot;subjectHeading&quot;],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="180">
          
          
          <code class="ruby">        subjectHeadingFacet_ssim: subject_headings_to_facet(json_to_index[&quot;subjectHeading&quot;]),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="181">
          
          
          <code class="ruby">        subjectTitle_tsim: json_to_index[&quot;subjectTitle&quot;],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="182">
          
          
          <code class="ruby">        subjectTitleDisplay_tsim: json_to_index[&quot;subjectTitleDisplay&quot;],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="183">
          
          
          <code class="ruby">        subjectName_ssim: json_to_index[&quot;subjectName&quot;],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="184">
          
          
          <code class="ruby">        subjectName_tesim: json_to_index[&quot;subjectName&quot;],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="185">
          
          
          <code class="ruby">        subjectTopic_tesim: json_to_index[&quot;subjectTopic&quot;],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="186">
          
          
          <code class="ruby">        subjectTopic_ssim: json_to_index[&quot;subjectTopic&quot;],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="187">
          
          
          <code class="ruby">        thumbnail_path_ss: representative_thumbnail_url,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="188">
          
          
          <code class="ruby">        title_tesim: json_to_index[&quot;title&quot;],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="189">
          
          
          <code class="ruby">        title_ssim: json_to_index[&quot;title&quot;],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="190">
          
          
          <code class="ruby">        uri_ssim: json_to_index[&quot;uri&quot;],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="191">
          
          
          <code class="ruby">        url_suppl_ssim: json_to_index[&quot;relatedUrl&quot;],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="192">
          
          
          <code class="ruby">        viewing_hint_ssi: display_layout,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="193">
          
          
          <code class="ruby">        visibility_ssi: visibility,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="194">
          
          
          <code class="ruby">        type_ssi: &#39;parent&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="195">
          
          
          <code class="ruby">      }.delete_if { |_k, v| v.blank? } # Delete nil, [], and empty string values</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="196">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="197">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="198">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="199">
          <span class="hits">1</span>
          
          <code class="ruby">  def to_solr_full_text(json_to_index = nil)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="200">
          
          
          <code class="ruby">    solr_document = to_solr(json_to_index)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="201">
          
          
          <code class="ruby">    child_solr_documents = child_object_solr_documents</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="202">
          
          
          <code class="ruby">    solr_document[:fulltext_tesim] = child_solr_documents.map { |child_solr_document| child_solr_document.try(:[], :child_fulltext_tesim) } unless solr_document.nil? || child_solr_documents.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="203">
          
          
          <code class="ruby">    solr_document = append_full_text_status(solr_document)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="204">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="205">
          
          
          <code class="ruby">    [solr_document, child_solr_documents]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="206">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="207">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="208">
          <span class="hits">1</span>
          
          <code class="ruby">  def child_object_solr_documents</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="209">
          
          
          <code class="ruby">    if full_text?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="210">
          
          
          <code class="ruby">      full_text_array = child_objects.map do |child_object|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="211">
          
          
          <code class="ruby">        child_object_full_text = S3Service.download_full_text(child_object.remote_ocr_path)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="212">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="213">
          
          
          <code class="ruby">        child_object_to_solr(child_object, child_object_full_text) unless child_object_full_text.nil?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="214">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="215">
          
          
          <code class="ruby">      return full_text_array.compact</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="216">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="217">
          
          
          <code class="ruby">    nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="218">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="219">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="220">
          <span class="hits">1</span>
          
          <code class="ruby">  def child_object_to_solr(child_object, child_object_full_text)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="221">
          
          
          <code class="ruby">    parent_object = child_object.parent_object</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="222">
          
          
          <code class="ruby">    {</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="223">
          
          
          <code class="ruby">      id: child_object.oid,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="224">
          
          
          <code class="ruby">      parent_ssi: parent_object.oid,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="225">
          
          
          <code class="ruby">      child_fulltext_tesim: child_object_full_text,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="226">
          
          
          <code class="ruby">      child_fulltext_wstsim: child_object_full_text,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="227">
          
          
          <code class="ruby">      type_ssi: &#39;child&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="228">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="229">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="230">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="231">
          <span class="hits">1</span>
          
          <code class="ruby">  def expand_date_structured(date_structured)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="232">
          
          
          <code class="ruby">    return nil unless date_structured&amp;.is_a?(Array)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="233">
          
          
          <code class="ruby">    date_structured.each_with_object(SortedSet.new) do |date, set|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="234">
          
          
          <code class="ruby">      if date.include? &#39;/&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="235">
          
          
          <code class="ruby">        dates = date.split(&#39;/&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="236">
          
          
          <code class="ruby">        if dates.count == 2</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="237">
          
          
          <code class="ruby">          date1 = dates[0].to_i</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="238">
          
          
          <code class="ruby">          date2 = dates[1].to_i</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="239">
          
          
          <code class="ruby">          date2 = Time.now.utc.year if date2 == 9999</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="240">
          
          
          <code class="ruby">          (date1..date2).each { |range_date| set &lt;&lt; range_date }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="241">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="242">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="243">
          
          
          <code class="ruby">        set &lt;&lt; date.to_i</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="244">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="245">
          
          
          <code class="ruby">    end.to_a</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="246">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="247">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="248">
          <span class="hits">1</span>
          
          <code class="ruby">  def append_full_text_status(solr_document)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="249">
          
          
          <code class="ruby">    return unless solr_document</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="250">
          
          
          <code class="ruby">    solr_document[:has_fulltext_ssi] = extent_of_full_text</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="251">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="252">
          
          
          <code class="ruby">    solr_document</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="253">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="254">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="255">
          <span class="hits">1</span>
          
          <code class="ruby">  def ancestor_structure(ancestor_title)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="256">
          
          
          <code class="ruby">    # Building the hierarchy structure</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="257">
          
          
          <code class="ruby">    return nil unless ancestor_title&amp;.is_a?(Array)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="258">
          
          
          <code class="ruby">    anc_struct = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="259">
          
          
          <code class="ruby">    ancestor_title = ancestor_title.reverse</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="260">
          
          
          <code class="ruby">    arr_size = 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="261">
          
          
          <code class="ruby">    prev_string = &quot;&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="262">
          
          
          <code class="ruby">    ancestor_title.each do |anc|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="263">
          
          
          <code class="ruby">      prev_string += (ancestor_title[arr_size - 1]).to_s + &quot; &gt; &quot; unless arr_size.zero?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="264">
          
          
          <code class="ruby">      anc = prev_string + anc + &quot; &gt; &quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="265">
          
          
          <code class="ruby">      formatted = anc[0...-3]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="266">
          
          
          <code class="ruby">      anc_struct.push(formatted)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="267">
          
          
          <code class="ruby">      arr_size += 1</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="268">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="269">
          
          
          <code class="ruby">    anc_struct</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="270">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="271">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="272">
          <span class="hits">1</span>
          
          <code class="ruby">  def generate_hash</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="273">
          
          
          <code class="ruby">    Digest::MD5.hexdigest oid.to_s</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="274">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="275">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="276">
          <span class="hits">1</span>
          
          <code class="ruby">  def generate_pid(project_identifier)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="277">
          
          
          <code class="ruby">    project_identifier.presence || self&amp;.project_identifier || nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="278">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="279">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="280">
          <span class="hits">1</span>
          
          <code class="ruby">  def generate_digitization_note(digitization_note)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="281">
          
          
          <code class="ruby">    digitization_note.presence || self&amp;.digitization_note || nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="282">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="283">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="284">
          
          
          <code class="ruby">  # not ASpace records will use the repository value</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="285">
          <span class="hits">1</span>
          
          <code class="ruby">  def generate_ancestor_title(ancestor_title)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="286">
          
          
          <code class="ruby">    ancestor_title.presence || [self&amp;.admin_set&amp;.label] || nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="287">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="288">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="289">
          <span class="hits">1</span>
          
          <code class="ruby">  def generate_orbis_id(bib)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="290">
          
          
          <code class="ruby">    (bib.to_i.positive? &amp;&amp; bib.presence) || nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="291">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="292">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="293">
          <span class="hits">1</span>
          
          <code class="ruby">  def generate_quicksearch_id(bib)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="294">
          
          
          <code class="ruby">    (bib.present? &amp;&amp; bib.start_with?(&quot;b&quot;) &amp;&amp; bib) || nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="295">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="296">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="297">
          <span class="hits">1</span>
          
          <code class="ruby">  def series_sort(json_to_index)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="298">
          
          
          <code class="ruby">    return nil unless json_to_index[&#39;series&#39;].present? &amp;&amp; json_to_index[&#39;archivalSort&#39;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="299">
          
          
          <code class="ruby">    # only get the first portion of the sort, that represents the series sort value.</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="300">
          
          
          <code class="ruby">    sort = json_to_index[&#39;archivalSort&#39;].split(&quot;.&quot;)[0]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="301">
          
          
          <code class="ruby">    &quot;#{sort}|#{json_to_index[&#39;series&#39;]}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="302">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="303">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="304">
          <span class="hits">1</span>
          
          <code class="ruby">  def subject_headings_to_facet(subject_headings)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="305">
          
          
          <code class="ruby">    return nil unless subject_headings</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="306">
          
          
          <code class="ruby">    facets = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="307">
          
          
          <code class="ruby">    subject_headings.each do |subject_heading|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="308">
          
          
          <code class="ruby">      components = subject_heading.split(&quot; &gt; &quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="309">
          
          
          <code class="ruby">      components.each_index do |ix|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="310">
          
          
          <code class="ruby">        facets &lt;&lt; components[0..ix].join(&quot; &gt; &quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="311">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="312">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="313">
          
          
          <code class="ruby">    facets</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="314">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="315">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="d72c0d287c21dbbfdd9d2ae0ae4fba0ac23ff1c6">
  <div class="header">
    <h3>app/models/concerns/statable.rb</h3>
    <h4><span class="red">67.35 %</span> covered</h4>
    <div>
      <b>49</b> relevant lines. 
      <span class="green"><b>33</b> lines covered</span> and
      <span class="red"><b>16</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># frozen_string_literal: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">module Statable</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  extend ActiveSupport::Concern</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">  def notes_for_batch_process(batch_process)</code>
        </li>
      
        <li class="covered" data-hits="14" data-linenumber="6">
          <span class="hits">14</span>
          
          <code class="ruby">    events_for_batch_process(batch_process).each_with_object({}) { |e, i| i[e.status] = e.created_at }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">  def events_for_batch_process(batch_process)</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="10">
          <span class="hits">7</span>
          
          <code class="ruby">    IngestEvent.where(batch_connection: batch_connections_for(batch_process))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">  def start_note(notes)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="14">
          
          
          <code class="ruby">    @start_note ||= start_states.map { |state| notes[state] }.compact.first</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="17">
          <span class="hits">1</span>
          
          <code class="ruby">  def finished_note(notes)</code>
        </li>
      
        <li class="covered" data-hits="36" data-linenumber="18">
          <span class="hits">36</span>
          
          <code class="ruby">    @finished_note ||= finished_states.map { |state| notes[state] }.compact.first</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="21">
          <span class="hits">1</span>
          
          <code class="ruby">  def deleted_note(notes)</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="22">
          <span class="hits">6</span>
          
          <code class="ruby">    notes[&quot;deleted&quot;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="25">
          <span class="hits">1</span>
          
          <code class="ruby">  def batch_connections_for(_batch_process)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="26">
          
          
          <code class="ruby">    raise &#39;Must be implemented&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="29">
          <span class="hits">1</span>
          
          <code class="ruby">  def status_for_batch_process(batch_process)</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="30">
          <span class="hits">7</span>
          
          <code class="ruby">    notes = notes_for_batch_process(batch_process)</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="31">
          <span class="hits">7</span>
          
          <code class="ruby">    if notes.empty?</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="32">
          <span class="hits">1</span>
          
          <code class="ruby">      &quot;Pending&quot;</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="33">
          <span class="hits">6</span>
          
          <code class="ruby">    elsif deleted_note(notes)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="34">
          
          
          <code class="ruby">      &quot;Parent object deleted successfully&quot;</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="35">
          <span class="hits">6</span>
          
          <code class="ruby">    elsif finished_note(notes)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="36">
          <span class="hits">1</span>
          
          <code class="ruby">      &quot;Complete&quot;</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="37">
          <span class="hits">5</span>
          
          <code class="ruby">    elsif latest_failure(batch_process).nil?</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="38">
          <span class="hits">5</span>
          
          <code class="ruby">      &quot;In progress - no failures&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="39">
          
          
          <code class="ruby">    elsif latest_failure(batch_process)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="40">
          
          
          <code class="ruby">      &quot;Failed&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="42">
          
          
          <code class="ruby">      &quot;Unknown status&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="46">
          <span class="hits">1</span>
          
          <code class="ruby">  def duration_for_batch_process(batch_process)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="47">
          
          
          <code class="ruby">    notes = notes_for_batch_process(batch_process)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="48">
          
          
          <code class="ruby">    if notes.present?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="49">
          
          
          <code class="ruby">      start = start_note(notes)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="50">
          
          
          <code class="ruby">      finish = finished_note(notes)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="51">
          
          
          <code class="ruby">      finish - start if finish &amp;&amp; start</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="53">
          
          
          <code class="ruby">      &quot;n/a&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="57">
          <span class="hits">1</span>
          
          <code class="ruby">  def note_records(batch_process)</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="58">
          <span class="hits">5</span>
          
          <code class="ruby">    IngestEvent.where(batch_connection: batch_connections.where(batch_process: batch_process))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="61">
          <span class="hits">1</span>
          
          <code class="ruby">  def note_deletion</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="62">
          
          
          <code class="ruby">    batch_connections.each do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="63">
          
          
          <code class="ruby">      processing_event(&quot;The parent object was deleted&quot;, &#39;deleted&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="67">
          <span class="hits">1</span>
          
          <code class="ruby">  def latest_failure(batch_process)</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="68">
          <span class="hits">5</span>
          
          <code class="ruby">    failures = note_records(batch_process).where(status: &#39;failed&#39;)</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="69">
          <span class="hits">5</span>
          
          <code class="ruby">    if failures.empty?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby">      nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="72">
          
          
          <code class="ruby">      { reason: failures.last[:reason], time: failures.last[:created_at] }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="75">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="76">
          <span class="hits">1</span>
          
          <code class="ruby">  def current_batch_connection</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="77">
          
          
          <code class="ruby">    @current_batch_connection ||= current_batch_process&amp;.batch_connections&amp;.find_or_create_by(connectable: self)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="79">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="80">
          <span class="hits">1</span>
          
          <code class="ruby">  def processing_event(message, status = &#39;info&#39;)</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="81">
          <span class="hits">12</span>
          
          <code class="ruby">    return &quot;no batch connection&quot; unless current_batch_connection</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="82">
          <span class="hits">6</span>
          
          <code class="ruby">    IngestEvent.create!(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="83">
          
          
          <code class="ruby">      status: status,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="84">
          
          
          <code class="ruby">      reason: message,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="85">
          
          
          <code class="ruby">      batch_connection: current_batch_connection</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="86">
          
          
          <code class="ruby">    )</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="87">
          <span class="hits">6</span>
          
          <code class="ruby">    current_batch_connection&amp;.update_status!</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="88">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="89">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="17dd4de8907d0e7d2ea829106c22786317d9a4ac">
  <div class="header">
    <h3>app/models/concerns/updatable.rb</h3>
    <h4><span class="red">17.02 %</span> covered</h4>
    <div>
      <b>94</b> relevant lines. 
      <span class="green"><b>16</b> lines covered</span> and
      <span class="red"><b>78</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># frozen_string_literal: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"># rubocop:disable Metrics/ModuleLength</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">module Updatable</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">  extend ActiveSupport::Concern</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">  BLANK_VALUE = &quot;_blank_&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">  def updatable_parent_object(oid, index)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">    parent_object = ParentObject.find_by(oid: oid)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="11">
          
          
          <code class="ruby">    if parent_object.blank?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">      batch_processing_event(&quot;Skipping row [#{index + 2}] with parent oid: #{oid} because it was not found in local database&quot;, &#39;Skipped Row&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby">      return false</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="14">
          
          
          <code class="ruby">    elsif !current_ability.can?(:update, parent_object)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="15">
          
          
          <code class="ruby">      batch_processing_event(&quot;Skipping row [#{index + 2}] with parent oid: #{oid}, user does not have permission to update.&quot;, &#39;Permission Denied&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="16">
          
          
          <code class="ruby">      return false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">      parent_object</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">  # rubocop:disable Metrics/CyclomaticComplexity</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">  # rubocop:disable Metrics/PerceivedComplexity</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="24">
          <span class="hits">1</span>
          
          <code class="ruby">  def update_parent_objects</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="25">
          
          
          <code class="ruby">    return unless batch_action == &quot;update parent objects&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="26">
          
          
          <code class="ruby">    parsed_csv.each_with_index do |row, index|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="27">
          
          
          <code class="ruby">      oid = row[&#39;oid&#39;] unless [&#39;oid&#39;].nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="28">
          
          
          <code class="ruby">      redirect = row[&#39;redirect_to&#39;] unless [&#39;redirect_to&#39;].nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="29">
          
          
          <code class="ruby">      parent_object = updatable_parent_object(oid, index)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="30">
          
          
          <code class="ruby">      next unless parent_object</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="31">
          
          
          <code class="ruby">      next if redirect.present? &amp;&amp; !validate_redirect(redirect)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="32">
          
          
          <code class="ruby">      next unless check_for_children(redirect, parent_object)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="34">
          
          
          <code class="ruby">      processed_fields = validate_field(parent_object, row)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">      # move metadata_source here since row is updated in validate_field</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="36">
          
          
          <code class="ruby">      metadata_source = row[&#39;source&#39;].presence || parent_object.authoritative_metadata_source.metadata_cloud_name</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="37">
          
          
          <code class="ruby">      next unless validate_metadata_source(metadata_source, index)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="38">
          
          
          <code class="ruby">      setup_for_background_jobs(parent_object, metadata_source)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="39">
          
          
          <code class="ruby">      parent_object.update(processed_fields)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="40">
          
          
          <code class="ruby">      trigger_setup_metadata(parent_object)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="42">
          
          
          <code class="ruby">      processing_event_for_parent(parent_object)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby">  # rubocop:enable Metrics/CyclomaticComplexity</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby">  # rubocop:enable Metrics/PerceivedComplexity</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="48">
          <span class="hits">1</span>
          
          <code class="ruby">  def remove_blanks(row, parent_object)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="49">
          
          
          <code class="ruby">    blankable = %w[aspace_uri barcode bib digitization_note holding item project_identifier rights_statement redirect_to display_layout extent_of_digitization viewing_direction]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="50">
          
          
          <code class="ruby">    blanks = {}</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="51">
          
          
          <code class="ruby">    row.delete_if do |k, v|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="52">
          
          
          <code class="ruby">      if v == BLANK_VALUE</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="53">
          
          
          <code class="ruby">        if blankable.include?(k)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="54">
          
          
          <code class="ruby">          blanks[k.to_sym] = nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="56">
          
          
          <code class="ruby">          processing_event_invalid_blank(parent_object, k)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="58">
          
          
          <code class="ruby">        true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="60">
          
          
          <code class="ruby">        false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="63">
          
          
          <code class="ruby">    [row, blanks]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="66">
          <span class="hits">1</span>
          
          <code class="ruby">  def validate_field(parent_object, row)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="67">
          
          
          <code class="ruby">    fields = [&#39;aspace_uri&#39;, &#39;barcode&#39;, &#39;bib&#39;, &#39;digitization_note&#39;, &#39;holding&#39;, &#39;item&#39;, &#39;project_identifier&#39;, &#39;rights_statement&#39;, &#39;redirect_to&#39;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="68">
          
          
          <code class="ruby">    validation_fields = { &quot;display_layout&quot; =&gt; &#39;viewing_hints&#39;, &quot;extent_of_digitization&quot; =&gt; &#39;extent_of_digitizations&#39;, &quot;viewing_direction&quot; =&gt; &#39;viewing_directions&#39;, &quot;visibility&quot; =&gt; &#39;visibilities&#39; }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="69">
          
          
          <code class="ruby">    row, blanks = remove_blanks(row, parent_object)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="70">
          
          
          <code class="ruby">    processed_fields = {}</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="71">
          
          
          <code class="ruby">    fields.each do |f|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="72">
          
          
          <code class="ruby">      processed_fields[f.to_sym] = valid_regular_fields(row, f, parent_object)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="74">
          
          
          <code class="ruby">    validation_fields.each do |k, v|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="75">
          
          
          <code class="ruby">      processed_fields[k.to_sym] = valid_controlled_vocab_fields(row, k, v, parent_object)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="76">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="77">
          
          
          <code class="ruby">    processed_fields.merge!(blanks)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="78">
          
          
          <code class="ruby">    processed_fields</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="79">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="81">
          <span class="hits">1</span>
          
          <code class="ruby">  def processing_event_for_parent(parent_object)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="82">
          
          
          <code class="ruby">    parent_object.current_batch_process = self</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="83">
          
          
          <code class="ruby">    parent_object.current_batch_connection = batch_connections.find_or_create_by(connectable: parent_object)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="84">
          
          
          <code class="ruby">    parent_object.current_batch_connection.save!</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="85">
          
          
          <code class="ruby">    parent_object.processing_event(&quot;Parent #{parent_object.oid} has been updated&quot;, &#39;update-complete&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="86">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="87">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="88">
          <span class="hits">1</span>
          
          <code class="ruby">  def processing_event_invalid_blank(parent_object, field)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="89">
          
          
          <code class="ruby">    batch_processing_event(&quot;Parent #{parent_object.oid} did not update value for #{field} because it can not be blanked.&quot;, &#39;Invalid Blank&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="90">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="91">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="92">
          <span class="hits">1</span>
          
          <code class="ruby">  def remote_po_path(oid, metadata_source)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="93">
          
          
          <code class="ruby">    &quot;#{metadata_source}/#{oid}.json&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="94">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="95">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="96">
          <span class="hits">1</span>
          
          <code class="ruby">  def valid_regular_fields(row, field_value, parent_object)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="97">
          
          
          <code class="ruby">    if row[field_value].present? &amp;&amp; row[field_value] != parent_object.send(field_value)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="98">
          
          
          <code class="ruby">      row[field_value]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="99">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="100">
          
          
          <code class="ruby">      parent_object.send(field_value)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="101">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="102">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="103">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="104">
          <span class="hits">1</span>
          
          <code class="ruby">  def valid_controlled_vocab_fields(row, column_name, vocab, parent_object)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="105">
          
          
          <code class="ruby">    if row[column_name].present? &amp;&amp; row[column_name] != parent_object.send(column_name) &amp;&amp; (ParentObject.send(vocab).include? row[column_name])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="106">
          
          
          <code class="ruby">      row[column_name]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="107">
          
          
          <code class="ruby">    elsif row[column_name].present? &amp;&amp; row[column_name] != parent_object.send(column_name) &amp;&amp; !(ParentObject.send(vocab).include? row[column_name])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="108">
          
          
          <code class="ruby">      process_invalid_vocab_event(column_name, row[column_name], parent_object.oid)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="109">
          
          
          <code class="ruby">      parent_object.send(column_name)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="110">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="111">
          
          
          <code class="ruby">      parent_object.send(column_name)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="112">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="113">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="114">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="115">
          
          
          <code class="ruby">  # rubocop:disable Metrics/LineLength</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="116">
          <span class="hits">1</span>
          
          <code class="ruby">  def process_invalid_vocab_event(column_name, row_value, oid)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="117">
          
          
          <code class="ruby">    case column_name</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="118">
          
          
          <code class="ruby">    when &#39;display_layout&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="119">
          
          
          <code class="ruby">      batch_processing_event(&quot;Parent #{oid} did not update value for Viewing Hint. Value: #{row_value} is invalid. For field Display Layout / Viewing Hint please use: individuals, paged, continuous, or leave column empty&quot;, &#39;Invalid Vocabulary&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="120">
          
          
          <code class="ruby">    when &#39;extent_of_digitization&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="121">
          
          
          <code class="ruby">      batch_processing_event(&quot;Parent #{oid} did not update value for Extent of Digitization. Value: #{row_value} is invalid. For field Extent of Digitization please use: Completely digitizied, Partially digitizied, or leave column empty&quot;, &#39;Invalid Vocabulary&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="122">
          
          
          <code class="ruby">    when &#39;viewing_direction&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="123">
          
          
          <code class="ruby">      batch_processing_event(&quot;Parent #{oid} did not update value for Viewing Directions. Value: #{row_value} is invalid. For field Viewing Direction please use: left-to-right, right-to-left, top-to-bottom, bottom-to-top, or leave column empty&quot;, &#39;Invalid Vocabulary&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="124">
          
          
          <code class="ruby">    when &#39;visibility&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="125">
          
          
          <code class="ruby">      batch_processing_event(&quot;Parent #{oid} did not update value for Visibility. Value: #{row_value} is invalid. For field Visibility please use: Private, Public, or Yale Community Only&quot;, &#39;Invalid Vocabulary&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="126">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="127">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="128">
          
          
          <code class="ruby">  # rubocop:enable Metrics/LineLength</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="129">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="130">
          <span class="hits">1</span>
          
          <code class="ruby">  def trigger_setup_metadata(parent_object)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="131">
          
          
          <code class="ruby">    parent_object.current_batch_process = self</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="132">
          
          
          <code class="ruby">    parent_object.current_batch_connection = batch_connections.find_or_create_by(connectable: parent_object)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="133">
          
          
          <code class="ruby">    parent_object.current_batch_connection.save!</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="134">
          
          
          <code class="ruby">    parent_object.save!</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="135">
          
          
          <code class="ruby">    SetupMetadataJob.perform_later(parent_object, self, parent_object.current_batch_connection)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="136">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="137">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="138">
          <span class="hits">1</span>
          
          <code class="ruby">  def check_for_children(redirect, parent_object)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="139">
          
          
          <code class="ruby">    if redirect.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="140">
          
          
          <code class="ruby">      true</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="141">
          
          
          <code class="ruby">    elsif redirect &amp;&amp; parent_object.child_objects.count.zero?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="142">
          
          
          <code class="ruby">      true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="143">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="144">
          
          
          <code class="ruby">      batch_processing_event(&quot;Skipping row with parent oid: #{parent_object.oid} Child objects are attached to parent object.  Parent must have no children to be redirected.&quot;, &#39;Skipped Row&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="145">
          
          
          <code class="ruby">      false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="146">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="147">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="148">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="149">
          <span class="hits">1</span>
          
          <code class="ruby">  def validate_redirect(redirect)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="150">
          
          
          <code class="ruby">    if redirect =~ /\A((http|https):\/\/)?(collections-test.|collections-uat.|collections.)?library.yale.edu\/catalog\//</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="151">
          
          
          <code class="ruby">      true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="152">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="153">
          
          
          <code class="ruby">      batch_processing_event(&quot;Skipping row with redirect to: #{redirect}. Redirect to must be in format https://collections.library.yale.edu/catalog/1234567.&quot;, &#39;Skipped Row&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="154">
          
          
          <code class="ruby">      false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="155">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="156">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="157">
          
          
          <code class="ruby">end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="158">
          
          
          <code class="ruby"># rubocop:enable Metrics/ModuleLength</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="b29f6b11743643f08e90223b6137d0586cdcad06">
  <div class="header">
    <h3>app/models/csv_export.rb</h3>
    <h4><span class="red">0.0 %</span> covered</h4>
    <div>
      <b>12</b> relevant lines. 
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>12</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># frozen_string_literal: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"># frozen_string_literal</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="5">
          
          
          <code class="ruby">class CsvExport</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="6">
          
          
          <code class="ruby">  def initialize(csv, batch_process)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="7">
          
          
          <code class="ruby">    @csv = csv</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="8">
          
          
          <code class="ruby">    @batch_process = batch_process</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="9">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="11">
          
          
          <code class="ruby">  def fetch</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">    S3Service.download(@batch_process.remote_csv_path)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="15">
          
          
          <code class="ruby">  def save</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="16">
          
          
          <code class="ruby">    S3Service.upload_csv(@batch_process.remote_csv_path, @csv, &quot;text/csv; charset=UTF-8; header=present&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="17">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="bd4c3de8b94cf620d67bbbafe5778291d05f6708">
  <div class="header">
    <h3>app/models/dependent_object.rb</h3>
    <h4><span class="red">0.0 %</span> covered</h4>
    <div>
      <b>3</b> relevant lines. 
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>3</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># frozen_string_literal: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="3">
          
          
          <code class="ruby">class DependentObject &lt; ApplicationRecord</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="4">
          
          
          <code class="ruby">  belongs_to :parent_object</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="5">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="fed2bf7deaf5ad819cffedd84d84c4d854d625e3">
  <div class="header">
    <h3>app/models/digital_object_json.rb</h3>
    <h4><span class="red">0.0 %</span> covered</h4>
    <div>
      <b>3</b> relevant lines. 
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>3</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># frozen_string_literal: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="3">
          
          
          <code class="ruby">class DigitalObjectJson &lt; ApplicationRecord</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="4">
          
          
          <code class="ruby">  belongs_to :parent_object</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="5">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="75c5cff65a276c77b06b336a2a6e27b0bf426700">
  <div class="header">
    <h3>app/models/iiif_presentation_v3.rb</h3>
    <h4><span class="red">0.0 %</span> covered</h4>
    <div>
      <b>244</b> relevant lines. 
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>244</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># frozen_string_literal: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"># rubocop:disable Metrics/ClassLength</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="4">
          
          
          <code class="ruby">class IiifPresentationV3</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="5">
          
          
          <code class="ruby">  attr_reader :parent_object, :mets_doc, :oid, :errors</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="7">
          
          
          <code class="ruby">  def image_base_url</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="8">
          
          
          <code class="ruby">    @image_base_url ||= (ENV[&quot;IIIF_IMAGE_BASE_URL&quot;] || &quot;http://localhost:8182/iiif&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="9">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="11">
          
          
          <code class="ruby">  def manifest_base_url</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">    @manifest_base_url ||= (ENV[&quot;IIIF_MANIFESTS_BASE_URL&quot;] || &quot;http://localhost/manifests&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="15">
          
          
          <code class="ruby">  def pdf_base_url</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="16">
          
          
          <code class="ruby">    @pdf_base_url ||= (ENV[&quot;PDF_BASE_URL&quot;] || &quot;http://localhost/pdfs&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="17">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="19">
          
          
          <code class="ruby">  def image_service_url(oid)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="20">
          
          
          <code class="ruby">    &quot;#{image_base_url}/2/#{oid}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="21">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="23">
          
          
          <code class="ruby">  def image_url(oid)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="24">
          
          
          <code class="ruby">    &quot;#{image_service_url(oid)}/full/!200,200/0/default.jpg&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="25">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="27">
          
          
          <code class="ruby">  def initialize(parent_object)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="28">
          
          
          <code class="ruby">    @parent_object = parent_object</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="29">
          
          
          <code class="ruby">    @oid = parent_object.oid</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="30">
          
          
          <code class="ruby">    @errors = ActiveModel::Errors.new(self)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="31">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="33">
          
          
          <code class="ruby">  def valid?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="34">
          
          
          <code class="ruby">    if ChildObject.where(parent_object: parent_object).order(:order).empty?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="35">
          
          
          <code class="ruby">      errors.add(:manifest, &quot;There are no child objects for #{@oid}&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="36">
          
          
          <code class="ruby">      return false</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="37">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="38">
          
          
          <code class="ruby">    true</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="39">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">  # Build the actual manifest object</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">  # rubocop:disable Metrics/AbcSize</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="43">
          
          
          <code class="ruby">  def manifest</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="44">
          
          
          <code class="ruby">    return @manifest if @manifest</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="45">
          
          
          <code class="ruby">    @manifest = {}</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="46">
          
          
          <code class="ruby">    @manifest[&quot;@context&quot;] = [&quot;http://iiif.io/api/search/1/context.json&quot;, &quot;http://iiif.io/api/presentation/3/context.json&quot;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="47">
          
          
          <code class="ruby">    @manifest[&#39;id&#39;] = File.join((ENV[&#39;IIIF_MANIFESTS_BASE_URL&#39;]).to_s, oid.to_s)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="48">
          
          
          <code class="ruby">    @manifest[&#39;type&#39;] = &quot;Manifest&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="49">
          
          
          <code class="ruby">    manifest_descriptive_properties</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="50">
          
          
          <code class="ruby">    @manifest[&#39;provider&#39;] = [provider]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="51">
          
          
          <code class="ruby">    @manifest[&quot;viewingDirection&quot;] = @parent_object.viewing_direction unless @parent_object.viewing_direction.nil? || @parent_object.viewing_direction.empty?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="52">
          
          
          <code class="ruby">    @manifest[&quot;behavior&quot;] = [@parent_object.display_layout] unless @parent_object.display_layout.nil? || @parent_object.display_layout.empty?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="53">
          
          
          <code class="ruby">    @manifest[&quot;items&quot;] = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="54">
          
          
          <code class="ruby">    add_canvases_to_manifest(@manifest[&#39;items&#39;])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="55">
          
          
          <code class="ruby">    if parent_object.full_text?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="56">
          
          
          <code class="ruby">      @manifest[&quot;service&quot;] ||= []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="57">
          
          
          <code class="ruby">      @manifest[&quot;service&quot;] &lt;&lt; search_service</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="58">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="59">
          
          
          <code class="ruby">    @manifest</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="60">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby">  # rubocop:enable Metrics/AbcSize</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="63">
          
          
          <code class="ruby">  def manifest_descriptive_properties</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="64">
          
          
          <code class="ruby">    @manifest[&#39;label&#39;] = {</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="65">
          
          
          <code class="ruby">      &quot;none&quot; =&gt; [@parent_object&amp;.authoritative_json&amp;.[](&quot;title&quot;)&amp;.first || &#39;&#39;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="66">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="67">
          
          
          <code class="ruby">    @manifest[&quot;homepage&quot;] = homepage</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="68">
          
          
          <code class="ruby">    @manifest[&quot;requiredStatement&quot;] = required_statement</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="69">
          
          
          <code class="ruby">    @manifest[&quot;rendering&quot;] = rendering</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="70">
          
          
          <code class="ruby">    @manifest[&quot;seeAlso&quot;] = see_also</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="71">
          
          
          <code class="ruby">    @manifest[&quot;metadata&quot;] = metadata</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="72">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="74">
          
          
          <code class="ruby">  def required_statement</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="75">
          
          
          <code class="ruby">    {</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="76">
          
          
          <code class="ruby">      &quot;label&quot; =&gt; { &quot;en&quot; =&gt; [&quot;Provider&quot;] },</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="77">
          
          
          <code class="ruby">      &quot;value&quot; =&gt; { &quot;en&quot; =&gt; [&quot;Yale University Library&quot;] }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="78">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="79">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="81">
          
          
          <code class="ruby">  def search_service</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="82">
          
          
          <code class="ruby">    base = ENV[&#39;BLACKLIGHT_BASE_URL&#39;] || &#39;http://localhost:3000&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="83">
          
          
          <code class="ruby">    {</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="84">
          
          
          <code class="ruby">      &quot;@id&quot;: File.join(base, &quot;catalog/#{oid}/iiif_search&quot;),</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="85">
          
          
          <code class="ruby">      &quot;@type&quot;: &quot;SearchService1&quot;,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="86">
          
          
          <code class="ruby">      &quot;profile&quot;: &quot;http://iiif.io/api/search/1/search&quot;,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="87">
          
          
          <code class="ruby">      &quot;service&quot;: {</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="88">
          
          
          <code class="ruby">        &quot;@id&quot;: File.join(base, &quot;catalog/#{oid}/iiif_suggest&quot;),</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="89">
          
          
          <code class="ruby">        &quot;@type&quot;: &quot;AutoCompleteService1&quot;,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="90">
          
          
          <code class="ruby">        &quot;profile&quot;: &quot;http://iiif.io/api/search/1/autocomplete&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="91">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="92">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="93">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="94">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="95">
          
          
          <code class="ruby">  def extract_value(field, hash)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="96">
          
          
          <code class="ruby">    if hash[:digital_only] == true</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="97">
          
          
          <code class="ruby">      @parent_object.send(field.to_s)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="98">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="99">
          
          
          <code class="ruby">      @parent_object&amp;.authoritative_json&amp;.[](field.to_s).presence || (hash[:backup_field] &amp;&amp; @parent_object&amp;.authoritative_json&amp;.[](hash[:backup_field]).presence)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="100">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="101">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="102">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="103">
          
          
          <code class="ruby">  def metadata</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="104">
          
          
          <code class="ruby">    values = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="105">
          
          
          <code class="ruby">    METADATA_FIELDS.each do |field, hash|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="106">
          
          
          <code class="ruby">      value = extract_value(field, hash)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="107">
          
          
          <code class="ruby">      if value.is_a?(Array)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="108">
          
          
          <code class="ruby">        value = process_metadata_array value, hash</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="109">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="110">
          
          
          <code class="ruby">        unless value.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="111">
          
          
          <code class="ruby">          value = value.to_s</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="112">
          
          
          <code class="ruby">          value = metadata_url(value, hash) if hash[:is_url]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="113">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="114">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="115">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="116">
          
          
          <code class="ruby">      values &lt;&lt; metadata_pair(hash[:label], value) if value</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="117">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="118">
          
          
          <code class="ruby">    values</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="119">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="120">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="121">
          
          
          <code class="ruby">  def metadata_url(url, hash)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="122">
          
          
          <code class="ruby">    return unless url</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="123">
          
          
          <code class="ruby">    url = hash[:prefix] + url if hash[:prefix]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="124">
          
          
          <code class="ruby">    return url unless url.start_with?(&#39;http&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="125">
          
          
          <code class="ruby">    &quot;&lt;span&gt;&lt;a href=\&quot;#{url}\&quot;&gt;#{url}&lt;/a&gt;&lt;/span&gt;&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="126">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="127">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="128">
          
          
          <code class="ruby">  def process_metadata_array(value, hash)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="129">
          
          
          <code class="ruby">    value = value.reverse if hash[:reverse_array]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="130">
          
          
          <code class="ruby">    value = value.compact.map { |url| metadata_url(url, hash) } if hash[:is_url]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="131">
          
          
          <code class="ruby">    value = value.join(hash[:join_char]) if hash[:join_char].present?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="132">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="133">
          
          
          <code class="ruby">    value</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="134">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="135">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="136">
          
          
          <code class="ruby">  def metadata_pair(label, value)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="137">
          
          
          <code class="ruby">    value = [value] if value.is_a? String</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="138">
          
          
          <code class="ruby">    { &#39;label&#39; =&gt; { &#39;en&#39; =&gt; [label] }, &#39;value&#39; =&gt; { &#39;none&#39; =&gt; value } }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="139">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="140">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="141">
          
          
          <code class="ruby">  def provider</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="142">
          
          
          <code class="ruby">    {</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="143">
          
          
          <code class="ruby">      &quot;id&quot; =&gt; &quot;https://www.wikidata.org/wiki/Q2583293&quot;,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="144">
          
          
          <code class="ruby">      &quot;type&quot; =&gt; &quot;Agent&quot;,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="145">
          
          
          <code class="ruby">      &quot;label&quot; =&gt; { &quot;en&quot; =&gt; [&quot;Yale Library&quot;] },</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="146">
          
          
          <code class="ruby">      &quot;homepage&quot; =&gt; [</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="147">
          
          
          <code class="ruby">        {</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="148">
          
          
          <code class="ruby">          &quot;id&quot; =&gt; &quot;https://library.yale.edu/&quot;,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="149">
          
          
          <code class="ruby">          &quot;type&quot; =&gt; &quot;Text&quot;,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="150">
          
          
          <code class="ruby">          &quot;label&quot; =&gt; { &quot;en&quot; =&gt; [&quot;Yale Library homepage&quot;] },</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="151">
          
          
          <code class="ruby">          &quot;format&quot; =&gt; &quot;text/html&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="152">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="153">
          
          
          <code class="ruby">      ]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="154">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="155">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="156">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="157">
          
          
          <code class="ruby">  def homepage</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="158">
          
          
          <code class="ruby">    [</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="159">
          
          
          <code class="ruby">      {</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="160">
          
          
          <code class="ruby">        &quot;id&quot; =&gt; &quot;https://collections.library.yale.edu/catalog/#{@oid}&quot;,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="161">
          
          
          <code class="ruby">        &quot;type&quot; =&gt; &quot;Text&quot;,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="162">
          
          
          <code class="ruby">        &quot;format&quot; =&gt; &quot;text/html&quot;,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="163">
          
          
          <code class="ruby">        &quot;label&quot; =&gt; { &quot;en&quot; =&gt; [&quot;Yale Digital Collections page&quot;] }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="164">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="165">
          
          
          <code class="ruby">    ]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="166">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="167">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="168">
          
          
          <code class="ruby">  def rendering</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="169">
          
          
          <code class="ruby">    [</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="170">
          
          
          <code class="ruby">      {</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="171">
          
          
          <code class="ruby">        &quot;id&quot; =&gt; File.join(pdf_base_url.to_s, &quot;#{@oid}.pdf&quot;),</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="172">
          
          
          <code class="ruby">        &quot;type&quot; =&gt; &quot;Text&quot;,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="173">
          
          
          <code class="ruby">        &quot;format&quot; =&gt; &quot;application/pdf&quot;,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="174">
          
          
          <code class="ruby">        &quot;label&quot; =&gt; { &quot;en&quot; =&gt; [&quot;Download as PDF&quot;] }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="175">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="176">
          
          
          <code class="ruby">    ]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="177">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="178">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="179">
          
          
          <code class="ruby">  def see_also</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="180">
          
          
          <code class="ruby">    [</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="181">
          
          
          <code class="ruby">      {</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="182">
          
          
          <code class="ruby">        &quot;id&quot; =&gt; &quot;https://collections.library.yale.edu/catalog/oai?verb=GetRecord&amp;metadataPrefix=oai_mods&amp;identifier=oai:collections.library.yale.edu:#{oid}&quot;,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="183">
          
          
          <code class="ruby">        &quot;type&quot; =&gt; &quot;Dataset&quot;,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="184">
          
          
          <code class="ruby">        &quot;format&quot; =&gt; &quot;application/mods+xml&quot;,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="185">
          
          
          <code class="ruby">        &quot;profile&quot; =&gt; &quot;http://www.loc.gov/mods/v3&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="186">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="187">
          
          
          <code class="ruby">    ]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="188">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="189">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="190">
          
          
          <code class="ruby">  def image_resource(child)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="191">
          
          
          <code class="ruby">    {</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="192">
          
          
          <code class="ruby">      &#39;id&#39; =&gt; image_url(child.oid),</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="193">
          
          
          <code class="ruby">      &#39;type&#39; =&gt; &quot;Image&quot;,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="194">
          
          
          <code class="ruby">      &#39;format&#39; =&gt; &quot;image/jpeg&quot;,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="195">
          
          
          <code class="ruby">      &#39;height&#39; =&gt; child.height,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="196">
          
          
          <code class="ruby">      &#39;width&#39; =&gt; child.width,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="197">
          
          
          <code class="ruby">      &#39;service&#39; =&gt; [{</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="198">
          
          
          <code class="ruby">        &#39;@id&#39; =&gt; image_service_url(child.oid),</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="199">
          
          
          <code class="ruby">        &#39;type&#39; =&gt; &#39;ImageService2&#39;,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="200">
          
          
          <code class="ruby">        &#39;profile&#39; =&gt; &#39;http://iiif.io/api/image/2/level2.json&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="201">
          
          
          <code class="ruby">      }]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="202">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="203">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="204">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="205">
          
          
          <code class="ruby">  def add_image_to_canvas(child, canvas)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="206">
          
          
          <code class="ruby">    annotation_page = {</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="207">
          
          
          <code class="ruby">      &quot;id&quot; =&gt; File.join(manifest_base_url.to_s, &quot;oid/#{oid}/canvas/#{child.oid}/page/1&quot;),</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="208">
          
          
          <code class="ruby">      &quot;type&quot; =&gt; &quot;AnnotationPage&quot;,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="209">
          
          
          <code class="ruby">      &quot;items&quot; =&gt; []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="210">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="211">
          
          
          <code class="ruby">    canvas[&quot;items&quot;] &lt;&lt; annotation_page</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="212">
          
          
          <code class="ruby">    image = {}</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="213">
          
          
          <code class="ruby">    image[&#39;id&#39;] = File.join(manifest_base_url.to_s, &quot;oid/#{oid}/canvas/#{child.oid}/image/1&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="214">
          
          
          <code class="ruby">    image[&#39;type&#39;] = &quot;Annotation&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="215">
          
          
          <code class="ruby">    image[&quot;motivation&quot;] = &quot;painting&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="216">
          
          
          <code class="ruby">    image[&quot;target&quot;] = File.join(manifest_base_url.to_s, &quot;oid/#{oid}/canvas/#{child.oid}&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="217">
          
          
          <code class="ruby">    image[&quot;body&quot;] = image_resource(child)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="218">
          
          
          <code class="ruby">    annotation_page[&quot;items&quot;] &lt;&lt; image</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="219">
          
          
          <code class="ruby">    canvas[&#39;thumbnail&#39;] = [image_resource(child)]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="220">
          
          
          <code class="ruby">    @manifest[&#39;thumbnail&#39;] = [image_resource(child)] if child_is_thumbnail?(child[:oid])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="221">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="222">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="223">
          
          
          <code class="ruby">  # rubocop:disable Metrics/AbcSize</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="224">
          
          
          <code class="ruby">  def add_canvases_to_manifest(items)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="225">
          
          
          <code class="ruby">    child_objects = parent_object.child_objects</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="226">
          
          
          <code class="ruby">    child_objects.map do |child, index|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="227">
          
          
          <code class="ruby">      canvas = {</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="228">
          
          
          <code class="ruby">        &quot;type&quot; =&gt; &quot;Canvas&quot;,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="229">
          
          
          <code class="ruby">        &quot;items&quot; =&gt; []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="230">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="231">
          
          
          <code class="ruby">      canvas[&#39;id&#39;] = File.join(manifest_base_url.to_s, &quot;oid/#{oid}/canvas/#{child.oid}&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="232">
          
          
          <code class="ruby">      canvas[&#39;label&#39;] = { &quot;none&quot; =&gt; [child.label || &#39;&#39;] }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="233">
          
          
          <code class="ruby">      add_image_to_canvas(child, canvas)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="234">
          
          
          <code class="ruby">      image_anno = canvas[&quot;items&quot;].first[&quot;items&quot;].first[&quot;body&quot;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="235">
          
          
          <code class="ruby">      canvas[&#39;height&#39;] = image_anno[&quot;height&quot;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="236">
          
          
          <code class="ruby">      canvas[&#39;width&#39;] = image_anno[&quot;width&quot;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="237">
          
          
          <code class="ruby">      canvas[&#39;behavior&#39;] = [child.viewing_hint] unless child.viewing_hint.nil? || child.viewing_hint.empty?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="238">
          
          
          <code class="ruby">      add_metadata_to_canvas(canvas, child)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="239">
          
          
          <code class="ruby">      @manifest[&quot;start&quot;] = { &#39;id&#39; =&gt; canvas[&#39;id&#39;], &#39;type&#39; =&gt; &#39;Canvas&#39; } if child_is_start_canvas? child.oid, index</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="240">
          
          
          <code class="ruby">      items &lt;&lt; canvas</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="241">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="242">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="243">
          
          
          <code class="ruby">  # rubocop:enable Metrics/AbcSize</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="244">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="245">
          
          
          <code class="ruby">  def add_metadata_to_canvas(canvas, child)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="246">
          
          
          <code class="ruby">    metadata_values = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="247">
          
          
          <code class="ruby">    metadata_values &lt;&lt;  metadata_pair(&#39;Image ID&#39;, child.oid.to_s) if child.oid</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="248">
          
          
          <code class="ruby">    metadata_values &lt;&lt;  metadata_pair(&#39;Image Label&#39;, child.label) if child.label</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="249">
          
          
          <code class="ruby">    metadata_values &lt;&lt;  metadata_pair(&#39;Image Caption&#39;, child.caption) if child.caption</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="250">
          
          
          <code class="ruby">    metadata_values &lt;&lt;  metadata_pair(&#39;Link to this Image&#39;, &quot;https://collections.library.yale.edu/catalog/#{@oid}?child_oid=#{child.oid}&quot;) if child.oid</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="251">
          
          
          <code class="ruby">    canvas[&#39;metadata&#39;] = metadata_values</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="252">
          
          
          <code class="ruby">    canvas</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="253">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="254">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="255">
          
          
          <code class="ruby">  def child_is_start_canvas?(child, index)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="256">
          
          
          <code class="ruby">    return true if index.eql? 0 # set the first child as start canvas</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="257">
          
          
          <code class="ruby">    return false unless child_is_thumbnail? child</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="258">
          
          
          <code class="ruby">    child_oids = @parent_object.child_objects.map { |child_cur| child_cur[:oid] }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="259">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="260">
          
          
          <code class="ruby">    child_oids.index(child) &lt; 10 # only set if the rep. child is one of the first 10</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="261">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="262">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="263">
          
          
          <code class="ruby">  def child_is_thumbnail?(child)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="264">
          
          
          <code class="ruby">    @parent_object.representative_child.oid.eql? child # checks if child is the rep</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="265">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="266">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="267">
          
          
          <code class="ruby">  def pairtree_path</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="268">
          
          
          <code class="ruby">    Partridge::Pairtree.oid_to_pairtree(oid)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="269">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="270">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="271">
          
          
          <code class="ruby">  def fetch</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="272">
          
          
          <code class="ruby">    S3Service.download(manifest_path)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="273">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="274">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="275">
          
          
          <code class="ruby">  def formatted_manifest</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="276">
          
          
          <code class="ruby">    manifest.to_json(pretty: true)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="277">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="278">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="279">
          
          
          <code class="ruby">  def save</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="280">
          
          
          <code class="ruby">    S3Service.upload_if_changed(manifest_path, formatted_manifest)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="281">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="282">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="283">
          
          
          <code class="ruby">  def manifest_path</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="284">
          
          
          <code class="ruby">    @manifest_path ||= &quot;manifests/#{pairtree_path}/#{oid}.json&quot; if pairtree_path &amp;&amp; oid</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="285">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="286">
          
          
          <code class="ruby">end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="287">
          
          
          <code class="ruby"># rubocop:enable Metrics/ClassLength</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="32ad6ffafa6b2170e7cf39435bfbdda9738302e4">
  <div class="header">
    <h3>app/models/ingest_event.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>2</b> relevant lines. 
      <span class="green"><b>2</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># frozen_string_literal: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">class IngestEvent &lt; ApplicationRecord</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :batch_connection</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="9bac5f8e6b54f78003f46c1bee2737dd3822c9e7">
  <div class="header">
    <h3>app/models/metadata_source.rb</h3>
    <h4><span class="red">28.26 %</span> covered</h4>
    <div>
      <b>46</b> relevant lines. 
      <span class="green"><b>13</b> lines covered</span> and
      <span class="red"><b>33</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># frozen_string_literal: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">class MetadataSource &lt; ApplicationRecord</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :parent_objects, foreign_key: &quot;authoritative_metadata_source_id&quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">  class MetadataCloudServerError &lt; StandardError</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">    def message</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="7">
          
          
          <code class="ruby">      &quot;MetadataCloud is responding with 5XX error&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">  class MetadataCloudVersionError &lt; StandardError</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>
          
          <code class="ruby">    def message</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby">      &quot;MetadataCloud is not responding to requests for version: #{MetadataSource.metadata_cloud_version}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="17">
          <span class="hits">1</span>
          
          <code class="ruby">  def fetch_record(parent_object)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">    # The environment value has to be set as a string, real booleans do not work</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="19">
          
          
          <code class="ruby">    raw_metadata = if ENV[&quot;VPN&quot;] == &quot;true&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="20">
          
          
          <code class="ruby">                     fetch_record_on_vpn(parent_object)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">                   else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="22">
          
          
          <code class="ruby">                     s3_path = &quot;#{metadata_cloud_name}/#{file_name(parent_object)}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="23">
          
          
          <code class="ruby">                     r = S3Service.download(s3_path)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="24">
          
          
          <code class="ruby">                     parent_object.processing_event(&quot;S3 did not return json for #{s3_path}&quot;, &quot;failed&quot;) unless r.present?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="25">
          
          
          <code class="ruby">                     r</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">                   end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="27">
          
          
          <code class="ruby">    return unless raw_metadata</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="28">
          
          
          <code class="ruby">    JSON.parse(raw_metadata)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="31">
          <span class="hits">1</span>
          
          <code class="ruby">  def fetch_record_on_vpn(parent_object)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="32">
          
          
          <code class="ruby">    mc_url = parent_object.send(url_type)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="33">
          
          
          <code class="ruby">    full_response = mc_get(mc_url)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="34">
          
          
          <code class="ruby">    case full_response.status</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">    when 200</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="36">
          
          
          <code class="ruby">      response_text = full_response.body.to_str</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="37">
          
          
          <code class="ruby">      S3Service.upload_if_changed(&quot;#{metadata_cloud_name}/#{file_name(parent_object)}&quot;, response_text)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="38">
          
          
          <code class="ruby">      response_text</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">    when 400...500</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="40">
          
          
          <code class="ruby">      parent_object.processing_event(&quot;Metadata Cloud did not return json. Response was #{full_response.status.code} - #{full_response.body}&quot;, &quot;failed&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="41">
          
          
          <code class="ruby">      raise MetadataSource::MetadataCloudVersionError if JSON.parse(full_response.body)[&quot;ex&quot;].include?(&quot;Unable to find retriever&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="42">
          
          
          <code class="ruby">      false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby">    when 500...600</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="44">
          
          
          <code class="ruby">      parent_object.processing_event(&quot;Metadata Cloud did not return json. Response was #{full_response.status.code} - #{full_response.body}&quot;, &quot;failed&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="45">
          
          
          <code class="ruby">      raise MetadataSource::MetadataCloudServerError</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="47">
          
          
          <code class="ruby">      parent_object.processing_event(&quot;Metadata Cloud did not return json. Response was #{full_response.status.code} - #{full_response.body}&quot;, &quot;failed&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="48">
          
          
          <code class="ruby">      false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="52">
          <span class="hits">1</span>
          
          <code class="ruby">  def file_name(parent_object)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="53">
          
          
          <code class="ruby">    &quot;#{file_prefix}#{parent_object.oid}.json&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="56">
          <span class="hits">1</span>
          
          <code class="ruby">  def url_type</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="57">
          
          
          <code class="ruby">    case metadata_cloud_name</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby">    when &quot;ladybird&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="59">
          
          
          <code class="ruby">      &quot;ladybird_cloud_url&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby">    when &quot;ils&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="61">
          
          
          <code class="ruby">      &quot;voyager_cloud_url&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby">    when &quot;aspace&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="63">
          
          
          <code class="ruby">      &quot;aspace_cloud_url&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="67">
          <span class="hits">1</span>
          
          <code class="ruby">  def mc_get(mc_url)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="68">
          
          
          <code class="ruby">    metadata_cloud_username = ENV[&quot;MC_USER&quot;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="69">
          
          
          <code class="ruby">    metadata_cloud_password = ENV[&quot;MC_PW&quot;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="70">
          
          
          <code class="ruby">    HTTP.basic_auth(user: metadata_cloud_username, pass: metadata_cloud_password).get(mc_url)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="72">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby">  # Hard coding the metadata cloud version because it is directly correlated with the solr indexing code</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="74">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.metadata_cloud_version</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="75">
          
          
          <code class="ruby">    &quot;1.0.1&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="76">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="78">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.metadata_cloud_host</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="79">
          
          
          <code class="ruby">    ENV[&#39;METADATA_CLOUD_HOST&#39;].present? ? ENV[&#39;METADATA_CLOUD_HOST&#39;] : &#39;metadata-api-uat.library.yale.edu&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="81">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="74605905f1f4acf88e5dba3bfbe0f6aa7d8a3ce6">
  <div class="header">
    <h3>app/models/mets_document.rb</h3>
    <h4><span class="red">0.0 %</span> covered</h4>
    <div>
      <b>167</b> relevant lines. 
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>167</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># frozen_string_literal: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"># rubocop:disable Metrics/ClassLength</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="3">
          
          
          <code class="ruby">class MetsDocument</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="4">
          
          
          <code class="ruby">  include MetadataCloudUrlParsable</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="5">
          
          
          <code class="ruby">  attr_reader :source_xml</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">  # Takes a path to the mets file</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="7">
          
          
          <code class="ruby">  def initialize(mets_xml)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="8">
          
          
          <code class="ruby">    @source_xml = mets_xml</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="9">
          
          
          <code class="ruby">    @mets = Nokogiri::XML(@source_xml)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">  def oid</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby">    @mets.xpath(&quot;//mods:recordIdentifier[@source=&#39;gbv-ppn&#39;]&quot;).inner_text</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="14">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="16">
          
          
          <code class="ruby">  def parent_uuid</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="17">
          
          
          <code class="ruby">    file_group = @mets.xpath(&quot;/mets:mets/mets:fileSec/mets:fileGrp&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">    file_group.xpath(&quot;@ID&quot;).first&amp;.inner_text</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="19">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="21">
          
          
          <code class="ruby">  def metadata_source_path</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="22">
          
          
          <code class="ruby">    @mets.xpath(&quot;//mods:identifier&quot;).inner_text</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="23">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="25">
          
          
          <code class="ruby">  def visibility</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="26">
          
          
          <code class="ruby">    @mets.xpath(&quot;//mods:accessCondition[@type=&#39;restriction on access&#39;]&quot;).inner_text</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="27">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="29">
          
          
          <code class="ruby">  def extent_of_dig</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="30">
          
          
          <code class="ruby">    eodig = @mets.xpath(&quot;//mods:part&quot;).first&amp;.inner_text</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="31">
          
          
          <code class="ruby">    unless eodig.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="32">
          
          
          <code class="ruby">      return nil unless eodig.include?(&quot;digitized&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="33">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="34">
          
          
          <code class="ruby">    eodig</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="35">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="37">
          
          
          <code class="ruby">  def dig_note</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="38">
          
          
          <code class="ruby">    dig_note = @mets.xpath(&quot;//mods:note[@type=&#39;admin&#39;]&quot;).inner_text</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="39">
          
          
          <code class="ruby">    return nil unless dig_note.present?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="40">
          
          
          <code class="ruby">    dig_note</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="41">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="43">
          
          
          <code class="ruby">  def rights_statement</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="44">
          
          
          <code class="ruby">    @mets.xpath(&quot;//mods:accessCondition[@type=&#39;use and reproduction&#39;]&quot;).inner_text</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="45">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="47">
          
          
          <code class="ruby">  def viewing_direction</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="48">
          
          
          <code class="ruby">    return nil unless @mets.collect_namespaces.keys.include?(&quot;xmlns:intranda&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="49">
          
          
          <code class="ruby">    @mets.xpath(&quot;//mods:extension/intranda:intranda/intranda:ViewingDirection&quot;).inner_text</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="50">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="52">
          
          
          <code class="ruby">  def viewing_hint</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="53">
          
          
          <code class="ruby">    return nil unless @mets.collect_namespaces.include?(&quot;xmlns:intranda&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="54">
          
          
          <code class="ruby">    @mets.xpath(&quot;//mods:extension/intranda:intranda/intranda:ViewingHint&quot;).inner_text</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="55">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="57">
          
          
          <code class="ruby">  def thumbnail_image</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="58">
          
          
          <code class="ruby">    child_img = combined.find do |child|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="59">
          
          
          <code class="ruby">      child[:thumbnail_flag]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="60">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="61">
          
          
          <code class="ruby">    child_img&amp;.[](:oid)&amp;.to_i</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="62">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby">  # rubocop:disable Metrics/CyclomaticComplexity,Metrics/PerceivedComplexity</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="65">
          
          
          <code class="ruby">  def valid_mets?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="66">
          
          
          <code class="ruby">    raise &quot;no mets xml&quot; unless @mets.xml?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="67">
          
          
          <code class="ruby">    raise &quot;no mets namespace in mets file&quot; unless @mets.collect_namespaces.include?(&quot;xmlns:mets&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="68">
          
          
          <code class="ruby">    raise &quot;no mets file in the mets xml&quot; unless @mets.xpath(&quot;//mets:file&quot;).count &gt;= 1</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="69">
          
          
          <code class="ruby">    raise &quot;no right statement found in the mets xml&quot; if rights_statement.blank?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="70">
          
          
          <code class="ruby">    raise &quot;not valid metadata source&quot; unless valid_metadata_source_path?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="71">
          
          
          <code class="ruby">    raise &quot;no image path&quot; if fixture_images_in_production?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="72">
          
          
          <code class="ruby">    raise &quot;no admin set in mets xml&quot; unless admin_set.present?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="73">
          
          
          <code class="ruby">    all_images_have_checksum?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="74">
          
          
          <code class="ruby">    true</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="75">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="76">
          
          
          <code class="ruby">  # rubocop:enable Metrics/CyclomaticComplexity,Metrics/PerceivedComplexity</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby">  # ensure we don&#39;t accidentally upload tiny fixture images in production</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="79">
          
          
          <code class="ruby">  def fixture_images_in_production?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="80">
          
          
          <code class="ruby">    production_environment = ENV.fetch(&quot;RAILS_ENV&quot;) != &quot;test&quot; &amp;&amp; ENV.fetch(&quot;RAILS_ENV&quot;) != &quot;development&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="81">
          
          
          <code class="ruby">    has_fixtures = files.any? { |file| file[:mets_access_master_path].include?(&quot;spec/fixtures&quot;) }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="82">
          
          
          <code class="ruby">    production_environment &amp;&amp; has_fixtures</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="83">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="84">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="85">
          
          
          <code class="ruby">  def all_images_present?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="86">
          
          
          <code class="ruby">    files.all? { |file| File.exist?(file[:mets_access_master_path]) }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="87">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="88">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="89">
          
          
          <code class="ruby">  def all_images_have_checksum?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="90">
          
          
          <code class="ruby">    files.each_with_index do |file, index|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="91">
          
          
          <code class="ruby">      raise &quot;#{file[:checksum]}, index: #{index} invalid checksum, check the checksum in mets xml&quot; unless file[:checksum] =~ /^([a-f0-9]{40})$/</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="92">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="93">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="94">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="95">
          
          
          <code class="ruby">  # Combines the physical info and file info for a given image</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="96">
          
          
          <code class="ruby">  def combined</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="97">
          
          
          <code class="ruby">    zipped = add_nil_caption.nil? ? files.zip(physical_divs) : files.zip(add_nil_caption)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="98">
          
          
          <code class="ruby">    zipped.map { |file, physical_div| file.merge(physical_div) }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="99">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="100">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="101">
          
          
          <code class="ruby">  # merge into physical divs</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="102">
          
          
          <code class="ruby">  def add_nil_caption</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="103">
          
          
          <code class="ruby">    if combined_logical_link_hash.nil? == true</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="104">
          
          
          <code class="ruby">      nil</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="105">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="106">
          
          
          <code class="ruby">      combined_logical_link_physical_hash.each do |i|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="107">
          
          
          <code class="ruby">        i[:caption] = i[:caption].nil? ? nil : i[:caption]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="108">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="109">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="110">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="111">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="112">
          
          
          <code class="ruby">  def combined_logical_link_physical_hash</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="113">
          
          
          <code class="ruby">    index = combined_logical_link_hash.group_by { |entry| entry[:physical_id] } unless combined_logical_link_hash.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="114">
          
          
          <code class="ruby">    physical_divs.map { |entry| (index[entry[:physical_id]] || []).reduce(entry, :merge) } unless combined_logical_link_hash.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="115">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="116">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="117">
          
          
          <code class="ruby">  # combine logic_link with logic divs</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="118">
          
          
          <code class="ruby">  def combined_logical_link_hash</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="119">
          
          
          <code class="ruby">    index = logical_divs.group_by { |entry| entry[:logical_id] } unless logical_divs.empty?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="120">
          
          
          <code class="ruby">    link_value_hash.map { |entry| (index[entry[:logical_id]] || []).reduce(entry, :merge) } unless logical_divs.empty?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="121">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="122">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="123">
          
          
          <code class="ruby">  def physical_divs</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="124">
          
          
          <code class="ruby">    @mets.xpath(&quot;/mets:mets/mets:structMap[@TYPE=&#39;PHYSICAL&#39;]/mets:div&quot; \</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="125">
          
          
          <code class="ruby">                &quot;/mets:div&quot;).map do |p|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="126">
          
          
          <code class="ruby">      physical_info(p)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="127">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="128">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="129">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="130">
          
          
          <code class="ruby">  def logical_divs</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="131">
          
          
          <code class="ruby">    @mets.xpath(&quot;/mets:mets/mets:structMap[@TYPE=&#39;LOGICAL&#39;]/mets:div&quot; \</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="132">
          
          
          <code class="ruby">                &quot;/mets:div&quot;).map do |l|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="133">
          
          
          <code class="ruby">      logical_info(l)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="134">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="135">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="136">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="137">
          
          
          <code class="ruby">  def physical_info(physical_div)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="138">
          
          
          <code class="ruby">    {</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="139">
          
          
          <code class="ruby">      oid: physical_div.xpath(&#39;@CONTENTIDS&#39;).inner_text, # oid for child object</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="140">
          
          
          <code class="ruby">      label: normalize_label(physical_div),</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="141">
          
          
          <code class="ruby">      order: physical_div.xpath(&quot;@ORDER&quot;).inner_text,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="142">
          
          
          <code class="ruby">      parent_object_oid: oid,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="143">
          
          
          <code class="ruby">      child_uuid: physical_div.xpath(&quot;mets:fptr/@FILEID&quot;).first&amp;.text, # uuid for child object</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="144">
          
          
          <code class="ruby">      physical_id: physical_div.xpath(&quot;@ID&quot;).inner_text</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="145">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="146">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="147">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="148">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="149">
          
          
          <code class="ruby">  def logical_info(logical_div)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="150">
          
          
          <code class="ruby">    {</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="151">
          
          
          <code class="ruby">      caption: caption_info(logical_div), # caption for child object</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="152">
          
          
          <code class="ruby">      logical_id: caption_logical_id(logical_div)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="153">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="154">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="155">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="156">
          
          
          <code class="ruby">  def caption_info(logical_div)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="157">
          
          
          <code class="ruby">    return nil if logical_div.xpath(&quot;@TYPE&quot;).inner_text != &quot;caption&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="158">
          
          
          <code class="ruby">    logical_div.xpath(&quot;@LABEL&quot;).inner_text</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="159">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="160">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="161">
          
          
          <code class="ruby">  def caption_logical_id(logical_div)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="162">
          
          
          <code class="ruby">    return nil if logical_div.xpath(&quot;@TYPE&quot;).inner_text != &quot;caption&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="163">
          
          
          <code class="ruby">    logical_div.xpath(&quot;@ID&quot;).inner_text</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="164">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="165">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="166">
          
          
          <code class="ruby">  def parent_logical_id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="167">
          
          
          <code class="ruby">    parent_logical = @mets.xpath(&quot;/mets:mets/mets:structMap[@TYPE=&#39;LOGICAL&#39;]/mets:div&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="168">
          
          
          <code class="ruby">    parent_logical.xpath(&quot;@ID&quot;).inner_text</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="169">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="170">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="171">
          
          
          <code class="ruby">  def link_value_hash</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="172">
          
          
          <code class="ruby">    link_array = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="173">
          
          
          <code class="ruby">    link_value = @mets.xpath(&quot;/mets:mets/mets:structLink/mets:smLink&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="174">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="175">
          
          
          <code class="ruby">    link_value.each do |pl|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="176">
          
          
          <code class="ruby">      link_array.push pl.values unless pl.values[1] == parent_logical_id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="177">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="178">
          
          
          <code class="ruby">    link_array</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="179">
          
          
          <code class="ruby">      .map { |(physical_id, logical_id)| { physical_id: physical_id, logical_id: logical_id } }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="180">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="181">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="182">
          
          
          <code class="ruby">  def admin_set_key</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="183">
          
          
          <code class="ruby">    @mets.xpath(&quot;//mods:note[@type=&#39;ownership&#39; and @displayLabel=&#39;Yale Collection Owner&#39;]&quot;)&amp;.inner_text</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="184">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="185">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="186">
          
          
          <code class="ruby">  def admin_set</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="187">
          
          
          <code class="ruby">    @admin_set ||= AdminSet.find_by(key: admin_set_key)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="188">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="189">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="190">
          
          
          <code class="ruby">  def normalize_label(physical_div)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="191">
          
          
          <code class="ruby">    return nil if physical_div.xpath(&quot;@ORDERLABEL&quot;).inner_text == &quot; - &quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="192">
          
          
          <code class="ruby">    physical_div.xpath(&quot;@ORDERLABEL&quot;).inner_text</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="193">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="194">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="195">
          
          
          <code class="ruby">  def files</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="196">
          
          
          <code class="ruby">    @mets.xpath(&quot;/mets:mets/mets:fileSec/mets:fileGrp[@USE=&#39;PRESENTATION&#39;]/mets:file&quot;).map do |f|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="197">
          
          
          <code class="ruby">      file_info(f)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="198">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="199">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="200">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="201">
          
          
          <code class="ruby">  def file_info(file)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="202">
          
          
          <code class="ruby">    thumbnail_flag = file.xpath(&#39;@USE&#39;).inner_text == &quot;banner&quot; ? true : false</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="203">
          
          
          <code class="ruby">    {</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="204">
          
          
          <code class="ruby">      thumbnail_flag: thumbnail_flag,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="205">
          
          
          <code class="ruby">      checksum: file.xpath(&#39;@CHECKSUM&#39;).inner_text,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="206">
          
          
          <code class="ruby">      mets_access_master_path: file.xpath(&#39;mets:FLocat/@xlink:href&#39;).to_s.gsub(/file:\/\//, &#39;&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="207">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="208">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="209">
          
          
          <code class="ruby">  # rubocop:enable Metrics/ClassLength</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="210">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="d21dccce01f4efa2b8b0c4abad7be653aff59c1c">
  <div class="header">
    <h3>app/models/parent_object.rb</h3>
    <h4><span class="red">32.92 %</span> covered</h4>
    <div>
      <b>322</b> relevant lines. 
      <span class="green"><b>106</b> lines covered</span> and
      <span class="red"><b>216</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># frozen_string_literal: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"># A parent object is the unit of discovery (what is represented as a single record in Blacklight).</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"># It is synonymous with a parent oid in Ladybird.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;fileutils&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">class ParentObject &lt; ApplicationRecord # rubocop:disable Metrics/ClassLength</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">  has_paper_trail</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">  include JsonFile</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">  include SolrIndexable</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="10">
          <span class="hits">1</span>
          
          <code class="ruby">  include Statable</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">  include PdfRepresentable</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>
          
          <code class="ruby">  include Delayable</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">  include DigitalObjectManagement</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="14">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :dependent_objects, dependent: :delete_all</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="15">
          <span class="hits">5</span>
          
          <code class="ruby">  has_many :child_objects, -&gt; { order(&#39;&quot;order&quot; ASC, oid ASC&#39;) }, primary_key: &#39;oid&#39;, foreign_key: &#39;parent_object_oid&#39;, dependent: :delete_all</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :batch_connections, as: :connectable</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="17">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :batch_processes, through: :batch_connections</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="18">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :authoritative_metadata_source, class_name: &quot;MetadataSource&quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="19">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :admin_set</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="20">
          <span class="hits">1</span>
          
          <code class="ruby">  has_one :digital_object_json</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="21">
          <span class="hits">1</span>
          
          <code class="ruby">  attr_accessor :metadata_update</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="22">
          <span class="hits">1</span>
          
          <code class="ruby">  attr_accessor :current_batch_process</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="23">
          <span class="hits">1</span>
          
          <code class="ruby">  attr_accessor :current_batch_connection</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="24">
          <span class="hits">1</span>
          
          <code class="ruby">  self.primary_key = &#39;oid&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="25">
          <span class="hits">1</span>
          
          <code class="ruby">  after_save :setup_metadata_job</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="26">
          <span class="hits">1</span>
          
          <code class="ruby">  before_update :check_for_redirect</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="27">
          <span class="hits">1</span>
          
          <code class="ruby">  after_update :digital_object_check</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">  # after_update :solr_index_job # we index from the fetch job on create</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="29">
          <span class="hits">1</span>
          
          <code class="ruby">  after_destroy :solr_delete</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="30">
          <span class="hits">1</span>
          
          <code class="ruby">  after_destroy :note_deletion</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="31">
          <span class="hits">1</span>
          
          <code class="ruby">  after_destroy :delayed_jobs_deletion</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="32">
          <span class="hits">1</span>
          
          <code class="ruby">  after_destroy :pdf_deletion</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="33">
          <span class="hits">1</span>
          
          <code class="ruby">  after_destroy :digital_object_delete</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="34">
          <span class="hits">1</span>
          
          <code class="ruby">  paginates_per 50</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">  # rubocop:disable Metrics/LineLength</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="36">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :redirect_to, format: { with: /\A((http|https):\/\/)?(collections-test.|collections-uat.|collections.)?library.yale.edu\/catalog\//, message: &quot; in incorrect format. Please enter DCS url https://collections.library.yale.edu/catalog/123&quot;, allow_blank: true }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">  # rubocop:enable Metrics/LineLength</code>
        </li>
      
        <li class="covered" data-hits="13" data-linenumber="38">
          <span class="hits">13</span>
          
          <code class="ruby">  validates :preservica_uri, presence: true, format: { with: %r{\A/}, message: &quot; in incorrect format. URI must start with a /&quot; }, if: proc { digital_object_source == &quot;Preservica&quot; }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="40">
          <span class="hits">1</span>
          
          <code class="ruby">  def check_for_redirect</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="41">
          
          
          <code class="ruby">    minify if redirect_to.present?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="44">
          <span class="hits">1</span>
          
          <code class="ruby">  def minify</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="45">
          
          
          <code class="ruby">    minimal_attr = [&#39;oid&#39;, &#39;use_ladybird&#39;, &#39;generate_manifest&#39;, &#39;from_mets&#39;, &#39;admin_set_id&#39;, &#39;authoritative_metadata_source_id&#39;, &#39;created_at&#39;, &#39;updated_at&#39;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="47">
          
          
          <code class="ruby">    attributes.keys.each do |key|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="48">
          
          
          <code class="ruby">      if key == &#39;visibility&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="49">
          
          
          <code class="ruby">        self[key.to_sym] = &quot;Redirect&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="50">
          
          
          <code class="ruby">      elsif key == &#39;redirect_to&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="51">
          
          
          <code class="ruby">        self[key.to_sym] = redirect_to</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="53">
          
          
          <code class="ruby">        self[key.to_sym] = nil unless minimal_attr.include? key</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby">    # clear dependent objects</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="58">
          
          
          <code class="ruby">    DependentObject.delete(dependent_objects)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="61">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.visibilities</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="62">
          <span class="hits">1</span>
          
          <code class="ruby">    [&#39;Private&#39;, &#39;Public&#39;, &#39;Redirect&#39;, &#39;Yale Community Only&#39;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby">  # Options from iiif presentation api 2.1 - see https://iiif.io/api/presentation/2.1/#viewingdirection</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="66">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.viewing_directions</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="67">
          
          
          <code class="ruby">    [nil, &quot;left-to-right&quot;, &quot;right-to-left&quot;, &quot;top-to-bottom&quot;, &quot;bottom-to-top&quot;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby">  # Options from iiif presentation api 2.1 - see https://iiif.io/api/presentation/2.1/#viewinghint</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="71">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.viewing_hints</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="72">
          
          
          <code class="ruby">    [nil, &quot;individuals&quot;, &quot;paged&quot;, &quot;continuous&quot;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="75">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.extent_of_digitizations</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="76">
          
          
          <code class="ruby">    [nil, &quot;Completely digitized&quot;, &quot;Partially digitized&quot;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="79">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :visibility, inclusion: { in: visibilities, allow_nil: true,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby">                                      message: &quot;%{value} is not a valid value&quot; }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="81">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="82">
          <span class="hits">1</span>
          
          <code class="ruby">  def initialize(attributes = nil)</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="83">
          <span class="hits">6</span>
          
          <code class="ruby">    super</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="84">
          <span class="hits">6</span>
          
          <code class="ruby">    self.use_ladybird = true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="85">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="86">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="87">
          <span class="hits">1</span>
          
          <code class="ruby">  def from_upstream_for_the_first_time?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="88">
          
          
          <code class="ruby">    from_ladybird_for_the_first_time? || from_mets_for_the_first_time? || (from_preservica_for_the_first_time? &amp;&amp; digital_object_source == &quot;Preservica&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="89">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="90">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="91">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.cannot_reindex</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="92">
          
          
          <code class="ruby">    return true unless Delayable.solr_reindex_jobs.empty?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="93">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="94">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="95">
          
          
          <code class="ruby">  # Returns true if last_ladybird_update has changed from nil to some value, indicating initial ladybird fetch</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="96">
          <span class="hits">1</span>
          
          <code class="ruby">  def from_ladybird_for_the_first_time?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="97">
          
          
          <code class="ruby">    return true if changes[&quot;last_ladybird_update&quot;] &amp;&amp;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="98">
          
          
          <code class="ruby">                   !changes[&quot;last_ladybird_update&quot;][0] &amp;&amp;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="99">
          
          
          <code class="ruby">                   changes[&quot;last_ladybird_update&quot;][1]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="100">
          
          
          <code class="ruby">    false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="101">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="102">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="103">
          
          
          <code class="ruby">  # Returns true if last_mets_update has changed from nil to some value,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="104">
          
          
          <code class="ruby">  # indicating assigning values from the mets document</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="105">
          <span class="hits">1</span>
          
          <code class="ruby">  def from_mets_for_the_first_time?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="106">
          
          
          <code class="ruby">    return true if last_mets_update_before_last_save.nil? &amp;&amp; !last_mets_update.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="107">
          
          
          <code class="ruby">    false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="108">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="109">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="110">
          
          
          <code class="ruby">  # Returns true if last_preservica_update has changed from nil to some value,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="111">
          
          
          <code class="ruby">  # indicating assigning values from the last preservica api call</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="112">
          <span class="hits">1</span>
          
          <code class="ruby">  def from_preservica_for_the_first_time?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="113">
          
          
          <code class="ruby">    last_preservica_update.nil?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="114">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="115">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="116">
          <span class="hits">1</span>
          
          <code class="ruby">  def start_states</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="117">
          
          
          <code class="ruby">    [&#39;processing-queued&#39;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="118">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="119">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="120">
          <span class="hits">1</span>
          
          <code class="ruby">  def finished_states</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="121">
          <span class="hits">3</span>
          
          <code class="ruby">    [&#39;solr-indexed&#39;, &#39;pdf-generated&#39;, &#39;ptiffs-recreated&#39;, &#39;update-complete&#39;, &#39;deleted&#39;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="122">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="123">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="124">
          
          
          <code class="ruby">  # Note - the upsert_all method skips ActiveRecord callbacks, and is entirely</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="125">
          
          
          <code class="ruby">  # database driven. This also makes object creation much faster.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="126">
          
          
          <code class="ruby">  # rubocop:disable Metrics/PerceivedComplexity</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="127">
          <span class="hits">1</span>
          
          <code class="ruby">  def create_child_records</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="128">
          
          
          <code class="ruby">    if from_mets</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="129">
          
          
          <code class="ruby">      upsert_child_objects(array_of_child_hashes_from_mets)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="130">
          
          
          <code class="ruby">      upsert_preservica_ingest_child_objects(array_preservica_hashes_from_mets) unless array_preservica_hashes_from_mets.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="131">
          
          
          <code class="ruby">    elsif digital_object_source == &quot;Preservica&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="132">
          
          
          <code class="ruby">      child_hashes = array_of_child_hashes_from_preservica # only call array_of_child_hashes_from_preservica once since it causes all images to be downloaded</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="133">
          
          
          <code class="ruby">      if child_hashes.present?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="134">
          
          
          <code class="ruby">        valid_child_hashes = validate_child_hashes(child_hashes)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="135">
          
          
          <code class="ruby">        upsert_child_objects(valid_child_hashes)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="136">
          
          
          <code class="ruby">        self.last_preservica_update = Time.current</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="137">
          
          
          <code class="ruby">        save!</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="138">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="139">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="140">
          
          
          <code class="ruby">      return unless ladybird_json</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="141">
          
          
          <code class="ruby">      return self.child_object_count = 0 if ladybird_json[&quot;children&quot;].empty? &amp;&amp; parent_model != &#39;simple&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="142">
          
          
          <code class="ruby">      upsert_child_objects(array_of_child_hashes)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="143">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="144">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="145">
          
          
          <code class="ruby">    self.child_object_count = child_objects.size</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="146">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="147">
          
          
          <code class="ruby">  # rubocop:enable Metrics/PerceivedComplexity</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="148">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="149">
          
          
          <code class="ruby">  # rubocop:disable Metrics/LineLength</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="150">
          <span class="hits">1</span>
          
          <code class="ruby">  def validate_child_hashes(child_hashes)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="151">
          
          
          <code class="ruby">    # if not found locally add the image</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="152">
          
          
          <code class="ruby">    preservica_co_uris = child_hashes.pluck(:preservica_content_object_uri)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="153">
          
          
          <code class="ruby">    preservica_co_uris.each do |uri|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="154">
          
          
          <code class="ruby">      # check if exists</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="155">
          
          
          <code class="ruby">      co = ChildObject.find_by(preservica_content_object_uri: uri)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="156">
          
          
          <code class="ruby">      next if co.nil?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="157">
          
          
          <code class="ruby">      # if it does remove it from the child hash</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="158">
          
          
          <code class="ruby">      child_hashes.delete_if { |h| h[:preservica_content_object_uri] == co.preservica_content_object_uri &amp;&amp; h[:preservica_generation_uri] == co.preservica_generation_uri &amp;&amp; h[:preservica_bitstream_uri] == co.preservica_bitstream_uri }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="159">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="160">
          
          
          <code class="ruby">    child_hashes</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="161">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="162">
          
          
          <code class="ruby">  # rubocop:enable Metrics/LineLength</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="163">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="164">
          <span class="hits">1</span>
          
          <code class="ruby">  def upsert_child_objects(child_objects_hash)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="165">
          
          
          <code class="ruby">    raise &quot;One or more of the child objects exists, Unable to create children&quot; if ChildObject.where(oid: child_objects_hash.map { |co| co[:oid] }).exists?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="166">
          
          
          <code class="ruby">    ChildObject.insert_all(child_objects_hash)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="167">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="168">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="169">
          
          
          <code class="ruby">  # rubocop:disable Metrics/AbcSize</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="170">
          
          
          <code class="ruby">  # rubocop:disable Metrics/MethodLength</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="171">
          <span class="hits">1</span>
          
          <code class="ruby">  def array_of_child_hashes_from_preservica</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="172">
          
          
          <code class="ruby">    PreservicaImageService.new(preservica_uri, admin_set.key).image_list(preservica_representation_name).map.with_index(1) do |child_hash, index|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="173">
          
          
          <code class="ruby">      co_oid = OidMinterService.generate_oids(1)[0]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="174">
          
          
          <code class="ruby">      preservica_copy_to_access(child_hash, co_oid)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="175">
          
          
          <code class="ruby">      child_hash.delete(:bitstream)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="176">
          
          
          <code class="ruby">      child_hash[:oid] = co_oid</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="177">
          
          
          <code class="ruby">      child_hash[:parent_object_oid] = oid</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="178">
          
          
          <code class="ruby">      child_hash[:order] = index</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="179">
          
          
          <code class="ruby">      child_hash</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="180">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="181">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="182">
          
          
          <code class="ruby">  # rubocop:enable Metrics/AbcSize</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="183">
          
          
          <code class="ruby">  # rubocop:enable Metrics/MethodLength</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="184">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="185">
          <span class="hits">1</span>
          
          <code class="ruby">  def preservica_copy_to_access(child_hash, co_oid)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="186">
          
          
          <code class="ruby">    pairtree_path = Partridge::Pairtree.oid_to_pairtree(co_oid)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="187">
          
          
          <code class="ruby">    image_mount = ENV[&#39;ACCESS_MASTER_MOUNT&#39;] || &quot;data&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="188">
          
          
          <code class="ruby">    directory = format(&quot;%02d&quot;, pairtree_path.first)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="189">
          
          
          <code class="ruby">    FileUtils.mkdir_p(File.join(image_mount, directory, pairtree_path))</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="190">
          
          
          <code class="ruby">    access_master_path = File.join(image_mount, directory, pairtree_path, &quot;#{co_oid}.tif&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="191">
          
          
          <code class="ruby">    child_hash[:bitstream].download_to_file(access_master_path)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="192">
          
          
          <code class="ruby">  rescue StandardError =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="193">
          
          
          <code class="ruby">    processing_event(e.to_s, &quot;failed&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="194">
          
          
          <code class="ruby">    raise e.to_s</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="195">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="196">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="197">
          <span class="hits">1</span>
          
          <code class="ruby">  def upsert_preservica_ingest_child_objects(preservica_ingest_hash)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="198">
          
          
          <code class="ruby">    PreservicaIngest.insert_all(preservica_ingest_hash)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="199">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="200">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="201">
          <span class="hits">1</span>
          
          <code class="ruby">  def sync_from_preservica(local_children_hash, preservica_children_hash)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="202">
          
          
          <code class="ruby">    # iterate through local hashes and remove any children no longer found on preservica</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="203">
          
          
          <code class="ruby">    local_children_hash.each_value do |value|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="204">
          
          
          <code class="ruby">      co = ChildObject.find_by(order: value[:order])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="205">
          
          
          <code class="ruby">      co.destroy unless found_in_preservica(value[:content_uri], preservica_children_hash)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="206">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="207">
          
          
          <code class="ruby">    # iterate through preservica and update when local version found</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="208">
          
          
          <code class="ruby">    preservica_children_hash.each_value do |value|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="209">
          
          
          <code class="ruby">      co = ChildObject.find_by(preservica_content_object_uri: value[:content_uri])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="210">
          
          
          <code class="ruby">      next if co.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="211">
          
          
          <code class="ruby">      co.order = value[:order]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="212">
          
          
          <code class="ruby">      co.preservica_content_object_uri = value[:content_uri]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="213">
          
          
          <code class="ruby">      co.preservica_generation_uri = value[:generation_uri]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="214">
          
          
          <code class="ruby">      co.preservica_bitstream_uri = value[:bitstream_uri]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="215">
          
          
          <code class="ruby">      co.save</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="216">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="217">
          
          
          <code class="ruby">    # create child records for any new items in preservica</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="218">
          
          
          <code class="ruby">    create_child_records</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="219">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="220">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="221">
          <span class="hits">1</span>
          
          <code class="ruby">  def found_in_preservica(local_preservica_content_object_uri, preservica_children_hash)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="222">
          
          
          <code class="ruby">    preservica_children_hash.each_value do |value|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="223">
          
          
          <code class="ruby">      return true if value[:content_uri] == local_preservica_content_object_uri</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="224">
          
          
          <code class="ruby">      return false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="225">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="226">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="227">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="228">
          <span class="hits">1</span>
          
          <code class="ruby">  def array_of_child_hashes_from_mets</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="229">
          
          
          <code class="ruby">    return unless current_batch_process&amp;.mets_doc</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="230">
          
          
          <code class="ruby">    current_batch_process.mets_doc.combined.map { |child_hash| child_hash.select { |k| k != :thumbnail_flag &amp;&amp; k != :child_uuid &amp;&amp; k != :physical_id &amp;&amp; k != :logical_id } }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="231">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="232">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="233">
          <span class="hits">1</span>
          
          <code class="ruby">  def array_preservica_hashes_from_mets</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="234">
          
          
          <code class="ruby">    return unless current_batch_process&amp;.mets_doc &amp;&amp; current_batch_process.mets_doc.parent_uuid.present?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="235">
          
          
          <code class="ruby">    current_batch_process.mets_doc.combined.map do |child_hash|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="236">
          
          
          <code class="ruby">      { parent_oid: oid,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="237">
          
          
          <code class="ruby">        preservica_id: current_batch_process.mets_doc.parent_uuid,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="238">
          
          
          <code class="ruby">        batch_process_id: current_batch_process.id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="239">
          
          
          <code class="ruby">        ingest_time: Time.current,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="240">
          
          
          <code class="ruby">        child_oid: child_hash[:oid],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="241">
          
          
          <code class="ruby">        preservica_child_id: child_hash[:child_uuid] }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="242">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="243">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="244">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="245">
          <span class="hits">1</span>
          
          <code class="ruby">  def array_of_child_hashes</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="246">
          
          
          <code class="ruby">    return unless ladybird_json</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="247">
          
          
          <code class="ruby">    if parent_model == &quot;simple&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="248">
          
          
          <code class="ruby">      raise &quot;Can not import a Parent as simple if it has Children&quot; if ladybird_json[&quot;children&quot;].present?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="249">
          
          
          <code class="ruby">      array_of_child_hashes_for_simple</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="250">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="251">
          
          
          <code class="ruby">      ladybird_json[&quot;children&quot;].map.with_index(1) do |child_record, index|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="252">
          
          
          <code class="ruby">        {</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="253">
          
          
          <code class="ruby">          oid: child_record[&quot;oid&quot;],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="254">
          
          
          <code class="ruby">          # Ladybird has only one field for both order label (7v, etc.), and descriptive captions (&quot;Mozart at the Keyboard&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="255">
          
          
          <code class="ruby">          # For the first iteration we will map this field to label</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="256">
          
          
          <code class="ruby">          label: child_record[&quot;caption&quot;],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="257">
          
          
          <code class="ruby">          caption: child_record[&quot;title&quot;]&amp;.first,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="258">
          
          
          <code class="ruby">          order: index,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="259">
          
          
          <code class="ruby">          parent_object_oid: oid</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="260">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="261">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="262">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="263">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="264">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="265">
          <span class="hits">1</span>
          
          <code class="ruby">  def array_of_child_hashes_for_simple</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="266">
          
          
          <code class="ruby">    new_oid = process_simple_object</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="267">
          
          
          <code class="ruby">    [{</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="268">
          
          
          <code class="ruby">      oid: new_oid,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="269">
          
          
          <code class="ruby">      original_oid: oid,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="270">
          
          
          <code class="ruby">      label: ladybird_json[&#39;title&#39;][0],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="271">
          
          
          <code class="ruby">      order: 1,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="272">
          
          
          <code class="ruby">      parent_object_oid: oid</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="273">
          
          
          <code class="ruby">    }]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="274">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="275">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="276">
          
          
          <code class="ruby">  # rubocop:disable Metrics/MethodLength</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="277">
          
          
          <code class="ruby">  # Mint new oid for child, rename access master tif to the new oid filename</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="278">
          <span class="hits">1</span>
          
          <code class="ruby">  def process_simple_object</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="279">
          
          
          <code class="ruby">    image_mount = ENV[&#39;ACCESS_MASTER_MOUNT&#39;] || &quot;data&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="280">
          
          
          <code class="ruby">    new_oid = OidMinterService.generate_oids(1)[0]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="281">
          
          
          <code class="ruby">    pairtree_path = Partridge::Pairtree.oid_to_pairtree(oid)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="282">
          
          
          <code class="ruby">    new_pairtree_path = Partridge::Pairtree.oid_to_pairtree(new_oid)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="283">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="284">
          
          
          <code class="ruby">    if image_mount == &quot;s3&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="285">
          
          
          <code class="ruby">      ## should we move the file on S3? Probably not.  Image mount is s3 only in dev environments.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="286">
          
          
          <code class="ruby">      ## S3Service.move_image(File.join(pairtree_path, &quot;#{oid}.tif&quot;), File.join(new_pairtree_path, &quot;#{new_oid}.tif&quot;))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="287">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="288">
          
          
          <code class="ruby">      begin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="289">
          
          
          <code class="ruby">        directory = format(&quot;%02d&quot;, pairtree_path.first)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="290">
          
          
          <code class="ruby">        parent_access_master_path = File.join(image_mount, directory, pairtree_path, &quot;#{oid}.tif&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="291">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="292">
          
          
          <code class="ruby">        new_directory = format(&quot;%02d&quot;, new_pairtree_path.first)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="293">
          
          
          <code class="ruby">        FileUtils.mkdir_p(File.join(image_mount, new_directory, new_pairtree_path))</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="294">
          
          
          <code class="ruby">        child_access_master_path = File.join(image_mount, new_directory, new_pairtree_path, &quot;#{new_oid}.tif&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="295">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="296">
          
          
          <code class="ruby">        FileUtils.move parent_access_master_path, child_access_master_path</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="297">
          
          
          <code class="ruby">      rescue =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="298">
          
          
          <code class="ruby">        processing_event(&quot;Moving parent access master to child failed: #{e}&quot;, &quot;failed&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="299">
          
          
          <code class="ruby">        Rails.logger.error(&quot;Unable to rename simple parent access master for parent_oid: #{oid} and new child: #{new_oid}: #{e}&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="300">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="301">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="302">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="303">
          
          
          <code class="ruby">    new_oid</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="304">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="305">
          
          
          <code class="ruby">  # rubocop:enable Metrics/MethodLength</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="306">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="307">
          <span class="hits">1</span>
          
          <code class="ruby">  def assign_dependent_objects(json = authoritative_json)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="308">
          
          
          <code class="ruby">    return unless json</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="309">
          
          
          <code class="ruby">    metadata_source = authoritative_metadata_source&amp;.metadata_cloud_name</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="310">
          
          
          <code class="ruby">    dep_objs = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="311">
          
          
          <code class="ruby">    DependentObject.delete(dependent_objects)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="312">
          
          
          <code class="ruby">    json[&quot;dependentUris&quot;]&amp;.each do |uri|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="313">
          
          
          <code class="ruby">      dep_objs &lt;&lt; DependentObject.create(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="314">
          
          
          <code class="ruby">        dependent_uri: uri,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="315">
          
          
          <code class="ruby">        metadata_source: metadata_source,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="316">
          
          
          <code class="ruby">        parent_object_id: oid</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="317">
          
          
          <code class="ruby">      )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="318">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="319">
          
          
          <code class="ruby">    self.dependent_objects = dep_objs</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="320">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="321">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="322">
          
          
          <code class="ruby">  # Fetches the record from the authoritative_metadata_source</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="323">
          <span class="hits">1</span>
          
          <code class="ruby">  def default_fetch(_current_batch_process = current_batch_process, _current_batch_connection = current_batch_connection)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="324">
          
          
          <code class="ruby">    fetch_results = case authoritative_metadata_source&amp;.metadata_cloud_name</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="325">
          
          
          <code class="ruby">                    when &quot;ladybird&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="326">
          
          
          <code class="ruby">                      self.ladybird_json = MetadataSource.find_by(metadata_cloud_name: &quot;ladybird&quot;).fetch_record(self)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="327">
          
          
          <code class="ruby">                    when &quot;ils&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="328">
          
          
          <code class="ruby">                      self.ladybird_json = MetadataSource.find_by(metadata_cloud_name: &quot;ladybird&quot;).fetch_record(self) unless bib.present?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="329">
          
          
          <code class="ruby">                      self.voyager_json = MetadataSource.find_by(metadata_cloud_name: &quot;ils&quot;).fetch_record(self)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="330">
          
          
          <code class="ruby">                    when &quot;aspace&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="331">
          
          
          <code class="ruby">                      self.ladybird_json = MetadataSource.find_by(metadata_cloud_name: &quot;ladybird&quot;).fetch_record(self) unless aspace_uri.present?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="332">
          
          
          <code class="ruby">                      self.aspace_json = MetadataSource.find_by(metadata_cloud_name: &quot;aspace&quot;).fetch_record(self)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="333">
          
          
          <code class="ruby">                    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="334">
          
          
          <code class="ruby">    if fetch_results</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="335">
          
          
          <code class="ruby">      assign_dependent_objects</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="336">
          
          
          <code class="ruby">      assign_values</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="337">
          
          
          <code class="ruby">      processing_event(&quot;Metadata has been fetched&quot;, &quot;metadata-fetched&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="338">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="339">
          
          
          <code class="ruby">    fetch_results</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="340">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="341">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="342">
          
          
          <code class="ruby">  # Currently we run this job if the record is new and ladybird json wasn&#39;t passed in from create</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="343">
          
          
          <code class="ruby">  # OR if the authoritative metaadata source changes</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="344">
          
          
          <code class="ruby">  # OR if the metadata_update accessor is set</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="345">
          
          
          <code class="ruby">  # rubocop:disable Metrics/CyclomaticComplexity</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="346">
          
          
          <code class="ruby">  # rubocop:disable Metrics/PerceivedComplexity</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="347">
          <span class="hits">1</span>
          
          <code class="ruby">  def setup_metadata_job(current_batch_connection = self.current_batch_connection)</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="348">
          <span class="hits">6</span>
          
          <code class="ruby">    if (created_at_previously_changed? &amp;&amp; ladybird_json.blank?) ||</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="349">
          
          
          <code class="ruby">       previous_changes[&quot;authoritative_metadata_source_id&quot;].present? ||</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="350">
          
          
          <code class="ruby">       metadata_update.present?</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="351">
          <span class="hits">6</span>
          
          <code class="ruby">      current_batch_connection&amp;.save! unless current_batch_connection&amp;.persisted?</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="352">
          <span class="hits">6</span>
          
          <code class="ruby">      SetupMetadataJob.perform_later(self, current_batch_process, current_batch_connection)</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="353">
          <span class="hits">6</span>
          
          <code class="ruby">      processing_event(&quot;Processing has been queued&quot;, &quot;processing-queued&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="354">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="355">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="356">
          
          
          <code class="ruby">  # rubocop:enable Metrics/CyclomaticComplexity</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="357">
          
          
          <code class="ruby">  # rubocop:enable Metrics/PerceivedComplexity</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="358">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="359">
          <span class="hits">1</span>
          
          <code class="ruby">  def authoritative_json</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="360">
          
          
          <code class="ruby">    json_for(authoritative_metadata_source.metadata_cloud_name)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="361">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="362">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="363">
          <span class="hits">1</span>
          
          <code class="ruby">  def assign_values</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="364">
          
          
          <code class="ruby">    self.call_number = authoritative_json[&quot;callNumber&quot;].is_a?(Array) ? authoritative_json[&quot;callNumber&quot;].first : authoritative_json[&quot;callNumber&quot;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="365">
          
          
          <code class="ruby">    self.container_grouping = authoritative_json[&quot;containerGrouping&quot;].is_a?(Array) ? authoritative_json[&quot;containerGrouping&quot;].first : authoritative_json[&quot;containerGrouping&quot;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="366">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="367">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="368">
          <span class="hits">1</span>
          
          <code class="ruby">  def add_media_type(url)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="369">
          
          
          <code class="ruby">    return &quot;#{url}&amp;mediaType=json&quot; if url.include?(&quot;?&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="370">
          
          
          <code class="ruby">    &quot;#{url}?mediaType=json&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="371">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="372">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="373">
          <span class="hits">1</span>
          
          <code class="ruby">  def metadata_cloud_url</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="374">
          
          
          <code class="ruby">    case source_name</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="375">
          
          
          <code class="ruby">    when &quot;ladybird&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="376">
          
          
          <code class="ruby">      add_media_type ladybird_cloud_url</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="377">
          
          
          <code class="ruby">    when &quot;ils&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="378">
          
          
          <code class="ruby">      add_media_type voyager_cloud_url</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="379">
          
          
          <code class="ruby">    when &quot;aspace&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="380">
          
          
          <code class="ruby">      add_media_type aspace_cloud_url</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="381">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="382">
          
          
          <code class="ruby">      raise StandardError, &quot;Unexpected metadata cloud name: #{authoritative_metadata_source.metadata_cloud_name}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="383">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="384">
          
          
          <code class="ruby">  rescue</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="385">
          
          
          <code class="ruby">    nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="386">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="387">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="388">
          <span class="hits">1</span>
          
          <code class="ruby">  def json_for(source_name)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="389">
          
          
          <code class="ruby">    case source_name</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="390">
          
          
          <code class="ruby">    when &quot;ladybird&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="391">
          
          
          <code class="ruby">      ladybird_json</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="392">
          
          
          <code class="ruby">    when &quot;ils&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="393">
          
          
          <code class="ruby">      voyager_json</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="394">
          
          
          <code class="ruby">    when &quot;aspace&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="395">
          
          
          <code class="ruby">      aspace_json</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="396">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="397">
          
          
          <code class="ruby">      raise StandardError, &quot;Unexpected metadata cloud name: #{authoritative_metadata_source.metadata_cloud_name}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="398">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="399">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="400">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="401">
          
          
          <code class="ruby">  # Takes a JSON record from the MetadataCloud and saves the Ladybird-specific info to the DB</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="402">
          <span class="hits">1</span>
          
          <code class="ruby">  def ladybird_json=(lb_record)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="403">
          
          
          <code class="ruby">    super(lb_record)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="404">
          
          
          <code class="ruby">    return lb_record if lb_record.blank?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="405">
          
          
          <code class="ruby">    self.last_ladybird_update = DateTime.current</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="406">
          
          
          <code class="ruby">    return unless use_ladybird</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="407">
          
          
          <code class="ruby">    self.bib = lb_record[&quot;orbisBibId&quot;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="408">
          
          
          <code class="ruby">    self.barcode = lb_record[&quot;orbisBarcode&quot;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="409">
          
          
          <code class="ruby">    self.aspace_uri = lb_record[&quot;archiveSpaceUri&quot;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="410">
          
          
          <code class="ruby">    self.visibility = lb_record[&quot;itemPermission&quot;].nil? ? &quot;Private&quot; : lb_record[&quot;itemPermission&quot;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="411">
          
          
          <code class="ruby">    self.rights_statement = lb_record[&quot;rights&quot;]&amp;.join(&quot;\n&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="412">
          
          
          <code class="ruby">    self.extent_of_digitization = normalize_extent_of_digitization</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="413">
          
          
          <code class="ruby">    self.project_identifier = lb_record[&quot;projectId&quot;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="414">
          
          
          <code class="ruby">    self.use_ladybird = false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="415">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="416">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="417">
          <span class="hits">1</span>
          
          <code class="ruby">  def normalize_extent_of_digitization</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="418">
          
          
          <code class="ruby">    extent_from_ladybird = ladybird_json&amp;.[](&quot;extentOfDigitization&quot;)&amp;.first</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="419">
          
          
          <code class="ruby">    return unless extent_from_ladybird</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="420">
          
          
          <code class="ruby">    if extent_from_ladybird.start_with?(&quot;Comp&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="421">
          
          
          <code class="ruby">      &quot;Completely digitized&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="422">
          
          
          <code class="ruby">    elsif extent_from_ladybird.start_with?(&quot;Part&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="423">
          
          
          <code class="ruby">      &quot;Partially digitized&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="424">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="425">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="426">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="427">
          <span class="hits">1</span>
          
          <code class="ruby">  def voyager_json=(v_record)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="428">
          
          
          <code class="ruby">    super(v_record)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="429">
          
          
          <code class="ruby">    return v_record if v_record.blank?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="430">
          
          
          <code class="ruby">    self.holding = v_record[&quot;holdingId&quot;] unless v_record[&quot;holdingId&quot;].zero?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="431">
          
          
          <code class="ruby">    self.item = v_record[&quot;itemId&quot;] unless v_record[&quot;itemId&quot;].zero?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="432">
          
          
          <code class="ruby">    self.last_id_update = DateTime.current</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="433">
          
          
          <code class="ruby">    self.last_voyager_update = DateTime.current</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="434">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="435">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="436">
          <span class="hits">1</span>
          
          <code class="ruby">  def aspace_json=(a_record)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="437">
          
          
          <code class="ruby">    super(a_record)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="438">
          
          
          <code class="ruby">    self.last_aspace_update = DateTime.current if a_record.present?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="439">
          
          
          <code class="ruby">    self.bib = a_record[&quot;orbisBibId&quot;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="440">
          
          
          <code class="ruby">    self.barcode = a_record[&quot;orbisBarcode&quot;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="441">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="442">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="443">
          <span class="hits">1</span>
          
          <code class="ruby">  def ladybird_cloud_url</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="444">
          
          
          <code class="ruby">    &quot;https://#{MetadataSource.metadata_cloud_host}/metadatacloud/api/#{MetadataSource.metadata_cloud_version}/ladybird/oid/#{oid}?include-children=1&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="445">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="446">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="447">
          <span class="hits">1</span>
          
          <code class="ruby">  def voyager_cloud_url</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="448">
          
          
          <code class="ruby">    raise StandardError, &quot;Bib id required to build Voyager url&quot; unless bib.present?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="449">
          
          
          <code class="ruby">    identifier_block = if barcode.present?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="450">
          
          
          <code class="ruby">                         &quot;/barcode/#{barcode}?bib=#{bib}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="451">
          
          
          <code class="ruby">                       elsif holding.present?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="452">
          
          
          <code class="ruby">                         &quot;/holding/#{holding}?bib=#{bib}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="453">
          
          
          <code class="ruby">                       elsif item.present?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="454">
          
          
          <code class="ruby">                         &quot;/item/#{item}?bib=#{bib}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="455">
          
          
          <code class="ruby">                       else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="456">
          
          
          <code class="ruby">                         &quot;/bib/#{bib}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="457">
          
          
          <code class="ruby">                       end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="458">
          
          
          <code class="ruby">    &quot;https://#{MetadataSource.metadata_cloud_host}/metadatacloud/api/#{MetadataSource.metadata_cloud_version}/ils#{identifier_block}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="459">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="460">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="461">
          <span class="hits">1</span>
          
          <code class="ruby">  def aspace_cloud_url</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="462">
          
          
          <code class="ruby">    raise StandardError, &quot;ArchiveSpace uri required to build ArchiveSpace url&quot; unless aspace_uri.present?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="463">
          
          
          <code class="ruby">    &quot;https://#{MetadataSource.metadata_cloud_host}/metadatacloud/api/#{MetadataSource.metadata_cloud_version}/aspace#{aspace_uri}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="464">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="465">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="466">
          <span class="hits">1</span>
          
          <code class="ruby">  def source_name=(metadata_source)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="467">
          
          
          <code class="ruby">    self.authoritative_metadata_source = MetadataSource.find_by(metadata_cloud_name: metadata_source)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="468">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="469">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="470">
          <span class="hits">1</span>
          
          <code class="ruby">  def source_name</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="471">
          
          
          <code class="ruby">    authoritative_metadata_source&amp;.metadata_cloud_name</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="472">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="473">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="474">
          <span class="hits">1</span>
          
          <code class="ruby">  def iiif_presentation</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="475">
          
          
          <code class="ruby">    @iiif_presentation ||= IiifPresentationV3.new(self)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="476">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="477">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="478">
          <span class="hits">1</span>
          
          <code class="ruby">  def iiif_manifest</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="479">
          
          
          <code class="ruby">    return @iiif_manifest if @iiif_manifest</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="480">
          
          
          <code class="ruby">    @iiif_manifest = @iiif_presentation.manifest if iiif_presentation.valid?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="481">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="482">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="483">
          <span class="hits">1</span>
          
          <code class="ruby">  def manifest_completed?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="484">
          
          
          <code class="ruby">    ready_for_manifest? &amp;&amp; iiif_presentation.valid? &amp;&amp; S3Service.s3_exists?(iiif_presentation.manifest_path, ENV[&#39;SAMPLE_BUCKET&#39;])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="485">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="486">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="487">
          <span class="hits">1</span>
          
          <code class="ruby">  def needs_a_manifest?</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="488">
          <span class="hits">2</span>
          
          <code class="ruby">    if ready_for_manifest? &amp;&amp; generate_manifest</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="489">
          
          
          <code class="ruby">      updated_rows = ParentObject.default_scoped.where(oid: oid, generate_manifest: true).update_all(generate_manifest: false) # rubocop:disable Rails/SkipsModelValidations</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="490">
          
          
          <code class="ruby">      self.generate_manifest = false</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="491">
          
          
          <code class="ruby">      return updated_rows == 1</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="492">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="493">
          <span class="hits">2</span>
          
          <code class="ruby">    false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="494">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="495">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="496">
          <span class="hits">1</span>
          
          <code class="ruby">  def ready_for_manifest?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="497">
          
          
          <code class="ruby">    # returns false if any child objects have a width of nil</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="498">
          <span class="hits">2</span>
          
          <code class="ruby">    !child_objects.pluck(:width).include?(nil)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="499">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="500">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="501">
          <span class="hits">1</span>
          
          <code class="ruby">  def representative_child</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="502">
          
          
          <code class="ruby">    @representative_child = (child_objects.find_by(oid: representative_child_oid) if representative_child_oid)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="503">
          
          
          <code class="ruby">    @representative_child ||= child_objects&amp;.first</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="504">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="505">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="506">
          <span class="hits">1</span>
          
          <code class="ruby">  def representative_thumbnail_url</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="507">
          
          
          <code class="ruby">    representative_child&amp;.thumbnail_url</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="508">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="509">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="510">
          <span class="hits">1</span>
          
          <code class="ruby">  def child_captions</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="511">
          
          
          <code class="ruby">    child_objects.map(&amp;:caption).compact</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="512">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="513">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="514">
          <span class="hits">1</span>
          
          <code class="ruby">  def child_labels</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="515">
          
          
          <code class="ruby">    child_objects.map(&amp;:label).compact</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="516">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="517">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="518">
          <span class="hits">1</span>
          
          <code class="ruby">  def child_oids</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="519">
          
          
          <code class="ruby">    child_objects.map(&amp;:oid)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="520">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="521">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="522">
          <span class="hits">1</span>
          
          <code class="ruby">  def extract_container_information(json = authoritative_json)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="523">
          
          
          <code class="ruby">    return nil unless json</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="524">
          
          
          <code class="ruby">    return json[&quot;containerGrouping&quot;] unless json[&quot;containerGrouping&quot;].nil? || json[&quot;containerGrouping&quot;].empty?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="525">
          
          
          <code class="ruby">    return [(json[&quot;box&quot;] &amp;&amp; (json[&#39;box&#39;]).to_s), (json[&quot;folder&quot;] &amp;&amp; (json[&#39;folder&#39;]).to_s)].join(&quot;, &quot;) if json[&quot;box&quot;] || json[&quot;folder&quot;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="526">
          
          
          <code class="ruby">    json[&quot;volumeEnumeration&quot;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="527">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="528">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="529">
          <span class="hits">1</span>
          
          <code class="ruby">  def dl_show_url</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="530">
          
          
          <code class="ruby">    base = ENV[&#39;BLACKLIGHT_BASE_URL&#39;] || &#39;http://localhost:3000&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="531">
          
          
          <code class="ruby">    &quot;#{base}/catalog/#{oid}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="532">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="533">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="534">
          <span class="hits">1</span>
          
          <code class="ruby">  def batch_connections_for(batch_process)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="535">
          <span class="hits">3</span>
          
          <code class="ruby">    batch_connections.where(batch_process: batch_process)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="536">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="537">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="538">
          <span class="hits">1</span>
          
          <code class="ruby">  def full_text?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="539">
          
          
          <code class="ruby">    return false unless child_objects.any?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="540">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="541">
          
          
          <code class="ruby">    %w[Partial Yes].include? extent_of_full_text</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="542">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="543">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="544">
          <span class="hits">1</span>
          
          <code class="ruby">  def extent_of_full_text</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="545">
          
          
          <code class="ruby">    children_with_ft = false</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="546">
          
          
          <code class="ruby">    children_without_ft = false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="547">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="548">
          
          
          <code class="ruby">    child_objects.each do |object|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="549">
          
          
          <code class="ruby">      if object.full_text</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="550">
          
          
          <code class="ruby">        children_with_ft = true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="551">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="552">
          
          
          <code class="ruby">        children_without_ft = true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="553">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="554">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="555">
          
          
          <code class="ruby">      break if children_with_ft &amp;&amp; children_without_ft</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="556">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="557">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="558">
          
          
          <code class="ruby">    return &quot;Partial&quot; if children_with_ft &amp;&amp; children_without_ft # if some children have full text and others dont</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="559">
          
          
          <code class="ruby">    return &quot;No&quot; unless children_with_ft # if none of children have full_text</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="560">
          
          
          <code class="ruby">    &quot;Yes&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="561">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="562">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="563">
          <span class="hits">1</span>
          
          <code class="ruby">  def update_fulltext_for_children</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="564">
          
          
          <code class="ruby">    child_objects.each do |child_object|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="565">
          
          
          <code class="ruby">      child_object.processing_event(&quot;Child #{child_object.oid} is being processed&quot;, &#39;processing-queued&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="566">
          
          
          <code class="ruby">      child_object.full_text = ChildObject.remote_ocr_exists?(child_object.oid)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="567">
          
          
          <code class="ruby">      child_object.save!</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="568">
          
          
          <code class="ruby">      child_object.processing_event(&quot;Child #{child_object.oid} has been updated: #{child_object.full_text ? &#39;YES&#39; : &#39;NO&#39;}&quot;, &#39;update-complete&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="569">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="570">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="571">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="572">
          <span class="hits">1</span>
          
          <code class="ruby">  def should_index?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="573">
          
          
          <code class="ruby">    return false if redirect_to.blank? &amp;&amp; (child_object_count&amp;.zero? || child_objects.empty?)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="574">
          
          
          <code class="ruby">    [&#39;Public&#39;, &#39;Redirect&#39;, &#39;Yale Community Only&#39;].include?(visibility) || redirect_to.present?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="575">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="576">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="577">
          <span class="hits">1</span>
          
          <code class="ruby">  def should_create_manifest_and_pdf?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="578">
          
          
          <code class="ruby">    !redirect_to.present?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="579">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="580">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="3b71ddcd5b42257d88fd6ceee42a4b871c03c626">
  <div class="header">
    <h3>app/models/preservica/bitstream.rb</h3>
    <h4><span class="red">0.0 %</span> covered</h4>
    <div>
      <b>44</b> relevant lines. 
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>44</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># frozen_string_literal: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="3">
          
          
          <code class="ruby">class Preservica::Bitstream</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="4">
          
          
          <code class="ruby">  include Preservica::PreservicaObject</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="6">
          
          
          <code class="ruby">  def initialize(preservica_client, content_id, generation_id, id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="7">
          
          
          <code class="ruby">    @preservica_client = preservica_client</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="8">
          
          
          <code class="ruby">    @id = id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="9">
          
          
          <code class="ruby">    @content_id = content_id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">    @generation_id = generation_id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="11">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby">  def sha512_checksum</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="14">
          
          
          <code class="ruby">    xml.xpath(&#39;//Fixity&#39;).each do |node|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="15">
          
          
          <code class="ruby">      return node.at(&quot;FixityValue&quot;).text.strip if node.at(&quot;FixityAlgorithmRef&quot;).text == &quot;SHA512&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="16">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="17">
          
          
          <code class="ruby">    nil</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="20">
          
          
          <code class="ruby">  def size</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="21">
          
          
          <code class="ruby">    xml.xpath(&#39;//FileSize/text()&#39;).text.strip.to_i</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="22">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="24">
          
          
          <code class="ruby">  def bits</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="25">
          
          
          <code class="ruby">    preservica_client.get content_uri</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="26">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="28">
          
          
          <code class="ruby">  def download_to_file(file_name)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="29">
          
          
          <code class="ruby">    data_length = 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="30">
          
          
          <code class="ruby">    sha512 = Digest::SHA512. new</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="31">
          
          
          <code class="ruby">    File.open(file_name, &#39;wb&#39;) do |file|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="32">
          
          
          <code class="ruby">      preservica_client.get(content_uri) do |chunk|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="33">
          
          
          <code class="ruby">        data_length += chunk.length</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="34">
          
          
          <code class="ruby">        file.write(chunk)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="35">
          
          
          <code class="ruby">        sha512 &lt;&lt; chunk</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="36">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="37">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="38">
          
          
          <code class="ruby">    data_sha512 = sha512.hexdigest</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="39">
          
          
          <code class="ruby">    file_size = File.size?(file_name)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="40">
          
          
          <code class="ruby">    raise StandardError, &quot;Checksum mismatch (#{data_sha512} != #{sha512_checksum})&quot; unless data_sha512 == sha512_checksum</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="41">
          
          
          <code class="ruby">    raise StandardError, &quot;Data size did not match (#{data_length} != #{size})&quot; unless data_length == size</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="42">
          
          
          <code class="ruby">    raise StandardError, &quot;File sizes do not match (#{file_size} != #{size})&quot; unless file_size == size</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby">    # could also check: Digest::SHA512.file(file_name).hexdigest == sha512_checksum, but probably not necessary</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="44">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="46">
          
          
          <code class="ruby">  def xml</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="47">
          
          
          <code class="ruby">    @xml ||= Nokogiri::XML(preservica_client.content_object_generation_bitstream(@content_id, @generation_id, @id)).remove_namespaces!</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="48">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="50">
          
          
          <code class="ruby">  private</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="52">
          
          
          <code class="ruby">    def content_uri</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="53">
          
          
          <code class="ruby">      @content_uri ||= &quot;/api/entity/content-objects/#{@content_id}/generations/#{@generation_id}/bitstreams/#{@id}/content&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="54">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="55">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="ae7510421e94bec401ed50776372f4ceb864d06c">
  <div class="header">
    <h3>app/models/preservica/content_object.rb</h3>
    <h4><span class="red">0.0 %</span> covered</h4>
    <div>
      <b>25</b> relevant lines. 
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>25</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># frozen_string_literal: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="3">
          
          
          <code class="ruby">class Preservica::ContentObject</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="4">
          
          
          <code class="ruby">  include Preservica::PreservicaObject</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="6">
          
          
          <code class="ruby">  def self.where(options)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="7">
          
          
          <code class="ruby">    preservica_client = options[:preservica_client] || PreservicaClient.new(admin_set_key: options[:admin_set_key])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="8">
          
          
          <code class="ruby">    Preservica::ContentObject.new(preservica_client, options[:id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="9">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="11">
          
          
          <code class="ruby">  def initialize(preservica_client, id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">    @preservica_client = preservica_client</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby">    @id = id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="14">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="16">
          
          
          <code class="ruby">  def active_generations</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="17">
          
          
          <code class="ruby">    @generations ||= load_generations</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="20">
          
          
          <code class="ruby">  def xml</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="21">
          
          
          <code class="ruby">    @xml ||= @preservica_client.content_object(@id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="22">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="24">
          
          
          <code class="ruby">  private</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="26">
          
          
          <code class="ruby">    def load_generations</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="27">
          
          
          <code class="ruby">      xml = Nokogiri::XML(@preservica_client.content_object_generations(@id)).remove_namespaces!</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="28">
          
          
          <code class="ruby">      xml.xpath(&quot;//Generations/Generation[@active=&#39;true&#39;]&quot;).map do |generation_node|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="29">
          
          
          <code class="ruby">        generation_id = generation_node.text.split(&#39;/&#39;).last</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="30">
          
          
          <code class="ruby">        Preservica::Generation.new(@preservica_client, @id, generation_id.strip)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="31">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="32">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="33">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="44e92fa54168865d8cec4eaf51acbcbcdb7fb4e4">
  <div class="header">
    <h3>app/models/preservica/generation.rb</h3>
    <h4><span class="red">0.0 %</span> covered</h4>
    <div>
      <b>39</b> relevant lines. 
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>39</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># frozen_string_literal: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="3">
          
          
          <code class="ruby">class Preservica::Generation</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="4">
          
          
          <code class="ruby">  include Preservica::PreservicaObject</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="6">
          
          
          <code class="ruby">  def initialize(preservica_client, content_id, generation_id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="7">
          
          
          <code class="ruby">    @preservica_client = preservica_client</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="8">
          
          
          <code class="ruby">    @id = generation_id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="9">
          
          
          <code class="ruby">    @content_id = content_id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">  def bitstreams</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby">    @bitstreams ||= load_bitstreams</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="14">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="16">
          
          
          <code class="ruby">  def formats</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="17">
          
          
          <code class="ruby">    @formats ||= load_formats</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="20">
          
          
          <code class="ruby">  def format_group</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="21">
          
          
          <code class="ruby">    @format_group ||= load_format_group</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="22">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="24">
          
          
          <code class="ruby">  def generation_uri</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="25">
          
          
          <code class="ruby">    xml.xpath(&#39;/GenerationResponse/AdditionalInformation/Self&#39;).text.strip</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="26">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="28">
          
          
          <code class="ruby">  def bitstream_uri</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="29">
          
          
          <code class="ruby">    xml.xpath(&#39;/GenerationResponse/Bitstreams/Bitstream&#39;).text.strip</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="30">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="32">
          
          
          <code class="ruby">  def xml</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="33">
          
          
          <code class="ruby">    @xml ||= Nokogiri::XML(preservica_client.content_object_generation(@content_id, @id)).remove_namespaces!</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="34">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="36">
          
          
          <code class="ruby">  private</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="38">
          
          
          <code class="ruby">    def load_bitstreams</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="39">
          
          
          <code class="ruby">      bitstream_ids = xml.xpath(&#39;/GenerationResponse/Bitstreams/Bitstream&#39;).map(&amp;:content).map { |x| x.split(&#39;/&#39;).last }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="40">
          
          
          <code class="ruby">      bitstream_ids.map do |bitstream_id|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="41">
          
          
          <code class="ruby">        Preservica::Bitstream.new(@preservica_client, @content_id, @id, bitstream_id.strip)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="42">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="43">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="45">
          
          
          <code class="ruby">    def load_formats</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="46">
          
          
          <code class="ruby">      xml.xpath(&#39;/GenerationResponse/Generation/Formats/Format/FormatName&#39;).map(&amp;:content)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="47">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="49">
          
          
          <code class="ruby">    def load_format_group</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="50">
          
          
          <code class="ruby">      xml.xpath(&#39;/GenerationResponse/Generation/FormatGroup&#39;).map(&amp;:content)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="51">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="52">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="1e0b824c05175b548f70c6627d2947ed110a4d1e">
  <div class="header">
    <h3>app/models/preservica/information_object.rb</h3>
    <h4><span class="red">0.0 %</span> covered</h4>
    <div>
      <b>37</b> relevant lines. 
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>37</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># frozen_string_literal: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="3">
          
          
          <code class="ruby">class Preservica::InformationObject</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="4">
          
          
          <code class="ruby">  include Preservica::PreservicaObject</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="6">
          
          
          <code class="ruby">  def self.where(options)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="7">
          
          
          <code class="ruby">    preservica_client = options[:preservica_client] || PreservicaClient.new(admin_set_key: options[:admin_set_key])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="8">
          
          
          <code class="ruby">    Preservica::InformationObject.new(preservica_client, options[:id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="9">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="11">
          
          
          <code class="ruby">  def initialize(preservica_client, id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">    @preservica_client = preservica_client</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby">    @id = id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="14">
          
          
          <code class="ruby">    @representation_hash = {}</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="15">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="17">
          
          
          <code class="ruby">  def representations</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">    @representations ||= load_representations</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="19">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="21">
          
          
          <code class="ruby">  def access_representations</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="22">
          
          
          <code class="ruby">    @access_representations ||= load_representation(&quot;Access&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="23">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="25">
          
          
          <code class="ruby">  def preservation_representations</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="26">
          
          
          <code class="ruby">    @preservation_representations ||= load_representation(&quot;Preservation&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="27">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">  # returns all representations with a name containing preservica_representation_name</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="30">
          
          
          <code class="ruby">  def fetch_by_representation_name(preservica_representation_name)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="31">
          
          
          <code class="ruby">    @representation_hash[preservica_representation_name] ||= load_representation(preservica_representation_name)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="32">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="34">
          
          
          <code class="ruby">  def xml</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="35">
          
          
          <code class="ruby">    @xml ||= @preservica_client.information_object(@id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="36">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="38">
          
          
          <code class="ruby">  private</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="40">
          
          
          <code class="ruby">    def load_representation(preservica_representation_name)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="41">
          
          
          <code class="ruby">      representations.select { |representation| representation.name.include?(preservica_representation_name) }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="42">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="44">
          
          
          <code class="ruby">    def load_representations</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="45">
          
          
          <code class="ruby">      xml = Nokogiri::XML(@preservica_client.information_object_representations(@id)).remove_namespaces!</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="46">
          
          
          <code class="ruby">      xml.xpath(&#39;//Representation/@name&#39;).map(&amp;:text).map do |name|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="47">
          
          
          <code class="ruby">        Preservica::Representation.new(@preservica_client, @id, name)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="48">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="49">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="50">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="8d8256e1054ecb4072be7cfe9a1188d15c086455">
  <div class="header">
    <h3>app/models/preservica/preservica_object.rb</h3>
    <h4><span class="red">0.0 %</span> covered</h4>
    <div>
      <b>4</b> relevant lines. 
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>4</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># frozen_string_literal: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="3">
          
          
          <code class="ruby">module Preservica::PreservicaObject</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="4">
          
          
          <code class="ruby">  attr_accessor :preservica_client</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="5">
          
          
          <code class="ruby">  attr_accessor :id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="6">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="507d99957289d16a6198be29c92ae8fe39ec68bd">
  <div class="header">
    <h3>app/models/preservica/representation.rb</h3>
    <h4><span class="red">0.0 %</span> covered</h4>
    <div>
      <b>34</b> relevant lines. 
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>34</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># frozen_string_literal: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="3">
          
          
          <code class="ruby">class Preservica::Representation</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="4">
          
          
          <code class="ruby">  include Preservica::PreservicaObject</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="6">
          
          
          <code class="ruby">  attr_accessor :name</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="8">
          
          
          <code class="ruby">  def self.where(options)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="9">
          
          
          <code class="ruby">    preservica_client = options[:preservica_client] || PreservicaClient.new(admin_set_key: options[:admin_set_key])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">    information_object_id = options[:information_object_id]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="11">
          
          
          <code class="ruby">    name = options[:name]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">    Preservica::Representation.new(preservica_client, information_object_id, name)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="15">
          
          
          <code class="ruby">  def initialize(preservica_client, information_object_id, name)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="16">
          
          
          <code class="ruby">    @preservica_client = preservica_client</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="17">
          
          
          <code class="ruby">    @id = information_object_id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">    @name = name</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="19">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="21">
          
          
          <code class="ruby">  def content_objects</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="22">
          
          
          <code class="ruby">    @content_objects ||= load_content_objects</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="23">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="25">
          
          
          <code class="ruby">  def type</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="26">
          
          
          <code class="ruby">    xml.xpath(&#39;/RepresentationResponse/Representation/Type&#39;).text.strip</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="27">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="29">
          
          
          <code class="ruby">  def content_object_uri(index)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="30">
          
          
          <code class="ruby">    xml.xpath(&#39;/RepresentationResponse/ContentObjects/ContentObject&#39;)[index].text.strip</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="31">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="33">
          
          
          <code class="ruby">  def xml</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="34">
          
          
          <code class="ruby">    @xml ||= Nokogiri::XML(@preservica_client.information_object_representation(@id, @name)).remove_namespaces!</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="35">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="37">
          
          
          <code class="ruby">  private</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="39">
          
          
          <code class="ruby">    def load_content_objects</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="40">
          
          
          <code class="ruby">      xml.xpath(&#39;/RepresentationResponse/ContentObjects/ContentObject&#39;).map do |content_object_node|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="41">
          
          
          <code class="ruby">        content_object_id = content_object_node.xpath(&#39;@ref&#39;).text</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="42">
          
          
          <code class="ruby">        Preservica::ContentObject.new(@preservica_client, content_object_id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="43">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="44">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="45">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="cb099bc2e3144de55713ebb89761069dc390b856">
  <div class="header">
    <h3>app/models/preservica/structural_object.rb</h3>
    <h4><span class="red">0.0 %</span> covered</h4>
    <div>
      <b>25</b> relevant lines. 
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>25</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># frozen_string_literal: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="3">
          
          
          <code class="ruby">class Preservica::StructuralObject</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="4">
          
          
          <code class="ruby">  include Preservica::PreservicaObject</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="6">
          
          
          <code class="ruby">  def self.where(options)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="7">
          
          
          <code class="ruby">    preservica_client = options[:preservica_client] || PreservicaClient.new(admin_set_key: options[:admin_set_key])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="8">
          
          
          <code class="ruby">    Preservica::StructuralObject.new(preservica_client, options[:id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="9">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="11">
          
          
          <code class="ruby">  def initialize(preservica_client, id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">    @preservica_client = preservica_client</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby">    @id = id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="14">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="16">
          
          
          <code class="ruby">  def information_objects</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="17">
          
          
          <code class="ruby">    @information_objects ||= load_information_objects</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="20">
          
          
          <code class="ruby">  def xml</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="21">
          
          
          <code class="ruby">    @xml ||= @preservica_client.structural_object(@id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="22">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="24">
          
          
          <code class="ruby">  private</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="26">
          
          
          <code class="ruby">    def load_information_objects</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="27">
          
          
          <code class="ruby">      structural_object_children = Nokogiri::XML(@preservica_client.structural_object_children(id)).remove_namespaces!</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="28">
          
          
          <code class="ruby">      structural_object_children.xpath(&#39;/ChildrenResponse/Children/Child&#39;).map do |child_ref|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="29">
          
          
          <code class="ruby">        information_object_id = child_ref.xpath(&#39;@ref&#39;).text</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="30">
          
          
          <code class="ruby">        Preservica::InformationObject.new(@preservica_client, information_object_id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="31">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="32">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="33">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="219b1961ac32c8c70d7f80b9ed3e0522956fd30b">
  <div class="header">
    <h3>app/models/preservica_ingest.rb</h3>
    <h4><span class="red">0.0 %</span> covered</h4>
    <div>
      <b>2</b> relevant lines. 
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>2</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># frozen_string_literal: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="3">
          
          
          <code class="ruby">class PreservicaIngest &lt; ApplicationRecord</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="4">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="ec443c59eff4740389c7707223bc723458e6bbf3">
  <div class="header">
    <h3>app/models/pyramidal_tiff.rb</h3>
    <h4><span class="red">41.67 %</span> covered</h4>
    <div>
      <b>60</b> relevant lines. 
      <span class="green"><b>25</b> lines covered</span> and
      <span class="red"><b>35</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># frozen_string_literal: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"># This class takes a child_object&#39;s oid, retrieves the access_master for that child object, creates a pyramidal tiff from the access master,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby"># and saves that pyramidal tiff to an S3 bucket.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">class PyramidalTiff</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">  include ActiveModel::Validations</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">  attr_accessor :child_object, :conversion_information, :force_update</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">  validate :verify_and_generate</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="10">
          <span class="hits">1</span>
          
          <code class="ruby">  delegate :access_master_path, :mets_access_master_path, :remote_access_master_path, :remote_ptiff_path, :oid, to: :child_object</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">  # This method takes the oid of a child_object and creates a new PyramidalTiff</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">  def initialize(child_object)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="14">
          <span class="hits">2</span>
          
          <code class="ruby">    @child_object = child_object</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="15">
          <span class="hits">2</span>
          
          <code class="ruby">    @conversion_information = {}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="18">
          <span class="hits">1</span>
          
          <code class="ruby">  def generate_ptiff</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">    # this adds the height and width to the object</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="20">
          
          
          <code class="ruby">    Dir.mktmpdir do |swing_tmpdir|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="21">
          
          
          <code class="ruby">      tiff_input_path = copy_access_master_to_working_directory(swing_tmpdir)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="22">
          
          
          <code class="ruby">      Dir.mktmpdir do |ptiff_tmpdir|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="23">
          
          
          <code class="ruby">        @conversion_information = convert_to_ptiff(tiff_input_path, ptiff_tmpdir)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="24">
          
          
          <code class="ruby">        save_to_s3(File.join(ptiff_tmpdir, File.basename(access_master_path)), @conversion_information) unless @conversion_information.empty?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="27">
          
          
          <code class="ruby">    conversion_information</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="30">
          <span class="hits">1</span>
          
          <code class="ruby">  def height_and_width?</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="31">
          <span class="hits">4</span>
          
          <code class="ruby">    child_object.height &amp;&amp; child_object.width</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="34">
          <span class="hits">1</span>
          
          <code class="ruby">  def verify_and_generate</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="35">
          <span class="hits">2</span>
          
          <code class="ruby">    ptiff_info = { oid: oid.to_s }</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="36">
          <span class="hits">2</span>
          
          <code class="ruby">    file_on_s3 = S3Service.s3_exists?(child_object.remote_ptiff_path)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="37">
          <span class="hits">2</span>
          
          <code class="ruby">    child_object.check_for_size_and_file if !height_and_width? &amp;&amp; file_on_s3</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">    # do not do the image conversion if there is already a PTIFF on S3</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="39">
          <span class="hits">2</span>
          
          <code class="ruby">    if height_and_width? &amp;&amp; !force_update &amp;&amp; file_on_s3</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="40">
          <span class="hits">1</span>
          
          <code class="ruby">      child_object.processing_event(&quot;PTIFF exists on S3, not converting: #{ptiff_info.to_json}&quot;, &#39;ptiff-ready-skipped&#39;)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="41">
          <span class="hits">1</span>
          
          <code class="ruby">      true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby">      # cannot convert to PTIFF if we can&#39;t find the original</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="44">
          <span class="hits">1</span>
          
          <code class="ruby">      return false unless original_file_exists? # this returns true</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="45">
          <span class="hits">1</span>
          
          <code class="ruby">      generate_ptiff</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="49">
          <span class="hits">1</span>
          
          <code class="ruby">  def original_file_exists?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="50">
          
          
          <code class="ruby">    if child_object.parent_object&amp;.from_mets == true</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="51">
          
          
          <code class="ruby">      image_exists = File.exist?(mets_access_master_path)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="52">
          
          
          <code class="ruby">      errors.add(:base, &quot;Expected file #{mets_access_master_path} not found.&quot;) unless image_exists</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="53">
          
          
          <code class="ruby">    elsif ENV[&#39;ACCESS_MASTER_MOUNT&#39;] == &quot;s3&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="54">
          
          
          <code class="ruby">      image_exists = S3Service.s3_exists?(remote_access_master_path)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="55">
          
          
          <code class="ruby">      errors.add(:base, &quot;Expected file #{remote_access_master_path} not found.&quot;) unless image_exists</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="57">
          
          
          <code class="ruby">      image_exists = File.exist?(access_master_path)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="58">
          
          
          <code class="ruby">      errors.add(:base, &quot;Expected file #{access_master_path} not found.&quot;) unless image_exists</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="60">
          
          
          <code class="ruby">    image_exists</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby">  ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby">  # Create a temp copy of the input file in TEMP_IMAGE_WORKSPACE</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby">  # @param [String] tmpdir - the tmpdir location where the file should be written</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby">  # @return [String] the full path where the file was downloaded</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="67">
          <span class="hits">1</span>
          
          <code class="ruby">  def copy_access_master_to_working_directory(tmpdir)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="68">
          
          
          <code class="ruby">    temp_file_path = File.join(tmpdir, File.basename(access_master_path))</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="69">
          
          
          <code class="ruby">    if ENV[&#39;ACCESS_MASTER_MOUNT&#39;] == &quot;s3&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="70">
          
          
          <code class="ruby">      download = S3Service.download_image(remote_access_master_path, temp_file_path)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="71">
          
          
          <code class="ruby">      if download</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="72">
          
          
          <code class="ruby">        child_object.processing_event(&quot;Access master retrieved from S3&quot;, &#39;access-master&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="73">
          
          
          <code class="ruby">        temp_file_path</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="75">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="76">
          
          
          <code class="ruby">      FileUtils.cp(access_master_path, tmpdir)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="77">
          
          
          <code class="ruby">      child_object.processing_event(&quot;Access master retrieved from file system&quot;, &#39;access-master&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="78">
          
          
          <code class="ruby">      temp_file_path</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="79">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="81">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="82">
          <span class="hits">1</span>
          
          <code class="ruby">  def build_command(ptiff_tmpdir, tiff_input_path, ptiff_output_path)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="83">
          
          
          <code class="ruby">    &quot;app/lib/tiff_to_pyramid.bash #{ptiff_tmpdir} #{tiff_input_path} #{ptiff_output_path}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="84">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="85">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="86">
          <span class="hits">1</span>
          
          <code class="ruby">  def convert_to_ptiff(tiff_input_path, ptiff_tmpdir)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="87">
          
          
          <code class="ruby">    ptiff_output_path = File.join(ptiff_tmpdir, File.basename(access_master_path))</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="88">
          
          
          <code class="ruby">    stdout, stderr, status = Open3.capture3(build_command(ptiff_tmpdir, tiff_input_path, ptiff_output_path))</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="89">
          
          
          <code class="ruby">    errors.add(:base, &quot;Conversion script exited with error code #{status.exitstatus}. ---\n#{stdout}---\n#{stderr}&quot;) if status.exitstatus != 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="90">
          
          
          <code class="ruby">    return {} if status.exitstatus != 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="91">
          
          
          <code class="ruby">    width = stdout.match(/Pyramid width: (\d*)/)&amp;.captures&amp;.[](0)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="92">
          
          
          <code class="ruby">    height = stdout.match(/Pyramid height: (\d*)/)&amp;.captures&amp;.[](0)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="93">
          
          
          <code class="ruby">    child_object.processing_event(&quot;PTIFF created #{width} x #{height}&quot;, &#39;ptiff-generated&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="94">
          
          
          <code class="ruby">    { width: width, height: height }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="95">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="96">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="97">
          <span class="hits">1</span>
          
          <code class="ruby">  def save_to_s3(ptiff_output_path, conversion_information)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="98">
          
          
          <code class="ruby">    metadata = { &#39;width&#39;: conversion_information[:width].to_s, &#39;height&#39;: conversion_information[:height].to_s }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="99">
          
          
          <code class="ruby">    S3Service.upload_image(ptiff_output_path, remote_ptiff_path, &quot;image/tiff&quot;, metadata)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="100">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="101">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="a2c95fa46c8da8e41ec1de35bf6d3d7d68c86e98">
  <div class="header">
    <h3>app/models/role.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>5</b> relevant lines. 
      <span class="green"><b>5</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># frozen_string_literal: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">class Role &lt; ApplicationRecord</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby">  # rubocop:disable Rails/HasAndBelongsToMany</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">  has_and_belongs_to_many :users, join_table: :users_roles</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">  # rubocop:enable Rails/HasAndBelongsToMany</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :resource,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">             polymorphic: true,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">             optional: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :resource_type,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">            inclusion: { in: Rolify.resource_types },</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">            allow_nil: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="15">
          <span class="hits">1</span>
          
          <code class="ruby">  scopify</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="560e1180e2f82ccecb0681b6560771c3f3e269a6">
  <div class="header">
    <h3>app/models/user.rb</h3>
    <h4><span class="red">51.52 %</span> covered</h4>
    <div>
      <b>33</b> relevant lines. 
      <span class="green"><b>17</b> lines covered</span> and
      <span class="red"><b>16</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># frozen_string_literal: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">class User &lt; ApplicationRecord</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  rolify</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">  devise :timeoutable, :omniauthable, omniauth_providers: [:cas]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :email, presence: true</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :first_name, presence: true</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :last_name, presence: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :batch_processes</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :users_roles</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="14">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.system_user</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="15">
          
          
          <code class="ruby">    system_user = User.find_by_uid(&#39;System&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="16">
          
          
          <code class="ruby">    unless system_user</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="17">
          
          
          <code class="ruby">      system_user = User.new(uid: &#39;System&#39;, email: &#39;test@example.com&#39;, first_name: &#39;test&#39;, last_name: &#39;user&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">      Rails.logger.error(&quot;Unable to save system user&quot;) unless system_user.save!</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="20">
          
          
          <code class="ruby">    system_user</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="23">
          <span class="hits">1</span>
          
          <code class="ruby">  def active_for_authentication?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="24">
          
          
          <code class="ruby">    super &amp;&amp; !deactivated</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="27">
          <span class="hits">1</span>
          
          <code class="ruby">  def deactivate</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="28">
          
          
          <code class="ruby">    self.deactivated = true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="31">
          <span class="hits">1</span>
          
          <code class="ruby">  def sysadmin=(value)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="32">
          
          
          <code class="ruby">    if value.present? &amp;&amp; value &amp;&amp; value != &#39;0&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="33">
          
          
          <code class="ruby">      add_role :sysadmin</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="35">
          
          
          <code class="ruby">      remove_role :sysadmin</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="39">
          <span class="hits">1</span>
          
          <code class="ruby">  def find_role(role, admin_set)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="40">
          
          
          <code class="ruby">    roles.find_by(name: role, resource_id: admin_set.id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="43">
          <span class="hits">1</span>
          
          <code class="ruby">  def sysadmin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="44">
          
          
          <code class="ruby">    has_role?(:sysadmin)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="47">
          <span class="hits">1</span>
          
          <code class="ruby">  def editor(admin_set)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="48">
          
          
          <code class="ruby">    has_role?(:editor, admin_set)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="51">
          <span class="hits">1</span>
          
          <code class="ruby">  def viewer(admin_set)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="52">
          
          
          <code class="ruby">    has_role?(:viewer, admin_set)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="55">
          <span class="hits">1</span>
          
          <code class="ruby">  def deactivate!</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="56">
          
          
          <code class="ruby">    deactivate</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="57">
          
          
          <code class="ruby">    save!</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="9b6af46cad0b11874edc42f3e1fee1491d927bac">
  <div class="header">
    <h3>app/models/users_role.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>3</b> relevant lines. 
      <span class="green"><b>3</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># frozen_string_literal: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">class UsersRole &lt; ApplicationRecord</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :user</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :role</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="beca431a1b978a79e1a5fb983977bc90b0fd081f">
  <div class="header">
    <h3>app/services/csv_row_parent_service.rb</h3>
    <h4><span class="red">0.0 %</span> covered</h4>
    <div>
      <b>89</b> relevant lines. 
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>89</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># frozen_string_literal: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"># rubocop:disable Metrics/ClassLength</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="4">
          
          
          <code class="ruby">class CsvRowParentService</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="5">
          
          
          <code class="ruby">  class BatchProcessingError &lt; StandardError</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="6">
          
          
          <code class="ruby">    attr_reader :kind</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="7">
          
          
          <code class="ruby">    def initialize(msg, kind)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="8">
          
          
          <code class="ruby">      @kind = kind</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="9">
          
          
          <code class="ruby">      super(msg)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="11">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby">  attr_accessor :row, :index, :current_ability, :user</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="15">
          
          
          <code class="ruby">  def initialize(row, index, current_ability, user)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="16">
          
          
          <code class="ruby">    @row = row</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="17">
          
          
          <code class="ruby">    @index = index</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">    @current_ability = current_ability</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="19">
          
          
          <code class="ruby">    @user = user</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="20">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">  # rubocop:disable Style/ClassVars</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="23">
          
          
          <code class="ruby">  def self.properties</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="24">
          
          
          <code class="ruby">    @@properties ||= []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="25">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">  # rubocop:enable Style/ClassVars</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="28">
          
          
          <code class="ruby">  def self.row_accessor(*names)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="29">
          
          
          <code class="ruby">    names.each do |name|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="30">
          
          
          <code class="ruby">      properties &lt;&lt; name</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="31">
          
          
          <code class="ruby">      define_method(name) { row[name.to_s] }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="32">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="33">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="35">
          
          
          <code class="ruby">  row_accessor :aspace_uri, :bib, :holding, :item, :barcode, :oid, :admin_set,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="36">
          
          
          <code class="ruby">               :preservica_uri, :visibility, :digital_object_source,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="37">
          
          
          <code class="ruby">               :authoritative_metadata_source_id, :preservica_representation_name</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="39">
          
          
          <code class="ruby">  def parent_object</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="40">
          
          
          <code class="ruby">    PreservicaImageService.new(preservica_uri, admin_set.key).image_list(preservica_representation_name)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="41">
          
          
          <code class="ruby">    @parent_object ||= ParentObject.new(properties_hash)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="42">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="44">
          
          
          <code class="ruby">  def properties_hash</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="45">
          
          
          <code class="ruby">    self.class.properties.each_with_object({}) { |p, h| h[p] = send(p); }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="46">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="48">
          
          
          <code class="ruby">  def oid</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="49">
          
          
          <code class="ruby">    @oid ||= OidMinterService.generate_oids(1)[0]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="50">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="52">
          
          
          <code class="ruby">  def parent_model</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="53">
          
          
          <code class="ruby">    row[&#39;parent_model&#39;] || &#39;complex&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="54">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="56">
          
          
          <code class="ruby">  def bib</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="57">
          
          
          <code class="ruby">    raise BatchProcessingError.new(&quot;Skipping row [#{index + 2}]. BIB must be present if &#39;ils&#39; metadata source&quot;, &#39;Skipped Row&#39;) if row[&#39;source&#39;] == &quot;ils&quot; &amp;&amp; !row[&#39;bib&#39;].present?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="58">
          
          
          <code class="ruby">    row[&#39;bib&#39;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="59">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="61">
          
          
          <code class="ruby">  def preservica_representation_name</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="62">
          
          
          <code class="ruby">    raise BatchProcessingError.new(&quot;Skipping row [#{index + 2}]. Preservica Representation Name must be present&quot;, &#39;Skipped Row&#39;) if row[&#39;preservica_representation_name&#39;].blank?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="63">
          
          
          <code class="ruby">    row[&#39;preservica_representation_name&#39;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="64">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="66">
          
          
          <code class="ruby">  def preservica_uri</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="67">
          
          
          <code class="ruby">    raise BatchProcessingError.new(&quot;Skipping row [#{index + 2}]. Preservica URI must start with a &#39;/&#39;&quot;, &#39;Skipped Row&#39;) unless row[&#39;preservica_uri&#39;].start_with?(&#39;/&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="68">
          
          
          <code class="ruby">    row[&#39;preservica_uri&#39;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="69">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="71">
          
          
          <code class="ruby">  def aspace_uri</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="72">
          
          
          <code class="ruby">    raise BatchProcessingError.new(&quot;Skipping row [#{index + 2}]. Aspace URI must be present if &#39;aspace&#39; metadata source&quot;, &#39;Skipped Row&#39;) if row[&#39;source&#39;] == &quot;aspace&quot; &amp;&amp; !row[&#39;aspace_uri&#39;].present?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="73">
          
          
          <code class="ruby">    row[&#39;aspace_uri&#39;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="74">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="75">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="76">
          
          
          <code class="ruby">  def visibility</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="77">
          
          
          <code class="ruby">    visibilities = [&#39;Private&#39;, &#39;Public&#39;, &#39;Redirect&#39;, &#39;Yale Community Only&#39;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="79">
          
          
          <code class="ruby">    return row[&#39;visibility&#39;] if visibilities.include?(row[&#39;visibility&#39;])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="81">
          
          
          <code class="ruby">    raise BatchProcessingError.new(&quot;Skipping row [#{index + 2}] with unknown visibility: #{row[&#39;visibility&#39;]}&quot;, &#39;Skipped Row&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="82">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="83">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="84">
          
          
          <code class="ruby">  def digital_object_source</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="85">
          
          
          <code class="ruby">    raise BatchProcessingError.new(&quot;Skipping row [#{index + 2}]. Digital Object Source must be &#39;Preservica&#39;&quot;, &#39;Skipped Row&#39;) if row[&#39;digital_object_source&#39;] != &quot;Preservica&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="86">
          
          
          <code class="ruby">    row[&#39;digital_object_source&#39;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="87">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="88">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="89">
          
          
          <code class="ruby">  # rubocop:disable Metrics/LineLength</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="90">
          
          
          <code class="ruby">  def admin_set</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="91">
          
          
          <code class="ruby">    admin_sets_hash = {}</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="92">
          
          
          <code class="ruby">    admin_set_key = row[&#39;admin_set&#39;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="93">
          
          
          <code class="ruby">    admin_sets_hash[admin_set_key] ||= AdminSet.find_by(key: admin_set_key)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="94">
          
          
          <code class="ruby">    admin_set = admin_sets_hash[admin_set_key]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="95">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="96">
          
          
          <code class="ruby">    raise BatchProcessingError.new(&quot;Skipping row [#{index + 2}] with unknown admin set [#{admin_set_key}] for parent: #{oid}&quot;, &#39;Skipped Row&#39;) if admin_set.blank?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="97">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="98">
          
          
          <code class="ruby">    raise BatchProcessingError.new(&quot;Skipping row [#{index + 2}] with admin set [#{admin_set_key}] for parent: #{oid}. Preservica credentials not set for #{admin_set_key}.&quot;, &#39;Skipped Row&#39;) unless admin_set.preservica_credentials_verified</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="99">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="100">
          
          
          <code class="ruby">    unless current_ability.can?(:add_member, admin_set)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="101">
          
          
          <code class="ruby">      raise BatchProcessingError.new(&quot;Skipping row [#{index + 2}] because #{user.uid} does not have permission to create or update parent: #{oid}&quot;,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="102">
          
          
          <code class="ruby">                                     &#39;Permission Denied&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="103">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="104">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="105">
          
          
          <code class="ruby">    admin_set</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="106">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="107">
          
          
          <code class="ruby">  # rubocop:enable Metrics/LineLength</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="108">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="109">
          
          
          <code class="ruby">  def authoritative_metadata_source_id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="110">
          
          
          <code class="ruby">    ms = row[&#39;source&#39;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="111">
          
          
          <code class="ruby">    raise BatchProcessingError.new(&quot;Skipping row [#{index + 2}] with unknown source [#{ms}]. Source must be &#39;ils&#39; or &#39;aspace&#39;&quot;, &#39;Skipped Row&#39;) if ms != &quot;ils&quot; &amp;&amp; ms != &quot;aspace&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="112">
          
          
          <code class="ruby">    if ms == &quot;ils&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="113">
          
          
          <code class="ruby">      ms = 2</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="114">
          
          
          <code class="ruby">    elsif ms == &quot;aspace&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="115">
          
          
          <code class="ruby">      ms = 3</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="116">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="117">
          
          
          <code class="ruby">    ms</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="118">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="119">
          
          
          <code class="ruby">end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="120">
          
          
          <code class="ruby"># rubocop:enable Metrics/ClassLength</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="2e9c1bc41a59b291ee8cd660641cf8af86f2848e">
  <div class="header">
    <h3>app/services/fixture_parsing_service.rb</h3>
    <h4><span class="red">0.0 %</span> covered</h4>
    <div>
      <b>43</b> relevant lines. 
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>43</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># frozen_string_literal: true</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="2">
          
          
          <code class="ruby">require &#39;csv&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="4">
          
          
          <code class="ruby">class FixtureParsingService</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby">  ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">  # Takes an oid and a metadata_source and returns a hash of the fixture file associated with that oid and metadata_source</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="7">
          
          
          <code class="ruby">  def self.fixture_file_to_hash(oid, metadata_source)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="8">
          
          
          <code class="ruby">    fixture_file_folder = Rails.root.join(&quot;spec&quot;, &quot;fixtures&quot;, metadata_source)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="9">
          
          
          <code class="ruby">    file_path = fixture_file_folder.join(&quot;#{file_prefix(metadata_source)}#{oid}&quot; + &quot;.json&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">    return false unless File.exist?(file_path)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="11">
          
          
          <code class="ruby">    fixture_file = File.read(file_path)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">    JSON.parse(fixture_file)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="15">
          
          
          <code class="ruby">  def self.find_dependent_uris(metadata_source)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="16">
          
          
          <code class="ruby">    parent_objects = ParentObject.all</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="17">
          
          
          <code class="ruby">    parent_objects.each do |parent_object|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">      oid = parent_object[&quot;oid&quot;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="19">
          
          
          <code class="ruby">      find_dependent_uri_for(oid, metadata_source)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="20">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="21">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="23">
          
          
          <code class="ruby">  def self.find_dependent_uri_for(oid, metadata_source)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="24">
          
          
          <code class="ruby">    hash = fixture_file_to_hash(oid, metadata_source)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="25">
          
          
          <code class="ruby">    return unless hash</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="26">
          
          
          <code class="ruby">    hash[&quot;dependentUris&quot;].each do |uri|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="27">
          
          
          <code class="ruby">      dep_obj = DependentObject.find_or_create_by(</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="28">
          
          
          <code class="ruby">        dependent_uri: uri,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="29">
          
          
          <code class="ruby">        metadata_source: metadata_source,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="30">
          
          
          <code class="ruby">        parent_object_id: oid</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="31">
          
          
          <code class="ruby">      )</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="32">
          
          
          <code class="ruby">      dep_obj.save</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="33">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="34">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">  ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">  # Takes a csv file and returns an array containing the values from the first column</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="38">
          
          
          <code class="ruby">  def self.build_oid_array(oid_path)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="39">
          
          
          <code class="ruby">    fixture_ids_table = CSV.read(oid_path, headers: true)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="40">
          
          
          <code class="ruby">    fixture_ids_table.by_col[0]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="41">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="43">
          
          
          <code class="ruby">  def self.file_prefix(metadata_source)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="44">
          
          
          <code class="ruby">    case metadata_source</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="45">
          
          
          <code class="ruby">    when &quot;ladybird&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="46">
          
          
          <code class="ruby">      &quot;&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="47">
          
          
          <code class="ruby">    when &quot;ils&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="48">
          
          
          <code class="ruby">      &quot;V-&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="49">
          
          
          <code class="ruby">    when &quot;aspace&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="50">
          
          
          <code class="ruby">      &quot;AS-&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="51">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="52">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="53">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="95354c7249fb5fbc0510dae7d66278abfb8efd85">
  <div class="header">
    <h3>app/services/oid_minter_service.rb</h3>
    <h4><span class="red">0.0 %</span> covered</h4>
    <div>
      <b>16</b> relevant lines. 
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>16</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># frozen_string_literal: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby">#</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="3">
          
          
          <code class="ruby">class OidMinterService</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="4">
          
          
          <code class="ruby">  def self.generate_oids(number)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="5">
          
          
          <code class="ruby">    oids = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="6">
          
          
          <code class="ruby">    initialize_sequence!</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="7">
          
          
          <code class="ruby">    number.times do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="8">
          
          
          <code class="ruby">      result = ActiveRecord::Base.connection.execute(&quot;SELECT NEXTVAL(&#39;OID_SEQUENCE&#39;)&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="9">
          
          
          <code class="ruby">      oids.push result.getvalue(0, 0)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="11">
          
          
          <code class="ruby">    oids</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="14">
          
          
          <code class="ruby">  def self.initialize_sequence!</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="15">
          
          
          <code class="ruby">    initial_value = Rails.application.config.oid_sequence_initial_value</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">    # This does nothing if the sequence already exists</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="17">
          
          
          <code class="ruby">    ActiveRecord::Base.connection.execute(&quot;CREATE SEQUENCE IF NOT EXISTS OID_SEQUENCE START WITH #{initial_value};&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">    initial_value</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="19">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="20">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="d6e6a1f0efeb8a61c5e20db59381325488d9819c">
  <div class="header">
    <h3>app/services/preservica_image_service.rb</h3>
    <h4><span class="red">0.0 %</span> covered</h4>
    <div>
      <b>67</b> relevant lines. 
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>67</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># frozen_string_literal: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="3">
          
          
          <code class="ruby">class PreservicaImageService</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="4">
          
          
          <code class="ruby">  class PreservicaImageServiceError &lt; StandardError</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="5">
          
          
          <code class="ruby">    attr_reader :id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="6">
          
          
          <code class="ruby">    def initialize(msg, id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="7">
          
          
          <code class="ruby">      @id = id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="8">
          
          
          <code class="ruby">      super(&quot;#{msg} for #{id}&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="9">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="11">
          
          
          <code class="ruby">  class PreservicaImageServiceNetworkError &lt; PreservicaImageServiceError</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">    def initialize(msg, id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby">      super(msg, id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="14">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="15">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="17">
          
          
          <code class="ruby">  def initialize(uri, admin_set_key)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">    @uri = uri</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="19">
          
          
          <code class="ruby">    if uri.include?(&#39;structural&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="20">
          
          
          <code class="ruby">      @pattern = :pattern_one</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="21">
          
          
          <code class="ruby">    elsif uri.include?(&#39;information&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="22">
          
          
          <code class="ruby">      @pattern = :pattern_two</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="23">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="24">
          
          
          <code class="ruby">    @admin_set_key = admin_set_key</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="25">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">  # rubocop:disable Metrics/MethodLength</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">  # rubocop:disable Metrics/AbcSize</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">  # rubocop:disable Metrics/PerceivedComplexity</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="30">
          
          
          <code class="ruby">  def image_list(representation_name)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="31">
          
          
          <code class="ruby">    @images = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="32">
          
          
          <code class="ruby">    begin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="33">
          
          
          <code class="ruby">      if @pattern == :pattern_one</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="34">
          
          
          <code class="ruby">        structural_object = Preservica::StructuralObject.where(admin_set_key: @admin_set_key, id: (@uri.split(&#39;/&#39;)[-1]).to_s)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="35">
          
          
          <code class="ruby">        begin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="36">
          
          
          <code class="ruby">          @information_objects = structural_object.information_objects</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="37">
          
          
          <code class="ruby">        rescue Net::OpenTimeout, Errno::ECONNREFUSED =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="38">
          
          
          <code class="ruby">          raise PreservicaImageServiceNetworkError.new(e.to_s, @uri.to_s)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="39">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="40">
          
          
          <code class="ruby">      elsif @pattern == :pattern_two</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="41">
          
          
          <code class="ruby">        @information_objects = [Preservica::InformationObject.where(admin_set_key: @admin_set_key, id: (@uri.split(&#39;/&#39;)[-1]).to_s)]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="42">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="43">
          
          
          <code class="ruby">    rescue StandardError</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="44">
          
          
          <code class="ruby">      raise PreservicaImageServiceError.new(&quot;Unable to log in to Preservica&quot;, @uri.to_s)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="45">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="46">
          
          
          <code class="ruby">    begin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="47">
          
          
          <code class="ruby">      process_information_objects(representation_name)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="48">
          
          
          <code class="ruby">    rescue StandardError =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="49">
          
          
          <code class="ruby">      error = e.to_s</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="50">
          
          
          <code class="ruby">      cleaned_error = error.split(&#39; for /&#39;).first</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="51">
          
          
          <code class="ruby">      raise PreservicaImageServiceError.new(cleaned_error, @uri.to_s) if error.include?(@uri.to_s)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="52">
          
          
          <code class="ruby">      raise PreservicaImageServiceError.new(e.to_s, @uri.to_s)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="53">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="54">
          
          
          <code class="ruby">    @images</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="55">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby">  # rubocop:enable Metrics/MethodLength</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby">  # rubocop:enable Metrics/AbcSize</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby">  # rubocop:enable Metrics/PerceivedComplexity</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby">  # rubocop:disable Metrics/LineLength</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby">  # rubocop:disable Metrics/AbcSize</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="62">
          
          
          <code class="ruby">  def process_information_objects(representation_name)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="63">
          
          
          <code class="ruby">    @information_objects.each do |information_object|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="64">
          
          
          <code class="ruby">      representation = information_object.fetch_by_representation_name(representation_name)[0]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="65">
          
          
          <code class="ruby">      raise PreservicaImageServiceError.new(&quot;No matching representation found in Preservica&quot;, @uri.to_s) if representation.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="66">
          
          
          <code class="ruby">      content_objects = representation.content_objects</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="67">
          
          
          <code class="ruby">      raise PreservicaImageServiceError.new(&quot;No matching content object found in Preservica&quot;, @uri.to_s) if content_objects.empty?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="68">
          
          
          <code class="ruby">      content_objects.each_with_index do |content_object, index|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="69">
          
          
          <code class="ruby">        raise PreservicaImageServiceError.new(&quot;No active generations found in Preservica&quot;, &quot;content object: #{content_object.id}&quot;) if content_object.active_generations.empty?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="70">
          
          
          <code class="ruby">        raise PreservicaImageServiceError.new(&quot;No matching bitstreams found in Preservica&quot;, content_object.active_generations[0].id.to_s) if content_object.active_generations[0].bitstreams.empty?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="71">
          
          
          <code class="ruby">        raise PreservicaImageServiceError.new(&quot;SHA mismatch found in Preservica&quot;, &quot;bitstream: #{content_object.active_generations[0].bitstreams[0].id}&quot;) if content_object.active_generations[0].bitstreams[0].sha512_checksum.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="72">
          
          
          <code class="ruby">        @images &lt;&lt; { preservica_content_object_uri: representation.content_object_uri(index),</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="73">
          
          
          <code class="ruby">                     preservica_generation_uri: content_object.active_generations[0].generation_uri,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="74">
          
          
          <code class="ruby">                     preservica_bitstream_uri: content_object.active_generations[0].bitstream_uri,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="75">
          
          
          <code class="ruby">                     sha512_checksum: content_object.active_generations[0].bitstreams[0].sha512_checksum,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="76">
          
          
          <code class="ruby">                     bitstream: content_object.active_generations[0].bitstreams[0] }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="77">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="78">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="79">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby">  # rubocop:enable Metrics/LineLength</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="81">
          
          
          <code class="ruby">  # rubocop:enable Metrics/AbcSize</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="82">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="aaf21e66f2911224e6b5a537ad0b46830b8dc070">
  <div class="header">
    <h3>app/services/s3_service.rb</h3>
    <h4><span class="red">35.29 %</span> covered</h4>
    <div>
      <b>51</b> relevant lines. 
      <span class="green"><b>18</b> lines covered</span> and
      <span class="red"><b>33</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># frozen_string_literal: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">class S3Service</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  @client ||= Aws::S3::Client.new # for debugging add (http_wire_trace: true)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.upload(file_path, data)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="7">
          
          
          <code class="ruby">    @client.put_object(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">      body: data,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">      bucket: ENV[&#39;SAMPLE_BUCKET&#39;],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">      key: file_path</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">    )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="14">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.upload_csv(file_path, data, content_type)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="15">
          
          
          <code class="ruby">    @client.put_object(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">      body: data,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">      bucket: ENV[&#39;SAMPLE_BUCKET&#39;],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">      key: file_path,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">      content_type: content_type</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">    )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="23">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.delete(file_path)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="24">
          
          
          <code class="ruby">    @client.delete_object(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">      bucket: ENV[&#39;S3_SOURCE_BUCKET_NAME&#39;],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">      key: file_path</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">    )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="30">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.upload_if_changed(file_path, data, bucket = ENV[&#39;SAMPLE_BUCKET&#39;])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="31">
          
          
          <code class="ruby">    return true if checksum_matches?(file_path, bucket, data)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="32">
          
          
          <code class="ruby">    status = @client.put_object(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">      body: data,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">      bucket: bucket,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">      key: file_path</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">    )</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="37">
          
          
          <code class="ruby">    status.successful?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">  # Returns the response body text</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="41">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.download(file_path)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="42">
          
          
          <code class="ruby">    resp = @client.get_object(bucket: ENV[&#39;SAMPLE_BUCKET&#39;], key: file_path)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="43">
          
          
          <code class="ruby">    resp.body&amp;.read</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">  rescue Aws::S3::Errors::NoSuchKey, Aws::S3::Errors::NotFound, Aws::S3::Errors::BadRequest</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="45">
          
          
          <code class="ruby">    nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby">  # Takes a remote S3 bucket path and writes the retrieved image to a local path.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">  # It downloads it in chunks because images are very large.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="50">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.download_image(remote_path, local_path, bucket = ENV[&#39;S3_SOURCE_BUCKET_NAME&#39;])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="51">
          
          
          <code class="ruby">    object = Aws::S3::Object.new(bucket_name: bucket, key: remote_path)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="52">
          
          
          <code class="ruby">    object.download_file(local_path, destination: local_path)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="55">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.upload_image(local_path, remote_path, content_type, metadata)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="56">
          
          
          <code class="ruby">    File.open(local_path, &#39;r&#39;) do |f|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="57">
          
          
          <code class="ruby">      @client.put_object(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby">        bucket: ENV[&#39;S3_SOURCE_BUCKET_NAME&#39;],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby">        key: remote_path,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby">        body: f,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby">        content_type: content_type,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby">        metadata: metadata</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby">      )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby">  # Returns String which is a pre-signed URL that a client can use to access the</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby">  # object from S3 without needing other credentials.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="69">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.presigned_url(remote_path, seconds, bucket = ENV[&#39;S3_SOURCE_BUCKET_NAME&#39;])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="70">
          
          
          <code class="ruby">    return remote_path unless bucket</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="71">
          
          
          <code class="ruby">    object = Aws::S3::Object.new(bucket_name: bucket, key: remote_path)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="72">
          
          
          <code class="ruby">    object.presigned_url(&#39;get&#39;, expires_in: seconds, response_content_disposition: &#39;attachment&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="75">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.remote_metadata(remote_path, bucket = ENV[&#39;S3_SOURCE_BUCKET_NAME&#39;])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="76">
          
          
          <code class="ruby">    object = Aws::S3::Object.new(bucket_name: bucket, key: remote_path)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="77">
          
          
          <code class="ruby">    return false unless object.exists?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="78">
          
          
          <code class="ruby">    object.metadata.symbolize_keys</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="79">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="81">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.checksum_matches?(remote_path, bucket, data)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="82">
          
          
          <code class="ruby">    etag = S3Service.etag(remote_path, bucket)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="83">
          
          
          <code class="ruby">    return false unless etag</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="84">
          
          
          <code class="ruby">    md5 = &quot;\&quot;#{Digest::MD5.hexdigest(data)}\&quot;&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="85">
          
          
          <code class="ruby">    md5 == etag</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="86">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="87">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="88">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.etag(remote_path, bucket = ENV[&#39;SAMPLE_BUCKET&#39;])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="89">
          
          
          <code class="ruby">    object = Aws::S3::Object.new(bucket_name: bucket, key: remote_path)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="90">
          
          
          <code class="ruby">    return nil unless object.exists?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="91">
          
          
          <code class="ruby">    object.etag</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="92">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="93">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="94">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.s3_exists?(remote_path, bucket = ENV[&#39;S3_SOURCE_BUCKET_NAME&#39;])</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="95">
          <span class="hits">2</span>
          
          <code class="ruby">    object = Aws::S3::Object.new(bucket_name: bucket, key: remote_path)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="96">
          <span class="hits">2</span>
          
          <code class="ruby">    object.exists?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="97">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="98">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="99">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.full_text_exists?(remote_path, bucket = ENV[&#39;OCR_DOWNLOAD_BUCKET&#39;])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="100">
          
          
          <code class="ruby">    object = Aws::S3::Object.new(bucket_name: bucket, key: remote_path)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="101">
          
          
          <code class="ruby">    begin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="102">
          
          
          <code class="ruby">      return true if object.exists? &amp;&amp; object.content_type == &#39;text/plain&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="103">
          
          
          <code class="ruby">    rescue Aws::S3::Errors::Forbidden</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="104">
          
          
          <code class="ruby">      false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="105">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="106">
          
          
          <code class="ruby">    false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="107">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="108">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="109">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.download_full_text(file_path, bucket = ENV[&#39;OCR_DOWNLOAD_BUCKET&#39;])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="110">
          
          
          <code class="ruby">    resp = @client.get_object(bucket: bucket, key: file_path)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="111">
          
          
          <code class="ruby">    resp.body&amp;.read</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="112">
          
          
          <code class="ruby">  rescue Aws::S3::Errors::NoSuchKey, Aws::S3::Errors::NotFound, Aws::S3::Errors::BadRequest</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="113">
          
          
          <code class="ruby">    nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="114">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="115">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="cb328b0fce87a4f5bd88a3193411b09607011502">
  <div class="header">
    <h3>app/services/solr_service.rb</h3>
    <h4><span class="red">0.0 %</span> covered</h4>
    <div>
      <b>76</b> relevant lines. 
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>76</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># frozen_string_literal: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="3">
          
          
          <code class="ruby">class SolrService</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="4">
          
          
          <code class="ruby">  def self.connection</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="5">
          
          
          <code class="ruby">    solr_core = ENV[&quot;SOLR_CORE&quot;] ||= &quot;blacklight-core&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="6">
          
          
          <code class="ruby">    solr_base_url = ENV[&quot;SOLR_BASE_URL&quot;] ||= &quot;http://localhost:8983/solr&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="7">
          
          
          <code class="ruby">    RSolr.connect url: File.join(solr_base_url, solr_core)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="8">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">  def self.delete_all</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="11">
          
          
          <code class="ruby">    connection.delete_by_query(&quot;*:*&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">    connection.commit</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">  # Heavily influenced by https://github.com/sunspot/sunspot</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">  # ==== Options (passed as a hash)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">  # batch_size&lt;Integer&gt;:: Override default batch size with which to load records.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">  # ==== Returns</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">  # Array:: Collection of IDs that exist in Solr but not in the database</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="24">
          
          
          <code class="ruby">  def self.solr_index_orphans(opts = {})</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="25">
          
          
          <code class="ruby">    batch_size = opts[:batch_size] || 500</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="27">
          
          
          <code class="ruby">    solr_page = 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="28">
          
          
          <code class="ruby">    solr_ids = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="29">
          
          
          <code class="ruby">    while (solr_page = solr_page.next)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="30">
          
          
          <code class="ruby">      search = connection.paginate(solr_page, batch_size, &quot;select&quot;, params: { q: &#39;oid_ssi:[* TO *]&#39;, fl: &#39;id&#39; })</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="31">
          
          
          <code class="ruby">      ids = (search&amp;.[](&#39;response&#39;)&amp;.[](&#39;docs&#39;)&amp;.map { |r| r.values })&amp;.flatten</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="32">
          
          
          <code class="ruby">      break if ids.empty?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="33">
          
          
          <code class="ruby">      solr_ids.concat(ids.map(&amp;:to_i))</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="34">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="36">
          
          
          <code class="ruby">    solr_ids - ParentObject.pluck(:oid)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="37">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">  # Heavily influenced by https://github.com/sunspot/sunspot</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">  # Find IDs of records of this class that are indexed in Solr but do not</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">  # exist in the database, and remove them from Solr. Under normal</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">  # circumstances, this should not be necessary; this method is provided</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby">  # in case something goes wrong.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby">  # ==== Options (passed as a hash)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby">  # batch_size&lt;Integer&gt;:: Override default batch size with which to load records</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="49">
          
          
          <code class="ruby">  def self.clean_index_orphans(opts = {})</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="50">
          
          
          <code class="ruby">    orphans = solr_index_orphans(opts)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="51">
          
          
          <code class="ruby">    connection.delete_by_id(orphans)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="52">
          
          
          <code class="ruby">    connection.commit</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="53">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby">  # Creates a new field type to update schema of already create solr index</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="56">
          
          
          <code class="ruby">  def self.add_field_type(name, type, index_analyzer, query_analyzer)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="57">
          
          
          <code class="ruby">    post_to_schema(</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="58">
          
          
          <code class="ruby">      &quot;add-field-type&quot;: {</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="59">
          
          
          <code class="ruby">        &quot;name&quot;: name,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="60">
          
          
          <code class="ruby">        &quot;class&quot;: type,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="61">
          
          
          <code class="ruby">        &quot;indexAnalyzer&quot;: index_analyzer,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="62">
          
          
          <code class="ruby">        &quot;queryAnalyzer&quot;: query_analyzer</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="63">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="64">
          
          
          <code class="ruby">    )</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="65">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby">  # Creates a new field type to update schema of already create solr index</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="68">
          
          
          <code class="ruby">  def self.replace_field_type(name, type, index_analyzer, query_analyzer)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="69">
          
          
          <code class="ruby">    post_to_schema(</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="70">
          
          
          <code class="ruby">      &quot;replace-field-type&quot;: {</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="71">
          
          
          <code class="ruby">        &quot;name&quot;: name,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="72">
          
          
          <code class="ruby">        &quot;class&quot;: type,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="73">
          
          
          <code class="ruby">        &quot;indexAnalyzer&quot;: index_analyzer,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="74">
          
          
          <code class="ruby">        &quot;queryAnalyzer&quot;: query_analyzer</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="75">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="76">
          
          
          <code class="ruby">    )</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="77">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="79">
          
          
          <code class="ruby">  # Creates a new field type to update schema of already create solr index</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="80">
          
          
          <code class="ruby">  def self.replace_dynamic_field(name, type, indexed, stored, multi_value)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="81">
          
          
          <code class="ruby">    post_to_schema(</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="82">
          
          
          <code class="ruby">      &quot;replace-dynamic-field&quot;: {</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="83">
          
          
          <code class="ruby">        &quot;name&quot;: name,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="84">
          
          
          <code class="ruby">        &quot;type&quot;: type,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="85">
          
          
          <code class="ruby">        &quot;indexed&quot;: indexed,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="86">
          
          
          <code class="ruby">        &quot;multiValued&quot;: multi_value,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="87">
          
          
          <code class="ruby">        &quot;stored&quot;: stored</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="88">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="89">
          
          
          <code class="ruby">    )</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="90">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="91">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="92">
          
          
          <code class="ruby">  # Creates a new field type to update schema of already create solr index</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="93">
          
          
          <code class="ruby">  def self.add_dynamic_field(name, type, indexed, stored, multi_value)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="94">
          
          
          <code class="ruby">    post_to_schema(</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="95">
          
          
          <code class="ruby">      &quot;add-dynamic-field&quot;: {</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="96">
          
          
          <code class="ruby">        &quot;name&quot;: name,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="97">
          
          
          <code class="ruby">        &quot;type&quot;: type,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="98">
          
          
          <code class="ruby">        &quot;indexed&quot;: indexed,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="99">
          
          
          <code class="ruby">        &quot;multiValued&quot;: multi_value,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="100">
          
          
          <code class="ruby">        &quot;stored&quot;: stored</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="101">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="102">
          
          
          <code class="ruby">    )</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="103">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="104">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="105">
          
          
          <code class="ruby">  def self.post_to_schema(data)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="106">
          
          
          <code class="ruby">    connection.connection.post(&#39;schema&#39;) do |req|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="107">
          
          
          <code class="ruby">      req.body = data.to_json</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="108">
          
          
          <code class="ruby">      req.headers[&#39;Content-Type&#39;] = &#39;application/json&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="109">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="110">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="111">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="9ef4732ba0c2a9abbcd2e3571699773c650235a7">
  <div class="header">
    <h3>lib/download_images.rb</h3>
    <h4><span class="red">0.0 %</span> covered</h4>
    <div>
      <b>9</b> relevant lines. 
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>9</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># frozen_string_literal: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="3">
          
          
          <code class="ruby">require &#39;benchmark&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="4">
          
          
          <code class="ruby">require &#39;csv&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby"># rubocop:disable Rails/Output</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="7">
          
          
          <code class="ruby">image_details = CSV.read(&quot;image_details.csv&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="8">
          
          
          <code class="ruby">puts Benchmark.realtime {</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="9">
          
          
          <code class="ruby">  image_details.each do |row|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">    puts row[0]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="11">
          
          
          <code class="ruby">    `curl -s -o /dev/null &quot;#{row[1]}&quot;`</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby">}</code>
        </li>
      
    </ol>
  </pre>
</div>

      
      </div>
    </div>
  </body>
</html>
