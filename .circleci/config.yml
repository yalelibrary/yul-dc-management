version: 2.1
executors:
  docker-publisher:
    environment:
      IMAGE_NAME: yalelibraryit/dc-management
    docker:
      - image: circleci/buildpack-deps:stretch
workflows:
  version: 2
  build-master:
    jobs:
      - build:
          filters:
            branches:
              only: push_from_circle_ci
      - run-tests:
          requires:
            - build
      - publish-latest:
          requires:
            - run-tests
          # filters:
          #   branches:
          #     only: master
orbs:
  # Orb documentation - https://circleci.com/orbs/registry/orb/circleci/docker
  docker: circleci/docker@1.0.1
jobs:
  build:
    executor: docker-publisher
    environment:
      IMAGE_NAME: yalelibraryit/dc-management
      POSTGRES_HOST: localhost
      POSTGRES_DB: yul_dc_management_test
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: password
      SOLR_CORE: blacklight-test
      SOLR_URL: http://localhost:8983/solr
    docker:
      - image: circleci/buildpack-deps:stretch
    steps:
      - setup_remote_docker
      - checkout
      - run:
          name: Build Docker image
          command: docker build -t $IMAGE_NAME:latest .
      - run:
          name: Rubocop
          command: bundle exec rubocop --parallel
      - run:
          name: Archive Docker image
          command: docker save -o image.tar $IMAGE_NAME
      - persist_to_workspace:
          root: .
          paths:
            - ./image.tar
  run-tests:
    executor: docker/docker
    steps:
      - attach_workspace:
          at: /tmp/workspace
      - setup_remote_docker
      - run:
          name: Load archived Docker image
          command: docker load -i /tmp/workspace/image.tar
      # - run:
      #     name: Install Docker Compose
      #     command: |
      #       set -x
      #       curl -L https://github.com/docker/compose/releases/download/1.25.3/docker-compose-`uname -s`-`uname -m` > /usr/local/bin/docker-compose
      #       chmod +x /usr/local/bin/docker-compose
      # - run:
      #     name: Rubocop
      #     command: bundle exec rubocop --parallel
  publish-latest:
    executor: docker-publisher
    steps:
      - attach_workspace:
          at: /tmp/workspace
      - setup_remote_docker
      - run:
          name: Load archived Docker image
          command: docker load -i /tmp/workspace/image.tar
      - run:
          name: Publish Docker Image to Docker Hub
          command: |
            echo "$DOCKERHUB_PASS" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin
            docker push $IMAGE_NAME:latest
      # # - run:
      #     # name: Install Docker Compose
      #     # command: |
      #     #   set -x
      #     #   curl -L https://github.com/docker/compose/releases/download/1.25.3/docker-compose-`uname -s`-`uname -m` > /usr/local/bin/docker-compose
      #     #   chmod +x /usr/local/bin/docker-compose
      # - setup_remote_docker
      # - run: |
      #     echo "$DOCKER_PASSWORD"
      #     echo "$DOCKER_LOGIN"
      #     # | docker login --username $DOCKER_LOGIN --password-stdin
      # - run:
      #     name: Setup Environment Variables
      #     command: |
      #       echo "export MANAGEMENT_TAG=$CIRCLE_SHA1" >> $BASH_ENV
      # - run:
      #     name: Build docker image using docker-compose
      #     command: |
      #       touch .secrets
      #       docker-compose build web
      # - run:
      #     name: Push Docker image
      #     command: |
      #       docker login -u ${docker_login} -p ${docker_password}
      #       docker push web
